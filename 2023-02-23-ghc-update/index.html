<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="IOG Engineering RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="IOG Engineering Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="IOG Engineering JSON Feed"><title data-react-helmet="true">IOG GHC Update #4 | IOG Engineering</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://engineering.iog.io/2023-02-23-ghc-update"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="IOG GHC Update #4 | IOG Engineering"><meta data-react-helmet="true" name="description" content="Biweekly update from the GHC DevX team at IOG."><meta data-react-helmet="true" property="og:description" content="Biweekly update from the GHC DevX team at IOG."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2023-02-23T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://iog.io/en/,https://iog.io/en/"><meta data-react-helmet="true" property="article:tag" content="ghc,ghc-update"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://engineering.iog.io/2023-02-23-ghc-update"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/2023-02-23-ghc-update" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/2023-02-23-ghc-update" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.10ad4647.css">
<link rel="preload" href="/assets/js/runtime~main.b0c41128.js" as="script">
<link rel="preload" href="/assets/js/main.1d0af711.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Recent</a><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-06-28-p2p">Unveiling Cardano&#x27;s Dynamic P2P: a leap forward in decentralization</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-06-15-ghc-update">IOG GHC Update #12</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-06-01-ghc-update">IOG GHC Update #11</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-05-18-ghc-update">IOG GHC Update #10</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-05-04-ghc-update">IOG GHC Update #9</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">IOG GHC Update #4</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-02-23T00:00:00.000Z" itemprop="datePublished">February 23, 2023</time> Â· <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="template-haskell">Template Haskell<a class="hash-link" href="#template-haskell" title="Direct link to heading">â€‹</a></h3><p>Sylvain: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779" target="_blank" rel="noopener noreferrer">!9779</a>
adding TH support for the JS backend passes CI and is ready for reviews.</p><p>Ticket <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23013" target="_blank" rel="noopener noreferrer">#23013</a> has been
opened to keep track of an issue with the recompilation avoidance mechanism.
Fixing the issue seems to require some invasive refactoring that is best left
for a future merge request.</p><p>Luite: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10008" target="_blank" rel="noopener noreferrer">!10008</a>
Implemented keeping track of subdirectories in GHC&#x27;s temporary file manager.
Ready for review. Fixes
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22952" target="_blank" rel="noopener noreferrer">#22952</a>.</p><p>Temporary subdirectories are used when linking Template Haskell with the
JavaScript backend and also in some situations when linking with other backends.
This would always result in files being left behind in GHC&#x27;s temporary directory
(and a warning at high enough verbosity settings) since these subdirectories
were never removed. With this patch, GHC keeps track of all created subdirectories
and removes them at the end of the session.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-rts-refactor">JavaScript RTS refactor<a class="hash-link" href="#javascript-rts-refactor" title="Direct link to heading">â€‹</a></h3><p>Josh: has merged the refactor of the RTS generation module to reduce redundant code.
In this refactor, debug logging was also completed to determine the correct numbers
to use as the cache sizes for generated JavaScript names - allowing us to vastly
reduce the size of these arrays for efficiency, and to remove <code>panic</code> cases in favour
of generating higher numbered names without caching.</p><p><a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9794" target="_blank" rel="noopener noreferrer">!9794</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="integer-performance">Integer performance<a class="hash-link" href="#integer-performance" title="Direct link to heading">â€‹</a></h3><p>Sylvain: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9825" target="_blank" rel="noopener noreferrer">!9825</a> has
been updated after an helpful review by Matthew Claven.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-edsl">JavaScript EDSL<a class="hash-link" href="#javascript-edsl" title="Direct link to heading">â€‹</a></h3><p>Jeff: MR is <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10000" target="_blank" rel="noopener noreferrer">open</a>.
In response to feedback from the team Jeff has added (and removed)
several features that distinguish the eDSL from
<a href="https://github.com/ku-fpg/sunroof-compiler" target="_blank" rel="noopener noreferrer">sunroof</a>. These include: removing
threading and continuations, adding named unique variables and a proper switch
statement. These changes allow more of the RTS to be replaced in the eDSL and
allow the RTS to be typed using Haskell&#x27;s type system. For example, now the STG
registers track the type of the values they hold.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ci">CI<a class="hash-link" href="#ci" title="Direct link to heading">â€‹</a></h3><p>Sylvain: fixed CI script test that prevented performance results to be stored for
the JS backend (see <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22923" target="_blank" rel="noopener noreferrer">#22923</a> and
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10026" target="_blank" rel="noopener noreferrer">!10026</a>).</p><hr><h2 class="anchor anchorWithStickyNavbar_mojV" id="compiler-performance">Compiler performance<a class="hash-link" href="#compiler-performance" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="more-strict-breakspan">More-strict <code>break</code>/<code>span</code><a class="hash-link" href="#more-strict-breakspan" title="Direct link to heading">â€‹</a></h3><p>Josh: opened a CLC (Core Libraries Committee) proposal to add stricter versions of
<code>break</code> and <code>span</code> to <code>Data.List</code> in addition to the existing lazy versions. The
proposal considers evidence that these versions are situationally more performant,
by comparing allocation statistics, generated STG, and microbenchmarks - as well as
making the argument for consistency with existing <code>List</code> functions that also have
strict versions.</p><p>See also:</p><ul><li><a href="https://github.com/haskell/core-libraries-committee/issues/133" target="_blank" rel="noopener noreferrer">CLC proposal 133</a></li><li><a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22865" target="_blank" rel="noopener noreferrer">GHC Issue 22865</a></li><li><a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9868" target="_blank" rel="noopener noreferrer">GHC MR 9868</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="unboxed-codebuffers">Unboxed CodeBuffers<a class="hash-link" href="#unboxed-codebuffers" title="Direct link to heading">â€‹</a></h3><p>Josh: opened a CLC proposal to modify the implementation of <code>CodeBuffer</code>s in <code>base</code>
to use unboxed tuples in the return type of encoding functions. This change presents
a significant allocation improvement, due to the difficulty GHC has with applying a
certain optimisation within data types.</p><p>See also:</p><ul><li><a href="https://github.com/haskell/core-libraries-committee/issues/134" target="_blank" rel="noopener noreferrer">CLC proposal 134</a></li><li><a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22946" target="_blank" rel="noopener noreferrer">GHC Issue 22946</a></li><li><a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9948" target="_blank" rel="noopener noreferrer">GHC MR 9948</a>.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="optimization-handbook">Optimization Handbook<a class="hash-link" href="#optimization-handbook" title="Direct link to heading">â€‹</a></h3><p>Jeff: Has been hard at work on the <a href="https://input-output-hk.github.io/hs-opt-handbook.github.io/" target="_blank" rel="noopener noreferrer">Optimization Handbook</a>.
He has finished a
chapter on <code>Lambda Lifting</code>, significantly expanded the glossary, and added
documentation to the
<a href="https://github.com/yongrenjie/sphinx-exec-directive" target="_blank" rel="noopener noreferrer">sphinx-exec-directive</a>
haskell extension that he finished last month. The optimization handbook is now
in review by IOG&#x27;s IT team to migrate it to the Haskell Foundation website.</p><hr><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghci">GHCi<a class="hash-link" href="#ghci" title="Direct link to heading">â€‹</a></h2><p>Luite: Added a testcase and did some cleanups in the types of the C code in MR
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9957" target="_blank" rel="noopener noreferrer">!9957</a>, and adjusted
the bytecode generator to not produce zero offset <code>SLIDE</code> instructions anymore.
This is now ready for review.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2023-03-09-ghc-update"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">IOG GHC Update #5</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2023-02-09-ghc-update"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">IOG GHC Update #3 (2023-02-09)</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#javascript-backend" class="table-of-contents__link toc-highlight">JavaScript backend</a><ul><li><a href="#template-haskell" class="table-of-contents__link toc-highlight">Template Haskell</a></li><li><a href="#javascript-rts-refactor" class="table-of-contents__link toc-highlight">JavaScript RTS refactor</a></li><li><a href="#integer-performance" class="table-of-contents__link toc-highlight">Integer performance</a></li><li><a href="#javascript-edsl" class="table-of-contents__link toc-highlight">JavaScript EDSL</a></li><li><a href="#ci" class="table-of-contents__link toc-highlight">CI</a></li></ul></li><li><a href="#compiler-performance" class="table-of-contents__link toc-highlight">Compiler performance</a><ul><li><a href="#more-strict-breakspan" class="table-of-contents__link toc-highlight">More-strict <code>break</code>/<code>span</code></a></li><li><a href="#unboxed-codebuffers" class="table-of-contents__link toc-highlight">Unboxed CodeBuffers</a></li><li><a href="#optimization-handbook" class="table-of-contents__link toc-highlight">Optimization Handbook</a></li></ul></li><li><a href="#ghci" class="table-of-contents__link toc-highlight">GHCi</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/iog_eng" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">IOG Blog</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 IOG Engineering, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b0c41128.js"></script>
<script src="/assets/js/main.1d0af711.js"></script>
</body>
</html>