<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">GHCJS heap representation | IOG Engineering</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://engineering.iog.io/2022-09-23-ghcjs-heap-representation"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="GHCJS heap representation | IOG Engineering"><meta data-rh="true" name="description" content="Introduction"><meta data-rh="true" property="og:description" content="Introduction"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-09-23T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="ghc,javascript"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://engineering.iog.io/2022-09-23-ghcjs-heap-representation"><link data-rh="true" rel="alternate" href="https://engineering.iog.io/2022-09-23-ghcjs-heap-representation" hreflang="en"><link data-rh="true" rel="alternate" href="https://engineering.iog.io/2022-09-23-ghcjs-heap-representation" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.3f63ffa1.css">
<link rel="preload" href="/assets/js/runtime~main.840dcf4b.js" as="script">
<link rel="preload" href="/assets/js/main.522da32c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/iohk-logo.png" alt="IOG" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/iohk-logo-inverted.png" alt="IOG" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Recent</a><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/upgrading-to-ghc-9.14">Upgrading to ghc-9.14</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-06-12-ghc-update">IOG GHC Update #47</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-05-15-ghc-update">IOG GHC Update #46</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-04-24-ghc-update">IOG GHC Update #45</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-04-03-ghc-update">IOG GHC Update #44</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-03-13-ghc-update">IOG GHC Update #43</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-02-20-ghc-update">IOG GHC Update #42</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-01-30-ghc-update">IOG GHC Update #41</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-01-09-ghc-update">IOG GHC Update #40</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-12-19-ghc-update">IOG GHC Update #39</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-11-28-ghc-update">IOG GHC Update #38</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-11-07-ghc-update">IOG GHC Update #37</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-10-17-ghc-update">IOG GHC Update #36</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-09-26-ghc-update">IOG GHC Update #35</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-09-05-ghc-update">IOG GHC Update #34</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-08-15-ghc-update">IOG GHC Update #33</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-07-24-ghc-update">IOG GHC Update #32</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-07-08-ghc-update">IOG GHC Update #31</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-06-17-ghc-update">IOG GHC Update #30</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-05-23-ghc-update">IOG GHC Update #29</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">GHCJS heap representation</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-09-23T00:00:00.000Z" itemprop="datePublished">September 23, 2022</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="mailto:sylvain.henry@iohk.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2><p>I recently gave a short presentation about heap objects representation in GHCJS and hence in the upcoming JS backend for GHC. This post is a summary of the content.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="heap-objects">Heap objects<a href="#heap-objects" class="hash-link" aria-label="Direct link to Heap objects" title="Direct link to Heap objects">​</a></h2><p>GHC implements Haskell code evaluation by using graph reduction. As such Haskell
programs compiled by GHC use the heap to store nodes of the graph to be
reduced and utility nodes participating in graph reduction. These nodes are:</p><ul><li>FUN: functions with their free variables as payload</li><li>THUNK: suspensions with their free variables as payload</li><li>PAP: partial application to a FUN. FUN closure and already applied arguments
as payload.</li><li>IND: indirection to another heap object</li><li>BLACKHOLE: used to overwrite a THUNK when it is being evaluated</li></ul><p>The heap is also used to store other values:</p><ul><li>CON: boxed values (saturated constructor applications) with field values as payload</li><li>Other unlifted values: TSO, BCO, arrays, MutVar#, MVar#, TVar#, stacks, stack frames...</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="info-tables">Info tables<a href="#info-tables" class="hash-link" aria-label="Direct link to Info tables" title="Direct link to Info tables">​</a></h2><p>Many heap objects share the same properties: e.g. all <code>Int</code> CON objects are
exactly the same except for their payload (the <code>Int#</code> value) that may be
different.
Hence heap objects are split in two parts to allow sharing of common properties:</p><ul><li>info table: statically known properties (at compilation time) that can be
shared by several heap objects</li><li>heap object itself: dynamically allocated in the heap</li></ul><p>Heap objects always have the same layout in the native code generated by GHC.
They are composed of:</p><ul><li>a pointer to an info table</li><li>some words of payload</li></ul><p>Heap traversal is done by following the info table pointer of every heap
object to query in the info table the layout of the heap object payload.</p><p>Info tables contain a pointer to a function called &quot;entry code&quot; that can be
specific to each info table. This code is mainly used to apply a node to some
arguments.
Note that with tables-next-to-code optimisation enabled, to avoid an
indirection the info table pointer is actually a pointer to this entry code and
the info table itself is stored in the words preceeding the entry code.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="heap-objects-in-javascript">Heap objects in JavaScript<a href="#heap-objects-in-javascript" class="hash-link" aria-label="Direct link to Heap objects in JavaScript" title="Direct link to Heap objects in JavaScript">​</a></h2><p>GHCJS represents most heap objects with a JavaScript object having the following
fields:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>One question I had was: why don&#x27;t we use a JS array instead of a JS object?
Arrays should be faster than objects (i.e. hashmaps), no? It turns out that
objects like this are optimised by JS engines using &quot;hidden classes&quot; (see
<a href="https://v8.dev/blog/fast-properties" target="_blank" rel="noopener noreferrer">https://v8.dev/blog/fast-properties</a> for an explanation). That&#x27;s why
they are usually more efficient than arrays for which bound checking must be
made. Also arrays are larger in memory because they need to store their size.</p><p>Let&#x27;s now discuss the fields of the heap objects.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="f-field">f field<a href="#f-field" class="hash-link" aria-label="Direct link to f field" title="Direct link to f field">​</a></h3><p>&quot;f&quot; is the equivalent of the info table pointer. It contains a JavaScript
function that is the entry code for the heap object.</p><p>Similar to the tables-next-to-code optimisation discussed above, we use the
fact that JS functions are objects which have properties to store the info
table fields as properties of the function itself.</p><p>Example of an info table / entry function:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token known-class-name class-name">Function</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> h$entry_function_xyz</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> t    </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) object type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) number of fields in payload (-1 if variable layout)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i    </span><span class="token comment" style="color:#999988;font-style:italic">// (Array) fields layout (empty if variable layout)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n    </span><span class="token comment" style="color:#999988;font-style:italic">// (String) object name for debug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a    </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) function arity or constructor tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> r    </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) arity in number of JS variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s    </span><span class="token comment" style="color:#999988;font-style:italic">// (Array) static refs that must be kept alive (SRT)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m    </span><span class="token comment" style="color:#999988;font-style:italic">// GC mark</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="d1-d2-fields">d1, d2 fields<a href="#d1-d2-fields" class="hash-link" aria-label="Direct link to d1, d2 fields" title="Direct link to d1, d2 fields">​</a></h3><p>The d1 and d2 fields contain the payload of the heap object: constructor fields,
function free variables, etc.</p><p>Payloads can be composed of zero, one, or many fields. A naive solution would be
to have one JS object field (d1, d2, d3...) per payload field. However it would
be bad for two reasons:</p><ul><li><p>performance: JS engine hidden classes optimisation mentioned above needs
objects to have the same field structure.</p></li><li><p>genericity: we couldn&#x27;t write generic functions (e.g. to copy a closure)
without dynamically querying the number of fields composing the payload.</p></li></ul><p>Another solution would be to use a single field to store the whole payload. It
would fulfill the genericity constraint. However performance may not be good
because of the extra allocation of the object containing the payload and the
indirection to access its fields.</p><p>Instead GHCJS uses a middle ground approach: it always uses only two JS object
fields to store any number of payload fields. The following encoding is used to
stash any number of payload fields into two JS fields:</p><table><thead><tr><th>Payload</th><th>d1</th><th>d2</th></tr></thead><tbody><tr><td>[]</td><td>null</td><td>null</td></tr><tr><td>[a]</td><td>a</td><td>null</td></tr><tr><td>[a,b]</td><td>a</td><td>b</td></tr><tr><td>[a,b,c]</td><td>a</td><td>{d1=b,d2=c}</td></tr><tr><td>[a,b,c,d...]</td><td>a</td><td>{d1=b,d2=c,d3=d...}</td></tr></tbody></table><p>It still fulfills the genericity constraint and small objects (up to two fields
of payload) don&#x27;t pay for an extra allocation/indirection. The price to pay is
that two fields of payload are always allocated, even for for objects with 1
field of payload.</p><p>It would be interesting to benchmark the performance of the different payload
representations.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="m-field">m field<a href="#m-field" class="hash-link" aria-label="Direct link to m field" title="Direct link to m field">​</a></h3><p>The &quot;m&quot; field is used both for reachability checking (~ garbage collection) and
to implement the &quot;stable names&quot; features.</p><p>GHCJS can&#x27;t rely on the JS engine to know when a heap object is collected. So it
implements its own heap traversal algorithm for this. The &quot;m&quot; field is used as a
marker for this algorithm (it will be the topic of a future blog post).
In this case, the &quot;m&quot; field is a number (a GC mark).</p><p>When a StableName is created for an object, the &quot;m&quot; field of the object is
updated to point to the StableName object:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$StableName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> m </span><span class="token comment" style="color:#999988;font-style:italic">// GC mark</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s </span><span class="token comment" style="color:#999988;font-style:italic">// stable name unique id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The &quot;m&quot; field of the StableName object is used in replacement of the mark of the object.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cc-field">cc field<a href="#cc-field" class="hash-link" aria-label="Direct link to cc field" title="Direct link to cc field">​</a></h3><p>The &quot;cc&quot; field is the cost center associated to the heap object. This field is
only present when profiling mode is enabled. Cost centers are entered (pushed on
the cost center stack of the current thread) before the evaluation of thunks and
function applications.</p><p>Cost centers are allocated with the <code>h$CC</code> function.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-heap-object-representation">Other heap object representation<a href="#other-heap-object-representation" class="hash-link" aria-label="Direct link to Other heap object representation" title="Direct link to Other heap object representation">​</a></h2><p>The generic heap object representation presented above is only used for some
objects: those involved in graph reduction (e.g. updatable objects) and values
that don&#x27;t have a fixed layout (e.g. CON objects have different layouts
depending on which constructor they represent). The object layout allows generic
access to the infotable and to the payload, and the infotable describes the
object type and the payload layout.</p><p>Several other objects don&#x27;t need this machinery: they always have the same
layout and are never the result of a reduction (they are unlifted values). These
objects are represented as JS objects with any fields they need (i.e. not using
the d1/d2 encoding above). To determine the type of such heap objects, instead
of using the &quot;type&quot; field of an infotable the code uses the <code>instanceof</code>
operator. For example a TSO is represented as a <code>h$Thread</code> object.</p><p>Note that we could be tempted to give every heap object a different object name
and to always use <code>instanceof</code> instead of the infotable &quot;type&quot; properties. It
would mean adding <code>h$Con</code>, <code>h$Thunk</code>, <code>h$Fun</code>, <code>h$Pap</code>, <code>h$Blackhole</code>, and
<code>h$StackFrame</code> objects. Then all the heap objects could be treated in the same
way. However the isssue is that these objects need to be overwritable in place:
a Thunk becomes a Fun/Con/Pap/Blackhole, etc. As far as I know we can&#x27;t update
the &quot;instance&quot; of an object, so all these object have to be instances of
the same JS object.</p><p>Also note that the JS backend doesn&#x27;t need INDirection nodes because it can
always overwrite the fields of a JS object with the fields of another to update
a closure. For the record, indirection nodes are needed in backends that
layout closures as a chunk of bytes/words and when the size of the closure to
update is smaller than the size of the updatee closure.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="automatic-unboxing">Automatic unboxing<a href="#automatic-unboxing" class="hash-link" aria-label="Direct link to Automatic unboxing" title="Direct link to Automatic unboxing">​</a></h3><p>Sometimes the generic heap object representation is unnecessary. For example, a
boxed <code>Int</code> would be represented as a <code>CON</code> heap object with the <code>Int#</code> in its
payload, represented as a JavaScript number value. The only thing we can do with
this heap object is to pass it around and to extract its payload. As such, it is
more memory efficient to directly pass the payload (a JS number).</p><p>GHCJS provides an optimisation that consists in automatically unboxing some CON
heap objects. For example, Haskell booleans (True and False datacons) are
directly mapped to JavaScript booleans, boxed numbers (Float, Double, Int, Word,
Int8, etc.) are directly mapped to JavaScript numbers.</p><p>We can do this because JavaScript already provides some boxing of its own: we
can use the <code>typeof</code> operator on a heap object to know if it is a JS object, a
JS number, a JS boolean, etc. It makes it possible to distinguish between heap
object representations. In comparison, we can&#x27;t do this with the native (non-JS)
backend when we only have a pointer to a heap object: the pointer doesn&#x27;t carry
the kind of value it points to, hence the pointed memory location must be
generic enough for this introspection to be performed (e.g. using infotable
pointers).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2><p>Heap object can be represented as JS values (number, boolean) because of the
automatic unboxing, or as JS objects: discimination is done with the <code>typeof</code>
operator.</p><p>Heap objects represented as JS objects come in two flavours:</p><ul><li>unlifted objects are represented with specific JS objects, disciminated with
the <code>instanceof</code> operator</li><li>other objects use the following generic and updatable structure:</li></ul><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">cc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ghc">ghc</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/javascript">javascript</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/input-output-hk/engineering/tree/master/blog/2022-09-23-ghcjs-heap-representation.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2022-09-28-introduce-q-d"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Model-Based Testing with QuickCheck</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2022-08-18-js-backend-ffi"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">GHCJS FFI system in the JS Backend</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#heap-objects" class="table-of-contents__link toc-highlight">Heap objects</a></li><li><a href="#info-tables" class="table-of-contents__link toc-highlight">Info tables</a></li><li><a href="#heap-objects-in-javascript" class="table-of-contents__link toc-highlight">Heap objects in JavaScript</a><ul><li><a href="#f-field" class="table-of-contents__link toc-highlight">f field</a></li><li><a href="#d1-d2-fields" class="table-of-contents__link toc-highlight">d1, d2 fields</a></li><li><a href="#m-field" class="table-of-contents__link toc-highlight">m field</a></li><li><a href="#cc-field" class="table-of-contents__link toc-highlight">cc field</a></li></ul></li><li><a href="#other-heap-object-representation" class="table-of-contents__link toc-highlight">Other heap object representation</a><ul><li><a href="#automatic-unboxing" class="table-of-contents__link toc-highlight">Automatic unboxing</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/iog_eng" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">IOG Blog</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 IOG Engineering, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.840dcf4b.js"></script>
<script src="/assets/js/main.522da32c.js"></script>
</body>
</html>