---
slug: 2023-03-09-ghc-update
title: "IOG GHC Update #5"
authors: [sylvain,doyougnu,luite,josh]
tags: [ghc,ghc-update]
---

Biweekly update from the GHC DevX team at IOG.

<!-- truncate  -->

Previous updates can be found [here](https://engineering.iog.io/tags/ghc-update).

## JavaScript backend

Luite: [!10059](https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10059)
Implemented computing a valid `LambdaFormInfo` for the JavaScript backend
so that interface files can be written without warnings. Fixes
[#23053](https://gitlab.haskell.org/ghc/ghc/-/issues/23053).

### Template Haskell

Luite: [!10008](https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10008)
implemented keeping track of subdirectories in GHC's temporary file manager.
It has been updated after reviews and is now ready to be merged.

### JavaScript EDSL

Jeff: MR is [open](https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10000).
In response to feedback from the team Jeff has added (and removed)
several features that distinguish the eDSL from
[sunroof](https://github.com/ku-fpg/sunroof-compiler). These include: 
  - removing threading and continuations
  - adding named unique variables and a proper switch statement
  - removing a dependency on the `operational` package
  - removing a dependency on the `data-reify` package
  - added a compilation function that compiles the eDSL to the IR the JavaScript backend uses.

These changes allow more of the RTS to be replaced in the eDSL and allow the RTS
to be typed using Haskell's type system. For example, now the STG registers
track the type of the values they hold. The RTS migration is now underway.

### copyMutableArray primops

Sylvain: fixed JS implementations for `copyMutableByteArray#` and
`copySmallMutableArray` primops. They were wrong in some cases when the source
and target arrays overlap. See
[#23033](https://gitlab.haskell.org/ghc/ghc/-/issues/23033) and
[!10037](https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10037).

### Testsuite

Sylvain: made a minor cleanup in the testsuite to correctly tag tests requiring
Cmm support (which the JS backend doesn't have):
[!10043](https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10043).

### Callbacks

Josh: ported GHCJS's `GHCJS.Foreign.Callback` module. Manual testing revealed some
minor changes required in the JavaScript backend, including to `base.GHC.JS.Prim`,
to make everything work as expected.

This will enable passing Haskell functions into `foreign import`s, which in turn
enables a form of calling into Haskell from JavaScript code.

----


## Compiler performance

### Optimization Handbook

Jeff: Work has begun on the first major case study: a performance
[regression](https://github.com/LeventErkok/sbv/issues/642) in the
[sbv](https://github.com/LeventErkok/sbv) library. 


----

## RTS linker

Sylvain: helped fixing a RTS linker bug. The RTS ELF linker didn't properly
take into account required section alignments and always used 16-bytes alignment.
However AVX instructions generated by the C compiler may expect 32-bytes alignment
(even if the code uses unaligned load intrinsics, the C compiler may optimize them
into aligned load instructions, as was the case here).
The fix was simple, the test case a bit more involved.
See [#23066](https://gitlab.haskell.org/ghc/ghc/-/issues/23066) and [!10087](https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10087).
