<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="IOG Engineering RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="IOG Engineering Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="IOG Engineering JSON Feed"><title data-react-helmet="true">The GHCJS Linker | IOG Engineering</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://engineering.iog.io/2022-07-26-the-ghcjs-linker"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="The GHCJS Linker | IOG Engineering"><meta data-react-helmet="true" name="description" content="Introduction"><meta data-react-helmet="true" property="og:description" content="Introduction"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-07-26T00:00:00.000Z"><meta data-react-helmet="true" property="article:tag" content="ghc,javascript,linking"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://engineering.iog.io/2022-07-26-the-ghcjs-linker"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/2022-07-26-the-ghcjs-linker" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/2022-07-26-the-ghcjs-linker" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.10ad4647.css">
<link rel="preload" href="/assets/js/runtime~main.71b3dbef.js" as="script">
<link rel="preload" href="/assets/js/main.602e5b06.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Recent</a><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-01-24-javascript-browser-tutorial">Using GHC&#x27;s JavaScript Backend in the Browser</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-01-12-ghc-update">GHC DevX Update 2023-01-12</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022-12-13-ghc-js-backend-merged">JavaScript backend merged into GHC</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022-09-28-introduce-q-d">Model-Based Testing with QuickCheck</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022-09-23-ghcjs-heap-representation">GHCJS heap representation</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">The GHCJS Linker</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-26T00:00:00.000Z" itemprop="datePublished">July 26, 2022</time> Â· <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">â€‹</a></h2><p>I recently gave a short presentation on the workings of the GHCJS linker. This post is a summary of the content.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-executables">JavaScript &quot;executables&quot;<a class="hash-link" href="#javascript-executables" title="Direct link to heading">â€‹</a></h2><p>The task of a linker is collecting and organizing object files and resources into a loadable library or executable program. JavaScript can be run in various environments, for example the browser or node.js, and not in all of these the concept of an executable makes sense.</p><p>Therefore, when we link a Haskell program, we generate a <code>jsexe</code> directory filled with various files that allow us to run the JavaScript result:</p><table><thead><tr><th align="center">File</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center"><code>out.js</code></td><td align="center">compiled/linked Haskell code</td></tr><tr><td align="center"><code>out.frefs.*</code></td><td align="center">list of foreign calls from <code>out.js</code></td></tr><tr><td align="center"><code>out.stats</code></td><td align="center">source code size origin statistics for <code>out.js</code></td></tr><tr><td align="center"><code>lib.js</code></td><td align="center">non-Haskell code, from <code>js-sources</code> in packages and RTS. possibly preprocessed</td></tr><tr><td align="center"><code>rts.js</code></td><td align="center">generated part of RTS (apply functions and similarly repetitive things)</td></tr><tr><td align="center"><code>runmain.js</code></td><td align="center">single line just starts <code>main</code></td></tr><tr><td align="center"><code>all.js</code></td><td align="center">complete runnable program, created by combining <code>out.js</code>, <code>lib.js</code>, <code>rts.js</code> and <code>runmain.js</code></td></tr></tbody></table><p>Most of the work done by the linker is producing <code>out.js</code>, and that&#x27;s what we&#x27;ll be focusing on in the next sections.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-outjs">Building <code>out.js</code><a class="hash-link" href="#building-outjs" title="Direct link to heading">â€‹</a></h2><p>The linker builds <code>out.js</code> by collecting all code reachable from <code>main</code> (and a few other symbols required by the RTS) and generating the required initialization code for all top-level data. The code is found in object files. These object files have the following structure:</p><table><thead><tr><th align="center">Section</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">Header</td><td align="center">version number and offsets of other sections</td></tr><tr><td align="center">String table</td><td align="center">shared string table, referred to by <code>Dependencies</code> and <code>Code</code>, to avoid duplication in file and memory</td></tr><tr><td align="center">Dependencies</td><td align="center">Dependency data, internally between binding groups and externally to symbols in other object files</td></tr><tr><td align="center">Code</td><td align="center">Compiled Haskell code stored as serialized JavaScript AST and metadata. Code is organized in binding groups</td></tr></tbody></table><p>The object files contain binding groups of mutually dependent bindings. These are the smallest units of code that can be linked. Each binding group has some associated metadata required for initialization of the heap objects in the group. The metadata contains for example constructor tags (e.g. 1 for <code>Nothing</code>, 2 for <code>Just</code>), the arity of functions and static reference tables.</p><p>From a high level, the procedure that the linker follows is this:</p><table><thead><tr><th align="center">Step</th></tr></thead><tbody><tr><td align="center">Read object files from dependencies into memory</td></tr><tr><td align="center">Decode dependency part of all object files in dependencies (includes reading the string tables)</td></tr><tr><td align="center">Using dependency data, find all code reachable from <code>main</code></td></tr><tr><td align="center">Decode reachable binding groups</td></tr><tr><td align="center">Render AST to JavaScript</td></tr><tr><td align="center">Construct initializers from metadata</td></tr></tbody></table><p>We avoid decoding (deserializing) the binding groups that do end up in the linked result to keep the memory consumption lower. Still the linker requires a lot of memory for larger programs, so we may need to make more improvements in the future.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-compactor">The Compactor<a class="hash-link" href="#the-compactor" title="Direct link to heading">â€‹</a></h2><p>The compactor is an optional link-time transformation step that reduces code size. It consists of a lightweight (i.e. no expensive operations like dataflow analysis) rewrite of the code contained in the object files. The compactor is disabled when linking with the <code>-debug</code> flag. There are a few steps involved.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="renaming-private-symbols">Renaming private symbols<a class="hash-link" href="#renaming-private-symbols" title="Direct link to heading">â€‹</a></h3><p>Haskell names are quite long by default: they need to be globally unique, hence they contain their defining unit-id and module name. For example: <code>mtl-2.2.2-somehash-Control.Monad.State.Lazy.execState_go1</code> (special characters would be z-encoded but it isn&#x27;t shown here).</p><p>Private symbols are only referred to from within the same module. It doesn&#x27;t matter which JavaScript name we pick for them, as long as there is no overlap between the names from different modules. The compactor renames all the private symbols using a global sequence to ensure short names that do not overlap.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="block-initializer">Block Initializer<a class="hash-link" href="#block-initializer" title="Direct link to heading">â€‹</a></h3><p>Without the compactor, the linker generates an <code>h$initObj</code> initialization call (or <code>h$o</code>) call for each global Haskell heap value. The code for this can get quite big. The compactor collects all heap objects to be initialized in a single large array and encodes the metadata in a string. This makes the initialization code much more compact.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="deduplication">Deduplication<a class="hash-link" href="#deduplication" title="Direct link to heading">â€‹</a></h3><p>An optional step in the compactor is deduplication of code. When deduplication is enabled with the <code>-dedupe</code> flag, the compactor looks for functionally equivalent pieces of JavaScript in the output and merges them. This can result in a significant reduction of code size.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="incremental-linking">Incremental Linking<a class="hash-link" href="#incremental-linking" title="Direct link to heading">â€‹</a></h2><p>The linker supports building programs that are loaded incrementally. This is used for example for Template Haskell. The process that runs the Template Haskell stays alive during compilation of a whole module. When the first Template Haskell expression is compiled, it is linked against all its dependencies (including the RTS) and the resulting JavaScript code is sent over to be run in the evaluator process.</p><p>As subsequent Template Haskell expressions are evaluated in the same process, there is no need to load already loaded dependencies (including the RTS) again and it is much more efficient to avoid doing so. Therefore the linker keeps track of which dependencies have already been linked and each subsequent TH expression is only linked against dependencies that are not already loaded in the evaluator process.</p><p>It&#x27;s also possible for users to use this functionality directly, with the <code>-generate-base</code> to create a &quot;linker state&quot; file along with the regular <code>jsexe</code> files. Another program can then be linked with <code>-use-base=state_file</code>, resulting in a program which leaves out everything already present in the first program.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="future-improvements">Future Improvements<a class="hash-link" href="#future-improvements" title="Direct link to heading">â€‹</a></h2><p>Memory consumption is the biggest problem in the linker at the moment. Possible ways to achieve this are compression, more efficient representation of the data structures or more incremental loading of the parts from the object files that we need.</p><p>In terms of functionality, we don&#x27;t take advantage of JavaScript modules yet. It would be good if we could improve the linker to support linking a library as a JavaScript module. We should also consider making use of <code>foreign export javascript</code> for this purpose.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/linking">linking</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2022-08-01-ghc-update"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">GHC DevX July 2022 Update</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2022-07-20-js-backend-prim-types"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Primitive Type Representation in GHC&#x27;s upcoming JS-backend</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#javascript-executables" class="table-of-contents__link toc-highlight">JavaScript &quot;executables&quot;</a></li><li><a href="#building-outjs" class="table-of-contents__link toc-highlight">Building <code>out.js</code></a></li><li><a href="#the-compactor" class="table-of-contents__link toc-highlight">The Compactor</a><ul><li><a href="#renaming-private-symbols" class="table-of-contents__link toc-highlight">Renaming private symbols</a></li><li><a href="#block-initializer" class="table-of-contents__link toc-highlight">Block Initializer</a></li><li><a href="#deduplication" class="table-of-contents__link toc-highlight">Deduplication</a></li></ul></li><li><a href="#incremental-linking" class="table-of-contents__link toc-highlight">Incremental Linking</a></li><li><a href="#future-improvements" class="table-of-contents__link toc-highlight">Future Improvements</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/iog_eng" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">IOG Blog</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 IOG Engineering, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.71b3dbef.js"></script>
<script src="/assets/js/main.602e5b06.js"></script>
</body>
</html>