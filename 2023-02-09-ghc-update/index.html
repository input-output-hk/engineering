<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">IOG GHC Update #3 (2023-02-09) | IOG Engineering</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://engineering.iog.io/2023-02-09-ghc-update"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="IOG GHC Update #3 (2023-02-09) | IOG Engineering"><meta data-rh="true" name="description" content="Biweekly update from the GHC DevX team at IOG."><meta data-rh="true" property="og:description" content="Biweekly update from the GHC DevX team at IOG."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-02-09T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://iog.io/en/,https://iog.io/en/"><meta data-rh="true" property="article:tag" content="ghc,ghc-update"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://engineering.iog.io/2023-02-09-ghc-update"><link data-rh="true" rel="alternate" href="https://engineering.iog.io/2023-02-09-ghc-update" hreflang="en"><link data-rh="true" rel="alternate" href="https://engineering.iog.io/2023-02-09-ghc-update" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.3f63ffa1.css">
<link rel="preload" href="/assets/js/runtime~main.840dcf4b.js" as="script">
<link rel="preload" href="/assets/js/main.522da32c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/iohk-logo.png" alt="IOG" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/iohk-logo-inverted.png" alt="IOG" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Recent</a><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/upgrading-to-ghc-9.14">Upgrading to ghc-9.14</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-06-12-ghc-update">IOG GHC Update #47</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-05-15-ghc-update">IOG GHC Update #46</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-04-24-ghc-update">IOG GHC Update #45</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-04-03-ghc-update">IOG GHC Update #44</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-03-13-ghc-update">IOG GHC Update #43</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-02-20-ghc-update">IOG GHC Update #42</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-01-30-ghc-update">IOG GHC Update #41</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-01-09-ghc-update">IOG GHC Update #40</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-12-19-ghc-update">IOG GHC Update #39</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-11-28-ghc-update">IOG GHC Update #38</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-11-07-ghc-update">IOG GHC Update #37</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-10-17-ghc-update">IOG GHC Update #36</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-09-26-ghc-update">IOG GHC Update #35</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-09-05-ghc-update">IOG GHC Update #34</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-08-15-ghc-update">IOG GHC Update #33</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-07-24-ghc-update">IOG GHC Update #32</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-07-08-ghc-update">IOG GHC Update #31</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-06-17-ghc-update">IOG GHC Update #30</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-05-23-ghc-update">IOG GHC Update #29</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">IOG GHC Update #3 (2023-02-09)</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-02-09T00:00:00.000Z" itemprop="datePublished">February 9, 2023</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="mailto:sylvain.henry@iohk.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="mailto:luite.stegeman@iohk.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-backend">JavaScript backend<a href="#javascript-backend" class="hash-link" aria-label="Direct link to JavaScript backend" title="Direct link to JavaScript backend">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="template-haskell">Template Haskell<a href="#template-haskell" class="hash-link" aria-label="Direct link to Template Haskell" title="Direct link to Template Haskell">​</a></h3><p>Luite: fixed the support for one-shot mode (GHC&#x27;s <code>-c</code> command-line flag)
in the TH JS linker.</p><p>Luite: Investigated a warning about the temporary directory not being removed
after running Template Haskell with the JavaScript backend. It turned out
that GHC&#x27;s <code>GHC.Utils.TmpFs.newTempDir</code>, which is used by the Template Haskell
linker, does not allow the newly created directory to be removed
(see <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22952" target="_blank" rel="noopener noreferrer">#22952</a>).</p><p>Sylvain: cleaned up the <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779" target="_blank" rel="noopener noreferrer">merge request</a>,
removing unnecessary changes and adding documentation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-backend-ci">JavaScript backend CI<a href="#javascript-backend-ci" class="hash-link" aria-label="Direct link to JavaScript backend CI" title="Direct link to JavaScript backend CI">​</a></h3><p>Jeff: JavaScript backend CI was <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9552" target="_blank" rel="noopener noreferrer">finally
merged</a>! Now that we
have CI we are unblocked on several fronts, such as, implementing <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9825" target="_blank" rel="noopener noreferrer">faster
arithmetic</a> and fixing
some <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9879" target="_blank" rel="noopener noreferrer">async
exceptions</a>. In
general, we can now have confidence that our work is progressing the JavaScript
backend to a better state.</p><p>Sylvain: fixed a spurious failure on JS CI due to some test <em>passing</em> on fast runners
while it was expected to fail (see <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9934" target="_blank" rel="noopener noreferrer">!9934</a>).</p><p>Josh: fixed some inaccurate test predicates <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9939" target="_blank" rel="noopener noreferrer">!9939</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="filestat">FileStat<a href="#filestat" class="hash-link" aria-label="Direct link to FileStat" title="Direct link to FileStat">​</a></h3><p>Josh: rebased and merged <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9755" target="_blank" rel="noopener noreferrer">!9755</a>.
This patch changes the representation of the JavaScript equivalent of the C <code>struct stat</code>
to make its field offsets match the C ones: some Haskell codes directly access fields of
this structure using <code>hsc2hs</code> to get the field offsets from the C headers.</p><p>This patch also adds fields to the JavaScript file stat that were previously not
included, such as modification and access times.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-rts-refactor">JavaScript RTS refactor<a href="#javascript-rts-refactor" class="hash-link" aria-label="Direct link to JavaScript RTS refactor" title="Direct link to JavaScript RTS refactor">​</a></h3><p>Josh: rebased <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9794" target="_blank" rel="noopener noreferrer">!9794</a> which consists
in the refactor of the module generating some part of the RTS. The new JS CI job found a bug in the patch that
caused ~50 tests to time out, so waiting for CI to be set up before merging this MR was judicious.</p><p>This MR also became an opportunity to revisit some arbitrary cache sizes in the RTS code generator.
This is still ongoing work.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="warnings">Warnings<a href="#warnings" class="hash-link" aria-label="Direct link to Warnings" title="Direct link to Warnings">​</a></h3><p>Luite: We accidently removed the check for the &quot;javascript&quot; calling convention on
foreign imports, allowing this convention to be wrongly used on native platform.
Fixed in <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9880" target="_blank" rel="noopener noreferrer">!9880</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fix-for-asynchronous-exceptions">Fix for asynchronous exceptions<a href="#fix-for-asynchronous-exceptions" class="hash-link" aria-label="Direct link to Fix for asynchronous exceptions" title="Direct link to Fix for asynchronous exceptions">​</a></h3><p>Luite: Fixed an issue in the garbage collector for the JavaScript backend:
A thread that posts an asynchronous exception (<code>throwTo</code>) to another thread
is temporarily suspended until the exception has been delivered. The
garbage collector did not correctly follow the list of threads suspended in
this way, potentially considering them unreachable and cleaning up data
referenced by them. See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22836" target="_blank" rel="noopener noreferrer">#22836</a> and
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9879" target="_blank" rel="noopener noreferrer">!9879</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="integer-performance">Integer performance<a href="#integer-performance" class="hash-link" aria-label="Direct link to Integer performance" title="Direct link to Integer performance">​</a></h3><p>Evaluating the following expression is very slow in general but especially with
the JS backend:</p><div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1 `shiftL` (1 `shiftL` 20) :: Integer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We&#x27;ve had to mark a test computing this as broken on CI because it triggers a
timeout error. Luckily the identification of slow operations is easy with
JavaScript profiling tools (see graphs in
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22835" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/issues/22835</a>) and we know that <code>Word32</code>
primops are the culprit in this case.</p><p>Sylvain started replacing the uses of JavaScript&#x27;s <code>BigInt</code> in the
implementation of these primops with usual JavaScript <code>numbers</code>.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9825" target="_blank" rel="noopener noreferrer">!9825</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-edsl">JavaScript EDSL<a href="#javascript-edsl" class="hash-link" aria-label="Direct link to JavaScript EDSL" title="Direct link to JavaScript EDSL">​</a></h3><p>Jeff: JavaScript eDSL based on
<a href="https://github.com/ku-fpg/sunroof-compiler" target="_blank" rel="noopener noreferrer">sunroof</a> close to MR, see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22736" target="_blank" rel="noopener noreferrer">#22736</a> for background.
Compiler is complete. Major items left are: the interpreter to translate to
<code>JStat</code>, filling in documentation, and testing now that CI has been merged.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="documentation">Documentation<a href="#documentation" class="hash-link" aria-label="Direct link to Documentation" title="Direct link to Documentation">​</a></h3><p>Jeff: Wrote the JavaScript backend release notes. Notes pending
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9828" target="_blank" rel="noopener noreferrer">approval</a>. We cite
the <a href="https://gitlab.haskell.org/ghc/ghc/-/wikis/javascript-backend" target="_blank" rel="noopener noreferrer">JavaScript
backend</a> wiki
page in the release notes. So Jeff and Sylvain heavily edited the wiki pages to
make them suitable for external customers.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="change-from-js-to-javascript-architecture">Change from <code>js</code> to <code>javascript</code> architecture<a href="#change-from-js-to-javascript-architecture" class="hash-link" aria-label="Direct link to change-from-js-to-javascript-architecture" title="Direct link to change-from-js-to-javascript-architecture">​</a></h3><p>In <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22740" target="_blank" rel="noopener noreferrer">#22740</a> it was noticed that
<code>hackage-server</code> would prevent the upload of the upcoming <code>base</code> package bundled with GHC 9.6.
The reason is that <code>hackage-server</code> relies on the <code>cabal --check</code> feature which filters
out perfectly valid packages (it happened before, for example with <a href="https://gitlab.haskell.org/haskell/ghc-api-compat/-/issues/1" target="_blank" rel="noopener noreferrer">ghc-api-compat</a>).</p><p>In our case, the package was rejected because the <code>js</code> architecture wasn&#x27;t recognized
as a built-in one, but luckily we could fall back to the existing <code>javascript</code> built-in
architecture defined for GHCJS (if it wasn&#x27;t a JS backend, we would have had to fix Cabal,
update <code>hackage-server</code> dependencies, and redeploy <code>hackage-server</code>...).</p><p>Sylvain completed Ben&#x27;s MR in <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9814" target="_blank" rel="noopener noreferrer">!9814</a>.</p><p>For early users of the JS backend the change means that from now on:</p><ul><li><code>configure</code> command is: <code>emconfigure ./configure --target=javascript-unknown-ghcjs</code></li><li>Cabal condition is: <code>arch(javascript)</code></li><li>CPP condition is: <code>#if defined(javascript_HOST_ARCH)</code></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="compiler-performance">Compiler performance<a href="#compiler-performance" class="hash-link" aria-label="Direct link to Compiler performance" title="Direct link to Compiler performance">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="more-strict-break">More-strict <code>break</code><a href="#more-strict-break" class="hash-link" aria-label="Direct link to more-strict-break" title="Direct link to more-strict-break">​</a></h3><p>Josh: opened merge request <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9868" target="_blank" rel="noopener noreferrer">!9868</a> to add a stricter <code>break&#x27;</code> version to <code>base</code> - however, this would require a CLC proposal.</p><p>Further analysis was done using ticky profiles on a simple test program that benchmarks GHC&#x27;s startup code.
This has found an example where a more-strict break is an improvement in GHC, which will provide motivation
for the CLC proposal.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="unboxed-codebuffers">Unboxed CodeBuffers<a href="#unboxed-codebuffers" class="hash-link" aria-label="Direct link to Unboxed CodeBuffers" title="Direct link to Unboxed CodeBuffers">​</a></h3><p>Josh: implemented changes to GHC&#x27;s text encoding buffers to use unboxed tuples on handle encoders/decoders.
The buffers pass around and repeatedly pack/unpack a tuple in an <code>IO</code> inner loop, which causes a significant
number of unnecessary allocations. By replacing this with an unboxed tuple, and replacing the <code>IO</code> with
manually passing around a <code>State# RealWorld</code> in the same tuple, we&#x27;re able to reduce allocations by nearly 50%
in a pathological example (non-allocating loop printing characters). See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22946" target="_blank" rel="noopener noreferrer">#22946</a> and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9948" target="_blank" rel="noopener noreferrer">!9948</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimization-handbook">Optimization Handbook<a href="#optimization-handbook" class="hash-link" aria-label="Direct link to Optimization Handbook" title="Direct link to Optimization Handbook">​</a></h3><p>Jeff: opened IT ticket to move the <a href="https://github.com/input-output-hk/hs-opt-handbook.github.io" target="_blank" rel="noopener noreferrer">Optimization
Handbook</a> to Haskell Foundation&#x27;s repository.
IT stated they need to check with legal, of course.</p><p>Jeff: almost finished the <a href="https://input-output-hk.github.io/hs-opt-handbook.github.io/src/Optimizations/GHC_opt/lambda_lifting.html" target="_blank" rel="noopener noreferrer">lambda
lifting</a>
chapter; major remaining items are adding some glossary terms and describing the
interaction between lambda lifting and calling conventions.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="constant-folding-for-division-operations">Constant folding for division operations<a href="#constant-folding-for-division-operations" class="hash-link" aria-label="Direct link to Constant folding for division operations" title="Direct link to Constant folding for division operations">​</a></h3><p>While looking into his old merge requests still opened, Sylvain nerd-snipped
himself into fixing constant folding rules for division operations (see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22152" target="_blank" rel="noopener noreferrer">#22152</a>).</p><p>MR <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/8956" target="_blank" rel="noopener noreferrer">!8956</a> adds the
following rewrite rules:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   case quotRemInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     (# q, _ #) -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ====&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   case quotInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     q -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   case quotRemInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     (# _, r #) -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ====&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   case remInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     r -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  For all primitive numerical types:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (x `quot` l1) `quot` l2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | l1 /= 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | l2 /= 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | l1*l2 doesn&#x27;t overflow/underflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ====&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x `quot` (l1 * l2)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It also makes some division primops (Word64/Int64 Quot/Rem, WordQuotRem2Op)
ok-for-speculation when the divisor is known to be non-zero, similarly to other
division primops. Otherwise the last rule wasn&#x27;t firing in the added test
because we got the following Core (simplified for the presentation):</p><div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">case quotWord64# x# 10#Word64 of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ds1 -&gt; case quotWord64# ds1 20#Word64 of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ds2 -&gt; ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and not:</p><div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">case quotWord64# (quotWord64# x# 10#Word64) 20#Word64 of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ds2 -&gt; ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ghci">GHCi<a href="#ghci" class="hash-link" aria-label="Direct link to GHCi" title="Direct link to GHCi">​</a></h2><p>Luite: A test run of GHC 9.6 with the <code>-fbyte-code-and-object-code</code> flag
on <a href="https://ghc.gitlab.haskell.org/head.hackage/" target="_blank" rel="noopener noreferrer">head.hackage</a> revealed
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22888" target="_blank" rel="noopener noreferrer">issue #22888</a> with bytecode
size limits. Many bytecode instructions have <code>Word16</code> operands, which
is not always enough to run programs generated from optimized core. The solution
is to enable large operands for all the bytecode instructions that deal with
stack offsets. See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22888" target="_blank" rel="noopener noreferrer">#22888</a>
and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9957" target="_blank" rel="noopener noreferrer">!9957</a>.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ghc">ghc</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/input-output-hk/engineering/tree/master/blog/2023-02-09-ghc-update-2023-02-09.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2023-02-23-ghc-update"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">IOG GHC Update #4</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2023-01-26-ghc-update"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">GHC DevX Update 2023-01-26</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#javascript-backend" class="table-of-contents__link toc-highlight">JavaScript backend</a><ul><li><a href="#template-haskell" class="table-of-contents__link toc-highlight">Template Haskell</a></li><li><a href="#javascript-backend-ci" class="table-of-contents__link toc-highlight">JavaScript backend CI</a></li><li><a href="#filestat" class="table-of-contents__link toc-highlight">FileStat</a></li><li><a href="#javascript-rts-refactor" class="table-of-contents__link toc-highlight">JavaScript RTS refactor</a></li><li><a href="#warnings" class="table-of-contents__link toc-highlight">Warnings</a></li><li><a href="#fix-for-asynchronous-exceptions" class="table-of-contents__link toc-highlight">Fix for asynchronous exceptions</a></li><li><a href="#integer-performance" class="table-of-contents__link toc-highlight">Integer performance</a></li><li><a href="#javascript-edsl" class="table-of-contents__link toc-highlight">JavaScript EDSL</a></li><li><a href="#documentation" class="table-of-contents__link toc-highlight">Documentation</a></li><li><a href="#change-from-js-to-javascript-architecture" class="table-of-contents__link toc-highlight">Change from <code>js</code> to <code>javascript</code> architecture</a></li></ul></li><li><a href="#compiler-performance" class="table-of-contents__link toc-highlight">Compiler performance</a><ul><li><a href="#more-strict-break" class="table-of-contents__link toc-highlight">More-strict <code>break</code></a></li><li><a href="#unboxed-codebuffers" class="table-of-contents__link toc-highlight">Unboxed CodeBuffers</a></li><li><a href="#optimization-handbook" class="table-of-contents__link toc-highlight">Optimization Handbook</a></li><li><a href="#constant-folding-for-division-operations" class="table-of-contents__link toc-highlight">Constant folding for division operations</a></li></ul></li><li><a href="#ghci" class="table-of-contents__link toc-highlight">GHCi</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/iog_eng" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">IOG Blog</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 IOG Engineering, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.840dcf4b.js"></script>
<script src="/assets/js/main.522da32c.js"></script>
</body>
</html>