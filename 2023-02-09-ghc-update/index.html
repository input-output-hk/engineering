<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="IOG Engineering RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="IOG Engineering Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="IOG Engineering JSON Feed"><title data-react-helmet="true">IOG GHC Update #3 (2023-02-09) | IOG Engineering</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://engineering.iog.io/2023-02-09-ghc-update"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="IOG GHC Update #3 (2023-02-09) | IOG Engineering"><meta data-react-helmet="true" name="description" content="Biweekly update from the GHC DevX team at IOG."><meta data-react-helmet="true" property="og:description" content="Biweekly update from the GHC DevX team at IOG."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2023-02-09T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://iog.io/en/,https://iog.io/en/"><meta data-react-helmet="true" property="article:tag" content="ghc,ghc-update"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://engineering.iog.io/2023-02-09-ghc-update"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/2023-02-09-ghc-update" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/2023-02-09-ghc-update" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.10ad4647.css">
<link rel="preload" href="/assets/js/runtime~main.e476eab3.js" as="script">
<link rel="preload" href="/assets/js/main.d44ad81a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Recent</a><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-03-09-ghc-update">IOG GHC Update #5</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-02-23-ghc-update">IOG GHC Update #4</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/2023-02-09-ghc-update">IOG GHC Update #3 (2023-02-09)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-01-26-ghc-update">GHC DevX Update 2023-01-26</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-01-26-hs-bindgen-introduction">One step forward, an easier interoperability between Rust and Haskell</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">IOG GHC Update #3 (2023-02-09)</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-02-09T00:00:00.000Z" itemprop="datePublished">February 9, 2023</time> Â· <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="template-haskell">Template Haskell<a class="hash-link" href="#template-haskell" title="Direct link to heading">â€‹</a></h3><p>Luite: fixed the support for one-shot mode (GHC&#x27;s <code>-c</code> command-line flag)
in the TH JS linker.</p><p>Luite: Investigated a warning about the temporary directory not being removed
after running Template Haskell with the JavaScript backend. It turned out
that GHC&#x27;s <code>GHC.Utils.TmpFs.newTempDir</code>, which is used by the Template Haskell
linker, does not allow the newly created directory to be removed
(see <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22952" target="_blank" rel="noopener noreferrer">#22952</a>).</p><p>Sylvain: cleaned up the <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779" target="_blank" rel="noopener noreferrer">merge request</a>,
removing unnecessary changes and adding documentation.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-ci">JavaScript backend CI<a class="hash-link" href="#javascript-backend-ci" title="Direct link to heading">â€‹</a></h3><p>Jeff: JavaScript backend CI was <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9552" target="_blank" rel="noopener noreferrer">finally
merged</a>! Now that we
have CI we are unblocked on several fronts, such as, implementing <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9825" target="_blank" rel="noopener noreferrer">faster
arithmetic</a> and fixing
some <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9879" target="_blank" rel="noopener noreferrer">async
exceptions</a>. In
general, we can now have confidence that our work is progressing the JavaScript
backend to a better state.</p><p>Sylvain: fixed a spurious failure on JS CI due to some test <em>passing</em> on fast runners
while it was expected to fail (see <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9934" target="_blank" rel="noopener noreferrer">!9934</a>).</p><p>Josh: fixed some inaccurate test predicates <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9939" target="_blank" rel="noopener noreferrer">!9939</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="filestat">FileStat<a class="hash-link" href="#filestat" title="Direct link to heading">â€‹</a></h3><p>Josh: rebased and merged <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9755" target="_blank" rel="noopener noreferrer">!9755</a>.
This patch changes the representation of the JavaScript equivalent of the C <code>struct stat</code>
to make its field offsets match the C ones: some Haskell codes directly access fields of
this structure using <code>hsc2hs</code> to get the field offsets from the C headers.</p><p>This patch also adds fields to the JavaScript file stat that were previously not
included, such as modification and access times.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-rts-refactor">JavaScript RTS refactor<a class="hash-link" href="#javascript-rts-refactor" title="Direct link to heading">â€‹</a></h3><p>Josh: rebased <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9794" target="_blank" rel="noopener noreferrer">!9794</a> which consists
in the refactor of the module generating some part of the RTS. The new JS CI job found a bug in the patch that
caused ~50 tests to time out, so waiting for CI to be set up before merging this MR was judicious.</p><p>This MR also became an opportunity to revisit some arbitrary cache sizes in the RTS code generator.
This is still ongoing work.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="warnings">Warnings<a class="hash-link" href="#warnings" title="Direct link to heading">â€‹</a></h3><p>Luite: We accidently removed the check for the &quot;javascript&quot; calling convention on
foreign imports, allowing this convention to be wrongly used on native platform.
Fixed in <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9880" target="_blank" rel="noopener noreferrer">!9880</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="fix-for-asynchronous-exceptions">Fix for asynchronous exceptions<a class="hash-link" href="#fix-for-asynchronous-exceptions" title="Direct link to heading">â€‹</a></h3><p>Luite: Fixed an issue in the garbage collector for the JavaScript backend:
A thread that posts an asynchronous exception (<code>throwTo</code>) to another thread
is temporarily suspended until the exception has been delivered. The
garbage collector did not correctly follow the list of threads suspended in
this way, potentially considering them unreachable and cleaning up data
referenced by them. See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22836" target="_blank" rel="noopener noreferrer">#22836</a> and
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9879" target="_blank" rel="noopener noreferrer">!9879</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="integer-performance">Integer performance<a class="hash-link" href="#integer-performance" title="Direct link to heading">â€‹</a></h3><p>Evaluating the following expression is very slow in general but especially with
the JS backend:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">1 `shiftL` (1 `shiftL` 20) :: Integer</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We&#x27;ve had to mark a test computing this as broken on CI because it triggers a
timeout error. Luckily the identification of slow operations is easy with
JavaScript profiling tools (see graphs in
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22835" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/issues/22835</a>) and we know that <code>Word32</code>
primops are the culprit in this case.</p><p>Sylvain started replacing the uses of JavaScript&#x27;s <code>BigInt</code> in the
implementation of these primops with usual JavaScript <code>numbers</code>.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9825" target="_blank" rel="noopener noreferrer">!9825</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-edsl">JavaScript EDSL<a class="hash-link" href="#javascript-edsl" title="Direct link to heading">â€‹</a></h3><p>Jeff: JavaScript eDSL based on
<a href="https://github.com/ku-fpg/sunroof-compiler" target="_blank" rel="noopener noreferrer">sunroof</a> close to MR, see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22736" target="_blank" rel="noopener noreferrer">#22736</a> for background.
Compiler is complete. Major items left are: the interpreter to translate to
<code>JStat</code>, filling in documentation, and testing now that CI has been merged.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="documentation">Documentation<a class="hash-link" href="#documentation" title="Direct link to heading">â€‹</a></h3><p>Jeff: Wrote the JavaScript backend release notes. Notes pending
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9828" target="_blank" rel="noopener noreferrer">approval</a>. We cite
the <a href="https://gitlab.haskell.org/ghc/ghc/-/wikis/javascript-backend" target="_blank" rel="noopener noreferrer">JavaScript
backend</a> wiki
page in the release notes. So Jeff and Sylvain heavily edited the wiki pages to
make them suitable for external customers.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="change-from-js-to-javascript-architecture">Change from <code>js</code> to <code>javascript</code> architecture<a class="hash-link" href="#change-from-js-to-javascript-architecture" title="Direct link to heading">â€‹</a></h3><p>In <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22740" target="_blank" rel="noopener noreferrer">#22740</a> it was noticed that
<code>hackage-server</code> would prevent the upload of the upcoming <code>base</code> package bundled with GHC 9.6.
The reason is that <code>hackage-server</code> relies on the <code>cabal --check</code> feature which filters
out perfectly valid packages (it happened before, for example with <a href="https://gitlab.haskell.org/haskell/ghc-api-compat/-/issues/1" target="_blank" rel="noopener noreferrer">ghc-api-compat</a>).</p><p>In our case, the package was rejected because the <code>js</code> architecture wasn&#x27;t recognized
as a built-in one, but luckily we could fall back to the existing <code>javascript</code> built-in
architecture defined for GHCJS (if it wasn&#x27;t a JS backend, we would have had to fix Cabal,
update <code>hackage-server</code> dependencies, and redeploy <code>hackage-server</code>...).</p><p>Sylvain completed Ben&#x27;s MR in <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9814" target="_blank" rel="noopener noreferrer">!9814</a>.</p><p>For early users of the JS backend the change means that from now on:</p><ul><li><code>configure</code> command is: <code>emconfigure ./configure --target=javascript-unknown-ghcjs</code></li><li>Cabal condition is: <code>arch(javascript)</code></li><li>CPP condition is: <code>#if defined(javascript_HOST_ARCH)</code></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="compiler-performance">Compiler performance<a class="hash-link" href="#compiler-performance" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="more-strict-break">More-strict <code>break</code><a class="hash-link" href="#more-strict-break" title="Direct link to heading">â€‹</a></h3><p>Josh: opened merge request <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9868" target="_blank" rel="noopener noreferrer">!9868</a> to add a stricter <code>break&#x27;</code> version to <code>base</code> - however, this would require a CLC proposal.</p><p>Further analysis was done using ticky profiles on a simple test program that benchmarks GHC&#x27;s startup code.
This has found an example where a more-strict break is an improvement in GHC, which will provide motivation
for the CLC proposal.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="unboxed-codebuffers">Unboxed CodeBuffers<a class="hash-link" href="#unboxed-codebuffers" title="Direct link to heading">â€‹</a></h3><p>Josh: implemented changes to GHC&#x27;s text encoding buffers to use unboxed tuples on handle encoders/decoders.
The buffers pass around and repeatedly pack/unpack a tuple in an <code>IO</code> inner loop, which causes a significant
number of unnecessary allocations. By replacing this with an unboxed tuple, and replacing the <code>IO</code> with
manually passing around a <code>State# RealWorld</code> in the same tuple, we&#x27;re able to reduce allocations by nearly 50%
in a pathological example (non-allocating loop printing characters). See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22946" target="_blank" rel="noopener noreferrer">#22946</a> and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9948" target="_blank" rel="noopener noreferrer">!9948</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="optimization-handbook">Optimization Handbook<a class="hash-link" href="#optimization-handbook" title="Direct link to heading">â€‹</a></h3><p>Jeff: opened IT ticket to move the <a href="https://github.com/input-output-hk/hs-opt-handbook.github.io" target="_blank" rel="noopener noreferrer">Optimization
Handbook</a> to Haskell Foundation&#x27;s repository.
IT stated they need to check with legal, of course.</p><p>Jeff: almost finished the <a href="https://input-output-hk.github.io/hs-opt-handbook.github.io/src/Optimizations/GHC_opt/lambda_lifting.html" target="_blank" rel="noopener noreferrer">lambda
lifting</a>
chapter; major remaining items are adding some glossary terms and describing the
interaction between lambda lifting and calling conventions.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="constant-folding-for-division-operations">Constant folding for division operations<a class="hash-link" href="#constant-folding-for-division-operations" title="Direct link to heading">â€‹</a></h3><p>While looking into his old merge requests still opened, Sylvain nerd-snipped
himself into fixing constant folding rules for division operations (see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22152" target="_blank" rel="noopener noreferrer">#22152</a>).</p><p>MR <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/8956" target="_blank" rel="noopener noreferrer">!8956</a> adds the
following rewrite rules:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">   case quotRemInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     (# q, _ #) -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ====&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   case quotInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     q -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   case quotRemInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     (# _, r #) -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ====&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   case remInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     r -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  For all primitive numerical types:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (x `quot` l1) `quot` l2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | l1 /= 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | l2 /= 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | l1*l2 doesn&#x27;t overflow/underflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ====&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x `quot` (l1 * l2)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>It also makes some division primops (Word64/Int64 Quot/Rem, WordQuotRem2Op)
ok-for-speculation when the divisor is known to be non-zero, similarly to other
division primops. Otherwise the last rule wasn&#x27;t firing in the added test
because we got the following Core (simplified for the presentation):</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">case quotWord64# x# 10#Word64 of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ds1 -&gt; case quotWord64# ds1 20#Word64 of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ds2 -&gt; ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>and not:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">case quotWord64# (quotWord64# x# 10#Word64) 20#Word64 of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ds2 -&gt; ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghci">GHCi<a class="hash-link" href="#ghci" title="Direct link to heading">â€‹</a></h2><p>Luite: A test run of GHC 9.6 with the <code>-fbyte-code-and-object-code</code> flag
on <a href="https://ghc.gitlab.haskell.org/head.hackage/" target="_blank" rel="noopener noreferrer">head.hackage</a> revealed
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22888" target="_blank" rel="noopener noreferrer">issue #22888</a> with bytecode
size limits. Many bytecode instructions have <code>Word16</code> operands, which
is not always enough to run programs generated from optimized core. The solution
is to enable large operands for all the bytecode instructions that deal with
stack offsets. See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22888" target="_blank" rel="noopener noreferrer">#22888</a>
and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9957" target="_blank" rel="noopener noreferrer">!9957</a>.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2023-02-23-ghc-update"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">IOG GHC Update #4</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2023-01-26-ghc-update"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">GHC DevX Update 2023-01-26</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#javascript-backend" class="table-of-contents__link toc-highlight">JavaScript backend</a><ul><li><a href="#template-haskell" class="table-of-contents__link toc-highlight">Template Haskell</a></li><li><a href="#javascript-backend-ci" class="table-of-contents__link toc-highlight">JavaScript backend CI</a></li><li><a href="#filestat" class="table-of-contents__link toc-highlight">FileStat</a></li><li><a href="#javascript-rts-refactor" class="table-of-contents__link toc-highlight">JavaScript RTS refactor</a></li><li><a href="#warnings" class="table-of-contents__link toc-highlight">Warnings</a></li><li><a href="#fix-for-asynchronous-exceptions" class="table-of-contents__link toc-highlight">Fix for asynchronous exceptions</a></li><li><a href="#integer-performance" class="table-of-contents__link toc-highlight">Integer performance</a></li><li><a href="#javascript-edsl" class="table-of-contents__link toc-highlight">JavaScript EDSL</a></li><li><a href="#documentation" class="table-of-contents__link toc-highlight">Documentation</a></li><li><a href="#change-from-js-to-javascript-architecture" class="table-of-contents__link toc-highlight">Change from <code>js</code> to <code>javascript</code> architecture</a></li></ul></li><li><a href="#compiler-performance" class="table-of-contents__link toc-highlight">Compiler performance</a><ul><li><a href="#more-strict-break" class="table-of-contents__link toc-highlight">More-strict <code>break</code></a></li><li><a href="#unboxed-codebuffers" class="table-of-contents__link toc-highlight">Unboxed CodeBuffers</a></li><li><a href="#optimization-handbook" class="table-of-contents__link toc-highlight">Optimization Handbook</a></li><li><a href="#constant-folding-for-division-operations" class="table-of-contents__link toc-highlight">Constant folding for division operations</a></li></ul></li><li><a href="#ghci" class="table-of-contents__link toc-highlight">GHCi</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/iog_eng" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">IOG Blog</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 IOG Engineering, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e476eab3.js"></script>
<script src="/assets/js/main.d44ad81a.js"></script>
</body>
</html>