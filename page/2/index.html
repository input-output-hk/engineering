<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="IOG Engineering RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="IOG Engineering Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="IOG Engineering JSON Feed"><title data-react-helmet="true">Blog | IOG Engineering</title><meta data-react-helmet="true" property="og:title" content="Blog | IOG Engineering"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://engineering.iog.io/page/2"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://engineering.iog.io/page/2"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/page/2" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/page/2" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.10ad4647.css">
<link rel="preload" href="/assets/js/runtime~main.e024b0cf.js" as="script">
<link rel="preload" href="/assets/js/main.45687a98.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Recent</a><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-02-09-ghc-update">IOG GHC Update #3 (2023-02-09)</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-01-26-ghc-update">GHC DevX Update 2023-01-26</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-01-26-hs-bindgen-introduction">One step forward, an easier interoperability between Rust and Haskell</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-01-24-javascript-browser-tutorial">Using GHC&#x27;s JavaScript Backend in the Browser</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-01-12-ghc-update">GHC DevX Update 2023-01-12</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-01-26-ghc-update">GHC DevX Update 2023-01-26</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-26T00:00:00.000Z" itemprop="datePublished">January 26, 2023</time> Â· <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This is the second biweekly update of the IOG GHC DevX team.
You can find the previous one <a href="https://engineering.iog.io/2023-01-12-ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="template-haskell">Template Haskell<a class="hash-link" href="#template-haskell" title="Direct link to heading">â€‹</a></h3><p>Sylvain continued his work on the implementation of Template Haskell for the JS
backend. He factorized the code from <code>iserv</code> and <code>libiserv</code> into the <code>ghci</code>
library. This makes it easy for GHC to load and run the external interpreter
server (<code>iserv</code>) that ends up compiled into JavaScript in a NodeJS instance. He
modified GHC to avoid creating ByteCode objects (which are unsupported by the JS
backend) and to instead compile and link JavaScript code.</p><p>Template Haskell basically works with the JavaScript backend now, except for a few
corner cases (such as one-shot mode), but these should be fixed in the coming
days/weeks.</p><p>Luite modified Sylvain&#x27;s JavaScript code to fix support for Darwin and Windows. If you
want to test it, a draft merge request has been opened:
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-in-the-browser-tutorial">JavaScript backend in the browser tutorial<a class="hash-link" href="#javascript-backend-in-the-browser-tutorial" title="Direct link to heading">â€‹</a></h3><p>Josh published a tutorial about using code produced by the JavaScript backend in a web
page:
<a href="https://engineering.iog.io/2023-01-24-javascript-browser-tutorial" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2023-01-24-javascript-browser-tutorial</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="cabal-support-for-js-sources">Cabal support for js-sources<a class="hash-link" href="#cabal-support-for-js-sources" title="Direct link to heading">â€‹</a></h3><p>Sylvain added tests to his patch that adds cabal support for the <code>js-sources</code>
stanza when GHC is used as a compiler (and not only when GHCJS is used as a
compiler), allowing the patch to be merged:
<a href="https://github.com/haskell/cabal/pull/8636" target="_blank" rel="noopener noreferrer">https://github.com/haskell/cabal/pull/8636</a></p><p><a href="https://github.com/haskell/cabal/issues/8639" target="_blank" rel="noopener noreferrer">https://github.com/haskell/cabal/issues/8639</a> is still open though so be careful
if you try to use <code>js-sources</code>, they still don&#x27;t work in some cases.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-ci">JavaScript backend CI<a class="hash-link" href="#javascript-backend-ci" title="Direct link to heading">â€‹</a></h3><p>The <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9552" target="_blank" rel="noopener noreferrer">JavaScript backend
CI</a> has been an
ongoing saga for the last month, and has been a blocking item for JavaScript
Backend development. Thankfully it is close to being merged. This week, Jeff
rebased the CI to discover that recent
<a href="https://gitlab.haskell.org/ghc/ghc/-/commit/d31fcbca6cf4bc166904cfd25696503401ad631d" target="_blank" rel="noopener noreferrer">changes</a>
removed <code>nodejs</code> (the <code>node</code> that is bundled with emscripten) from the CI
containers <code>$PATH</code>. So Jeff patched the CI images to add <code>node</code>. Now the CI runs
and has discovered two new bugs even before being merged. All that is left is to
bump some submodules and the CI will be ready to land in GHC HEAD.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="filestat">FileStat<a class="hash-link" href="#filestat" title="Direct link to heading">â€‹</a></h3><p>Josh opened an MR to match the layout of the JavaScript <code>fileStat</code> with the
layout of the equivalent struct defined in Emscripten&#x27;s <code>stat.h</code>. This is needed
to ensure that hsc2hs features work correctly with this data type. Hsc2hs features
can peek at memory locations directly without using accessor functions, and the
memory locations are taken from the header file, hence the requirement to match
these layouts.</p><p>This MR only touches JavaScript files, so we&#x27;re waiting on the approval of the
JS CI before continuing. For more information, see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22573" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/issues/22573</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-rts-refactor">JavaScript RTS refactor<a class="hash-link" href="#javascript-rts-refactor" title="Direct link to heading">â€‹</a></h3><p>Josh refactored parts of the GHC.StgtoJS.Rts.Rts module to remove special cases
from one of the n-argument JavaScript RTS functions, and combined these cases
into a general case. Thus, simplifying the Rts module&#x27;s code.</p><p>Josh also improved the caching in the JavaScript Backend for commonly used names
in the generated JavaScript ASTs. Previously, names such as <code>x1</code> would require
allocation <em>for each</em> use: first by allocating a <code>String</code>, which was then
converted to a GHC <code>FastString</code>, which was finally wrapped in a JavaScript AST
data constructor. Now, these names are captured in a static CAF&#x27;d <code>Array</code> and
each reference was replaced with a lookup to the corresponding slot in the
array. This avoids the extra allocations and ensures these names are shared.</p><p>For the full set of refactors, see:
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22822" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/issues/22822</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-edsl">JavaScript EDSL<a class="hash-link" href="#javascript-edsl" title="Direct link to heading">â€‹</a></h3><p>Jeff began work on a new eDSL to replace the existing DSL the JavaScript Backend
inherited from GHCJS. This solves a <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22736" target="_blank" rel="noopener noreferrer">design
problem</a>. The existing DSL in
the JavaScript Backend is used for two things: (1) to write the JavaScript
Backend&#x27;s garbage collector, runtime system and other low level bits; (2) as a
target for optimizations; (3) as the source for code generation. This becomes
problematic because the existing DSL tries to do so much that it ends up not
being particularly good at (1), (2) and (3).</p><p>The fix is to separate concerns by writing a new DSL for (1). The DSL is Type
Safe and based on the <a href="https://github.com/ku-fpg/sunroof-compiler" target="_blank" rel="noopener noreferrer">Sunroof
compiler</a> (Thanks Andy Gill et al.
for your labor!). Then, we&#x27;ll compile the new DSL to the existing GHCJS DSL.
This way we can slowly begin to replace JavaScript Backend code module by
module, thus gaining type safety while still continuing other work. The end game
of this project is to eventually remove the GHCJS DSL entirely and then compile
our new DSL to a better intermediate representation that is explicitly crafted
to make optimizations easier.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="blog-posts">Blog posts<a class="hash-link" href="#blog-posts" title="Direct link to heading">â€‹</a></h3><p>Luite has been working on new blog posts about internals of the GHC JavaScript
backend and a strategy guide for debugging the generated JavaScript code. These
will be published in the coming weeks.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-configuration-issue-in-a-docker-image">JavaScript backend configuration issue in a Docker image<a class="hash-link" href="#javascript-backend-configuration-issue-in-a-docker-image" title="Direct link to heading">â€‹</a></h3><p>Sylvain debugged a configuration issue of GHC with the JavaScript backend (see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22814" target="_blank" rel="noopener noreferrer">#22814</a>).
The recommended way to configure is to use the following command line:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">emconfigure ./configure --target=js-unknown-ghcjs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>where <code>emconfigure</code> is provided by the Emscripten project and sets appropriate
environment variables (CC, LD, AR...).</p><p>However in some cases it seems like these variables are set as follows:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">CC=emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LD=emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>in which case GHC&#x27;s <code>configure</code> script will silently ignores them... and uses
the C compiler for the host platform instead (x86-64, aarch64...). As the C
compiler is only used for the CPP pass, it results in some inscrutable errors.
In <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22814" target="_blank" rel="noopener noreferrer">#22814</a> the error is due
to <code>CSize</code> being inferred as a 64-bit type while it should be 32-bit for the
JavaScript platform, leading to CSize values being passed as 2 arguments in FFI
calls while the callee expects 1.</p><p>Calling <code>configure</code> with the right environment variables fixes the issue:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./configure CC=$(which emcc) LD=$(which emcc) --target=js-unknown-ghcjs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="discussion-about-javascript-backend-maturity">Discussion about JavaScript backend maturity<a class="hash-link" href="#discussion-about-javascript-backend-maturity" title="Direct link to heading">â€‹</a></h3><p>Quite some time was spent discussing users&#x27; expectations about the JavaScript and WASM backends.
We would like to make it very clear that even if GHCJS has been here for a long time,
the JavaScript backend doesn&#x27;t yet have the same level of maturity.</p><p>Bugs, missing features, and sub-par performance are to be expected in the 9.6 release.
We encourage adventurous users to try out this release and send us feedback, but it&#x27;s
best to exercise caution before relying on it for production.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="compiler-performance">Compiler performance<a class="hash-link" href="#compiler-performance" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="more-strict-break">More-strict <code>break</code><a class="hash-link" href="#more-strict-break" title="Direct link to heading">â€‹</a></h3><p>Josh did more investigation into the performance difference that introducing
some strictness into the <code>break</code> function would make. The STG and microbenchmarks
are very promising, but using the &quot;compile cabal&quot; benchmark, there doesn&#x27;t seem
to be a noticable time difference caused by the change. In terms of memory, it
seems to reduce GC copying, but slightly increase overall allocations and total
memory usage.</p><p>There&#x27;s pathological cases in using a strict break by default - for example in the
<code>lines</code> function. Because of this, it&#x27;s likely that this optimization would have
the most benefit if applied in isolated cases in GHC, if any pathological lazy
cases are found.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="misc">Misc<a class="hash-link" href="#misc" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="cross-compilation-from-linuxdarwin-to-windows">Cross-compilation from Linux/Darwin to Windows<a class="hash-link" href="#cross-compilation-from-linuxdarwin-to-windows" title="Direct link to heading">â€‹</a></h3><p>Ticket <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22805" target="_blank" rel="noopener noreferrer">#22805</a> reminded Sylvain that he had made <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9310" target="_blank" rel="noopener noreferrer">MR !9310</a> more than two months ago to fix the same issue: cross-compilation from Linux/Darwin to Windows. The MR has now been updated, tested, reviewed, and merged.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="hadrian-rules-to-build-the-sphinx-based-docs">Hadrian rules to build the Sphinx-based docs<a class="hash-link" href="#hadrian-rules-to-build-the-sphinx-based-docs" title="Direct link to heading">â€‹</a></h3><p>Sylvain started working on adding a chapter about the JavaScript in GHC&#x27;s Users Guide.
The first step was to fix Hadrian&#x27;s build rules for the Users Guide (<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9795" target="_blank" rel="noopener noreferrer">MR !9795</a>)</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/"><div class="pagination-nav__label">Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/3"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/iog_eng" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">IOG Blog</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 IOG Engineering, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e024b0cf.js"></script>
<script src="/assets/js/main.45687a98.js"></script>
</body>
</html>