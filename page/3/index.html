<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<title data-react-helmet="true">Blog | IOG Engineering</title><meta data-react-helmet="true" property="og:title" content="Blog | IOG Engineering"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://engineering.iog.io/page/3"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://engineering.iog.io/page/3"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/page/3" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/page/3" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.10ad4647.css">
<link rel="preload" href="/assets/js/runtime~main.aea9cbda.js" as="script">
<link rel="preload" href="/assets/js/main.ab76ff8a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/iohk-logo.png" alt="IOG" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/iohk-logo-inverted.png" alt="IOG" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Recent</a><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">üåú</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">üåû</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-12-19-ghc-update">IOG GHC Update #39</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-11-28-ghc-update">IOG GHC Update #38</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-11-07-ghc-update">IOG GHC Update #37</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-10-17-ghc-update">IOG GHC Update #36</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-09-26-ghc-update">IOG GHC Update #35</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-09-05-ghc-update">IOG GHC Update #34</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-08-15-ghc-update">IOG GHC Update #33</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-07-24-ghc-update">IOG GHC Update #32</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-07-08-ghc-update">IOG GHC Update #31</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-06-17-ghc-update">IOG GHC Update #30</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-05-23-ghc-update">IOG GHC Update #29</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-05-02-ghc-update">IOG GHC Update #28</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-04-11-ghc-update">IOG GHC Update #27</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-03-21-ghc-update">IOG GHC Update #26</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-02-29-ghc-update">IOG GHC Update #25</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-02-08-ghc-update">IOG GHC Update #24</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-01-18-ghc-update">IOG GHC Update #23</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2024-01-04-ghc-update">IOG GHC Update #22</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-12-07-ghc-update">IOG GHC Update #21</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-11-16-ghc-update">IOG GHC Update #20</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-02-09-ghc-update">IOG GHC Update #3 (2023-02-09)</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-02-09T00:00:00.000Z" itemprop="datePublished">February 9, 2023</time> ¬∑ <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #3 (2023-02-09)" href="/2023-02-09-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-01-26-ghc-update">GHC DevX Update 2023-01-26</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-26T00:00:00.000Z" itemprop="datePublished">January 26, 2023</time> ¬∑ <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This is the second biweekly update of the IOG GHC DevX team.
You can find the previous one <a href="https://engineering.iog.io/2023-01-12-ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHC DevX Update 2023-01-26" href="/2023-01-26-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-01-26-hs-bindgen-introduction">One step forward, an easier interoperability between Rust and Haskell</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-26T00:00:00.000Z" itemprop="datePublished">January 26, 2023</time> ¬∑ <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Yvan Sraka</span></a></div><small class="avatar__subtitle" itemprop="description">Rust DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><strong>TL;DR:</strong> This blog post intends to sum up the why and how of <a href="https://github.com/yvan-sraka/cargo-cabal" target="_blank" rel="noopener noreferrer"><code>cargo-cabal</code></a> and <a href="https://github.com/yvan-sraka/hs-bindgen" target="_blank" rel="noopener noreferrer"><code>hs-bindgen</code></a>. If you‚Äôre looking for usage walkthroughs and code examples, check out project READMEs on GitHub!</p><blockquote><p><strong>N.B.</strong> quoted paragraphs in this article give straightforward motivation regarding some systems programming basic concepts. Feel free to skip them if you know you‚Äôre likely to be already comfortable with them ;)</p></blockquote></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cabal">cabal</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/rust">rust</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/bindgen">bindgen</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about One step forward, an easier interoperability between Rust and Haskell" href="/2023-01-26-hs-bindgen-introduction"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-01-24-javascript-browser-tutorial">Using GHC&#x27;s JavaScript Backend in the Browser</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-24T00:00:00.000Z" itemprop="datePublished">January 24, 2023</time> ¬∑ <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In a previous
<a href="https://engineering.iog.io/2022-12-13-ghc-js-backend-merged" target="_blank" rel="noopener noreferrer">post</a> we
introduced GHC&#x27;s new JavaScript backend, which allows the compilation of Haskell
code into JavaScript. This is the first tutorial in a new series about the
JavaScript backend. In this post, we&#x27;ll build GHC as
a JavaScript cross-compiler and run a trivial Haskell program in the browser.</p><p>We plan to write more of those blog post in the coming weeks and
months as we add new features (e.g. support for &quot;foreign exports&quot; that will
allow JavaScript code to call into Haskell code, support for Template Haskell,
etc.). For now it relies on our &quot;insider&quot; knowledge (e.g. how the FFI works)
that isn&#x27;t well documented elsewhere. We do plan to add a chapter about the
JavaScript backend in GHC&#x27;s user guide, but for now your best chance is to look
at GHCJS&#x27;s documentation or at the source code.</p><p>Please note: this is a technology preview of the in-development JavaScript backend
for GHC. Not all Haskell features are implemented, and bugs are expected. It is
currently rather complicated for JavaScript code to call into Haskell code (&quot;foreign
exports&quot; aren&#x27;t implemented). GHC isn&#x27;t a multi-target compiler yet, so a GHC executable
built for a native platform (Linux/x86-64, Windows/x86-64, Darwin/AArch64...) as currently distributed (via ghcup, Stack, binary distributions, etc.) won&#x27;t be able to produce JavaScript. Official prebuilt binary distributions are likely to remain
unavailable until GHC gains multi-target support - requiring the JavaScript backend
to be built from source even after the backend matures.
That&#x27;s why we start this post with the required steps to build yourself
a GHC compiler capable of producing JavaScript.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cross-compilation">cross-compilation</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Using GHC&#x27;s JavaScript Backend in the Browser" href="/2023-01-24-javascript-browser-tutorial"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-01-12-ghc-update">GHC DevX Update 2023-01-12</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-12T00:00:00.000Z" itemprop="datePublished">January 12, 2023</time> ¬∑ <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Starting in 2023 we‚Äìthe IOG GHC DevX team‚Äìare going to provide biweekly updates
about our work. This is the first edition.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHC DevX Update 2023-01-12" href="/2023-01-12-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-12-13-ghc-js-backend-merged">JavaScript backend merged into GHC</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-12-13T00:00:00.000Z" itemprop="datePublished">December 13, 2022</time> ¬∑ <!-- -->20 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Moritz Angermann</span></a></div><small class="avatar__subtitle" itemprop="description">Head of DevX @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>A new JavaScript backend was
<a href="https://gitlab.haskell.org/ghc/ghc/-/commit/cc25d52e0f65d54c052908c7d91d5946342ab88a" target="_blank" rel="noopener noreferrer">merged</a>
into GHC on November 30th, 2022! This means that the next release of GHC will be
able to emit code that runs in web browsers without requiring any extra tools,
enabling Haskell for both front-end and back-end web applications.</p><p>In this post, we, the GHC DevX team at <a href="https://iohk.io/" target="_blank" rel="noopener noreferrer">IOG</a>, describe the
challenges we faced bringing GHCJS to GHC, how we overcame those challenges, and
what&#x27;s left to do. This post is rather long so we&#x27;ve provided these links in
case you would like to skip ahead:</p><p><a href="#ghcjs">Take me to the future of GHCJS</a><br>
<a href="#expectations">Tell me what to expect</a><br>
<a href="#roadmap">Show me the product roadmap</a><br>
<a href="#contributing">Tell me how I can help</a><br>
<a href="#build">Just show me how to hello world! (Skip to build instructions)</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="why-javascript-or-the-big-picture">Why JavaScript? Or, the Big Picture.<a class="hash-link" href="#why-javascript-or-the-big-picture" title="Direct link to heading">‚Äã</a></h2><p>To put it simply, the number of users on the internet is as low as it will ever
be <em>right now</em>, and it is almost guaranteed that those users use JavaScript. At
time of writing, JavaScript holds 97.3% of client-side programming <a href="https://w3techs.com/technologies/details/cp-javascript" target="_blank" rel="noopener noreferrer">market
share</a> (not to mention
market share of front-end technologies). Furthermore, JavaScript is not going to
disappear anytime soon. As more and more interactivity is pushed onto the
internet, JavaScript will become more entrenched because of backwards
compatibility, network effects and the amount of capital already devoted to it.
JavaScript, like C and
<a href="https://cacm.acm.org/news/244370-cobol-programmers-are-back-in-demand-seriously/fulltext?mobile=false" target="_blank" rel="noopener noreferrer">COBOL</a>
will be with us for the foreseeable future. This makes JavaScript an attractive
target; it provides portability, allows us to capitalize on the massive
investments in the language and platform, and essentially eliminates the risk
that the we build our technology atop a disappearing or deprecating foundation.</p><p>WebAssembly is a promising target as well, and <a href="https://www.tweag.io/" target="_blank" rel="noopener noreferrer">Tweag</a>
has just merged a <a href="https://www.tweag.io/blog/2022-11-22-wasm-backend-merged-in-ghc/" target="_blank" rel="noopener noreferrer">WebAssembly
backend</a> into
GHC (great work and congrats!). WebAssembly is not as ubiquitous as
JavaScript yet, and has a harder time interacting with JavaScript directly.
Hence, we believe that the WebAssembly and JavaScript backends provide different
strengths, and it is to the Haskell community&#x27;s benefit to have and support
both code generation paths in GHC for different use cases and requirements.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cross-compilation">cross-compilation</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about JavaScript backend merged into GHC" href="/2022-12-13-ghc-js-backend-merged"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-09-28-introduce-q-d">Model-Based Testing with QuickCheck</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-10-04T00:00:00.000Z" itemprop="datePublished">October 4, 2022</time> ¬∑ <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Arnaud Bailly</span></a></div><small class="avatar__subtitle" itemprop="description">Technical Architect @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/input-output-hk/quickcheck-dynamic" target="_blank" rel="noopener noreferrer">quickcheck-dynamic</a> is a library jointly developed by Quviq and IOG, whose purpose is to leverage <a href="https://hackage.haskell.org/package/QuickCheck" target="_blank" rel="noopener noreferrer">QuickCheck</a> to test stateful programs against a <em>Model</em>. In other words, it&#x27;s a <a href="https://en.wikipedia.org/wiki/Model-based_testing" target="_blank" rel="noopener noreferrer"><em>Model-Based Testing</em></a> tool. This article wants to be a gentle introduction to the use of quickcheck-dynamic for Model-Based Testing. It describes the overall approach, how the library works, and how it&#x27;s being applied within IOG to improve the reach of our testing efforts.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/testing-quickcheck">testing quickcheck</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Model-Based Testing with QuickCheck" href="/2022-09-28-introduce-q-d"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-09-23-ghcjs-heap-representation">GHCJS heap representation</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-09-23T00:00:00.000Z" itemprop="datePublished">September 23, 2022</time> ¬∑ <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">‚Äã</a></h2><p>I recently gave a short presentation about heap objects representation in GHCJS and hence in the upcoming JS backend for GHC. This post is a summary of the content.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="heap-objects">Heap objects<a class="hash-link" href="#heap-objects" title="Direct link to heading">‚Äã</a></h2><p>GHC implements Haskell code evaluation by using graph reduction. As such Haskell
programs compiled by GHC use the heap to store nodes of the graph to be
reduced and utility nodes participating in graph reduction. These nodes are:</p><ul><li>FUN: functions with their free variables as payload</li><li>THUNK: suspensions with their free variables as payload</li><li>PAP: partial application to a FUN. FUN closure and already applied arguments
as payload.</li><li>IND: indirection to another heap object</li><li>BLACKHOLE: used to overwrite a THUNK when it is being evaluated</li></ul><p>The heap is also used to store other values:</p><ul><li>CON: boxed values (saturated constructor applications) with field values as payload</li><li>Other unlifted values: TSO, BCO, arrays, MutVar#, MVar#, TVar#, stacks, stack frames...</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHCJS heap representation" href="/2022-09-23-ghcjs-heap-representation"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-08-18-js-backend-ffi">GHCJS FFI system in the JS Backend</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-08-18T00:00:00.000Z" itemprop="datePublished">August 18, 2022</time> ¬∑ <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ol><li><a href="#orgcf7b9df">The Design Space</a></li><li><a href="#orgdca8008">GHCJS<!-- -->‚Äô<!-- -->s FFI</a></li><li><a href="#org461ca2a">Lightweight safety checks</a></li><li><a href="#orge4568be">Returning multiple values</a></li><li><a href="#org87ce79c">Changes in the FFI System for the JS Backend</a></li></ol><p>Users of GHCJS enjoyed a rich
<a href="https://github.com/ghcjs/ghcjs/blob/master/doc/foreign-function-interface.md" target="_blank" rel="noopener noreferrer">FFI</a>
system for foreign JavaScript imports. However, this has changed during our
adaptation of GHCJS to GHC 9.x. This short post goes over the GHCJS FFI system,
the motivation for these changes and what the changes are. First, we must
consider the design space of an FFI system.</p><a id="orgcf7b9df"></a><h1>The Design Space</h1><p>FFI code is typically employed in high performance scenarios. Additionally,
users of the FFI <em>do not</em> want to deal with the object language the compiler is
compiling to. Instead, users want a simple way to call functions from the object
language and use them in their own code as normal Haskell functions. However,
users of the FFI system <em>do</em> tend to be power users, and so as a design principle
we want to expose the tools they need to achieve their performance needs,
whatever those needs may be. We can summarize these constraints as follows:</p><ol><li>The FFI must abstract the JavaScript backend<!-- -->‚Äô<!-- -->s infidelities away as much as
possible. That is, users of the FFI <em>should</em> need to worry about the <code>Int64#</code>
representation, but should also be able to simply follow standard patterns we
have written in <code>base</code>.</li><li>The FFI must provide tools to achieve high performance code, even if those
tools require up front knowledge of the runtime system to use. However, these
tools should not be in the path of least resistance to use the FFI system.</li><li>The FFI must provide a lightweight specification that user<!-- -->‚Äô<!-- -->s program against
for the JS backend to optimize the imported function and for good error
messages for users.</li></ol><p>GHCJS<!-- -->‚Äô<!-- -->s FFI sets a high (qualitative) benchmark on these three constraints.
Let<!-- -->‚Äô<!-- -->s inspect them each in detail, in no particular order.</p><a id="orgdca8008"></a><h1>GHCJS<!-- -->‚Äô<!-- -->s FFI</h1><p>In GHCJS, a user could take advantage of JavaScript functions in their Haskell
code using the GHCJS<!-- -->‚Äô<!-- -->s FFI. However, the syntax was unique to GHCJS with place
holder variables like one might see in perl, nix, or bash. For example, here is
a foreign import from the <code>base</code> library for <code>st_size</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- base/System/Posix/Internal.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- the JS FFI version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foreign import javascript unsafe &quot;$r1 = h$base_st_size($1_1,$1_2); $r2 = h$ret1;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   st_size :: Ptr CStat -&gt; IO Int64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The syntax is different from what we know and love in the normal Haskell world
but the grammar is straightforward. We declare a <code>foreign import</code> from <code>javascript</code>,
state that the import is <code>unsafe</code> or <code>interruptible</code> and then provide a string,
<code>h$base_fstat(...)</code> for the code generator to use when compiling. Compare this
with the C version:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- base/System/Posix/Internal.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- the C FFI version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foreign import ccall unsafe &quot;HsBase.h __hscore_st_size&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   st_size :: Ptr CStat -&gt; IO Int64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And we see that they are similar. The only difference is the strange <code>$n</code>
symbols in the referrent string. Contrast this with the C version, which simply
declares a name.</p><p>These symbols are <em>place holder</em> variables with special meaning in GHCJS. There
are two intractable reasons for the placeholder patterns. First, we require
these patterns to work around the limitations of JavaScript as a backend (1).
For example, consider the case where we need to return an <code>Int64#</code> from an
imported foreign function. In C and Haskell this is not a problem because both
can represent <code>Int64#</code> natively, however JavaScript only has native support for
32-bit values. Thus, to be able to return an <code>Int64#</code> we need to have a method to
return two 32-bit numbers. Similarly, in order to apply a function to an <code>Int64#</code>
that function must take at least two arguments, one for the high bits and one
for the low. Second, the referrent string is untyped and can contain arbritrary
JavaScript code. So placeholder patterns provide a simply and lightweight way
for safety checks and eliminate classes of untyped, hard to understand errors.
For example, consider an arity mismatch error between a function definition and
call site. When this happens JavaScript happily continues processing with the
return value from the function application defined as <code>NaN</code> (of course). Such
arity conflicts can easily occur, especially when dealing with 64-bit values
which require function arity assumptions.</p><a id="org461ca2a"></a><h1>Lightweight safety checks</h1><p>Lightweight safety checks (3) are done by GHCJS by parsing the names of the
place holder variables; each of which follows a specific naming convention. This
convention is:</p><ul><li>Argument types:<ul><li><code>$n</code>: Used for unary arguments, i.e., arguments which require only a single register.</li><li><code>$n_n</code>: Used for binary arguments, i.e., arguments which require two registers.</li><li><code>$c</code>: A continuation argument, only valid for <code>interruptible</code> foreign functions.</li></ul></li><li>Return types:<ul><li><code>$r</code>: a unary return</li><li><code>$r1</code>, <code>$r2</code>: a binary return</li><li><code>$r1</code>, <code>$r2</code>, <code>$r3_1</code>, <code>$r3_2</code>: unboxed tuple return</li></ul></li><li>Top level patterns:<ul><li><code>&quot;&amp;value&quot;</code>: simply emitted as <code>value</code> by the code generator</li><li><code>&quot;someFunction&quot;</code>: emitted as <code>ret = someFunction(...)</code>, i.e., map the FFI to
the result of the function call.</li><li><code>&quot;$r = $1.f($2)&quot;</code>: emitted as <code>r1 = a1.f(a2)</code>, i.e., a combination of a
function call and a property access.</li></ul></li></ul><p>With this standard GHCJS then parses the FFI referrent string to ensure that it
conforms to this standard. If not then GHCJS can at least respond to the user
with an ill-formatted FFI message <em>and</em> say precisely where the issue is. For
example, it could respond that only half of an <code>Int64#</code> is returned based on the
referrent string and the function type.</p><a id="orge4568be"></a><h1>Returning multiple values</h1><p>But what of performant code? GHCJS achieves performant FFI by not trying to
abstract away from the runtime system. Instead, an advantage of GHCJS<!-- -->‚Äô<!-- -->s FFI <em>is</em>
that we can specify exactly which registers the foreign function should dump its
results or even arbitrary global variables. This places more burden on the user
of the FFI in specific scenarios, but crucially allows the FFI system to get out
of the way of the user. The FFI system also exploits this capability to return
multiple values from a single function call, which is a common need when
compiling to JavaScript. For example, in the above code <code>st_size</code> is declared to
return an <code>IO Int64</code>, the JavaScript handler <code>h$base_st_size</code> returns the <code>Int64</code>
using two registers <code>$r1</code> and <code>$r2</code>, but does so through the use of a special
purpose global variable called <code>h$ret1</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">function h$base_st_size(stat, stat_off) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$ret1 = (stat.i3[(stat_off&gt;&gt;2)+2]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (stat.i3[(stat_off&gt;&gt;2)+1]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The function inputs a pointer and an offset. Pointers in GHCJS are simply
pointers to ByteArrays so the function indexes into the ByteArray and retrieves
and stores the lower 32-bits in <code>h$ret1</code>, then returns the higher 32-bits
directly. These results are picked up by the FFI code, which performs assignment
to set <code>$r1</code> to the result of the function call (the higher 32-bits), and set <code>$r2</code>
to the value of <code>h$ret1</code> (the lower 32-bits). Crucially, the runtime system needs
to do nothing. The registers are already handled ready to be consumed by
whatever the caller of the foreign function will do.</p><p>One might consider using a simpler design, which trades register juggling for a
more straightforward representation such as a ByteArray which stores the <code>Int64#</code>.
However, such a design would trade speed for implementation simplicity. If we
passed ByteArrays then each foreign function would spend time wrapping and
unwrapping the array to get the payload; clearly an undesirable outcome for high
performance code.</p><a id="org87ce79c"></a><h1>Changes in the FFI System for the JS Backend</h1><p>So we see that GHCJS<!-- -->‚Äô<!-- -->s FFI system actually performs quite well in the design
space. Power users are well supported and can leverage enough unsafety to bind
global variables like <code>h$ret1</code> and specific registers such as <code>$r1</code>. The system
provides some lightweight checking through parsing. The nuances of the
JavaScript platform are generally abstracted over and the FFI system is tuned
for performance critical scenarios. So why change it?</p><p>The short answer is to hit deadlines. By skipping the FFI parsing the JS Backend
team was able to produce a working (can output <!-- -->‚Äú<!-- -->Hello World!<!-- -->‚Äù<!-- -->, and compile GHC<!-- -->‚Äô<!-- -->s
boot libraries), integrated, JS backend in GHC faster than had we finished the
FFI system.</p><p>For the time being, we have opted to replaced each foreign function call with a
JavaScript fat arrow, for example:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">foreign import javascript unsafe &quot;(($1_1,$1_2) =&gt; { return h$base_st_size($1_1,$1_2); })&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   st_size :: Ptr CStat -&gt; IO Int64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p> Of course, this situation is untenable, as argued above, FFI code is assumed to
be used in performance critical code, and thus any extra overhead, such as a
function closure and consequent indirection, must be avoided. But fear not! In
the near future we<!-- -->‚Äô<!-- -->ll be overhauling the FFI system and returning it to its
former glory.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ffi">ffi</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/explanation">explanation</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/knowledge-engineering">knowledge_engineering</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-08-01-ghc-update">GHC DevX July 2022 Update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-08-01T00:00:00.000Z" itemprop="datePublished">August 1, 2022</time> ¬∑ <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This is the July 2022 monthly update from the GHC DevX team at IOG.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-for-ghc">JavaScript Backend for GHC<a class="hash-link" href="#javascript-backend-for-ghc" title="Direct link to heading">‚Äã</a></h2><p>For a few months we have been merging GHCJS (Haskell to JavaScript compiler)
into GHC. We set our first milestone to be the ability to compile and to run the
usual &quot;Hello World&quot; program. This month we finally reached it!</p><p>We are now focusing on:</p><ul><li><p>fixing failing tests in GHC&#x27;s testsuite (~2800 unexpected failures). To do that, we
have to implement new primops, to fix bugs we introduced while we ported the
code from GHCJS, etc.</p></li><li><p>implementing support for the &quot;js-sources&quot; Cabal stanza in Hadrian. Currently
the JS backend finds the JS sources required for the RTS and for base into
explicitly defined location. It was only a stop-gap measure and we now need to
implement proper support for user-provided JavaScript files.</p></li><li><p>documenting and refactoring the source code and making it similar to other GHC
modules. As an example, GHCJS used the text package which isn&#x27;t a boot
package. Hence we first switched to use GHC&#x27;s ShortText implementation and now
we switched to a FastString based implementation.</p></li><li><p>adding back GHCJS&#x27;s features that we haven&#x27;t ported for some reasons (e.g. the
compactor, TH, etc.).</p></li></ul><p>You can follow our progress on our development branch
<a href="https://gitlab.haskell.org/ghc/ghc/-/tree/wip/js-staging" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="blog-posts">Blog posts<a class="hash-link" href="#blog-posts" title="Direct link to heading">‚Äã</a></h2><p>For the time being, we will focus blog post topics on GHCJS internals and
related topics. A few of these blog posts are currently under review and should
be published shortly.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-07-26-the-ghcjs-linker">The GHCJS Linker</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-26T00:00:00.000Z" itemprop="datePublished">July 26, 2022</time> ¬∑ <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">‚Äã</a></h2><p>I recently gave a short presentation on the workings of the GHCJS linker. This post is a summary of the content.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-executables">JavaScript &quot;executables&quot;<a class="hash-link" href="#javascript-executables" title="Direct link to heading">‚Äã</a></h2><p>The task of a linker is collecting and organizing object files and resources into a loadable library or executable program. JavaScript can be run in various environments, for example the browser or node.js, and not in all of these the concept of an executable makes sense.</p><p>Therefore, when we link a Haskell program, we generate a <code>jsexe</code> directory filled with various files that allow us to run the JavaScript result:</p><table><thead><tr><th align="center">File</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center"><code>out.js</code></td><td align="center">compiled/linked Haskell code</td></tr><tr><td align="center"><code>out.frefs.*</code></td><td align="center">list of foreign calls from <code>out.js</code></td></tr><tr><td align="center"><code>out.stats</code></td><td align="center">source code size origin statistics for <code>out.js</code></td></tr><tr><td align="center"><code>lib.js</code></td><td align="center">non-Haskell code, from <code>js-sources</code> in packages and RTS. possibly preprocessed</td></tr><tr><td align="center"><code>rts.js</code></td><td align="center">generated part of RTS (apply functions and similarly repetitive things)</td></tr><tr><td align="center"><code>runmain.js</code></td><td align="center">single line just starts <code>main</code></td></tr><tr><td align="center"><code>all.js</code></td><td align="center">complete runnable program, created by combining <code>out.js</code>, <code>lib.js</code>, <code>rts.js</code> and <code>runmain.js</code></td></tr></tbody></table><p>Most of the work done by the linker is producing <code>out.js</code>, and that&#x27;s what we&#x27;ll be focusing on in the next sections.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-outjs">Building <code>out.js</code><a class="hash-link" href="#building-outjs" title="Direct link to heading">‚Äã</a></h2><p>The linker builds <code>out.js</code> by collecting all code reachable from <code>main</code> (and a few other symbols required by the RTS) and generating the required initialization code for all top-level data. The code is found in object files. These object files have the following structure:</p><table><thead><tr><th align="center">Section</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">Header</td><td align="center">version number and offsets of other sections</td></tr><tr><td align="center">String table</td><td align="center">shared string table, referred to by <code>Dependencies</code> and <code>Code</code>, to avoid duplication in file and memory</td></tr><tr><td align="center">Dependencies</td><td align="center">Dependency data, internally between binding groups and externally to symbols in other object files</td></tr><tr><td align="center">Code</td><td align="center">Compiled Haskell code stored as serialized JavaScript AST and metadata. Code is organized in binding groups</td></tr></tbody></table><p>The object files contain binding groups of mutually dependent bindings. These are the smallest units of code that can be linked. Each binding group has some associated metadata required for initialization of the heap objects in the group. The metadata contains for example constructor tags (e.g. 1 for <code>Nothing</code>, 2 for <code>Just</code>), the arity of functions and static reference tables.</p><p>From a high level, the procedure that the linker follows is this:</p><table><thead><tr><th align="center">Step</th></tr></thead><tbody><tr><td align="center">Read object files from dependencies into memory</td></tr><tr><td align="center">Decode dependency part of all object files in dependencies (includes reading the string tables)</td></tr><tr><td align="center">Using dependency data, find all code reachable from <code>main</code></td></tr><tr><td align="center">Decode reachable binding groups</td></tr><tr><td align="center">Render AST to JavaScript</td></tr><tr><td align="center">Construct initializers from metadata</td></tr></tbody></table><p>We avoid decoding (deserializing) the binding groups that do end up in the linked result to keep the memory consumption lower. Still the linker requires a lot of memory for larger programs, so we may need to make more improvements in the future.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-compactor">The Compactor<a class="hash-link" href="#the-compactor" title="Direct link to heading">‚Äã</a></h2><p>The compactor is an optional link-time transformation step that reduces code size. It consists of a lightweight (i.e. no expensive operations like dataflow analysis) rewrite of the code contained in the object files. The compactor is disabled when linking with the <code>-debug</code> flag. There are a few steps involved.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="renaming-private-symbols">Renaming private symbols<a class="hash-link" href="#renaming-private-symbols" title="Direct link to heading">‚Äã</a></h3><p>Haskell names are quite long by default: they need to be globally unique, hence they contain their defining unit-id and module name. For example: <code>mtl-2.2.2-somehash-Control.Monad.State.Lazy.execState_go1</code> (special characters would be z-encoded but it isn&#x27;t shown here).</p><p>Private symbols are only referred to from within the same module. It doesn&#x27;t matter which JavaScript name we pick for them, as long as there is no overlap between the names from different modules. The compactor renames all the private symbols using a global sequence to ensure short names that do not overlap.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="block-initializer">Block Initializer<a class="hash-link" href="#block-initializer" title="Direct link to heading">‚Äã</a></h3><p>Without the compactor, the linker generates an <code>h$initObj</code> initialization call (or <code>h$o</code>) call for each global Haskell heap value. The code for this can get quite big. The compactor collects all heap objects to be initialized in a single large array and encodes the metadata in a string. This makes the initialization code much more compact.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="deduplication">Deduplication<a class="hash-link" href="#deduplication" title="Direct link to heading">‚Äã</a></h3><p>An optional step in the compactor is deduplication of code. When deduplication is enabled with the <code>-dedupe</code> flag, the compactor looks for functionally equivalent pieces of JavaScript in the output and merges them. This can result in a significant reduction of code size.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="incremental-linking">Incremental Linking<a class="hash-link" href="#incremental-linking" title="Direct link to heading">‚Äã</a></h2><p>The linker supports building programs that are loaded incrementally. This is used for example for Template Haskell. The process that runs the Template Haskell stays alive during compilation of a whole module. When the first Template Haskell expression is compiled, it is linked against all its dependencies (including the RTS) and the resulting JavaScript code is sent over to be run in the evaluator process.</p><p>As subsequent Template Haskell expressions are evaluated in the same process, there is no need to load already loaded dependencies (including the RTS) again and it is much more efficient to avoid doing so. Therefore the linker keeps track of which dependencies have already been linked and each subsequent TH expression is only linked against dependencies that are not already loaded in the evaluator process.</p><p>It&#x27;s also possible for users to use this functionality directly, with the <code>-generate-base</code> to create a &quot;linker state&quot; file along with the regular <code>jsexe</code> files. Another program can then be linked with <code>-use-base=state_file</code>, resulting in a program which leaves out everything already present in the first program.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="future-improvements">Future Improvements<a class="hash-link" href="#future-improvements" title="Direct link to heading">‚Äã</a></h2><p>Memory consumption is the biggest problem in the linker at the moment. Possible ways to achieve this are compression, more efficient representation of the data structures or more incremental loading of the parts from the object files that we need.</p><p>In terms of functionality, we don&#x27;t take advantage of JavaScript modules yet. It would be good if we could improve the linker to support linking a library as a JavaScript module. We should also consider making use of <code>foreign export javascript</code> for this purpose.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/linking">linking</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-07-20-js-backend-prim-types">Primitive Type Representation in GHC&#x27;s upcoming JS-backend</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-20T00:00:00.000Z" itemprop="datePublished">July 20, 2022</time> ¬∑ <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ol><li><a href="#orge86cd4a">GHC Primitives</a><ol><li><a href="#org75a0c27">The Easy Cases</a></li><li><a href="#org5eb1aee">ByteArray#, MutableByteArray#, SmallArray#, MutableSmallArray#,</a></li><li><a href="#org0de7f9e">Addr# and StablePtr#</a></li><li><a href="#orgfa8aeb4">Numbers: The Involved Case</a><ol><li><a href="#orgc9d245e">Working with 64-bit Types</a></li><li><a href="#org453f9cc">Unwrapped Number Optimization</a></li></ol></li><li><a href="#org2e2e79e">But what about the other stuff!</a></li></ol></li></ol><p>One of the key challenges in any novel backend is representing GHC primitive
types in the new backend. For JavaScript, this is especially tricky, as
JavaScript only has 8 primitive types and some of those types, such as <code>number</code> do
not directly map to any Haskell primitive type, such as <code>Int8#</code>. This post walks
through the most important GHC primitives and describes our implementation for
each in the JavaScript backend. This post is intended to be an
explanation-oriented post, light on details, but just enough to understand how
the system works.</p><a id="orge86cd4a"></a><h1>GHC Primitives</h1><p>There are 36 <code>primtype</code>s that GHC defines in <code>primops.txt.pp</code>:</p><ol><li><code>Char#</code></li><li><code>Int8#</code>, <code>Int16#</code>, <code>Int32#</code>, <code>Int64#</code>, <code>Int#</code></li><li><code>Word8#</code>, <code>Word16#</code>, <code>Word32#</code>, <code>Word64#</code>, <code>Word#</code></li><li><code>Double#</code>, <code>Float#</code>,</li><li><code>Array#</code>, <code>MutableArray#</code>,, <code>SmallArray#</code>, <code>SmallMutableArray#</code></li><li><code>ByteArray#</code>, <code>MutableByteArray#</code></li><li><code>Addr#</code></li><li><code>MutVar#</code>, <code>TVar#</code>, <code>MVar#</code>,</li><li><code>IOPort#</code>, <code>State#</code>, <code>RealWorld</code>, <code>ThreadId#</code></li><li><code>Weak#</code>, <code>StablePtr#</code>, <code>StableName#</code>, <code>Compact#</code>, <code>BCO</code>,</li><li><code>Fun</code>, <code>Proxy#</code></li><li><code>StackSnapshot#</code></li><li><code>VECTOR</code></li></ol><p>Some of these are unsupported in the JS-backend, such as <code>VECTOR</code> or lower
priority such as <code>StackSnapshot#</code>. We<!-- -->‚Äô<!-- -->ll begin with the easy cases.</p><a id="org75a0c27"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-easy-cases">The Easy Cases<a class="hash-link" href="#the-easy-cases" title="Direct link to heading">‚Äã</a></h2><p>The easy cases are the cases that are implemented as JavaScript objects. In
general, this is the big hammer used when nothing else will do. We<!-- -->‚Äô<!-- -->ll expand on
the use of objects<!-- -->‚Äî<!-- -->especially representing heap objects<!-- -->‚Äî<!-- -->in a future post,
but for the majority of cases we mimic the STG-machine behavior for GHC heap
objects using JavaScript heap objects. For example,</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">var someConstructor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { f  =                   // entry function of the datacon worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    , m  = 0                 // garbage collector mark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    , d1 = first arg         // First data field for the constructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    , d2 = arity = 2: second arg // second field, or object containing the remaining fields</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           arity &gt; 2: { d1, d2, ...} object with remaining args (starts with &quot;d1 = x2&quot;!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This is the general recipe; we define a JavaScript object that contains
properties which correspond to the entry function of the heap object; in this
case that is the entry function, <code>f</code> for a constructor, some meta data for garbage
collection <code>m</code>, and pointers to the fields of the constructor or whatever else the
heap object might need. Using JavaScript objects allows straightforward
translations of several GHC types. For example <code>TVar</code>s and <code>MVar</code>s:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// stg.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/** @constructor */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$TVar(v) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TRACE_STM(&quot;creating TVar, value: &quot; + h$collectProps(v));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.val        = v;           // current value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.blocked    = new h$Set(); // threads that get woken up if this TVar is updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.invariants = null;        // invariants that use this TVar (h$Set)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.m          = 0;           // gc mark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this._key       = ++h$TVarN;   // for storing in h$Map/h$Set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef GHCJS_DEBUG_ALLOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$debugAlloc_notifyAlloc(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// stm.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$MVar() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TRACE_SCHEDULER(&quot;h$MVar constructor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.val     = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.readers = new h$Queue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.writers = new h$Queue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.waiters = null;  // waiting for a value in the MVar with ReadMVar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.m       = 0; // gc mark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.id      = ++h$mvarId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef GHCJS_DEBUG_ALLOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$debugAlloc_notifyAlloc(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that both implementations defined properties specific to the semantics of
the Haskell type. JavaScript functions which create these objects follow the
naming convention <code>h$&lt;something&gt;</code> and reside in <em>Shim</em> files. <em>Shim</em> files are
JavaScript files that the JS-backend links against and are written in pure
JavaScript. This allows us to save some compile time by not generating code
which doesn<!-- -->‚Äô<!-- -->t change, and decompose the backend into JavaScript modules.</p><p>This strategy is also how functions are implemented in the JS-backend. Function
objects are generated by <code>StgToJS.Expr.genExpr</code> and <code>StgToJS.Apply.genApp</code> but
follow this recipe:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">var myFUN =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> { f  = &lt;function itself&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> , m  = &lt;garbage collector mark&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> , d1 = free variable 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> , d2 = free variable 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To summarize; for most cases we write custom JavaScript objects which hold
whatever machinery is needed as properties to satisfy the expected semantics of
the Haskell type. This is the strategy that implements: <code>TVar</code>, <code>MVar</code>, <code>MutVar</code> and
<code>Fun</code>.</p><a id="org5eb1aee"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="bytearray-mutablebytearray-smallarray-mutablesmallarray">ByteArray#, MutableByteArray#, SmallArray#, MutableSmallArray#,<a class="hash-link" href="#bytearray-mutablebytearray-smallarray-mutablesmallarray" title="Direct link to heading">‚Äã</a></h2><p><code>ByteArray#</code> and friends map to JavaScript&#x27;s
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer" target="_blank" rel="noopener noreferrer"><code>ArrayBuffer</code></a>
object. The <code>ArrayBuffer</code> object provides a fixed-length, raw binary data
buffer. To index into the <code>ArrayBuffer</code> we need to know the type of data the
buffer is expected to hold. So we make engineering tradeoff; we allocate typed
views of the buffer payload once at buffer allocation time. This prevents
allocations from views later when we might be handling the buffer in a hot loop,
at the cost of slower initialization. For example, consider the <code>mem.js.pp</code>
shim, which defines <code>ByteArray#</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// mem.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$newByteArray(len) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var len0 = Math.max(h$roundUpToMultipleOf(len, 8), 8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var buf = new ArrayBuffer(len0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return { buf: buf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , len: len</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , i3: new Int32Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u8: new Uint8Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u1: new Uint16Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f3: new Float32Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f6: new Float64Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , dv: new DataView(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , m: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p> <code>buf</code> is the payload of the <code>ByteArray#</code>, <code>len</code> is the length of the
<code>ByteArray#</code>. <code>i3</code> to <code>dv</code> are the <em>views</em> of the payload; each view is an
object which interprets the raw data in <code>buf</code> differently according to type. For
example, <code>i3</code> interprets <code>buf</code> as holding <code>Int32</code>, while <code>dv</code> interprets <code>buf</code>
as a
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" target="_blank" rel="noopener noreferrer"><code>DataView</code></a>
and so on. The final property, <code>m</code>, is the garbage collector marker.</p><a id="org0de7f9e"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="addr-and-stableptr">Addr# and StablePtr#<a class="hash-link" href="#addr-and-stableptr" title="Direct link to heading">‚Äã</a></h2><p><code>Addr#</code> and <code>StablePtr#</code> are implemented as a pair of <code>ByteArray#</code> and an <code>Int#</code>
offset into the array. We<!-- -->‚Äô<!-- -->ll focus on <code>Addr#</code> because <code>StablePtr#</code> is the
same implementation, with the exception that the <code>StablePtr#</code> is tracked in the
global variable <code>h$stablePtrBuf</code>. <code>Addr#</code>s do not have an explicit constructor,
rather they are implicitly constructed. For example, consider <code>h$rts_mkPtr</code>
which creates a <code>Ptr</code> that contains an <code>Addr#</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">function h$rts_mkPtr(x) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var buf, off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(typeof x == &#x27;string&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = h$encodeUtf8(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else if(typeof x == &#x27;object&#x27; &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     typeof x.len == &#x27;number&#x27; &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     x.buf instanceof ArrayBuffer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else if(x.isView) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = h$wrapBuffer(x.buffer, true, 0, x.buffer.byteLength);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = x.byteOffset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = h$wrapBuffer(x, true, 0, x.byteLength);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return (h$c2(h$baseZCGHCziPtrziPtr_con_e, (buf), (off)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The function does some type inspection to check for the special case on
<code>string</code>. If we do not have a string then a <code>Ptr</code>, which contains an <code>Addr#</code>, is
returned. The <code>Addr#</code> is implicitly constructed by allocating a new
<code>ArrayBuffer</code> and an offset into that buffer. The <code>object</code> case is an idempotent
check; if the input is already such a <code>Ptr</code>, then just return the input. The
cases which do the work are the cases which call to <code>h$wrapBuffer</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// mem.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$wrapBuffer(buf, unalignedOk, offset, length) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!unalignedOk &amp;&amp; offset &amp;&amp; offset % 8 !== 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw (&quot;h$wrapBuffer: offset not aligned:&quot; + offset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!buf || !(buf instanceof ArrayBuffer))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw &quot;h$wrapBuffer: not an ArrayBuffer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!offset) { offset = 0; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!length || length &lt; 0) { length = buf.byteLength - offset; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return { buf: buf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , len: length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , i3: (offset%4) ? null : new Int32Array(buf, offset, length &gt;&gt; 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u8: new Uint8Array(buf, offset, length)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u1: (offset%2) ? null : new Uint16Array(buf, offset, length &gt;&gt; 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f3: (offset%4) ? null : new Float32Array(buf, offset, length &gt;&gt; 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f6: (offset%8) ? null : new Float64Array(buf, offset, length &gt;&gt; 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , dv: new DataView(buf, offset, length)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>h$wrapBuffer</code> is a utility function that does some offset checks and performs
the allocation for the typed views as described above.</p><a id="orgfa8aeb4"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="numbers-the-involved-case">Numbers: The Involved Case<a class="hash-link" href="#numbers-the-involved-case" title="Direct link to heading">‚Äã</a></h2><p>Translating numbers has three issues. First, JavaScript has no concept of
fixed-precision 64-bit types such as <code>Int64#</code> and <code>Word64#</code>. Second, JavaScript
bitwise operators only support <em>signed</em> 32-bit values (except the unsigned
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Unsigned_right_shift" target="_blank" rel="noopener noreferrer">right
shift</a>
operator of course). Third, numbers are atomic types and do not require any
special properties for correct semantics, thus using wrapping objects gains us
nothing at the cost of indirection.</p><a id="orgc9d245e"></a><h3 class="anchor anchorWithStickyNavbar_mojV" id="working-with-64-bit-types">Working with 64-bit Types<a class="hash-link" href="#working-with-64-bit-types" title="Direct link to heading">‚Äã</a></h3><p>To express 64-bit numerics, we simply use two 32-bit numbers, one to express
the high bits, one for the low bits. For example, consider comparing two <code>Int64#:</code></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// arith.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$hs_ltInt64(h1,l1,h2,l2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(h1 === h2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var l1s = l1 &gt;&gt;&gt; 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var l2s = l2 &gt;&gt;&gt; 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (l1s &lt; l2s || (l1s === l2s &amp;&amp; ((l1&amp;1) &lt; (l2&amp;1)))) ? 1 : 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (h1 &lt; h2) ? 1 : 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The less than comparison function expects four inputs, two for each <code>Int64#</code> in
Haskell. The first number is represented by <code>h1</code> and <code>l1</code> (<em>high</em> and <em>low</em>),
and similarly the second number is represented by <code>h2</code> and <code>l2</code>. The comparison
is straightforward, we check equivalence of our high bits, if equal then we
check the lower bits while being careful with signedness. No surprises here.</p><p>For the bitwise operators we store both <code>Word32#</code> and <code>Word#</code> as 32-bit signed
values, and then map any values greater or equal <code>2^31</code> bits to negative values.
This way we stay within the 32-bit range even though in Haskell these types only
support nonnegative values.</p><a id="org453f9cc"></a><h3 class="anchor anchorWithStickyNavbar_mojV" id="unwrapped-number-optimization">Unwrapped Number Optimization<a class="hash-link" href="#unwrapped-number-optimization" title="Direct link to heading">‚Äã</a></h3><p>The JS backend uses JavaScript values to represent both Haskell heap objects and
unboxed values (note that this isn&#x27;t the only possible implementation, see
<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>). As such, it doesn&#x27;t require that all heap objects have the same
representation (e.g. a JavaScript object with a &quot;tag&quot; field indicating its type)
because we can rely on JS introspection for the same purpose (especially
<code>typeof</code>). Hence this optimization consists in using a more efficient JavaScript
type to represent heap objects when possible, and to fallback on the generic
representation otherwise.</p><p>This optimization particularly applies to <code>Boxed</code> numeric values (<code>Int</code>, <code>Word</code>,
<code>Int8</code>, etc.) which can be directly represented with a JavaScript number,
similarly to how unboxed <code>Int#</code>, <code>Word#</code>, <code>Int8#</code>, etc. values are represented.</p><p>Pros:</p><ul><li>Fewer allocations and indirections: instead of one JavaScript object with a
field containing a number value, we directly have the number value.</li></ul><p>Cons:</p><ul><li>More complex code to deal with heap objects that can have different
representations</li></ul><p>The optimization is applicable when:</p><ol><li>We have a single data type with a single data constructor.</li><li>The constructor holds a single field that <em>can only</em> be a particular type.</li></ol><p>If these invariants hold then, we remove the wrapping object and instead refer
to the value held by the constructor directly. <code>Int8</code> is the simplest case for
this optimization. In Haskell we have:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data Int8 = Int8 Int8#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that this definition satisfies the requirements. A direct translation in
the JS backend would be:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// An Int8 Thunk represented as an Object with an entry function, f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// and payload, d1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var anInt8 = { d1 = &lt;Int8# payload&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             , f  : entry function which would scrutinize the payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We can operationally distinguish between a <code>Thunk</code> and an <code>Int8</code> because these
will have separate types in the <code>StgToJS</code> GHC pass and will have separate types
(<code>object</code> vs <code>number</code>) at runtime. In contrast, in Haskell an <code>Int8</code> may
actually be a <code>Thunk</code> until it is scrutinized <em>and then</em> becomes the <code>Int8</code>
payload (i.e., call-by-need). So this means that we will always know when we
have an <code>Int8</code> rather than a <code>Thunk</code> and therefore we can omit the wrapper
object and convert this code to just:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// no object, just payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var anInt8 = = &lt;Int8# payload&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For the interested reader, this optimization takes place in the JavaScript code
generator module <code>GHC.StgToJS.Arg</code>, specifically the functions <code>allocConStatic</code>,
<code>isUnboxableCon</code>, and <code>primRepVt</code>.</p><a id="org2e2e79e"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="but-what-about-the-other-stuff">But what about the other stuff!<a class="hash-link" href="#but-what-about-the-other-stuff" title="Direct link to heading">‚Äã</a></h2><ul><li><code>Char#</code>: is represented by a <code>number</code>, i.e., the <a href="https://en.wikipedia.org/wiki/Code_point" target="_blank" rel="noopener noreferrer">code point</a></li><li><code>Float#/Double#</code>: Both represented as a JavaScript Double. This means that
<code>Float#</code> has excess precision and thus we do not generate exactly the same
answers as other platforms which are IEEE754 compliant. Full emulation of
single precision Floats does not seem to be worth the effort as of writing.
Our implementation represents these in a <code>ByteArray#</code>, where each <code>Float#</code>
takes 4 bytes in the <code>ByteArray#</code>. This means that the precision is reduced
to a 32-bit Float.</li></ul><div class="footnotes"><hr><ol><li id="fn-1">An alternative approach would be to use some JS ArrayBuffers as memory
blocks into which Haskell values and heap objects would be allocated. As an
example this is the approach used by the Asterius compiler. The RTS would
then need to be much more similar to the C RTS and the optimization
presented in this section wouldn&#x27;t apply because we couldn&#x27;t rely on
introspection of JS values.<a href="#fnref-1" class="footnote-backref">‚Ü©</a></li></ol></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/explanation">explanation</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/knowledge-engineering">knowledge_engineering</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-07-18-lightweight-threads-on-JavaScript">Lightweight Haskell Threads on JavaScript</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-18T00:00:00.000Z" itemprop="datePublished">July 18, 2022</time> ¬∑ <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">‚Äã</a></h2><p>I recently gave a short presentation on the topic of threads in GHCJS to the GHC team at IOG. This blog post is a summary of the content.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-and-threads">JavaScript and Threads<a class="hash-link" href="#javascript-and-threads" title="Direct link to heading">‚Äã</a></h2><p>JavaScript is fundamentally single threaded. There are ways to share specific data between tasks but it&#x27;s not possible to run multiple threads that have access to a shared memory space of JavaScript data.</p><p>The single JavaScript thread is often responsible for multiple tasks. For example a node.js server handles multiple simultaneous connections and a web application may be dealing with user input while downloading new data in the background.</p><p>This means that any single task should take care to never block execution of the other task. JavaScript&#x27;s canonical answer is to use asynchronous programming. A function reading a file returns immediately without waiting for the file data to be loaded in memory. When the data is ready, a user-supplied callback is called to continue processing the data.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="haskell-threads">Haskell Threads<a class="hash-link" href="#haskell-threads" title="Direct link to heading">‚Äã</a></h2><p>Concurrent Haskell supports lightweight threads through <code>forkIO</code>. These threads are scheduled on top of one more more operating system thread. A blocking foreign call blocks an OS thread but other lightweight threads can still run on other OS threads if available.</p><p>There is no built-in support for foreign calls with a callback in the style of JavaScript. Functions imported with <code>foreign import ccall interruptible</code> can be interrupted by sending an asynchronous exception to the corresponding lightweight thread.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="lightweight-threads-in-javascript">Lightweight Threads in JavaScript<a class="hash-link" href="#lightweight-threads-in-javascript" title="Direct link to heading">‚Äã</a></h2><p>GHCJS implements lightweight threads on top of the single JavaScript thread. The scheduler switches between threads and handles synchronization through <code>MVar</code> and <code>STM</code> as expected from other Haskell platforms.</p><p>Foreign calls that don&#x27;t block can be handled in the usual way. We extend the foreign function interface with a new type <code>foreign import javascript interruptible</code> that conveniently supports the callback mechanism used by JavaScript frameworks. The foreign call is supplied with an additional argument <code>$c</code> representing a callback to be called with the result when ready. From the Haskell side the corresponding lightweight thread is blocked until <code>$c</code> is called. This type of foreign call can be interrupted with an asynchronous exception to the lightweight Haskell thread.</p><p>By default, Haskell threads in the JS environment run asynchronously. A call to <code>h$run</code> returns immediately and starts the thread in the background. This works for tasks that does not require immediate actions. For situations that require more immediate action, such as dealing with event handler propagation, there is <code>h$runSync</code>. This starts a synchronous thread that is not interleaved with other task. If possible, the thread runs to completion before the call to <code>h$runSync</code> returns. If the thread blocks for any reason, such as waiting for an <code>MVar</code> or a <code>foreign import javascript interruptible</code> call, synchronous execution cannot complete. The blocking task is then either interrupted with an exception or the thread is &quot;demoted&quot; to a regular asynchronous thread.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="black-holes">Black Holes<a class="hash-link" href="#black-holes" title="Direct link to heading">‚Äã</a></h2><p>When a Haskell value is evaluated, its heap object is overwritten by a black hole. This black hole marks the value as being evaluated and prevents other threads from doing the same. &quot;black holing&quot; can be done either immediately or &quot;lazily&quot;, when the garbage collector is run. GHCJS implements immediate blackholing.</p><p>Black holes give rise to an interesting problem in the presence of synchronous and asynchronous threads. Typically if we use <code>h$runSync</code>, we want to have some guarantee that at least part of the task will run succesfully without blocking. For the most past it&#x27;s fairly clear which parts of our task depends on potentially blocking IO or thread synchronization. But black holes throw a spanner in the works: Suddenly any &quot;pure&quot; data structure can be a source of blocking if it is under evaluation by another thread.</p><p>To regain some predictability and usability of synchronous threads, the <code>h$runSync</code> scheduler can run other Haskell threads in order to &quot;clear&quot; a black hole. The process ends all black holes have been cleared or when any of the black holes is impossible to clear because of a blocking situation.</p><p>This all happens transparantly to the caller of <code>h$runSync</code>, if the black holes could be cleared it appears as if they were never there.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">‚Äã</a></h2><p>We have lightweight Haskell threads in the single-threaded JavaScript environment and extend the foreign function interface to easily support foreign calls that depend on an asynchronous callback. This way, only the Haskell lightweight thread blocks.</p><p>By default, Haskell threads are asynchronous and run in the background: The scheduler interleaves the tasks and synchronization between threads. For situations that require immediate results or actions there are synchronous threads. Synchronous threads cannot block and are not interleaved with other tasks except when a black hole is encountered.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/concurrency">concurrency</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ffi">ffi</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-07-01-ghc-update">GHC DevX June 2022 Update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-01T00:00:00.000Z" itemprop="datePublished">July 1, 2022</time> ¬∑ <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This is the June 2022 monthly update from the GHC DevX team at IOG.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-for-ghc">JavaScript Backend for GHC<a class="hash-link" href="#javascript-backend-for-ghc" title="Direct link to heading">‚Äã</a></h2><p>For a few months we have been merging GHCJS (Haskell to JavaScript compiler) into GHC.
We set our first milestone to be the ability to compile and to run the usual &quot;Hello World&quot; program.
It turned out to be much more involved than we initially thought (requiring FFI support, etc.), but we should be getting there soon.</p><p>This month we have made the following progress:</p><ul><li><p><strong>Linking</strong>: GHCJS requires some functions to be directly implemented in
JavaScript (e.g. the RTS, some low-level functions in base). We have added support
for linking <code>.js</code> files. We&#x27;ve also added support for a preprocessing pass with CPP
for <code>.js.pp</code> files.</p></li><li><p><strong>js-sources</strong>: there is some ongoing work to load these external JavaScript
files from installed libraries. Cabal provides a <code>js-sources</code> stanza for this,
we need to adapt Hadrian to make use of it.</p></li><li><p><strong>Binary vs Objectable</strong>: GHCJS used its own ByteString-based Objectable
type-class: we replaced it with GHC&#x27;s similar Binary type-class.
Josh has published a <a href="https://engineering.iog.io/2022/05/24/april-GHCJS-Objectable-vs-GHC-Binary" target="_blank" rel="noopener noreferrer">blog
post</a>
about their differences.</p></li><li><p><strong>64-bit primops</strong>: we&#x27;ve added support for 64-bit primops (Word64# and Int64#
types). In GHCJS (GHC 8.10), these were still implemented as foreign function
calls. It&#x27;s no longer true on GHC head.</p></li><li><p><strong>base library</strong>: added CPP as required to support the JS backend. Ported and
converted FFI imports from GHCJS to use JavaScript fat arrows (we haven&#x27;t
implemented GHCJS&#x27;s fancy import syntax yet).</p></li></ul><p>Now we can compile and link the &quot;HelloWorld&quot; program.
To reach the first milestone we only have to fix the remaining runtime errors.</p><p>You can follow our progress on our development branch <a href="https://gitlab.haskell.org/ghc/ghc/-/tree/wip/js-staging" target="_blank" rel="noopener noreferrer">here</a>.
We now rebase this branch every Friday to avoid lagging too much behind GHC head.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="haskell-optimization-handbook">Haskell Optimization Handbook<a class="hash-link" href="#haskell-optimization-handbook" title="Direct link to heading">‚Äã</a></h2><p>The &quot;Haskell Optimization Handbook&quot; is an <a href="https://github.com/haskellfoundation/tech-proposals/blob/main/proposals/accepted/026-haskell-optimization-handbook.md" target="_blank" rel="noopener noreferrer">accepted proposal</a> of the Haskell Foundation.
Jeff has been steadily writing some initial material as per the project plan.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-06-01-ghc-update">GHC DevX May 2022 Update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-06-01T00:00:00.000Z" itemprop="datePublished">June 1, 2022</time> ¬∑ <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This is the May 2022 monthly update from the GHC DevX team at IOG.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-for-ghc">JavaScript Backend for GHC<a class="hash-link" href="#javascript-backend-for-ghc" title="Direct link to heading">‚Äã</a></h2><p>For a few months we have been merging GHCJS (Haskell to JavaScript compiler) into GHC.
We set our first milestone to be the ability to compile and to run the usual &quot;Hello World&quot; program.
It turned out to be much more involved than we initially thought (requiring FFI support, etc.), but we should be getting there soon.</p><p>This month we have made the following progress:</p><ul><li><p><strong>RTS</strong>: we have modified Hadrian and <code>rts.cabal</code> in order to build a valid
native <code>rts</code> unit that GHC can use, in particular containing appropriate
header files.</p></li><li><p><strong>linker</strong>: the JS linker has been hooked up with GHC&#x27;s driver.
We fixed several panics in the linker due to erroneous symbol generation code.
These bugs were introduced while porting the code from the old 8.10 pretty-printing infrastructure to the newer one.</p></li><li><p><strong>boot libraries</strong>: the JS backend can now build and link all the boot libraries.
Note that we are not claiming that they are all usable yet. In particular complete FFI support is lacking, but the JS backend Hadrian build completes and so we can start using the produced JS cross-compiler.</p></li><li><p><strong>levity polymorphism</strong>: building <code>ghc-prim</code> uncovered a lurking bug related to
levity polymorphism. It wasn&#x27;t noticed in GHCJS 8.10 because it is also
related to the <code>BoxedRep</code> proposal that introduced a constructor application
in a commonly used <code>RuntimeRep</code>.</p></li><li><p><strong>sized literals</strong>: support for new sized literals have been added to the code
generator.</p></li></ul><p>Now that have achieved a build process that actually produces a JS cross compiler, we are confronting and fixing issues in the produced JavaScript code, such as adding, managing, and debugging CPP conditional compilation blocks in JS shim files. You can follow our progress on our development branch <a href="https://gitlab.haskell.org/ghc/ghc/-/tree/wip/js-staging" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="external-static-plugins">External Static Plugins<a class="hash-link" href="#external-static-plugins" title="Direct link to heading">‚Äã</a></h2><p>GHC doesn&#x27;t support plugins in cross-compilers <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/14335" target="_blank" rel="noopener noreferrer">#14335</a>.
Some time ago, we came up with a solution called &quot;external static plugins&quot; <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7377" target="_blank" rel="noopener noreferrer">!7377</a>.
These are plugins that are directly loaded from shared libaries, bypassing the issue with usual plugins.</p><p>Our colleague Shea Levy confirmed that the approach works, backported it to GHC 8.10, and has been working on making it work in stage1 cross-compilers for Windows.
Kudos for this work, Shea.</p><p>As the current user-interface based on environment variables isn&#x27;t convenient, we have been working on adding new command-line flags to GHC instead.
We expect to propose this for integration into GHC when the new interface will be fully implemented.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="blog-posts">Blog posts<a class="hash-link" href="#blog-posts" title="Direct link to heading">‚Äã</a></h2><p>Inspired by our friends and colleagues at Well-Typed and Tweag, we have been starting to write blog posts for IOG&#x27;s engineering blog.
They will mostly be about stuff we are working on or that we are interested in.
Feel free to send us feedback about these posts and to send us topics you would be interested to read about.</p><ul><li><a href="https://engineering.iog.io/2022-04-28-on-the-inlining-of-integer-and-natural-operations" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-04-28-on-the-inlining-of-integer-and-natural-operations</a></li><li><a href="https://engineering.iog.io/2022-05-02-setup-ext-stg-interp" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-05-02-setup-ext-stg-interp</a></li><li><a href="https://engineering.iog.io/2022-05-17-javascript-template-haskell-external-interpreter" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-05-17-javascript-template-haskell-external-interpreter</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="haskell-optimization-handbook">Haskell Optimization Handbook<a class="hash-link" href="#haskell-optimization-handbook" title="Direct link to heading">‚Äã</a></h2><p>The &quot;Haskell Optimization Handbook&quot; is an <a href="https://github.com/haskellfoundation/tech-proposals/blob/main/proposals/accepted/026-haskell-optimization-handbook.md" target="_blank" rel="noopener noreferrer">accepted proposal</a> of the Haskell Foundation.
Jeff has been working behind the scene to make this proposal concrete.
More about this in the upcoming months.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022/05/24/april-GHCJS-Objectable-vs-GHC-Binary">Objectable vs GHC Binary</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-05-24T00:00:00.000Z" itemprop="datePublished">May 24, 2022</time> ¬∑ <!-- -->11 min read</div></header><div class="markdown" itemprop="articleBody"><p>As part of the integration of GHCJS into GHC as a cross-compilation backend, we&#x27;ve converted the binary serialisation that GHCJS previously used, which was via its <code>Objectable</code> typeclass, into GHC&#x27;s internal <code>Binary</code> typeclass representation. In doing this, we gain access to instances for serialising many of GHC&#x27;s internal data types, and, importantly, we can reuse GHC&#x27;s mechanism for serialising its <code>Name</code> and <code>FastString</code> types, which are written to lookup tables in order to maintain identity, as well as allowing for space savings on disk.</p><p>In this post, we will explain how the GHC <code>Binary</code> and GHCJS <code>Objectable</code> approaches work, and compare their tradeoffs.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="how-ghc-binary-works">How GHC Binary Works<a class="hash-link" href="#how-ghc-binary-works" title="Direct link to heading">‚Äã</a></h2><p>Internally, GHC uses the <code>Name</code> data type to track the uniqueness of objects during compilation. Amongst information relating to the definition of a <code>Name</code> within the Haskell source, a <code>Name</code> also contains a <code>Unique</code> integer (the value of which is provided by the complation environment monad). Using this <code>Unique</code> integer, which is unpacked in <code>Name</code>&#x27;s definition, we can make O(1) equality comparisons without following further memory references - allowing for this operation to be very quick, which will have a large effect on compilation performance given how often it is used.</p><p><code>FastString</code> is used within GHC to store short, string-like data, and, similarly to <code>Name</code>, <code>FastString</code> uses a unique integer to allow for very fast equality comparisons. Primarily, <code>FastString</code> is used to represent variables and other definitions, and is used both in <code>Name</code> as the string-representation of a name with extra information attached, as well as directly, representing names that don&#x27;t require this extra information, such as local variables.</p><p>In GHC&#x27;s <code>.hi</code> interface files, <code>Name</code> and <code>FastString</code> are serialised differently compared to other data structures. They are written in the main data structure payload as indicies of a table, and these tables contain the actual string-like data of these types. So, an interface file might resemble:</p><ul><li>Header<ul><li>Magic number for recognising interface files</li><li>Pointer to <code>Name</code> symbol table</li><li>Pointer to <code>FastString</code> dictionary</li></ul></li><li>Main data structure payload</li><li><code>Name</code> symbol table</li><li><code>FastString</code> dictionary</li></ul><p>Importantly, the <code>FastString</code> dictionary must be written <em>after</em> the <code>Name</code> symbol table, because <code>Name</code>s contain <code>FastString</code>s, so writing the symbol table will expand the dictionary. Additionally, because we only have one buffer, and we don&#x27;t know the size of the payload until it&#x27;s written, the tables cannot be written in the header, and instead serialisation code must reserve space for the table pointers and jump back to write the pointers once the table locations are known.</p><p>During serialisation, GHC uses mutable data structures to store both the serialised binary buffer, as well as these tables:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data BinHandle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = BinMem {                     -- binary data stored in an unboxed array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     bh_usr :: UserData,         -- sigh, need parameterized modules :-)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     _off_r :: !FastMutInt,      -- the current offset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     _sz_r  :: !FastMutInt,      -- size of the array (cached)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     _arr_r :: !(IORef BinArray) -- the array (bounds: (0,size-1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data UserData =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   UserData {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -- for *deserialising* only:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ud_get_name :: BinHandle -&gt; IO Name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ud_get_fs   :: BinHandle -&gt; IO FastString,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -- for *serialising* only:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ud_put_nonbinding_name :: BinHandle -&gt; Name -&gt; IO (),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -- ^ serialize a non-binding &#x27;Name&#x27; (e.g. a reference to another</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -- binding).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ud_put_binding_name :: BinHandle -&gt; Name -&gt; IO (),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -- ^ serialize a binding &#x27;Name&#x27; (e.g. the name of an IfaceDecl)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ud_put_fs   :: BinHandle -&gt; FastString -&gt; IO ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here, we see that various functions are stored in the handle structure, to be later referenced by their respective types in their <code>GHC.Utils.Binary.Binary</code> typeclass instances. Notice that the instance of <code>Binary Name</code> references <code>ud_put_nonbinding_name</code> and <code>ud_get_name</code>. Similarly, the <code>Binary FastString</code> instance uses <code>ud_put_fs</code> and <code>ud_get_fs</code>.</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">class Binary a where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    put_   :: BinHandle -&gt; a -&gt; IO ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    put    :: BinHandle -&gt; a -&gt; IO (Bin a)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get    :: BinHandle -&gt; IO a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instance Binary FastString where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  put_ bh f =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case getUserData bh of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UserData { ud_put_fs = put_fs } -&gt; put_fs bh f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  get bh =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case getUserData bh of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UserData { ud_get_fs = get_fs } -&gt; get_fs bh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instance Binary Name where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   put_ bh name =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      case getUserData bh of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UserData{ ud_put_nonbinding_name = put_name } -&gt; put_name bh name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   get bh =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      case getUserData bh of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UserData { ud_get_name = get_name } -&gt; get_name bh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In <code>GHC.Iface.Binary</code>, helper types and functions are defined to store the <code>Name</code> symbol table and <code>FastString</code> dictionary in a mutable data structure. Here, <code>putFastString</code> is intended to be partially applied - passing it an appropriately initialised <code>BinDictionary</code> so that the resulting function can be stored in the <code>us_put_fs</code> field of the <code>UserData</code>. <code>allocateFastString</code> does the low-level work here, incrementing the index and modifying the mutable map (stored as a <code>UniqFM</code>, which is map keyed on types that contain <code>Unique</code>s - recalling that these are used for fast equality comparisons):</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data BinDictionary = BinDictionary {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bin_dict_next :: !FastMutInt, -- The next index to use</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bin_dict_map  :: !(IORef (UniqFM FastString (Int,FastString)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                -- indexed by FastString</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">putFastString :: BinDictionary -&gt; BinHandle -&gt; FastString -&gt; IO ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">putFastString dict bh fs = allocateFastString dict fs &gt;&gt;= put_ bh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allocateFastString :: BinDictionary -&gt; FastString -&gt; IO Word32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allocateFastString BinDictionary { bin_dict_next = j_r,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   bin_dict_map  = out_r} f = do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    out &lt;- readIORef out_r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let !uniq = getUnique f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case lookupUFM_Directly out uniq of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Just (j, _)  -&gt; return (fromIntegral j :: Word32)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Nothing -&gt; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           j &lt;- readFastMutInt j_r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           writeFastMutInt j_r (j + 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           writeIORef out_r $! addToUFM_Directly out uniq (j, f)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           return (fromIntegral j :: Word32)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Later, in <code>GHC.Iface.Binary</code>, <code>getWithUserData</code> and <code>putWithUserData</code> will structure the header, and initialise the <code>UserData</code> functions to write to/read from mutable tables. Notice that we must first reserve header space for pointers to the lookup tables, as well as initialise the mutable tables, write these initialised structures to the <code>UserData</code> (for example, we see the previous <code>putFastString</code> partially applied here), then write the main payload, then write the lookup tables (<code>Name</code> symbol table first, because writing this can add to the <code>FastString</code> dictionary), and finally jump back to fill in the pointers to these tables:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">putWithUserData :: Binary a =&gt; TraceBinIFace -&gt; BinHandle -&gt; a -&gt; IO ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">putWithUserData traceBinIface bh payload = do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Remember where the dictionary pointer will go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dict_p_p &lt;- tellBin bh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Placeholder for ptr to dictionary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    put_ bh dict_p_p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Remember where the symbol table pointer will go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symtab_p_p &lt;- tellBin bh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    put_ bh symtab_p_p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Make some initial state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symtab_next &lt;- newFastMutInt 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symtab_map &lt;- newIORef emptyUFM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let bin_symtab = BinSymbolTable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         bin_symtab_next = symtab_next,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         bin_symtab_map  = symtab_map }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dict_next_ref &lt;- newFastMutInt 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dict_map_ref &lt;- newIORef emptyUFM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let bin_dict = BinDictionary {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       bin_dict_next = dict_next_ref,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       bin_dict_map  = dict_map_ref }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Put the main thing,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bh &lt;- return $ setUserData bh $ newWriteState (putName bin_dict bin_symtab)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                  (putName bin_dict bin_symtab)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                  (putFastString bin_dict)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    put_ bh payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Write the symtab pointer at the front of the file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symtab_p &lt;- tellBin bh        -- This is where the symtab will start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    putAt bh symtab_p_p symtab_p  -- Fill in the placeholder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seekBin bh symtab_p           -- Seek back to the end of the file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Write the symbol table itself</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symtab_next &lt;- readFastMutInt symtab_next</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symtab_map  &lt;- readIORef symtab_map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    putSymbolTable bh symtab_next symtab_map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case traceBinIface of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      QuietBinIFace         -&gt; return ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TraceBinIFace printer -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         printer (text &quot;writeBinIface:&quot; &lt;+&gt; int symtab_next</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        &lt;+&gt; text &quot;Names&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- NB. write the dictionary after the symbol table, because</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- writing the symbol table may create more dictionary entries.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Write the dictionary pointer at the front of the file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dict_p &lt;- tellBin bh          -- This is where the dictionary will start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    putAt bh dict_p_p dict_p      -- Fill in the placeholder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seekBin bh dict_p             -- Seek back to the end of the file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Write the dictionary itself</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dict_next &lt;- readFastMutInt dict_next_ref</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dict_map  &lt;- readIORef dict_map_ref</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    putDictionary bh dict_next dict_map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case traceBinIface of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      QuietBinIFace         -&gt; return ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TraceBinIFace printer -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         printer (text &quot;writeBinIface:&quot; &lt;+&gt; int dict_next</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        &lt;+&gt; text &quot;dict entries&quot;)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In summary, we see a number of structural characteristics of code using GHC&#x27;s Binary implementation:</p><ul><li>Use of a single buffer means that the lookup tables can&#x27;t be written in the header, so we have to reserve space for table pointers in the header, and jump back once we know where they will be located in order to write the pointers to the buffer. Essentially, an ordering of file sections is enforced by the data dependencies of the payload containing <code>Name</code>s and <code>FastString</code>s, and <code>Name</code>s containing <code>FastString</code>s - which means these must be written in this order, but reading must be done in the reverse order, causing the need for pointers in the header.</li><li>Jumping around in binary buffers results in weakly enforced types and fiddly, code that Haskell&#x27;s type system isn&#x27;t able to help us debug</li><li>Must carry about read/write functions for the lookup table types (<code>Name</code> and <code>FastString</code>), which are <code>undefined</code> during the opposite serialisation stage, and are hard-coded into the handle, reducing extensibility.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="how-objectable-works">How Objectable Works<a class="hash-link" href="#how-objectable-works" title="Direct link to heading">‚Äã</a></h2><p>In comparison, GHCJS previously involved using instances of the <code>Objectable</code> typeclass to serialise its interface files:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">import qualified Data.Binary as DB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data SymbolTable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = SymbolTable !Int !(Map ShortText Int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deriving (Show)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type PutSM = St.StateT SymbolTable DB.PutM -- FIXME: StateT isn&#x27;t strict enough apparently</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type PutS  = PutSM ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type GetS  = ReaderT ObjEnv DB.Get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Objectable a where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  put :: a -&gt; PutS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  get :: GetS a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  putList :: [a] -&gt; PutS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  putList = putListOf put</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getList :: GetS [a]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getList = getListOf get</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here we see that GHCJS has opted for a different approach that avoids the mutable buffer by instead using <code>Data.Binary</code> instances that work via concatenating lazy <code>ByteString</code>s. Additionally, the mutable tables are replaced with a <code>State</code> monad that holds the symbol table as a <code>Map</code> structure.</p><p>Because <code>Data.Binary</code> forms lazy <code>ByteString</code>s, it&#x27;s trivial to serialise the individual parts of the interface file and later concatenate these using <code>ByteString</code>&#x27;s monoid instance - allowing for all of the sections of the file to be defined declaratively at the top-level of the function in order of their appearance within the file.</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">object&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  :: ModuleName                 -- ^ module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt; SymbolTable                -- ^ final symbol table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt; Deps                       -- ^ dependencies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt; [([ShortText],ByteString)] -- ^ serialized units and their exported symbols, the first unit is module-global</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt; ByteString</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object&#x27; mod_name st0 deps0 os = hdr &lt;&gt; symbs &lt;&gt; deps1 &lt;&gt; idx &lt;&gt; mconcat (map snd os)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hdr          = putHeader (Header (moduleNameTag mod_name) (bl symbs) (bl deps1) (bl idx))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bl           = fromIntegral . B.length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deps1        = putDepsSection deps0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (sti, idx)   = putIndex st0 os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbs        = putSymbolTable sti</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In summary, the use of multiple <code>ByteString</code> sections that are later concatenated offer several different structural characteristics compared to the use of a single mutable buffer:</p><ul><li>The final ordering of the sections is flexible, because they are serialsied separately, so any data dependencies don&#x27;t introduce ordering in the file - which we see in the <code>where</code> clause of <code>object&#x27;</code></li><li>Types are more strongly enforced because imperative <code>seekBin</code> instructions aren&#x27;t required. However, each section is still <em>deserialised</em> by taking a substring of the file to be read as that section type. Of course, all serialisation eventually results in raw binary, so the simplification of concatenating the sections into the final file without jumping around limits the places that bugs can hide</li><li>Visually, the ordering of the sections within the final file is very clear - we see in <code>object&#x27;</code> that every section is simply listed <em>in order</em> on one line, concatenated together.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">‚Äã</a></h2><p>Making use of GHC&#x27;s existing infrastructure lets the GHCJS backend to make use of the <code>FastString</code> and <code>Name</code> data types, as well as allowing for the removal of a significant amount of now-redundant code.</p><p>Additionally, interface file generation using GHC&#x27;s <code>Binary</code> appears to be very fast - for example, attempts to hide the handle behind a reader monad significantly reduce the compiler&#x27;s performance as measured by CI. Speculatively, looking at the generated core, this could be because the optimiser has a much better time with the style of IO code that is used - rather than being a limitation of more abstacted approaches.</p><p>The comparison provided the GHCJS&#x27;s old approach makes it clear that GHC&#x27;s <code>Binary</code> implementation, while very useful, has potential to be improved in both readability and extensiblity. However, because CI has shown that serialisation performance has a significant effect on overall compilation performance, this tradeoff must be considered when making any changes. Potentially, these readability shortfalls in GHC&#x27;s implementation might just be the result of legacy code, and so benchmarks of other approaches, such as <code>Data.Binary</code>, should be used to guide future work in improving the readability and flexibility of GHC&#x27;s serialisation without sacrificing performance.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-05-17-javascript-template-haskell-external-interpreter">JavaScript, Template Haskell and the External Interpreter</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-05-17T00:00:00.000Z" itemprop="datePublished">May 17, 2022</time> ¬∑ <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">‚Äã</a></h2><p>At IOG DevX we have been working on integrating various bits of GHCJS into GHC, with the goal of having a fully working JavaScript backend for the 9.6 release. For some parts this has mostly consisted of an update of the code to use the newer GHC API and dependencies. Other bits, like the Template Haskell runner, need more work.</p><p>This post gives an overview of the existing approaches for running Template Haskell in GHC based cross compilers and our plan for the JavaScript backend. Hopefully we can revisit this topic once all the work has been done, and see what exactly we ended up with.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-ghcjs-template-haskell-runner">The GHCJS Template Haskell Runner<a class="hash-link" href="#the-ghcjs-template-haskell-runner" title="Direct link to heading">‚Äã</a></h2><p>When I first worked on Template Haskell (TH) support for GHCJS, there was no mechanism to combine Template Haskell with cross compilation in GHC.</p><p>Normally, Template Haskell is run by loading library code directly into the GHC process and using the bytecode interpreter for the current module. Template Haskell can directly access GHC data structures through the <code>Q</code> monad. Clearly this would not be possible for GHCJS: We only have JavaScript code available for the libraries and the organization of the JavaScript data structures is very different from what GHC uses internally.</p><p>So I had to look for an alternative. Running Template Haskell consists of two parts:</p><ol><li>loading/executing the TH code</li><li>handling compiler queries from the TH code, for example looking up names or types</li></ol><p>Running the TH code can be done by first compiling the Haskell to JavaScript and then using the JavaScript <code>eval</code> feature.</p><p>Template Haskell code can query the compiler using the <code>Quasi</code> typeclass. I noticed that none of the methods required passing around functions or complicated data structures, so it would be possible to serialize each request and response and send it to another process.</p><p>So I went ahead and implemented this approach with a script <code>thrunner.js</code> to load and start the code in a node.js server, a message type with serialization, and a new instance of the <code>Quasi</code> typeclass to handle the communication with the compiler via the messages. This is still what&#x27;s in use by GHCJS to this day. Every time GHCJS encounters Template Haskell, it starts a <code>thrunner</code> process and the compiler communicates with it over a pipe.</p><p>After starting <code>thrunner.js</code> GHCJS sends the Haskell parts of the Template Haskell runnner to the script. This includes the runtime system and the implementation of the <code>Quasi</code> typeclass and communication protocol. After that, the TH session starts. A typical TH session looks as follows:</p><table><thead><tr><th align="left">Compiler</th><th align="left">thrunner</th></tr></thead><tbody><tr><td align="left"><code>RunTH THExp &lt;js code&gt; &lt;source location&gt;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>LookupName (Just &lt;name-string&gt;)</code></td></tr><tr><td align="left"><code>LookupName&#x27; (Just &lt;name&gt;)</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>Reify &lt;name&gt;</code></td></tr><tr><td align="left"><code>Reify&#x27; &lt;name-info&gt;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>RunTH&#x27; &lt;result&gt;</code></td></tr><tr><td align="left"><code>RunTH THDec &lt;js code&gt; &lt;source location&gt;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>AddTopDecls &lt;declarations&gt;</code></td></tr><tr><td align="left"><code>AddTopDecls&#x27;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>RunTH&#x27; &lt;result&gt;</code></td></tr><tr><td align="left"><code>FinishTH True</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>FinishTH&#x27; &lt;memory-consumption&gt;</code></td></tr></tbody></table><p>Each message is followed up by a corresponding reply. For example, a <code>LookupName&#x27;</code> response follows a <code>LookupName</code> request and a <code>RunTH</code> message will eventually generate a <code>RunTH&#x27;</code> result. The first <code>RunTH</code> message contains the compiled JavaScript for the Template Haskell code, along with its dependencies. Each subsequent <code>RunTH</code> only includes dependencies that have not already been sent.</p><p>The <code>thrunner</code> process stays alive during the compilation of at least an entire module, allowing for persistent state (<code>putQ</code>/<code>getQ</code>).</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-ghc-external-interpreter">The GHC External Interpreter<a class="hash-link" href="#the-ghc-external-interpreter" title="Direct link to heading">‚Äã</a></h2><p>If we build a Haskell program with (cost centre) profiling, the layout of our data structures changes to include bookkeeping of cost centre information. This means that we need a special profiling runtime system to run this code.</p><p>What can we do if we want to run our profiled build in GHCi or Template Haskell? We cannot load compiled profiling libraries into GHC directly; its runtime system expects non-profiled code. We could use a profiled version of the compiler itself, but this would make all compilation very slow. Or we could somehow separate the profiled code of our own program from the non-profiled code in the compiler.</p><p>This was Simon Marlow&#x27;s motivation for adapting the GHCJS <code>thrunner</code> approach, integrating in GHC and extending it it to support GHCi and bytecode. This functionality can be activated with the <code>-fexternal-interpreter</code> flag and has been available since GHC version 8.0.1. When the external interpreter is activated, GHC starts a separate process, <code>iserv</code> (customizable with the <code>-pgmi</code> flag) which has the role analogous to the <code>thrunner</code> script for GHCJS.</p><p>Over time, the <code>iserv</code> code has evolved with GHC and has been extended to include more operations. By now, there are quite a few differences in features:</p><table><thead><tr><th align="left">Feature</th><th align="center">thrunner</th><th align="center">iserv</th></tr></thead><tbody><tr><td align="left">Template Haskell support</td><td align="center">yes</td><td align="center">yes</td></tr><tr><td align="left">GHCi</td><td align="center">no</td><td align="center">yes</td></tr><tr><td align="left">Debugger</td><td align="center">no</td><td align="center">yes</td></tr><tr><td align="left">Bytecode</td><td align="center">no</td><td align="center">yes</td></tr><tr><td align="left">Object code</td><td align="center">through pipe</td><td align="center">from file</td></tr><tr><td align="left">Object code linking</td><td align="center">compiler</td><td align="center">iserv process</td></tr></tbody></table><p><code>thrunner</code> is not quite as complete as <code>iserv</code>: It lacks GHCi and the debugger, and there is no bytecode support. But these features are not essential for basic Template Haskell.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="proxies-and-bytecodes">Proxies and Bytecodes<a class="hash-link" href="#proxies-and-bytecodes" title="Direct link to heading">‚Äã</a></h2><p>We have now seen two systems for running Template Haskell code outside the compiler process: The original GHCJS <code>thrunner</code> and the extended GHC <code>iserv</code>.</p><p>Clearly it isn&#x27;t ideal to have multiple &quot;external interpreter&quot; systems in GHC, therefore we plan to switch from <code>thrunner</code> to <code>iserv</code> for the upcoming JavaScript GHC backend. We don&#x27;t need the debugger or GHCi support yet, but we do need to adapt to other changes in the infrastructure. So what does this mean in practice?</p><p>The biggest change is that we have to rework the linker: <code>thrunner</code> does not contain any linking logic by itself: GHCJS compiles everything to JavaScript and sends compiled code to the <code>thrunner</code> process, ready to be executed. In contrast, <code>iserv</code> has a loader for object and archive files. When dependencies need to be loaded into the interpreter, GHC just gives it the file name.</p><p>Another change is using the updated message types. In the <code>thrunner</code> session example above we could see that each message is paired with a response. For example a <code>RunTH&#x27;</code> response always follows a <code>RunTH</code> message, with possibly other messages in between. <code>iserv</code> has an interesting approach for the <code>Message</code> datatype: Instead of having pairs of data constructors for each message and its response, <code>iserv</code> has a GADT <code>Message a</code>, where the <code>a</code> type parameter indicates the expected response payload for each data constructor.</p><p>During development of the <code>thrunner</code> program it turned out to be very useful to save and replay Template Haskell sessions for debugging purposes. We&#x27;d like to do this again, but now saving the message in a readable/writable format. Since we&#x27;re dealing with JavaScript, JSON appears to be the obvious choice.</p><p>Our plan is to have an <code>iserv</code> implementation that consists of a JavaScript part that runs in node.js and a proxy process to handle communication with GHC. The proxy process converts the messages between GHC&#x27;s own (<code>binary</code> based) serialization format and JSON. The proxy process is relatively simple, but it does reveal one downside of the new GADT based message types: A proxy is stateful. We must always know which message we have sent to convert the response back from JSON to <code>binary</code>.</p><p>It&#x27;s not yet known whether we will implement a full bytecode interpreter. We expect it to become clear during implementation whether we can get away without one early on.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">‚Äã</a></h2><p>We have seen how Template Haskell and GHCi code can be run outside the GHC process for profiling or cross compiling, with both the <code>thrunner</code> approach in GHCJS and the newer <code>iserv</code> in GHC.</p><p>We at IOG DevX are working on switching to the <code>iserv</code> infrastructure for the upcoming GHC JavaScript backend, which involves a substantial rewrite, mainly because of differences in linking. This is a work in progress, and we intend to revisit this topic in another blog post once the final design has been implemented.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghcjs">ghcjs</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/tooling">tooling</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/profiling">profiling</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/ghc-update-2022-04">GHC April 2022 Update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-05-13T00:00:00.000Z" itemprop="datePublished">May 13, 2022</time> ¬∑ <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Welcome to the (rather late) April 2022 monthly update from the GHC DevX team at IOG. Since the last update we&#x27;ve continued work on the upcoming JavaScript backend for GHC. Unfortunately, we have nothing to show quite yet but that doesn&#x27;t mean nothing has happened! On the contrary, we&#x27;ve made great progress and are close to that crucial first milestone <code>hello world</code>. Besides our work on the JavaScript backend, we were pleased to finally push through the <a href="https://hsyl20.fr/home/posts/2022-05-03-modularizing-ghc-paper.html" target="_blank" rel="noopener noreferrer">Modularizing GHC</a> paper that Sylvain has been working on for 2+ years! It causes quite the splash on the Haskell discourse and reddit, we recommend reading it if you haven&#x27;t already (links below). Alright, enough introduction let&#x27;s get into the update.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript Backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">‚Äã</a></h2><p>We have made the following progresses in the implementation of a JavaScript
backend for GHC (adapted from GHCJS):</p><ul><li><p><strong>linker</strong>: ported GHCJS&#x27;s linker code into GHC. A lot of code was duplicated from GHC and
slightly modified for GHCJS&#x27;s needs, making the process far from trivial.</p></li><li><p><strong>testsuite</strong>: fixed Hadrian to run GHC&#x27;s testsuite with cross-compilers
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7850" target="_blank" rel="noopener noreferrer">!7850</a>. There are
remaining issues though (see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/21292" target="_blank" rel="noopener noreferrer">#21292</a>).</p></li><li><p><strong>build system</strong>: fixes for GHC&#x27;s configure script were ported (e.g. support for
the &quot;ghcjs&quot; target in <code>config.sub</code>). GHCJS&#x27;s custom
build script was integrated into <code>configure.ac</code>. We can now
configure the build with: <code>./configure --target=js-unknown-ghcjs</code></p></li><li><p><strong>TH</strong>: we have conducted some experiments to find the best way to bridge GHCJS&#x27;s
TH runner and GHC&#x27;s external interpreter. This will be described in details in
a future blog post.</p></li><li><p><strong>FFI</strong>: basic support for JavaScript FFI has been ported from GHCJS to GHC. We
haven&#x27;t ported the JavaScript parser, so we have dropped the fancy import
syntax (e.g. &quot;$1.xyz&quot;). It should be enough to build boot libraries and we
will add JS parsing support later.</p></li></ul><p>At this stage, we are working on building boot libraries and on supporting
linking with the JS RTS.</p><p>Development happens in the following branch: <a href="https://gitlab.haskell.org/ghc/ghc/-/tree/wip/js-staging" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/tree/wip/js-staging</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="modularity-paper">Modularity paper<a class="hash-link" href="#modularity-paper" title="Direct link to heading">‚Äã</a></h2><p>Sylvain, Jeffrey, and John Ericson (from Obsidian Systems) wrote a paper about
&quot;modularizing GHC&quot; using domain-driven design.</p><ul><li>Announce blog post: <a href="https://hsyl20.fr/home/posts/2022-05-03-modularizing-ghc-paper.html" target="_blank" rel="noopener noreferrer">https://hsyl20.fr/home/posts/2022-05-03-modularizing-ghc-paper.html</a></li><li>Paper: <a href="https://hsyl20.fr/home/files/papers/2022-ghc-modularity.pdf" target="_blank" rel="noopener noreferrer">https://hsyl20.fr/home/files/papers/2022-ghc-modularity.pdf</a></li><li>Reddit: <a href="https://www.reddit.com/r/haskell/comments/uhdu4l/modularizing_ghc_paper/" target="_blank" rel="noopener noreferrer">https://www.reddit.com/r/haskell/comments/uhdu4l/modularizing_ghc_paper/</a></li><li>Discourse: <a href="https://discourse.haskell.org/t/modularizing-ghc-paper/4471" target="_blank" rel="noopener noreferrer">https://discourse.haskell.org/t/modularizing-ghc-paper/4471</a></li></ul><p>We&#x27;ve got a lot of great feedback about it (expect a first revision soon).
We also got a GHC contribution directly inspired by the paper (see
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/8160" target="_blank" rel="noopener noreferrer">!8160</a>) which was
very welcome!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-05-02-setup-ext-stg-interp">Setting up Csaba&#x27;s External STG Interpreter</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-05-02T00:00:00.000Z" itemprop="datePublished">May 2, 2022</time> ¬∑ <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="table-of-contents">Table of Contents<a class="hash-link" href="#table-of-contents" title="Direct link to heading">‚Äã</a></h2><ul><li><a href="#orgfeb334e">Making sense of the project</a></li><li><a href="#org1d461dc">Building a working external STG interpreter</a><ul><li><a href="#orgb670539">ghc.nix</a></li><li><a href="#orgbb3f1d5">Building ghc-wpc</a></li><li><a href="#org9ef4bc5">Building the stg tooling</a></li></ul></li><li><a href="#org4a2eaf9">Building the external-stg-interpreter</a></li><li><a href="#org1d34a2e">Linking the external-stg-interpreter</a></li><li><a href="#org2daa4b8">The whole setup process on a demo</a></li><li><a href="#org8193a1a">Summary</a><ul><li><a href="#org940ba90">File Descriptions</a></li><li><a href="#org8e9f409">Step-by-Step guide for running the interpreter on your code</a></li></ul></li></ul><p>Haskell is a great language camouflaged by lackluster tooling. This situation
has led to well-known problems (who could forget Cabal hell?). A less discussed
problem is what I will call the <!-- -->‚Äú<!-- -->Black-box syndrome<!-- -->‚Äù<!-- -->: It is hard to
know <em>exactly</em> what the memory representation and runtime performance of my
Haskell programs are<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>. Now black-box syndrome is not <em>only</em> a problem,
it is also one of the nice features in the language since like all good
abstractions it elides things I<!-- -->‚Äô<!-- -->d rather not care about, at least most of
the time. In other words, I am happy I don<!-- -->‚Äô<!-- -->t have to do manual memory
manipulation!</p><p>However, when I have my optimization hat on, I run face first into black-box syndrome. The crux of the problem is a tension between the need for observation during performance engineering and optimization, and the need to ship fast code. During development we want to be able to open up a system, see exactly how it is working, make tweaks, package it back up and test again. I want to be able to answer questions like <!-- -->‚Äú<!-- -->Why is my executable this size?<!-- -->‚Äù<!-- -->, <!-- -->‚Äú<!-- -->Which code is a hot loop?<!-- -->‚Äù<!-- -->, or <!-- -->‚Äú<!-- -->When does my code do direct, known or unknown function calls?<!-- -->‚Äù<!-- -->.</p><p>In order to answer these questions we need the ability to observe <em>every part of that system as the machine experiences it</em>, without this ability we have no way to make progress other than test, change some code, compile and test again in an ad-hoc manner. And therein lies the problem, most Haskell tooling is insufficient to provide the observability that we would like, instead the tooling often expects and requires us to make source code changes to our program or even recompile all of our libraries and code for a profiling way. This leads to the idea and <em>the expectation</em> in the Haskell community that Haskell programs are hard to optimize because the barrier to entry for optimization has artificially increased.</p><p><a href="https://www.patreon.com/csaba_hruska" target="_blank" rel="noopener noreferrer">Csaba Hruska</a> has recently been making headway in this area with his work on the <a href="https://youtu.be/iXhh0NSR67k" target="_blank" rel="noopener noreferrer">GRIN</a> compiler and an external STG interpreter. His STG interpreter (and patched ghc) exactly solve these problems and he has demonstrated dumping the entire call graph of large Haskell projects, filter to hot loops and finding unknown function calls in these graphs. If you haven<!-- -->‚Äô<!-- -->t seen his <a href="https://www.youtube.com/watch?v=wt6iCgYmVGA&amp;t=2054s" target="_blank" rel="noopener noreferrer">demo</a> be sure to watch it, it is well worth your time.</p><p>This post is the first in a new blog series. In this blog series we<!-- -->‚Äô<!-- -->re going to kick the tires on the external STG interpreter see what it can do, and what we can uncover in some popular libraries by using it. In particular, I<!-- -->‚Äô<!-- -->m interested in running it on projects I<!-- -->‚Äô<!-- -->ve previously optimized<!-- -->‚Äî<!-- -->such as ghc itself, containers, unordered-containers<!-- -->‚Äî<!-- -->using the standard methods: ticky-ticky profiling, prof, flamegraphs, heap profiling, ghc-debug, cachegrind etc. This post, however, will be focused on setting up the patched ghc and interpreter on a NixOS system. My goals are threefold:</p><ol><li>Give an overview of the project and project layout to lower barrier to entry for the system.</li><li>Give step by step instructions on setting up the interpreter on a nix-based system and provide a forked github repo for nix users. This should allow nix users to just <code>git clone foo</code> and <code>nix-build</code> (spoiler: it won<!-- -->‚Äô<!-- -->t be that easy but still not hard.)</li><li>Popularize Csaba<!-- -->‚Äô<!-- -->s project! It is a refreshing take on Haskell optimization and compilation.</li></ol><a id="orgfeb334e"></a><h1>Making sense of the project</h1><p>The external STG interpreter is part of the <a href="https://github.com/grin-compiler" target="_blank" rel="noopener noreferrer">GRIN compiler</a> project. We are not doing anything with the GRIN compiler (yet!) and so we are only interested in <a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project" target="_blank" rel="noopener noreferrer">The GHC whole compiler project</a>. The whole-compiler-project has several sub-projects that we<!-- -->‚Äô<!-- -->ll be building and using directly:</p><ul><li><a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/tree/master/external-stg" target="_blank" rel="noopener noreferrer">external-stg</a>: This subproject provides utilites we<!-- -->‚Äô<!-- -->ll be using, in particular <code>mkfullpak</code></li><li><a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/tree/master/external-stg-interpreter" target="_blank" rel="noopener noreferrer">external-stg-interpreter</a>: This is the actual STG interpreter. The good news is that this is independent of the rest of the project and can be built just like a regular Haskell executable</li><li><a href="https://github.com/grin-compiler/ghc-wpc/tree/b51ab235f5c07caa5eb3dd3b40487f67f50fb838" target="_blank" rel="noopener noreferrer">ghc-wpc</a>: This is a fork of <code>ghc-8.10.x</code> (I<!-- -->‚Äô<!-- -->m not sure exactly which version it forks to be honest) which we must build in order to use the external STG interpreter. Ghc-wpc serves as a frontend for the external-stg-interpreter.</li></ul><a id="org1d461dc"></a><h1>Building a working external STG interpreter</h1><p>The external STG interpreter can be built like any regular haskell executable. But in order to use the interpreter we have to build <code>ghc-wpc</code>. <code>ghc-wpc</code> is necessary because it serves as a frontend for the STG interpreter. It compiles a Haskell program like normal and then dumps an enriched STG IR to file. This file is then run through a utility <code>gen-exe</code> (gen-exe is an executable built in the <a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/tree/master/external-stg-compiler" target="_blank" rel="noopener noreferrer">external-stg-compiler</a> sub-project) which picks up the compilation pipeline from the STG IR and creates an executable like we would expect from a normal compilation pipeline.</p><p>The major difference between this process and the usual compiler pipeline is that <code>ghc-wpc</code> leaves enough compiler information on disk for the rest of the tooling to consume, namely, in files with a <code>*.o_stgbin</code> (this is STG IR generated at compile time), and <code>*.o_stgapp</code> (project linker and dependency information) extension. Thus, once we build this custom ghc version we can use it to build the source code we wish to analyze and begin our optimization work.</p><p>For the rest of this tutorial I<!-- -->‚Äô<!-- -->ll be referencing my <a href="https://github.com/doyougnu/ghc-whole-program-compiler-project" target="_blank" rel="noopener noreferrer">fork</a> of the <code>ghc-whole-compiler-project</code> that includes everything you need if you want to follow along, including <code>.nix</code> files for creating a <code>nix-shell</code> which will prepare a suitable environment to run the entire toolchain.</p><a id="orgb670539"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghcnix">ghc.nix<a class="hash-link" href="#ghcnix" title="Direct link to heading">‚Äã</a></h2><p>The usual way to build ghc using a nix based system is with the <a href="https://github.com/alpmestan/ghc.nix" target="_blank" rel="noopener noreferrer">ghc.nix</a> project. Ghc.nix provides a <code>default.nix</code> with a suitable environment to run hadrian and build ghc. For <code>ghc-wpc</code> we<!-- -->‚Äô<!-- -->ll need some special packages, and we need our boot compiler to be <em>exactly</em> <code>ghc-8.3.3</code>. The custom <code>ghc.nix</code> file is included in my fork, I<!-- -->‚Äô<!-- -->ve taken the liberty to pin the nixpkgs to the right version for <code>ghc-8.3.3</code>. So let<!-- -->‚Äô<!-- -->s begin:</p><p>Clone the forked repo:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/doyougnu/ghc-whole-program-compiler-project.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ghc-whole-program-compiler-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tree -L </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ dist-newstyle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ external-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ external-stg-compiler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ external-stg-interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ ghc.nix.wpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ ghc-wpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ lambda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ mod-pak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ shell.nix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îú‚îÄ‚îÄ stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚îî‚îÄ‚îÄ stack.yaml.lock</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You<!-- -->‚Äô<!-- -->ll find the patched <code>ghc.nix</code> included (<code>ghc.nix.wpc</code>) and a <code>shell.nix</code> for a <code>nix-shell</code>. The <code>shell.nix</code> file simply references <code>ghc.nix.wpc/default.nix</code> with the appropriate options:</p><div class="codeBlockContainer_I0IT language-nix theme-code-block"><div class="codeBlockContent_wNvx nix"><pre tabindex="0" class="prism-code language-nix codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat shell.nix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import (./ghc.nix.wpc/default.nix) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">useClang = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">withHadrianDeps = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">withIde   = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">withLlvm  = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><a id="orgbb3f1d5"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-ghc-wpc">Building ghc-wpc<a class="hash-link" href="#building-ghc-wpc" title="Direct link to heading">‚Äã</a></h2><p>Now we can enter a nix-shell and build <code>ghc-wpc</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">pwd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/doyougnu/programming/haskell/ghc-whole-program-compiler-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ nix-shell shell.nix  </span><span class="token comment" style="color:#999988;font-style:italic"># or just nix-shell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trace: checking </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> /home/doyougnu/programming/haskell/ghc-whole-program-compiler-project/hadrian/hadrian.cabal is present:  no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Recommended ./configure arguments </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">found </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$CONFIGURE_ARGS</span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or use the configure_ghc </span><span class="token builtin class-name">command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sznfxigwvrvn6ar3nz3f0652zsld9xqj-gmp-6.2.0-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/447im4mh8gmw85dkrvz3facg1jsbn6c7-gmp-6.2.0/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/84g84bg47xxg01ba3nv0h418v5v3969n-ncurses-6.1-20190112-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/xhhkr936b9q5sz88jp4l29wljbbcg39k-ncurses-6.1-20190112/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-dwarf-unwind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell/ghc-whole-program-compiler-project</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we need to <code>cd</code> into <code>ghc-wpc</code> and tweak the hadrian build.</p><p><strong>MAJOR CONSTRAINT: You must build ghc-wpc with hadrian/build-stack</strong>, if you build in any other way you<!-- -->‚Äô<!-- -->ll run into shared object errors, see this <a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/issues/4" target="_blank" rel="noopener noreferrer">ticket</a> for details.</p><p>So in order to build <code>ghc-wpc</code> with stack we<!-- -->‚Äô<!-- -->ll have to tweak the <code>stack.yaml</code> file. <strong>You must do this since it is not included in the fork</strong>:</p><p>Quick side note: To make the formatting nicer I truncate
<code>nix-shell:~/foo/bar/baz/ghc-whole-program-compiler-project</code> to just <code>...</code>, so
<code>nix-shell:.../ghc-wpc</code> is equivalent to
<code>~/path/to/ghc-whole-compiler-project/ghc-wpc</code>.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ghc-wpc/hadrian/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc/hadrian</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resolver: lts-15.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- </span><span class="token string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- </span><span class="token string" style="color:#e3116c">&#x27;GHC-Cabal&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">system-ghc: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nix:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   enable: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   shell-file: </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/shell.nix</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The changes are: (1) tell <code>stack</code> we are using <code>nix</code>, and (2) reference the <code>shell.nix</code> file which points to <code>ghc.wpc.nix</code> at the root of the project, i.e., <code>ghc-whole-program-compiler-project/shell.nix</code>.</p><p>Now we should be able to begin our build, return to the root of <code>ghc-wpc</code> and run the following:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc/hadrian</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./boot </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> ./configure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ hadrian/build-stack -j</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>and go get some coffee since this will take some time. Once it finishes you should have the <code>ghc-wpc</code> binary in <code>_build/stage1/bin</code></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l _build/stage1/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">8592</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1843752</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 ghc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">11082</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 ghc.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">660128</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:50 ghc-pkg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">9977</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:50 ghc-pkg.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4624680</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 haddock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">16883</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 haddock.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">49344</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:25 hp2ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">2504</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:25 hp2ps.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">716440</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">9959</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hpc.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">738544</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hsc2hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10264</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hsc2hs.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">58384</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:34 runghc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">8864</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:34 runghc.dyn_o_ghc_stgapp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that this build dumped <code>*.&lt;way&gt;_o_ghc_stgapp</code> files!</p><a id="org9ef4bc5"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-the-stg-tooling">Building the stg tooling<a class="hash-link" href="#building-the-stg-tooling" title="Direct link to heading">‚Äã</a></h2><p>Now that we have a working <code>ghc-wpc</code> we need to build the rest of the project by pointing <code>stack</code> to the <code>ghc-wpc</code> binary in <code>ghc-wpc/_build/stage1/bin</code>. That is, we must change the <code>ghc-whole-program-compiler-project/stack.yaml</code> file:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell/ghc-whole-program-compiler-project</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resolver: lts-16.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allow-newer: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;external-stg-compiler&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;external-stg&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ghc-options:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$everything</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> -fno-stgbin -fno-stgapp -optcxx-std</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">c++17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra-deps:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - async-pool-0.9.1@sha256:4015140f896c3f1652b06a679b0ade2717d05557970c283ea2c372a71be2a6a1,1605</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - souffle-haskell-1.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - zip-1.7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># use custom ext-stg whole program compiler GHC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compiler:     ghc-8.11.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skip-ghc-check: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nix:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enable: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># use local GHC (for development)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">system-ghc: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra-path:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - /home/doyougnu/programming/haskell/ghc-whole-program-compiler-project/ghc-wpc/_build/stage1/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># DEBUG INFO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#dump-logs: all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#build:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  keep-tmp-files: true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  cabal-verbose: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The changes are: (1) set <code>compiler: ghc-8.11.0</code> (the <code>ghc-wpc</code> fork), (2) set <code>skip-ghc-check: true</code> so that stack doesn<!-- -->‚Äô<!-- -->t complain about the ghc version, (3) set <code>nix.enable: false</code>, confusingly if you leave this as true then stack will try to use <code>nixpkgs</code> to get a ghc binary, but we want it to use our local binary so we disable this even though we<!-- -->‚Äô<!-- -->ll still be in our original nix-shell (4) set <code>system-path: true</code> to tell stack we will be using a ghc we have on our system, and finally (5) set <code>extra-path: &lt;path-to-ghc-wpc-binary&gt;</code>.</p><p>Now we can run stack and install the stg tooling:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ stack --stack-root </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain">/.stack-root </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trouble loading CompilerPaths cache: UnliftIO.Exception.throwString called with:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Compiler </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> metadata mismatch, ignoring cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Called from:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throwString </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">src/Stack/Storage/User.hs:277:8 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> stack-2.7.5-9Yv1tjrmAU3JiZWCo86ldN:Stack.Storage.User</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Ignoring tagged</span><span class="token string" style="color:#e3116c">&#x27;s bounds on template-haskell (&gt;=2.8 &amp;&amp; &lt;2.17); using template-haskell-2.17.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">WARNING: Ignoring aeson&#x27;</span><span class="token plain">s bounds on template-haskell </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">2.9</span><span class="token plain">.0.0 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">2.17</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> using template-haskell-2.17.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Ignoring th-abstraction</span><span class="token string" style="color:#e3116c">&#x27;s bounds on template-haskell (&gt;=2.5 &amp;&amp; &lt;2.17); using template-haskell-2.17.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">WARNING: Ignoring unliftio-core&#x27;</span><span class="token plain">s bounds on base </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">4.5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">4.14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> using base-4.14.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Ignoring souffle-haskell&#x27;s bounds on megaparsec </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">7.0</span><span class="token plain">.5 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> using megaparsec-8.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stack --stack-root </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain">/.stack-root </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token comment" style="color:#999988;font-style:italic"># bunch of output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copied executables to /home/doyougnu/.local/bin:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- dce-fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ext-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-exe2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-obj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-obj2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- mkfullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- show-ghc-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Installation path /home/doyougnu/.local/bin not found on the </span><span class="token environment constant" style="color:#36acaa">PATH</span><span class="token plain"> environment variable.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can add <code>~/.local/bin</code> to your <code>PATH</code> if you want, I<!-- -->‚Äô<!-- -->ll just be directly referencing these binaries as we go.</p><a id="org4a2eaf9"></a><h1>Building the external-stg-interpreter</h1><p>We are almost all done, all that is left is to build the external-stg-interpreter and run a small script that links everything together into a shared object for the interpreter. So:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> external-stg-interpreter/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ stack </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.  </span><span class="token comment" style="color:#999988;font-style:italic"># bunch of output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copied executables to /home/doyougnu/.local/bin:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ext-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ext-stg-interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- mkfullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Installation path /home/doyougnu/.local/bin not found on the </span><span class="token environment constant" style="color:#36acaa">PATH</span><span class="token plain"> environment variable.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we have our <code>ext-stg-interpreter</code> built! There are a few caveats I want to point out here. I<!-- -->‚Äô<!-- -->ve modified <code>ghc-whole-program-compiler-project/external-stg-interpreter/stack.yaml</code> to load the right packages and use nix:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resolver: lts-16.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;external-stg&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra-deps:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - souffle-haskell-2.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - primitive-0.7.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - zip-1.7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nix:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enable: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  packages: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> zlib, libffi, pkg-config, </span><span class="token function" style="color:#d73a49">bzip2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice the <code>nix:</code> block. We could have just as easily built this using <code>nix</code> directly or using our <code>shell.nix</code> file.</p><a id="org1d34a2e"></a><h1>Linking the external-stg-interpreter</h1><p>The only task left is to link into a shared object library called
<code>libHSbase-4.14.0.0.cbits.so</code>. To do that we need to use the script called, <code>c</code>,
in <code>ghc-whole-program-compiler-project/external-stg-interpreter/data</code>. This
script is a bit of a hack, it generates the shared object file so that we can link the symbols requested by the C
FFI in <code>base</code>, but it populates those functions with our replacements, which do absolutely nothing. For example, we supply a fake garbage collect:</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// in .../external-stg-interpreter/data/cbits.so-script/c-src/fake_rts.c</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">performGC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">performMajorGC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This works because we won&#x27;t be using the runtime system at all, we&#x27;ll be using
the external STG interpreter instead, however we still need to provide these
symbols in order to link. *<strong>*MAJOR NOTE: this file must be next to any
<!-- -->*<!-- -->.fullpak file you<!-- -->‚Äô<!-- -->ll be running the interpreter on**</strong> or else
you<!-- -->‚Äô<!-- -->ll get an undefined symbol error during linking, for example:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cbits.so-script  ghc-rts-base.fullpak  minigame-strict.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### notice no .so file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ~/.local/bin/ext-stg-interpreter ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ext-stg-interpreter: user error </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dlopen: ./libHSbase-4.14.0.0.cbits.so: cannot </span><span class="token function" style="color:#d73a49">open</span><span class="token plain"> shared object file: No such </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> or directory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## we error&#x27;d out because it was missing, also</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## if you get this error then you have an old cbits.so file and need to rerun the c script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ~/.local/bin/ext-stg-interpreter ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ext-stg-interpreter: user error </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dlopen: ./libHSbase-4.14.0.0.cbits.so: undefined symbol: getProcessElapsedTime</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To link the interpreter we need to run <code>c</code> in the <code>data/cbits.so-script</code> sub-folder:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> data/cbits.so-script/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ar  c  cbits-rts.dyn_o  c-src  libHSbase-4.14.0.0.cbits.so  stub-base.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> ar/libHSbase-4.14.0.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSbindings-GLFW-3.3.2.0-Jg9TvsfYUZwD0ViIP0H2Tz-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSbytestring-0.10.9.0-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHScriterion-measurement-0.1.2.0-73BCI2Fnk7qE8QjjTa1xNa-ghc8.11.0.20210324.dyn_o_cbits.a ar/libHSghc-8.11.0.20210306-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20210324.dyn_o_stubs.a ar/libHShashable-1.3.0.0-Kn7aNSFvzgo2qY16wYzuCX-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSinteger-gmp-1.0.3.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSlambdacube-quake3-engine-0.1.0.0-7CKLP3Rqgq0PR81lhlwlR-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSmersenne-random-pure64-0.2.2.0-ExYg8DmthtrLG9JevQbt2m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSOpenGLRaw-3.3.4.0-5vXBlmbOM3AIT7GRYfpE3o-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSprimitive-0.7.0.1-2k3g9qX0zz16vEv34R307m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSprocess-1.6.8.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHStext-1.2.4.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_stubs.a ar/libHSzlib-0.6.2.1-1I6DmfbLEyTBgDZI7SbZfW-ghc8.11.0.20210306.dyn_o_stubs.a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> stub-base.dyn_o/Blank_stub.dyn_o stub-base.dyn_o/ClockGetTime_stub.dyn_o stub-base.dyn_o/Internals_stub.dyn_o stub-base.dyn_o/RUsage_stub.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> cbits-rts.dyn_o/StgPrimFloat.dyn_o cbits-rts.dyn_o/TTY.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> c-src/fake_rts.c c-src/hack.c c-src/hschooks.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ gcc -o libHSbase-4.14.0.0.cbits.so -shared -Wl,--whole-archive ar/libHSbase-4.14.0.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSbindings-GLFW-3.3.2.0-Jg9TvsfYUZwD0ViIP0H2Tz-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSbytestring-0.10.9.0-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHScriterion-measurement-0.1.2.0-73BCI2Fnk7qE8QjjTa1xNa-ghc8.11.0.20210324.dyn_o_cbits.a ar/libHSghc-8.11.0.20210306-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20210324.dyn_o_stubs.a ar/libHShashable-1.3.0.0-Kn7aNSFvzgo2qY16wYzuCX-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSinteger-gmp-1.0.3.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSlambdacube-quake3-engine-0.1.0.0-7CKLP3Rqgq0PR81lhlwlR-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSmersenne-random-pure64-0.2.2.0-ExYg8DmthtrLG9JevQbt2m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSOpenGLRaw-3.3.4.0-5vXBlmbOM3AIT7GRYfpE3o-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSprimitive-0.7.0.1-2k3g9qX0zz16vEv34R307m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSprocess-1.6.8.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHStext-1.2.4.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_stubs.a ar/libHSzlib-0.6.2.1-1I6DmfbLEyTBgDZI7SbZfW-ghc8.11.0.20210306.dyn_o_stubs.a -Wl,--no-whole-archive stub-base.dyn_o/Blank_stub.dyn_o stub-base.dyn_o/ClockGetTime_stub.dyn_o stub-base.dyn_o/Internals_stub.dyn_o stub-base.dyn_o/RUsage_stub.dyn_o cbits-rts.dyn_o/StgPrimFloat.dyn_o cbits-rts.dyn_o/TTY.dyn_o -fPIC c-src/fake_rts.c c-src/hack.c c-src/hschooks.c -lm -lgmp -ltinfo -lGL -lX11 -lXi -lXrandr -lXxf86vm -lXcursor -lXinerama -lpthread</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This will produce <code>libHSbase-4.14.0.0.cbits.so</code> in the immediate directory:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">984</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 ar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 cbits-rts.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 c-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">986008</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:50 libHSbase-4.14.0.0.cbits.so    </span><span class="token comment" style="color:#999988;font-style:italic">## &lt;----- new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 stub-base.dyn_o</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we can test our interpreter by running it on the <code>*.fullpak</code> files in <code>external-stg-interpreter/data</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cbits.so-script  ghc-rts-base-call-graph-summary  ghc-rts-base-call-graph.tsv  ghc-rts-base.fullpak  libHSbase-4.14.0.0.cbits.so  minigame-strict.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## remove the old .so file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## soft-link to the one we just built</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ln</span><span class="token plain"> -s cbits.so-script/libHSbase-4.14.0.0.cbits.so libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">79220</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:50 cbits.so-script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:47 ghc-rts-base-call-graph-summary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">28238</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:47 ghc-rts-base-call-graph.tsv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22450708</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">43</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:55 libHSbase-4.14.0.0.cbits.so -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cbits.so-script/libHSbase-4.14.0.0.cbits.so  </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">58630129</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 minigame-strict.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ~/.local/bin/ext-stg-interpreter ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssHeapStartAddress: </span><span class="token number" style="color:#36acaa">53522</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssTotalLNECount: </span><span class="token number" style="color:#36acaa">69</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssClosureCallCounter: </span><span class="token number" style="color:#36acaa">360</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">executed closure </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> count: </span><span class="token number" style="color:#36acaa">114</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call graph size: </span><span class="token number" style="color:#36acaa">150</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">79220</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:50 cbits.so-script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:56 ghc-rts-base-call-graph-summary    </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">28238</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:56 ghc-rts-base-call-graph.tsv        </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22450708</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">43</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:55 libHSbase-4.14.0.0.cbits.so -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cbits.so-script/libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">58630129</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 minigame-strict.fullpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And it works, we have two new files, <code>&lt;foo&gt;-call-graph-summary</code> and <code>&lt;foo&gt;-call-graph.tsv</code> which we can analyze to inspect the behavior of our program (more on this later).</p><a id="org2daa4b8"></a><h1>The whole setup process on a demo</h1><p>That was a rather involved example, to make clear the dependencies and steps required to run this on your own code the rest of this tutorial will run the interpreter on two of Csaba<!-- -->‚Äô<!-- -->s demo<!-- -->‚Äô<!-- -->s from his skillshare talk. First let<!-- -->‚Äô<!-- -->s grab the code:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">pwd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/doyougnu/programming/haskell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/grin-compiler/ext-stg-interpreter-presentation-demos.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ext-stg-interpreter-presentation-demos ghc-whole-program-compiler-project </span><span class="token punctuation" style="color:#393A34">..</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we<!-- -->‚Äô<!-- -->ll run the first demo which is a simply fold over a list:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ nix-shell ghc-whole-program-compiler-project/shell.nix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trace: checking </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> /home/doyougnu/programming/haskell/hadrian/hadrian.cabal is present:  no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Recommended ./configure arguments </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">found </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$CONFIGURE_ARGS</span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or use the configure_ghc </span><span class="token builtin class-name">command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sznfxigwvrvn6ar3nz3f0652zsld9xqj-gmp-6.2.0-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/447im4mh8gmw85dkrvz3facg1jsbn6c7-gmp-6.2.0/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/84g84bg47xxg01ba3nv0h418v5v3969n-ncurses-6.1-20190112-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/xhhkr936b9q5sz88jp4l29wljbbcg39k-ncurses-6.1-20190112/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-dwarf-unwind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ext-stg-interpreter-presentation-demos/demo-01-tsumupto/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell/ext-stg-interpreter-presentation-demos/demo-01-tsumupto</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/ghc-wpc/_build/stage1/bin/ghc -O2 tsumupto.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> of </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Compiling Main             </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> tsumupto.hs, tsumupto.o </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Linking tsumupto </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ext-stg-interpreter-presentation-demos/demo-01-tsumupto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsumupto  tsumupto.hi  tsumupto.hs  tsumupto.o  tsumupto.o_ghc_stgapp  tsumupto.o_modpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note, that we have two new files: <code>*.o_ghc_stgapp</code> and <code>.o_modpak</code> as a result of building with <code>ghc-wpc</code>. If you try to run this from outside the nix-shell you<!-- -->‚Äô<!-- -->ll get an error about missing <code>mkmodpak</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/ghc-wpc/_build/stage1/bin/ghc -O2 tsumupto.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> of </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Compiling Main             </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> tsumupto.hs, tsumupto.o </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ghc: could not execute: mkmodpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now that we have those files we can run the interpreter, but first though we need to make a <code>*.fullpak</code> file from the <code>*.o_ghc_stgapp</code> file and create a symbolic link to <code>libHSbase-4.14.0.0.cbits.so</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## make the fullpack file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ~/.local/bin/mkfullpak tsumupto.o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">all modules: </span><span class="token number" style="color:#36acaa">259</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app modules: </span><span class="token number" style="color:#36acaa">113</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app dependencies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token comment" style="color:#999988;font-style:italic"># bunch of output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main                                                         Main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">creating tsumupto.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## create the link to the shared object file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ln</span><span class="token plain"> -s </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/external-stg-interpreter/data/cbits.so-script/libHSbase-4.14.0.0.cbits.so libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## the final directory should look like this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libHSbase-4.14.0.0.cbits.so  tsumupto  tsumupto.fullpak  tsumupto.hi  tsumupto.hs  tsumupto.o  tsumupto.o_ghc_stgapp  tsumupto.o_modpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And now we can run the interpreter:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ~/.local/bin/ext-stg-interpreter tsumupto.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">50005000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssHeapStartAddress: </span><span class="token number" style="color:#36acaa">44082</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssTotalLNECount: </span><span class="token number" style="color:#36acaa">43</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssClosureCallCounter: </span><span class="token number" style="color:#36acaa">30275</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">executed closure </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> count: </span><span class="token number" style="color:#36acaa">112</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call graph size: </span><span class="token number" style="color:#36acaa">146</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The first line is the output of the program and the rest are diagnostics that the interpreter outputs. More importantly we should have a tab-separated csv file and call graph file in our local directory after running the interpreter:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">23876</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">114</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:21 libHSbase-4.14.0.0.cbits.so -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/external-stg-interpreter/data/cbits.so-script/libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">9442648</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">53</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:23 tsumupto-call-graph-summary   </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">27490</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:23 tsumupto-call-graph.tsv       </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw------- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14922366</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:19 tsumupto.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">1769</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.hi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">207</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">28</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:56 tsumupto.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">4488</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">8817</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw------- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">9803</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.o_modpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Which can be loaded into <code>gephi</code> for closer inspection of the call graph of our program. Be sure to watch the rest of the demo in Csaba<!-- -->‚Äô<!-- -->s talk for this part! For now we<!-- -->‚Äô<!-- -->ll be going over using <code>gephi</code> and these files in our next blog post in this series, stay tuned!</p><a id="org8193a1a"></a><h1>Summary</h1><a id="org940ba90"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="file-descriptions">File Descriptions<a class="hash-link" href="#file-descriptions" title="Direct link to heading">‚Äã</a></h2><ul><li><code>foo.modpak</code>: A zip file which contains the Core, STG, CMM, source code, and assembly for the module <code>foo</code></li><li><code>foo.fullpak</code>: A zip file which contains the same information as <code>modpack</code> but for every module of the program rather than just module <code>foo</code>.</li><li><code>foo.o_ghc_stgapp</code>: a yaml like file that contains:<ul><li>the module<!-- -->‚Äô<!-- -->s dependencies including package dependencies</li><li>a bunch of file paths for shared objects of the libraries</li><li>the flags the module was built with</li></ul></li><li><code>libHSbase-4.14.0.0.cbits.so</code>: shared object file created by <code>ext-stg-interpreter/data/cbits.so-script.c</code>. Required to be in the same directory as <code>ext-stg-interpreter</code> will be invoked.</li></ul><a id="org8e9f409"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="step-by-step-guide-for-running-the-interpreter-on-your-code">Step-by-Step guide for running the interpreter on your code<a class="hash-link" href="#step-by-step-guide-for-running-the-interpreter-on-your-code" title="Direct link to heading">‚Äã</a></h2><ol><li>Build your project with <code>ghc-wpc/_build/stage1/bin</code> by directly invoking that <code>ghc</code> (as I did in the demo-01 project) or by pointing stack to it with <code>system-ghc</code> and <code>extra-path</code> in <code>stack.yaml</code>, or by passing <code>-w &lt;path-to-ghc-wpc-binary</code> with cabal.</li><li>Generate the <code>foo.fullpak</code> file with <code>mkfullpak foo.o_ghc_stgapp</code></li><li>Soft-link to <code>libHSbase-4.14.0.0.cbits.so</code> in the directory you will run the interpreter in. This file must be present when you run the interpreter!</li><li>Now run the interpreter on <code>project.fullpak</code></li><li>Analyze <code>foo-call-graph-summary</code> and <code>foo-call-graph.tsv</code> with whatever tools make sense to you</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="footnotes">Footnotes<a class="hash-link" href="#footnotes" title="Direct link to heading">‚Äã</a></h2><div class="footnotes"><hr><ol><li id="fn-1">This isn<!-- -->‚Äô<!-- -->t completely true, there is the <code>RuntimeRep</code> type controls
exactly this and the levity polymorphism work by <a href="https://richarde.dev/" target="_blank" rel="noopener noreferrer">Richard
Eisenberg</a>. See <a href="https://www.youtube.com/watch?v=Mb_B-j8ePfc" target="_blank" rel="noopener noreferrer">this
video</a> for examples on using these
features. We do plan to include a more thorough and real world example on using
levity polymorphism for better performance in the <a href="https://github.com/haskellfoundation/tech-proposals/pull/26" target="_blank" rel="noopener noreferrer">haskell optimization
handbook</a>.<a href="#fnref-1" class="footnote-backref">‚Ü©</a></li></ol></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/stg">stg</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/tooling">tooling</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/profiling">profiling</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/optimization">optimization</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-04-28-on-the-inlining-of-integer-and-natural-operations">On the inlining of Integer and Natural operations</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-04-28T00:00:00.000Z" itemprop="datePublished">April 28, 2022</time> ¬∑ <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In this post I discuss the inlining of Integer and Natural operations in Haskell. It‚Äôs a promising performance work I‚Äôve been conducting six months ago, which was blocked by an independent issue, but that I will likely resume soon as the issue has been fixed in the meantime.</p><hr><p>To follow this post, you must know that <code>Natural</code> numbers are represented as follows in <code>ghc-bignum</code>:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- | Natural number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Invariant: numbers &lt;= WORD_MAXBOUND use the `NS` constructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data Natural</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   = NS !Word#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   | NB !BigNat#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Small naturals are represented with a <code>Word#</code> and large ones with a <code>BigNat#</code> (a <code>ByteArray#</code>).</p><p>Now consider the following simple example using Natural:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- | Add 2 to a Word. Use Natural to avoid Word overflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foo :: Word -&gt; Natural</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foo x = fromIntegral x + 2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There are only small naturals involved: <code>fromIntegral x</code> is small because <code>x</code> is a <code>Word</code>, and <code>2</code> is small. We could hope that GHC would use <code>Word#</code> primops to implement this and would allocate a <code>Natural</code> heap object for the result <em>only</em>. However it‚Äôs not what happens currently, even in GHC HEAD. In the following STG dump, we can see that a <code>Natural</code> heap object is allocated for <code>x</code> before calling <code>naturalAdd</code> (<code>let</code> bindings in STG reflect heap allocations):</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">foo1 = NS! [2##];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foo =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    \r [x_sXn]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case x_sXn of {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        W# x#_sXp -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let { sat_sXq = NS! [x#_sXp]; } in  naturalAdd sat_sXq foo1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Let‚Äôs look at <code>naturalAdd</code>:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- | Add two naturals</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">naturalAdd :: Natural -&gt; Natural -&gt; Natural</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{-# NOINLINE naturalAdd #-}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">naturalAdd (NS x) (NB y) = NB (bigNatAddWord# y x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">naturalAdd (NB x) (NS y) = NB (bigNatAddWord# x y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">naturalAdd (NB x) (NB y) = NB (bigNatAdd x y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">naturalAdd (NS x) (NS y) =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   case addWordC# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (# l,0# #) -&gt; NS l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (# l,c  #) -&gt; NB (bigNatFromWord2# (int2Word# c) l)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We are clearly in the last case where both arguments are small. It seems beneficial to allow this function to be inlined. If we did we would get:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">foo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    \r </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x_s158</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> x_s158 </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token constant" style="color:#36acaa">W</span><span class="token plain"># x#_s15a </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> addWordC# </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x#_s15a </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">##</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">#</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">#</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> l_s15c ds_s15d </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> ds_s15d</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token maybe-class-name">TagProper</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> ds1_s15e </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __DEFAULT </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> int2Word# </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ds1_s15e</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> sat_s15f </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              __DEFAULT </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> bigNatFromWord2# sat_s15f l_s15c </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> ds2_s15g </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              __DEFAULT </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NB</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ds2_s15g</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"># </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">l_s15c</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>which produces much better assembly code, especially if there is no carry:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    addq $2,%rax       ; add 2 to a machine word</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    setc %bl           ; test the carry.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    movzbl %bl,%ebx    ; it could be done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    testq %rbx,%rbx    ; more efficiently</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jne _blk_c17c      ; with &quot;jc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_blk_c17i:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    movq $NS_con_info,-8(%r12) ; alloc NS datacon value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    movq %rax,(%r12)           ; with the addition result as payload.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    leaq -7(%r12),%rbx         ; make it the first argument</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addq $8,%rbp               ; and then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp *(%rbp)                ; call continuation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>So why aren‚Äôt we always inlining <code>naturalAdd</code>? We even explicitly disallow it with a <code>NOINLINE</code> pragma. The reason is that <code>naturalAdd</code> and friends are involved in constant-folding rules.</p><p>For example, consider:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">bar :: Natural -&gt; Natural</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bar x = x + 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">baz = bar 0x12345678913245678912345679123456798</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Currently we get the following Core:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">bar1 = NS 2##</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bar = \ x_aHU -&gt; naturalAdd x_aHU bar1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">baz = NB 99114423092485377935703335253042771879834</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can see that <code>baz</code>  is a constant thanks to constant-folding.</p><p>However if we let <code>naturalAdd</code> inline we get:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">baz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = case bigNatAddWord# 99114423092485377935703335253042771879832 2##</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    of ds_d11H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { __DEFAULT -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NB ds_d11H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>baz</code> is no longer a constant.</p><p>A solution would be to add constant-folding rules for <code>BigNat#</code> functions, such as <code>bigNatAddWord#</code>. This is exactly what we have started doing in <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20361" target="_blank" rel="noopener noreferrer">#20361</a>. Our new plan is:</p><ul><li>Make <code>BigNat#</code> operation <code>NOINLINE</code> and add constant-folding rules for them</li><li>Make Integer/Natural operations <code>INLINEABLE</code> (expose their unfolding)</li><li>Hence rely on constant-folding for <code>Word#/Int#/BigNat#</code> to provide constant folding for <code>Integer</code> and <code>Natural</code></li></ul><p>The good consequences of this plan are:</p><ul><li>Less allocations when bignum operations are inlined and some of the arguments are known to be small/big or fully known (constant).</li><li><code>Integer</code> and <code>Natural</code> are less magical: you can implement your own similar types and expect the same performance without having to add new rewrite rules</li></ul><p>There were some unforeseen difficulties with this plan though:</p><ol><li>Some of the rewrite rules we need involve unboxed values such as <code>BigNat#</code> and <code>Word#</code> and the weren‚Äôt supported. Luckily, this has been recently fixed (<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19313" target="_blank" rel="noopener noreferrer">#19313</a>) by removing the ‚Äúapp invariant‚Äù (<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20554" target="_blank" rel="noopener noreferrer">#20554</a>). Thanks Joachim! That‚Äôs the reason why we could resume this work now.</li><li>Some unfoldings (RHSs) become bigger due to the inlining of bignum operations. Hence they may not themselves be inlined further due to inlining thresholds even if it would be beneficial. A better inlining heuristic would fix this (see <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20516" target="_blank" rel="noopener noreferrer">#20516</a>). It will likely be the topic of the next post.</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/page/2"><div class="pagination-nav__label">Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/4"><div class="pagination-nav__label">Older Entries</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/iog_eng" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">IOG Blog</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2024 IOG Engineering, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.aea9cbda.js"></script>
<script src="/assets/js/main.ab76ff8a.js"></script>
</body>
</html>