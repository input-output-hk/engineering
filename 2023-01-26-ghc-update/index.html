<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">GHC DevX Update 2023-01-26 | IOG Engineering</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://engineering.iog.io/2023-01-26-ghc-update"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="GHC DevX Update 2023-01-26 | IOG Engineering"><meta data-rh="true" name="description" content="This is the second biweekly update of the IOG GHC DevX team."><meta data-rh="true" property="og:description" content="This is the second biweekly update of the IOG GHC DevX team."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-01-26T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://iog.io/en/,https://iog.io/en/"><meta data-rh="true" property="article:tag" content="ghc,ghc-update"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://engineering.iog.io/2023-01-26-ghc-update"><link data-rh="true" rel="alternate" href="https://engineering.iog.io/2023-01-26-ghc-update" hreflang="en"><link data-rh="true" rel="alternate" href="https://engineering.iog.io/2023-01-26-ghc-update" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.3f63ffa1.css">
<link rel="preload" href="/assets/js/runtime~main.840dcf4b.js" as="script">
<link rel="preload" href="/assets/js/main.522da32c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/iohk-logo.png" alt="IOG" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/iohk-logo-inverted.png" alt="IOG" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Recent</a><a class="navbar__item navbar__link" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/upgrading-to-ghc-9.14">Upgrading to ghc-9.14</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-06-12-ghc-update">IOG GHC Update #47</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-05-15-ghc-update">IOG GHC Update #46</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-04-24-ghc-update">IOG GHC Update #45</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-04-03-ghc-update">IOG GHC Update #44</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-03-13-ghc-update">IOG GHC Update #43</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-02-20-ghc-update">IOG GHC Update #42</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-01-30-ghc-update">IOG GHC Update #41</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025-01-09-ghc-update">IOG GHC Update #40</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-12-19-ghc-update">IOG GHC Update #39</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-11-28-ghc-update">IOG GHC Update #38</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-11-07-ghc-update">IOG GHC Update #37</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-10-17-ghc-update">IOG GHC Update #36</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-09-26-ghc-update">IOG GHC Update #35</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-09-05-ghc-update">IOG GHC Update #34</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-08-15-ghc-update">IOG GHC Update #33</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-07-24-ghc-update">IOG GHC Update #32</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-07-08-ghc-update">IOG GHC Update #31</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-06-17-ghc-update">IOG GHC Update #30</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2024-05-23-ghc-update">IOG GHC Update #29</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">GHC DevX Update 2023-01-26</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-01-26T00:00:00.000Z" itemprop="datePublished">January 26, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="mailto:sylvain.henry@iohk.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="mailto:luite.stegeman@iohk.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>This is the second biweekly update of the IOG GHC DevX team.
You can find the previous one <a href="https://engineering.iog.io/2023-01-12-ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-backend">JavaScript backend<a href="#javascript-backend" class="hash-link" aria-label="Direct link to JavaScript backend" title="Direct link to JavaScript backend">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="template-haskell">Template Haskell<a href="#template-haskell" class="hash-link" aria-label="Direct link to Template Haskell" title="Direct link to Template Haskell">​</a></h3><p>Sylvain continued his work on the implementation of Template Haskell for the JS
backend. He factorized the code from <code>iserv</code> and <code>libiserv</code> into the <code>ghci</code>
library. This makes it easy for GHC to load and run the external interpreter
server (<code>iserv</code>) that ends up compiled into JavaScript in a NodeJS instance. He
modified GHC to avoid creating ByteCode objects (which are unsupported by the JS
backend) and to instead compile and link JavaScript code.</p><p>Template Haskell basically works with the JavaScript backend now, except for a few
corner cases (such as one-shot mode), but these should be fixed in the coming
days/weeks.</p><p>Luite modified Sylvain&#x27;s JavaScript code to fix support for Darwin and Windows. If you
want to test it, a draft merge request has been opened:
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-backend-in-the-browser-tutorial">JavaScript backend in the browser tutorial<a href="#javascript-backend-in-the-browser-tutorial" class="hash-link" aria-label="Direct link to JavaScript backend in the browser tutorial" title="Direct link to JavaScript backend in the browser tutorial">​</a></h3><p>Josh published a tutorial about using code produced by the JavaScript backend in a web
page:
<a href="https://engineering.iog.io/2023-01-24-javascript-browser-tutorial" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2023-01-24-javascript-browser-tutorial</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cabal-support-for-js-sources">Cabal support for js-sources<a href="#cabal-support-for-js-sources" class="hash-link" aria-label="Direct link to Cabal support for js-sources" title="Direct link to Cabal support for js-sources">​</a></h3><p>Sylvain added tests to his patch that adds cabal support for the <code>js-sources</code>
stanza when GHC is used as a compiler (and not only when GHCJS is used as a
compiler), allowing the patch to be merged:
<a href="https://github.com/haskell/cabal/pull/8636" target="_blank" rel="noopener noreferrer">https://github.com/haskell/cabal/pull/8636</a></p><p><a href="https://github.com/haskell/cabal/issues/8639" target="_blank" rel="noopener noreferrer">https://github.com/haskell/cabal/issues/8639</a> is still open though so be careful
if you try to use <code>js-sources</code>, they still don&#x27;t work in some cases.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-backend-ci">JavaScript backend CI<a href="#javascript-backend-ci" class="hash-link" aria-label="Direct link to JavaScript backend CI" title="Direct link to JavaScript backend CI">​</a></h3><p>The <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9552" target="_blank" rel="noopener noreferrer">JavaScript backend
CI</a> has been an
ongoing saga for the last month, and has been a blocking item for JavaScript
Backend development. Thankfully it is close to being merged. This week, Jeff
rebased the CI to discover that recent
<a href="https://gitlab.haskell.org/ghc/ghc/-/commit/d31fcbca6cf4bc166904cfd25696503401ad631d" target="_blank" rel="noopener noreferrer">changes</a>
removed <code>nodejs</code> (the <code>node</code> that is bundled with emscripten) from the CI
containers <code>$PATH</code>. So Jeff patched the CI images to add <code>node</code>. Now the CI runs
and has discovered two new bugs even before being merged. All that is left is to
bump some submodules and the CI will be ready to land in GHC HEAD.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="filestat">FileStat<a href="#filestat" class="hash-link" aria-label="Direct link to FileStat" title="Direct link to FileStat">​</a></h3><p>Josh opened an MR to match the layout of the JavaScript <code>fileStat</code> with the
layout of the equivalent struct defined in Emscripten&#x27;s <code>stat.h</code>. This is needed
to ensure that hsc2hs features work correctly with this data type. Hsc2hs features
can peek at memory locations directly without using accessor functions, and the
memory locations are taken from the header file, hence the requirement to match
these layouts.</p><p>This MR only touches JavaScript files, so we&#x27;re waiting on the approval of the
JS CI before continuing. For more information, see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22573" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/issues/22573</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-rts-refactor">JavaScript RTS refactor<a href="#javascript-rts-refactor" class="hash-link" aria-label="Direct link to JavaScript RTS refactor" title="Direct link to JavaScript RTS refactor">​</a></h3><p>Josh refactored parts of the GHC.StgtoJS.Rts.Rts module to remove special cases
from one of the n-argument JavaScript RTS functions, and combined these cases
into a general case. Thus, simplifying the Rts module&#x27;s code.</p><p>Josh also improved the caching in the JavaScript Backend for commonly used names
in the generated JavaScript ASTs. Previously, names such as <code>x1</code> would require
allocation <em>for each</em> use: first by allocating a <code>String</code>, which was then
converted to a GHC <code>FastString</code>, which was finally wrapped in a JavaScript AST
data constructor. Now, these names are captured in a static CAF&#x27;d <code>Array</code> and
each reference was replaced with a lookup to the corresponding slot in the
array. This avoids the extra allocations and ensures these names are shared.</p><p>For the full set of refactors, see:
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22822" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/issues/22822</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-edsl">JavaScript EDSL<a href="#javascript-edsl" class="hash-link" aria-label="Direct link to JavaScript EDSL" title="Direct link to JavaScript EDSL">​</a></h3><p>Jeff began work on a new eDSL to replace the existing DSL the JavaScript Backend
inherited from GHCJS. This solves a <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22736" target="_blank" rel="noopener noreferrer">design
problem</a>. The existing DSL in
the JavaScript Backend is used for two things: (1) to write the JavaScript
Backend&#x27;s garbage collector, runtime system and other low level bits; (2) as a
target for optimizations; (3) as the source for code generation. This becomes
problematic because the existing DSL tries to do so much that it ends up not
being particularly good at (1), (2) and (3).</p><p>The fix is to separate concerns by writing a new DSL for (1). The DSL is Type
Safe and based on the <a href="https://github.com/ku-fpg/sunroof-compiler" target="_blank" rel="noopener noreferrer">Sunroof
compiler</a> (Thanks Andy Gill et al.
for your labor!). Then, we&#x27;ll compile the new DSL to the existing GHCJS DSL.
This way we can slowly begin to replace JavaScript Backend code module by
module, thus gaining type safety while still continuing other work. The end game
of this project is to eventually remove the GHCJS DSL entirely and then compile
our new DSL to a better intermediate representation that is explicitly crafted
to make optimizations easier.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="blog-posts">Blog posts<a href="#blog-posts" class="hash-link" aria-label="Direct link to Blog posts" title="Direct link to Blog posts">​</a></h3><p>Luite has been working on new blog posts about internals of the GHC JavaScript
backend and a strategy guide for debugging the generated JavaScript code. These
will be published in the coming weeks.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="javascript-backend-configuration-issue-in-a-docker-image">JavaScript backend configuration issue in a Docker image<a href="#javascript-backend-configuration-issue-in-a-docker-image" class="hash-link" aria-label="Direct link to JavaScript backend configuration issue in a Docker image" title="Direct link to JavaScript backend configuration issue in a Docker image">​</a></h3><p>Sylvain debugged a configuration issue of GHC with the JavaScript backend (see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22814" target="_blank" rel="noopener noreferrer">#22814</a>).
The recommended way to configure is to use the following command line:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">emconfigure ./configure --target=js-unknown-ghcjs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>where <code>emconfigure</code> is provided by the Emscripten project and sets appropriate
environment variables (CC, LD, AR...).</p><p>However in some cases it seems like these variables are set as follows:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CC=emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LD=emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>in which case GHC&#x27;s <code>configure</code> script will silently ignores them... and uses
the C compiler for the host platform instead (x86-64, aarch64...). As the C
compiler is only used for the CPP pass, it results in some inscrutable errors.
In <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22814" target="_blank" rel="noopener noreferrer">#22814</a> the error is due
to <code>CSize</code> being inferred as a 64-bit type while it should be 32-bit for the
JavaScript platform, leading to CSize values being passed as 2 arguments in FFI
calls while the callee expects 1.</p><p>Calling <code>configure</code> with the right environment variables fixes the issue:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./configure CC=$(which emcc) LD=$(which emcc) --target=js-unknown-ghcjs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="discussion-about-javascript-backend-maturity">Discussion about JavaScript backend maturity<a href="#discussion-about-javascript-backend-maturity" class="hash-link" aria-label="Direct link to Discussion about JavaScript backend maturity" title="Direct link to Discussion about JavaScript backend maturity">​</a></h3><p>Quite some time was spent discussing users&#x27; expectations about the JavaScript and WASM backends.
We would like to make it very clear that even if GHCJS has been here for a long time,
the JavaScript backend doesn&#x27;t yet have the same level of maturity.</p><p>Bugs, missing features, and sub-par performance are to be expected in the 9.6 release.
We encourage adventurous users to try out this release and send us feedback, but it&#x27;s
best to exercise caution before relying on it for production.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="compiler-performance">Compiler performance<a href="#compiler-performance" class="hash-link" aria-label="Direct link to Compiler performance" title="Direct link to Compiler performance">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="more-strict-break">More-strict <code>break</code><a href="#more-strict-break" class="hash-link" aria-label="Direct link to more-strict-break" title="Direct link to more-strict-break">​</a></h3><p>Josh did more investigation into the performance difference that introducing
some strictness into the <code>break</code> function would make. The STG and microbenchmarks
are very promising, but using the &quot;compile cabal&quot; benchmark, there doesn&#x27;t seem
to be a noticable time difference caused by the change. In terms of memory, it
seems to reduce GC copying, but slightly increase overall allocations and total
memory usage.</p><p>There&#x27;s pathological cases in using a strict break by default - for example in the
<code>lines</code> function. Because of this, it&#x27;s likely that this optimization would have
the most benefit if applied in isolated cases in GHC, if any pathological lazy
cases are found.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="misc">Misc<a href="#misc" class="hash-link" aria-label="Direct link to Misc" title="Direct link to Misc">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cross-compilation-from-linuxdarwin-to-windows">Cross-compilation from Linux/Darwin to Windows<a href="#cross-compilation-from-linuxdarwin-to-windows" class="hash-link" aria-label="Direct link to Cross-compilation from Linux/Darwin to Windows" title="Direct link to Cross-compilation from Linux/Darwin to Windows">​</a></h3><p>Ticket <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22805" target="_blank" rel="noopener noreferrer">#22805</a> reminded Sylvain that he had made <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9310" target="_blank" rel="noopener noreferrer">MR !9310</a> more than two months ago to fix the same issue: cross-compilation from Linux/Darwin to Windows. The MR has now been updated, tested, reviewed, and merged.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hadrian-rules-to-build-the-sphinx-based-docs">Hadrian rules to build the Sphinx-based docs<a href="#hadrian-rules-to-build-the-sphinx-based-docs" class="hash-link" aria-label="Direct link to Hadrian rules to build the Sphinx-based docs" title="Direct link to Hadrian rules to build the Sphinx-based docs">​</a></h3><p>Sylvain started working on adding a chapter about the JavaScript in GHC&#x27;s Users Guide.
The first step was to fix Hadrian&#x27;s build rules for the Users Guide (<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9795" target="_blank" rel="noopener noreferrer">MR !9795</a>)</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ghc">ghc</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/input-output-hk/engineering/tree/master/blog/2023-01-26-ghc-update-2023-01-26.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2023-02-09-ghc-update"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">IOG GHC Update #3 (2023-02-09)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2023-01-26-hs-bindgen-introduction"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">One step forward, an easier interoperability between Rust and Haskell</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#javascript-backend" class="table-of-contents__link toc-highlight">JavaScript backend</a><ul><li><a href="#template-haskell" class="table-of-contents__link toc-highlight">Template Haskell</a></li><li><a href="#javascript-backend-in-the-browser-tutorial" class="table-of-contents__link toc-highlight">JavaScript backend in the browser tutorial</a></li><li><a href="#cabal-support-for-js-sources" class="table-of-contents__link toc-highlight">Cabal support for js-sources</a></li><li><a href="#javascript-backend-ci" class="table-of-contents__link toc-highlight">JavaScript backend CI</a></li><li><a href="#filestat" class="table-of-contents__link toc-highlight">FileStat</a></li><li><a href="#javascript-rts-refactor" class="table-of-contents__link toc-highlight">JavaScript RTS refactor</a></li><li><a href="#javascript-edsl" class="table-of-contents__link toc-highlight">JavaScript EDSL</a></li><li><a href="#blog-posts" class="table-of-contents__link toc-highlight">Blog posts</a></li><li><a href="#javascript-backend-configuration-issue-in-a-docker-image" class="table-of-contents__link toc-highlight">JavaScript backend configuration issue in a Docker image</a></li><li><a href="#discussion-about-javascript-backend-maturity" class="table-of-contents__link toc-highlight">Discussion about JavaScript backend maturity</a></li></ul></li><li><a href="#compiler-performance" class="table-of-contents__link toc-highlight">Compiler performance</a><ul><li><a href="#more-strict-break" class="table-of-contents__link toc-highlight">More-strict <code>break</code></a></li></ul></li><li><a href="#misc" class="table-of-contents__link toc-highlight">Misc</a><ul><li><a href="#cross-compilation-from-linuxdarwin-to-windows" class="table-of-contents__link toc-highlight">Cross-compilation from Linux/Darwin to Windows</a></li><li><a href="#hadrian-rules-to-build-the-sphinx-based-docs" class="table-of-contents__link toc-highlight">Hadrian rules to build the Sphinx-based docs</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/iog_eng" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">IOG Blog</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 IOG Engineering, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.840dcf4b.js"></script>
<script src="/assets/js/main.522da32c.js"></script>
</body>
</html>