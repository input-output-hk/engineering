<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="IOG Engineering RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="IOG Engineering Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="IOG Engineering JSON Feed"><title data-react-helmet="true">32 posts tagged with &quot;ghc&quot; | IOG Engineering</title><meta data-react-helmet="true" property="og:title" content="32 posts tagged with &quot;ghc&quot; | IOG Engineering"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://engineering.iog.io/tags/ghc"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://engineering.iog.io/tags/ghc"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/tags/ghc" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/tags/ghc" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.10ad4647.css">
<link rel="preload" href="/assets/js/runtime~main.ddd8cd56.js" as="script">
<link rel="preload" href="/assets/js/main.c7a1df79.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Recent</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">🌜</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">🌞</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-06-29-ghc-update">IOG GHC Update #13</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-06-28-p2p">Unveiling Cardano&#x27;s Dynamic P2P: a leap forward in decentralization</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-06-15-ghc-update">IOG GHC Update #12</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-06-01-ghc-update">IOG GHC Update #11</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-05-18-ghc-update">IOG GHC Update #10</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>32 posts tagged with &quot;ghc&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-06-29-ghc-update">IOG GHC Update #13</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-06-29T00:00:00.000Z" itemprop="datePublished">June 29, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Bartłomiej Cieślar</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Intern @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><ul><li><p>Luite: implemented JS support for running interactive processes via the <code>process</code> library by using NodeJS features. See <a href="https://github.com/haskell/process/pull/292" target="_blank" rel="noopener noreferrer">Process#292</a>. This change fixes a major issue with Cabal&#x27;s custom <code>Setup.hs</code> scripts which are built with the JS backend (i.e. when not using haskell.nix) as these scripts need to run other processes such as <code>ghc</code> interactively.</p></li><li><p>Sylvain: fixed an issue with exception pretty-printing. <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23565" target="_blank" rel="noopener noreferrer">GHC#23565</a> and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10739" target="_blank" rel="noopener noreferrer">GHC!10739</a>.</p></li><li><p>Sylvain: fixed an issue with levity polymorphic data constructors. <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22360" target="_blank" rel="noopener noreferrer">GHC#22360</a> and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10681" target="_blank" rel="noopener noreferrer">GHC!10681</a>. It also fixed <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22291" target="_blank" rel="noopener noreferrer">GHC#22291</a> as a side-effect.</p></li><li><p>Sylvain: disabled dumping the <code>eventlog</code> into <code>stderr</code> by default <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10677" target="_blank" rel="noopener noreferrer">GHC!10677</a>. We still neeed a better eventlog implementation but at least it fixed the <code>T16707</code> test in the <code>stm</code> package that was failing fo a reason unrelated to stm.</p></li><li><p>Josh: worked on updating <code>ghcjs-dom</code> and <code>ghcjs-base</code> to support the JS backend. This requires changes to some dependencies that have GHCJS FFI import strings, as well as dependencies that are broken by GHC 9.8.
See: <a href="https://github.com/haskellari/splitmix/pull/75" target="_blank" rel="noopener noreferrer">splitmix!75</a></p></li><li><p>Jeff: Changed the CI runner on gitlab to split the JavaScript job into two jobs: a debug build and a performance build. This re-enables performance testing and tracking on GHC&#x27;s testsuite for the JavaScript backend. <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10576" target="_blank" rel="noopener noreferrer">GHC!10576</a></p></li><li><p>Jeff: Opened the <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10722" target="_blank" rel="noopener noreferrer">JStg</a> draft MR. This MR is the next step on the roadmap to add GHCJS&#x27;s optimizer to the JS backend. It adds a new IR to the JavaScript backend pipeline that allows us to separate concerns in the code base. The current pipeline uses the same IR to write the RTS and garbage collector, as a target to compile STG to  and as a optimization target. As a consequence the IR is not a particularly good optimization target nor a good eDSL for the RTS and GC. With this MR we&#x27;ll have the beginnings of a good eDSL for the RTS and GC, which allows for a better IR for the code generator and optimizer.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="deprecation-warnings">Deprecation warnings<a class="hash-link" href="#deprecation-warnings" title="Direct link to heading">​</a></h2><ul><li>Bartek: <a href="https://github.com/ghc-proposals/ghc-proposals/blob/master/proposals/0134-deprecating-exports-proposal.rst" target="_blank" rel="noopener noreferrer">Deprecating exports proposal</a> is now implemented in GHC 9.8</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="incomplete-record-selectors">Incomplete Record Selectors<a class="hash-link" href="#incomplete-record-selectors" title="Direct link to heading">​</a></h2><ul><li>Bartek: The <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10736" target="_blank" rel="noopener noreferrer">MR</a> for the Incomplete Record Selectors warning is ready, waiting for another <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10664" target="_blank" rel="noopener noreferrer">MR</a> to fix the long-range PMC information in do-notations</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="cabal">Cabal<a class="hash-link" href="#cabal" title="Direct link to heading">​</a></h2><ul><li>Josh: added support for <code>js</code>/<code>asm</code>/<code>cmm</code> sources to executable components, and factorised the overlapping code for <code>c</code>/<code>cpp</code>/<code>js</code>/<code>asm</code>/<code>cmm</code> source handling for both library and executable components.
See: <a href="https://github.com/haskell/cabal/pull/9061" target="_blank" rel="noopener noreferrer">Cabal!9061</a>.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghci">GHCi<a class="hash-link" href="#ghci" title="Direct link to heading">​</a></h2><ul><li>Luite: added support for large stack offsets in the ByteCode to fix <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22888" target="_blank" rel="noopener noreferrer">GHC#22888</a>. See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9957" target="_blank" rel="noopener noreferrer">GHC!9957</a>.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="miscellaneous">Miscellaneous<a class="hash-link" href="#miscellaneous" title="Direct link to heading">​</a></h2><ul><li><p>Bartek: Almost finished investigating some of the cases for record fields not emitting custom warnings. See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23279" target="_blank" rel="noopener noreferrer">GHC#23279</a> for details</p></li><li><p>Jeff: FUNARCH GHC modularity paper was accepted! See you at ICFP.</p></li><li><p>Sylvain: implemented a <code>-prelude-is</code> GHC flag to make the <code>Prelude</code> module selectable, following the discussion on <a href="https://discourse.haskell.org/t/a-modern-take-on-the-prelude/6619" target="_blank" rel="noopener noreferrer">Discourse</a>. See ticket <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23551" target="_blank" rel="noopener noreferrer">GHC#23551</a> and merge request <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10704" target="_blank" rel="noopener noreferrer">GHC!10704</a>. Not sure if/when it&#x27;s going to be merged. Do show your support on the issue if you want this.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #13" href="/2023-06-29-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-06-15-ghc-update">IOG GHC Update #12</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-06-15T00:00:00.000Z" itemprop="datePublished">June 15, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Bartłomiej Cieślar</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Intern @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghc-contributors-workshop--zurihac">GHC contributors&#x27; workshop &amp; Zurihac<a class="hash-link" href="#ghc-contributors-workshop--zurihac" title="Direct link to heading">​</a></h2><ul><li>Sylvain: had a great time presenting the JavaScript backend at the GHC
contributors&#x27; workshop and discussing various Haskell/GHC related things at
Zurihac. It was nice to meet so many familiar nicknames in person!
Slides and examples can be found <a href="https://github.com/hsyl20/ghc-workshop-2023" target="_blank" rel="noopener noreferrer">here</a>.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><ul><li><p>Sylvain: updated the MR implementing Template Haskell for the JS backend
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779" target="_blank" rel="noopener noreferrer">!9779</a> to add
a workaround for recompilation avoidance issues. We hope to get this MR merged
before the GHC 9.8 fork (tomorrow).</p></li><li><p>Sylvain: has been doing some bug triage in the testsuite. Now the result can
be accessed and modifierd directly on the <a href="https://gitlab.haskell.org/ghc/ghc/-/wikis/javascript-backend/bug_triage" target="_blank" rel="noopener noreferrer">wiki</a>
(it was in a Google doc before).</p></li><li><p>Luite: fixed a few IO related bugs, including one that caused threads to be
unreachable by asynchronous exceptions such as timeout.
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10657" target="_blank" rel="noopener noreferrer">GHC!10657</a></p></li><li><p>Luite: fixed file descriptor sharing and signal handling for the <code>process</code> package
on node.js, among many smaller changes and fixes. The testsuite for the <code>process</code>
package now passes on the JavaScript target. Some work remains before it can be
merged, mostly around error handling and documentation, but the package should be
generally usable now.
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22349" target="_blank" rel="noopener noreferrer">GHC#22349</a>,
<a href="https://github.com/luite/process/tree/js" target="_blank" rel="noopener noreferrer">luite/process/js WIP branch GitHub</a>.</p></li><li><p>Josh: updated JavaScript FFI import strings in the <code>posix</code> library to use modern
JavaScript backend syntax.
See: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10590" target="_blank" rel="noopener noreferrer">!10590</a></p></li><li><p>Josh: worked on updating <code>ghcjs-base</code> to work with the JavaScript backend. This library
is the first step in updating the GHCJS ecosystem for the JavaScript backend, such as
<code>ghcjs-dom</code>.
See: <a href="https://github.com/ghcjs/ghcjs-base/pull/134" target="_blank" rel="noopener noreferrer">ghcjs-base!134</a></p></li><li><p>Jeff: Root caused JavaScript backend CI perf tests not being run. Perf tests should be enabled again soon. MR <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10576" target="_blank" rel="noopener noreferrer">here</a></p></li><li><p>Jeff: Continued splitting the JavaScript backend into an eDSL and IR for codegen/optimizations. Not ready for MR yet, but this will be a fairly large code churn.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="deprecation-warnings">Deprecation warnings<a class="hash-link" href="#deprecation-warnings" title="Direct link to heading">​</a></h2><ul><li>Bartek: Trying to get the last changes through and fixing minor comments from Sam.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10283" target="_blank" rel="noopener noreferrer">GHC!10283</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="incomplete-record-selectors">Incomplete Record Selectors<a class="hash-link" href="#incomplete-record-selectors" title="Direct link to heading">​</a></h2><ul><li><p>Bartek: started work on the <a href="https://github.com/ghc-proposals/ghc-proposals/blob/master/proposals/0516-incomplete-record-selectors.rst" target="_blank" rel="noopener noreferrer">incomplete record selectors propolal</a>,
reading through the desugarer code</p></li><li><p>Bartek: crunching through the <a href="https://dl.acm.org/doi/pdf/10.1145/3408989" target="_blank" rel="noopener noreferrer">pattern match checker paper</a></p></li><li><p>Bartek: investigating the issue where the code handling the incomplete record updates warning was removed.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23520" target="_blank" rel="noopener noreferrer">GHC#23520</a></p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="miscellaneous">Miscellaneous<a class="hash-link" href="#miscellaneous" title="Direct link to heading">​</a></h2><ul><li>Jeff: Continued trying to add ANSI Hyperlinks for the Haskell Error Index <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10395" target="_blank" rel="noopener noreferrer">here</a>. We hope to get this merged into the GHC 9.8 fork.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #12" href="/2023-06-15-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-06-01-ghc-update">IOG GHC Update #11</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-06-01T00:00:00.000Z" itemprop="datePublished">June 1, 2023</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Bartłomiej Cieślar</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Intern @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><ul><li><p>Sylvain: updated the MR implementing Template Haskell for the JS backend
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779" target="_blank" rel="noopener noreferrer">!9779</a> to start
fixing the remaining recompilation avoidance issues.</p></li><li><p>Sylvain: prepared slides for the GHC workshop about the JS backend. See you
there next week!</p></li><li><p>Luite: Continued working on support for the <code>process</code> package with the JS backend,
moving JavaScript specific functionality into the <code>System.Process.JavaScript</code> module.
Most functionality works, but sometimes tests hang, which seems to be caused by
nodejs being inconsistent emitting events on child process creation.</p></li><li><p>Josh: merged changes to the JavaScript code rendering. Previously, we used GHC&#x27;s <code>SDoc</code>
system, which included a hack of using the <code>layLeft</code> function to remove indentation
from rendered code to improve code size. Now, code is instead rendered on one
line using GHC&#x27;s new <code>HLine</code> system. <code>HLine</code> doesn&#x27;t have to waste time on indentation
logic, and instead simply concatenates very quickly. It also renders directly to a file
handle, rather than spending memory on an intermediate <code>ByteString</code>.</p><p>Additionally, the flag <code>-ddisable-js-minifier</code> is added in this MR, which causes JS
code to be rendered with full human-readable indentation and whitespace.</p><p>See: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10500" target="_blank" rel="noopener noreferrer">GHC!10500</a></p></li><li><p>Josh: fixed an issue where <code>ghc --supported-extensions</code> was incorrectly listing
<code>JavaScriptFFI</code>. This issue had a workaround in Cabal for several years, but the workaround
was causing issues for Cabal support in the JavaScript backend. Now, the extension is removed
from non-JavaScript targets, allowing the Cabal workaround to be reverted for new versions
of GHC.</p><p>See:</p><ul><li><a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10505" target="_blank" rel="noopener noreferrer">GHC!10505</a></li><li><a href="https://github.com/haskell/cabal/pull/8979" target="_blank" rel="noopener noreferrer">Cabal!8979</a>  </li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="deprecation-warnings">Deprecation warnings<a class="hash-link" href="#deprecation-warnings" title="Direct link to heading">​</a></h2><ul><li><p>Bartek: Deprecated exports proposal MR passes CI and has all the issues addressed, waiting for the MR to be accepted
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10283" target="_blank" rel="noopener noreferrer">GHC!10283</a></p></li><li><p>Bartek: Slight rework of parsing and storing the custom warnings so that it&#x27;s more generalized (for the upcoming Deprecated Instances)
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10531" target="_blank" rel="noopener noreferrer">GHC!10531</a></p></li><li><p>Bartek: Parsing for the Deprecated Instances implemented, still waiting for the <a href="https://github.com/ghc-proposals/ghc-proposals/pull/575" target="_blank" rel="noopener noreferrer">proposal</a> to be accepted</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="miscelleaneous">Miscelleaneous<a class="hash-link" href="#miscelleaneous" title="Direct link to heading">​</a></h2><ul><li>Jeff: The FUNARCH version of the <a href="https://hsyl20.fr/home/files/papers/2022-ghc-modularity.pdf" target="_blank" rel="noopener noreferrer">GHC Modularity</a> paper is submitted!</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #11" href="/2023-06-01-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-05-18-ghc-update">IOG GHC Update #10</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-05-18T00:00:00.000Z" itemprop="datePublished">May 18, 2023</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Bartłomiej Cieślar</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Intern @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><ul><li><p>Josh: Merged a port of <code>clock_gettime</code> from GHCJS into the JavaScript backend. This
function is required by some Cabal <code>Setup.hs</code> programs, so this brings us closer to
full Cabal functionality, as well as Unix parity.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10396" target="_blank" rel="noopener noreferrer">GHC!10396</a></p></li><li><p>Luite: Ported the patch to support the <code>process</code> package in the GHC JavaScript
backend from GHCJS. The old code was never fully tested and only intended to support
Cabal, so there is missing functionality and error reporting is lacking. Work is
now on the way to bring it up to level where it can be merged in the <code>process</code> package.</p></li><li><p>Luite: Looked into the test failures for the JavaScript specific weak references.
It turned out to be caused by messing deadlock detection. Experimented with making
the JavaScript storage manager (<code>FinalizationRegistry</code>) work for deadlock detection,add
but it requires signifcant changes to the representation of <code>ThreadId#</code> in the Haskell
code. For GHC 9.8 we will most likely document that deadlocks are not guaranteed to
be detected with the JavaScript backend, and give the user the option to manually run
full deadlock detection (heap scan) if desired.</p></li><li><p>Sylvain: fixed support for the <code>ghcjs_HOST_OS</code> CPP conditional.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23346" target="_blank" rel="noopener noreferrer">GHC#22346</a>
and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10430" target="_blank" rel="noopener noreferrer">GHC!10430</a>.</p></li><li><p>Sylvain: fixed <code>getpid</code>. See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23399" target="_blank" rel="noopener noreferrer">GHC#23399</a> and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10454" target="_blank" rel="noopener noreferrer">GHC!10454</a>.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="deprecation-warnings">Deprecation warnings<a class="hash-link" href="#deprecation-warnings" title="Direct link to heading">​</a></h2><ul><li><p>Bartek: changed the way warning reporting from addUsedGRE was done from artificially removing all warning categories from dynflags to an explicit argument
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10414" target="_blank" rel="noopener noreferrer">GHC!10414</a></p></li><li><p>Bartek: almost finished the deprecated exports proposal, a bug left to fix in backpack
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10283" target="_blank" rel="noopener noreferrer">GHC!10283</a></p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="performance">Performance<a class="hash-link" href="#performance" title="Direct link to heading">​</a></h2><ul><li>Josh: Merged improvements to the implementation of handle encoders after approval of
the CLC. By manually unboxing functions stored in the <code>CodeBuffer</code> record, the
allocations caused by allocations are reduced by ~20%, and general GHC usage is also
slightly improved.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9948" target="_blank" rel="noopener noreferrer">GHC!9948</a>
and <a href="https://gitlab.haskell.org/ghc/ghc/-/jobs/1514795#L6775" target="_blank" rel="noopener noreferrer">CI Performance Tests</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="linker">Linker<a class="hash-link" href="#linker" title="Direct link to heading">​</a></h2><ul><li>Sylvain: backported fix for <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19421" target="_blank" rel="noopener noreferrer">GHC#19421</a> (<code>internal error: m32_allocator_init: Failed to map</code>) to 9.2. See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10453" target="_blank" rel="noopener noreferrer">GHC!10453</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="misc">Misc.<a class="hash-link" href="#misc" title="Direct link to heading">​</a></h2><ul><li>Jeff: First draft of the <a href="https://hsyl20.fr/home/files/papers/2022-ghc-modularity.pdf" target="_blank" rel="noopener noreferrer">GHC Modularity</a> FUNARCH paper is complete.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #10" href="/2023-05-18-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-05-04-ghc-update">IOG GHC Update #9</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-05-04T00:00:00.000Z" itemprop="datePublished">May 4, 2023</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Bartłomiej Cieślar</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Intern @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><ul><li><p>Luite: has published a blog post about how Stacks work in the JS backend:
<a href="https://engineering.iog.io/2023-04-21-stacks-in-the-js-backend" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2023-04-21-stacks-in-the-js-backend</a></p></li><li><p>Jeff: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10260" target="_blank" rel="noopener noreferrer">GHC!10260</a>, which adds a small optimizer to the JS backend, has landed in master.</p></li><li><p>Josh &amp; Sylvain: fixed the <code>-fcheck-prim-bound</code> feature for the JS backend.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23123" target="_blank" rel="noopener noreferrer">GHC#23123</a> and
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10234" target="_blank" rel="noopener noreferrer">GHC!10234</a></p></li><li><p>Luite: improved gc pause times for the JS backend for programs that do not
use weak references, by omitting heap scans if there are no pending finalizers.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10379" target="_blank" rel="noopener noreferrer">GHC!10379</a></p></li></ul><ul><li><p>Josh: refactored some code related to saturated/unsaturated ASTs:</p><ul><li>First, the <code>identsS</code>/<code>identsE</code>/<code>identsV</code> functions were changed to
take a <code>Sat.JStat</code> instead of an <code>Unsat.JStat</code> as an argument, since
they previously would raise an error when encountering an unsaturated
constructor (<code>Sat.JStat</code> and <code>Unsat.JStat</code> are identical other than
this constructor)
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23304" target="_blank" rel="noopener noreferrer">GHC#23304</a><a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10348" target="_blank" rel="noopener noreferrer">GHC!10348</a></li><li>Then, <code>jsSaturate</code> and <code>satJStat</code> were combined into one function.
Previously, <code>jsSaturate</code> would instantiate unsaturated constructors
in a <code>JStat</code> AST, but retain the <code>Unsat.JStat</code> type, and <code>satJStat</code>
would separately traverse the AST to make the simple type conversion.
Since <code>jsSaturate</code> was never used without calling <code>satJStat</code> directly
after, these can be combined to traverse the AST and instantiate
unsaturated constructors in one pass.
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23328" target="_blank" rel="noopener noreferrer">GHC#23328</a><a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10369" target="_blank" rel="noopener noreferrer">GHC!10369</a></li></ul></li><li><p>Josh: Added the type of an STG closure to various STG data types so that
it&#x27;s passed through <code>GHC.CoreToStg.PreStgRhs</code> and <code>GHC.CoreToStg.StgRhsClosure</code>.
With this, we no longer have to guess types based on other information available
during JavaScript code generation. This fixes some issues that were revealed
in the testsuite.
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10261" target="_blank" rel="noopener noreferrer">GHC!10261</a></p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghc-proposal-0134-deprecated-exports">GHC Proposal #0134 (Deprecated Exports)<a class="hash-link" href="#ghc-proposal-0134-deprecated-exports" title="Direct link to heading">​</a></h2><ul><li><p>Bartek: found a bug in warnings about duplicate exports when exporting T(..).
See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23318" target="_blank" rel="noopener noreferrer">GHC#23318</a></p></li><li><p>Bartek: Finished exporting part of the renamer for the Deprecating Exports proposal.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10283" target="_blank" rel="noopener noreferrer">GHC!10283</a></p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="performance">Performance<a class="hash-link" href="#performance" title="Direct link to heading">​</a></h2><ul><li><p>Jeff: First case study on performance engineering for the <a href="https://input-output-hk.github.io/hs-opt-handbook.github.io/" target="_blank" rel="noopener noreferrer">Haskell
Optimization
Handbook</a> is done
and has been published.</p></li><li><p>Josh: Added a GHC testsuite performance test for measuring memory allocations
of encoding.
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10347" target="_blank" rel="noopener noreferrer">GHC!10347</a></p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="modularity">Modularity<a class="hash-link" href="#modularity" title="Direct link to heading">​</a></h2><ul><li>Jeff: Has begun to consolidate the
<a href="https://hsyl20.fr/home/files/papers/2022-ghc-modularity.pdf" target="_blank" rel="noopener noreferrer">ghc-modularity</a>
paper for a
<a href="https://icfp23.sigplan.org/home/funarch-2023#Call-for-Papers" target="_blank" rel="noopener noreferrer">FUNARCH</a>
submission. See you at ICFP!</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="tooling">Tooling<a class="hash-link" href="#tooling" title="Direct link to heading">​</a></h2><ul><li>Sylvain: fixed Stack&#x27;s hi-file-parser to support GHC 9.4.5 and GHC 9.6.1. See
ticket
<a href="https://github.com/commercialhaskell/hi-file-parser/issues/12" target="_blank" rel="noopener noreferrer">hi-file-parser#12</a>
and PR
<a href="https://github.com/commercialhaskell/hi-file-parser/pull/14" target="_blank" rel="noopener noreferrer">hi-file-parser#13</a>.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #9" href="/2023-05-04-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-04-21-stacks-in-the-js-backend">Stacks in the JavaScript Backend</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-04-21T00:00:00.000Z" itemprop="datePublished">April 21, 2023</time> · <!-- -->19 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>I recently gave a short presentation on the topic of stacks in the GHC JavaScript backend to the GHC team at IOG. This blog post is a summary of the content.</p><p>In the context of a program produced by the GHC JavaScript backend, two different types of stack exist: The JavaScript call stack and Haskell lightweight stacks. In this post we will focus mostly on the lightweight stacks.</p><p>First we will see why using only the JavaScript call stack is not suitable for running compiled Haskell code. Then we will introduce the calling convention we use for Haskell and see how the lightweight stacks are used for making calls and passing around data. After this, we will explore in more detail how they are used for exception handling and multithreading.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="lightweight-stacks">Lightweight Stacks<a class="hash-link" href="#lightweight-stacks" title="Direct link to heading">​</a></h2><p>GHC&#x27;s JavaScript backend translates Haskell, via the intermediate language STG, to JavaScript functions and data. When compiled Haskell code needs to run a computation from a different part of the code, it has to call into the corresponding (JavaScript) function. The code relies on tail calls a lot, and for this reason we cannot use a regular JavaScript function call: JavaScript does not support tail-call optimization and we would run out of stack space quickly.</p><p>Instead, we use a technique known as &quot;trampolining&quot; to avoid using space on the JavaScript call stack.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="trampolining">Trampolining<a class="hash-link" href="#trampolining" title="Direct link to heading">​</a></h3><p>When using trampolining to make a tail call, we don&#x27;t directly make a function call (which would use JavaScript stack space), instead we return the function itself, and let a &quot;scheduler&quot; do the call for us. This is easiest to show with an example:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// example without trampolining</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">example1_direct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> arg1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute arg1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// make a tail call to xyz (using space on the JavaScript call stack)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xyz</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>example1_direct</code> above uses a direct call to <code>xyz</code>. If we change it to use trampolining to call <code>xyz</code> it looks as follows:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// simplified scheduler function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scheduler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// scheduler trampolining loop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">c</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// example1 is called from the scheduler loop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">example1_trampoline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> arg1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute arg1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// use global &quot;register&quot; variable h$r1 for the argument</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$r1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> arg1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// return a reference to the function to make the call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> xyz</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>example1_trampoline</code> only works if it&#x27;s called from the scheduler loop. The scheduler loop keeps calling functions (<code>c = c();</code>), so all calls are made directly from the <code>scheduler</code> function, no growing JavaScript stack.</p><p>The scheduler loop cannot deal with function arguments, it calls each <code>c</code> without any arguments. There&#x27;s no way to efficiently return both a function and arguments to <code>scheduler</code> in JavaScript. Allocating an object wrapping the function and arguments for each call would be prohibitively expensive. Therefore we rely on global variables <code>h$r1, h$r2, h$r3, ...</code>, which we refer to as &quot;registers&quot;, to pass the arguments to <code>xyz</code>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="continuations">Continuations<a class="hash-link" href="#continuations" title="Direct link to heading">​</a></h3><p>Other situations are a bit more complicated, for example if our code needs to do something with the result of the call, like pattern matching on a data constructor or primitive value. Let&#x27;s extend our example a little bit:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">abc_direct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">arg1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">example2_direct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> arg1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute arg1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">abc_direct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here the call to <code>abc_direct</code> is not a tail call; <code>example2_direct</code> has to do something with the result of the call. To make a trampolining version out of <code>example2</code>, we need to consider the following:</p><ul><li><code>abc</code> has to return a value to the function that called it</li><li><code>example2</code> needs to inspect the value returned by <code>abc</code>.</li></ul><p>Returning the result value directly from <code>abc</code> is not possible: It would end up in the <code>c = c();</code> loop in <code>scheduler</code>. We need to return a value, but we can only return a function to make a tail call. Where do we get this function?</p><p>This is where the lightweight Haskell stack comes into play. We use the convention that when we are done computing, we &quot;return&quot; the result by making a tail call to a <em>continuation</em> (function) at the top of the lightweight stack, passing the result as an argument.</p><p>The stack is stored in the global variable <code>h$stack</code>, which is a JavaScript array, and we have a global integer variable <code>h$sp</code> which represents the index of the top of the stack. This means that our continuation is found at <code>h$stack[h$sp]</code>, the top of the stack. We call it the usual way: Returning the function to the trampoline and using registers (<code>h$r1, h$r2, ...</code>) for the arguments.</p><p>Using this convention, <code>example2</code> becomes:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">abc_trampoline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> arg1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$r1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// call the continuation on the stack with the result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$r1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">example2_trampoline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> arg1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute arg1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// push our continuation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$sp</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> example2_cont</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// tail-call abc through trampoline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$r1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> arg1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> abc_trampoline</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">example2_cont</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// pop this continuation from the stack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$sp</span><span class="token operator" style="color:#393A34">--</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// the result is the first register argument</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$r1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$r1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$r1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// make the tail call with the result in h$r1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Having a stack of continuations allows calls of arbitrary depth to be composed.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="stack-frames">Stack Frames<a class="hash-link" href="#stack-frames" title="Direct link to heading">​</a></h3><p>Sometimes just storing continuations isn&#x27;t enough. Suppose that we need to use some data in our continuation, for example:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">example3_direct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> arg1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute arg1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> a    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> b    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">abc_direct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here we need to make sure that <code>a</code> and <code>b</code> are available in the continuation. To do so, we save them on the stack as follows:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">example3_trampoline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> arg1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute arg1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> a    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> b    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// compute b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// push our continuation, saving a and b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$sp </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> example3_cont</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// tail-call abc through trampoline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$r1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> arg1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> abc_trampoline</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> example3_cont </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$r1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// restore a and b from stack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// pop the stack frame (3 slots: a, b, example3_cont)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$sp </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// return our result through the trampoline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$r1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$r1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now the stack consists of JavaScript functions (continuations), each followed by zero or more slots of data. We refer to the JavaScript function as the <em>header</em> and the data as the <em>payload</em>. The header and payload combined are called a <em>stack frame</em>.</p><p>Here is an example of what <code>h$stack</code> might look like during the execution of <code>example3_trampoline</code>:</p><table><thead><tr><th>Slot</th><th>Value</th><th>Frame</th><th>Type / Description</th></tr></thead><tbody><tr><td>0</td><td><code>h$done</code></td><td><strong>1</strong></td><td><code>function</code>, &quot;finished&quot; frame</td></tr><tr><td>1</td><td><code>0</code></td><td>2</td><td><code>number</code>, flags</td></tr><tr><td>2</td><td><code>h$...zireportError</code></td><td>2</td><td><code>object</code>, exception handler</td></tr><tr><td>3</td><td><code>h$catch_e</code></td><td><strong>2</strong></td><td><code>function</code>, exception catch frame</td></tr><tr><td>4</td><td><code>4</code></td><td>3</td><td>value of <code>a</code> (in <code>example3</code> above)</td></tr><tr><td>5</td><td><code>5</code></td><td>3</td><td>value of <code>b</code> (in <code>example3</code> above)</td></tr><tr><td>6</td><td><code>example3_cont</code></td><td><strong>3</strong></td><td><code>function</code>, <code>example3_cont</code> frame</td></tr></tbody></table><p>Frame <code>3</code> is the <code>example3_cont</code> frame with two slots of payload, pushed by our example. Frames <code>2</code> and <code>1</code> are added by the runtime system. We will discuss them in more detail later.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="stack-frame-metadata">Stack Frame Metadata<a class="hash-link" href="#stack-frame-metadata" title="Direct link to heading">​</a></h3><p>During normal execution of a program, the code that manipulates the stack has knowledge of the specific stack frame it&#x27;s working with: It knows the size of the payload and which values are stored in each stack slot. However, there are also operations that require dealing with all kinds of unknown stack frames. Exceptions and software transactional memory are the most important ones.</p><p>These operations deal with unknown stack frames and sometimes need information about the frame, for example the frame size. Where do we store it?</p><p>Every JavaScript function is also an object. This means that we can store arbitrary data in the function&#x27;s properties. For example for any function <code>f</code> we can do <code>f.x = 5;</code>. This is what we use to store the metadata for stack frames.</p><p>Stack frames contain at least the following metadata in the header:</p><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td><code>f.size</code></td><td><em>integer</em>, number of payload slots in stack frame</td></tr><tr><td><code>f.a</code></td><td><em>integer</em>, number of register variables used for arguments</td></tr></tbody></table><p><code>example3_cont.size</code> would be <code>2</code>, since it has two slots of payload. The size of the full <code>example3_cont</code> frame is three slots.</p><p>There is also a small number of frames (defined by the runtime system) with the value <code>f.size &lt; 0</code>. These have the stack frame size stored inside the payload. <code>h$ap_gen</code> is another special case, where the stack frame payload encodes both frame size and register information. The runtime system function <code>h$stackFrameSize</code> computes the size of a stack frame:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// compute the size of stack frame h$stack[h$sp] with header f</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">h$stackFrameSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> h$ap_gen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> tag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tag </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tag </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here is an example of a stack with an <code>h$ap_gen</code> stack frame, the payload is stored in slots <code>4</code> and <code>5</code>, while slot <code>6</code> contains the metadata:</p><table><thead><tr><th>Slot</th><th>Value</th><th>Frame</th><th>Type / Description</th></tr></thead><tbody><tr><td>0</td><td><code>h$done</code></td><td><strong>1</strong></td><td><code>function</code>, &quot;finished&quot; frame</td></tr><tr><td>1</td><td><code>0</code></td><td>2</td><td><code>number</code>, flags</td></tr><tr><td>2</td><td><code>h$...zireportError</code></td><td>2</td><td><code>object</code>, exception handler</td></tr><tr><td>3</td><td><code>h$catch_e</code></td><td><strong>2</strong></td><td><code>function</code>, exception catch frame</td></tr><tr><td>4</td><td><code>4</code></td><td>3</td><td>payload</td></tr><tr><td>5</td><td><code>3</code></td><td>3</td><td>payload</td></tr><tr><td>6</td><td><code>513</code></td><td>3</td><td><code>number</code>, stack frame metadata (payload size and registers)</td></tr><tr><td>7</td><td><code>h$ap_gen</code></td><td><strong>3</strong></td><td><code>function</code>, <code>h$ap_gen</code> frame</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_mojV" id="exception-handling">Exception Handling<a class="hash-link" href="#exception-handling" title="Direct link to heading">​</a></h2><p>Haskell allows exceptions to be thrown within threads and between threads as an alternate way of returning a value. The <em>throw</em> operation transfers control to exception handler in the next <code>catch</code> frame on the stack.</p><p>The <code>catch</code> frame has two words of payload:</p><table><thead><tr><th>Slot</th><th>Value</th><th>Frame</th><th>Type / Description</th></tr></thead><tbody><tr><td>0</td><td><code>0</code></td><td>1</td><td><code>number</code>, flags</td></tr><tr><td>1</td><td><code>h$...zireportError</code></td><td>1</td><td><code>object</code>, exception handler</td></tr><tr><td>2</td><td><code>h$catch_e</code></td><td><strong>1</strong></td><td><code>function</code>, exception catch frame</td></tr></tbody></table><p>The code for <code>h$catch_e</code> is straightforward. It just pops the stack frame and returns to the next frame. This is what happens if no exception has occurred; the program just skips past the exception handler:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">h$catch_e</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$sp </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>An exception is thrown by the <code>h$throw</code> function, which unwinds the stack. Its implementation in simplified form looks like this:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// throw exception e</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> h$</span><span class="token keyword control-flow" style="color:#00009f">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h$sp </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// check for stack frames that need to be handled</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> h$catch_e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> h$atomically_e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> h$catchStm_e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> h$upd_frame</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* handle black hole */</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$sp </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">h$stackFrameSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h$sp </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> maskStatus </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$p </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> handler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// jump to handler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// no exception handler found, report error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>h$throw</code> keeps removing stack frames from the stack until some frame of interest is found, using <code>h$stackFrameSize</code> to determine the size of each frame. Eventually, it transfers control to an exception handler or it reports an error if no exception handling frame could be found.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="threads">Threads<a class="hash-link" href="#threads" title="Direct link to heading">​</a></h2><p>Concurrent Haskell supports multiple Haskell threads. These Haskell threads are run by one or more system threads. The JavaScript &quot;system&quot; is single-threaded (ignoring Web Workers, which have limited memory sharing), so we have to use a single system thread to run everything. It turns out to be quite straightforward to support multithreading if we use the trampolining calling convention with lightweight stacks. Each Haskell thread gets its own stack and stack pointer.</p><p>Each Haskell thread has a thread state object, <code>t</code> of type <code>h$Thread</code>. This object contains the stack (<code>t.stack</code>, <code>Array</code>) and stack pointer (<code>t.sp</code>, <code>number</code>) for the thread, and also keeps track of the thread status, for example whether the thread is finished or masking asynchronous exceptions.</p><p>When a thread is created, the <code>h$Thread</code> object is initialized as follows:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/** @constructor */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">h$Thread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// get a unique thread id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">tid</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">h$threadIdN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">THREAD_RUNNING</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// some initial error handling frame on the stack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">stack</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> h$baseZCGHCziConcziSynczireportError</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> h$catch_e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sp</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">excep</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// waiting async exceptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">mask</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// async exceptions masked</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  </span><span class="token comment" style="color:#999988;font-style:italic">// (0 unmasked, 1: uninterruptible, 2: interruptible)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">interruptible</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// currently in an interruptible operation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The initial stack contains two stack frames. The top three slots contain a <code>catch</code> frame with the <code>h$catch_e</code> header, the <code>h$baseZCGHCziConcziSynczireportError</code> exception handler and <code>0</code>, for the mask state. The last slot of the stack is for <code>h$done</code> frame, which only has a header and no payload.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="scheduling-and-suspending-a-thread">Scheduling and Suspending a Thread<a class="hash-link" href="#scheduling-and-suspending-a-thread" title="Direct link to heading">​</a></h3><p>Now we have potentially multiple <code>h$Thread</code> objects, each with their own stack. But how do we run the threads?</p><p>The trampolining calling convention introduced earlier expects the stack to be stored in <code>h$stack</code>, with <code>h$sp</code> the index of the topmost used slot. This means that if we want to run a thread <code>t</code>, we need to set <code>h$stack</code> and <code>h$sp</code> to the values from the <code>h$Thread</code> object <code>t</code>:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// scheduling a thread t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__scheduleThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   h$currentThread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   h$stack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">stack</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   h$sp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We also store <code>t</code> itself in the global <code>h$currentThread</code> variable to keep track of the currently running thread.</p><p>While the thread is running, <code>h$stack</code> and <code>h$sp</code> are constantly updated by the compiled Haskell code, so they go out of sync with values saved in the <code>h$Thread</code> object. This means that when we suspend a thread, these need to be copied back into the <code>h$Thread</code> as follows:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// suspending the current thread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__suspendCurrentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// save the global h$stack and h$sp back into the thread state object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$currentThread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">stack</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$currentThread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sp</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$sp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// set h$currentThread to indicate that no thread is running.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$currentThread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Having multiple threads, the trampoline loop looks a bit different. A thread returns a special continuation <code>h$reschedule</code> to indicate that another thread may now be scheduled. In simplified form, the scheduler looks as follows:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scheduler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// fetch the next thread to run and schedule it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getNextThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// if there are no more threads then we&#x27;re done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token function" style="color:#d73a49">__scheduleThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// start by executing the continuation at the top of the stack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$stack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$sp</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// run until the thread indicates that another may now be scheduled</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> h$reschedule</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">c</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// suspend the thread again</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token function" style="color:#d73a49">__suspendCurrentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In practice, the scheduler is quite a bit more complicated. For example it also uses time-based switching, changing to different thread even when <code>h$reschedule</code> is not returned by the current thread. In that case, the scheduler takes care of saving the thread state onto the stack, using metadata from the continuation.</p><p>A discussion of all the ins and outs of the scheduler is beyond the scope of this blog post. But it could be the topic of a follow-up post.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="threads-and-asynchronous-exceptions">Threads and Asynchronous Exceptions<a class="hash-link" href="#threads-and-asynchronous-exceptions" title="Direct link to heading">​</a></h3><p>Haskell exceptions come in two flavours: <em>synchronous</em> exceptions and <em>asynchronous</em> exceptions. Synchronous exceptions always come from the code itself, for example a pattern match failure, a call to <code>error</code> or <code>undefined</code>. Running the code again with the same input always produces the same result.</p><p>Asynchronous exceptions come from the outside. They can come from other threads (but don&#x27;t need to) or from the runtime system. Typical reasons for asynchronous exceptions are timeouts and resource exhaustion. It&#x27;s perfectly possible for the same function with the same input to be aborted with an asynchronous exception the first run, while running to completion the second time. This means that we must be careful preserving any partially completed computation.</p><p>Asynchronous exceptions can happen at any time, which can make them quite tricky to deal with. They could leave the program in an inconsistent state if they occur at the wrong time. Therefore, threads can temporarily block asynchronous exceptions, a process called <em>masking</em>. Different masking states are used for indicating whether exceptions are still masked when the thread is performing an <em>interruptible</em> operation.</p><p>Here is a comparison of the main differences between synchronous and asynchronous exceptions:</p><table><thead><tr><th></th><th>Synchronous</th><th>Asynchronous</th></tr></thead><tbody><tr><td><strong>Thrown using primop</strong></td><td><code>raise#</code>, <code>raiseIO#</code></td><td><code>killThread#</code></td></tr><tr><td><strong>Computation on the stack</strong></td><td>thunks updated to immediately raise the same exception again</td><td>stack captured in heap objects so the computation can be resumed</td></tr><tr><td><strong>Throw to other thread</strong></td><td>impossible</td><td>push <code>h$raiseAsync_frame</code> frame onto receiving thread&#x27;s stack (unless masked)</td></tr><tr><td><strong>Throw to current thread</strong></td><td>use <code>h$throw</code> immediately</td><td>use <code>h$throw</code> immediately (no masking)</td></tr><tr><td><strong>Masking</strong></td><td>no masking, thrown immediately</td><td>exception saved in <code>h$Thread.excep</code> of receiving thread if masked, the sending thread is blocked until the exception is delivered</td></tr></tbody></table><p>We can see that while on the surface, synchronous and asynchronous exceptions look similar, there are many differences under the hood. Masking requires some additional machinery for thread synchronization and storing exceptions that cannot be delivered yet.</p><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody><tr><td><code>h$Thread.mask</code></td><td><code>number</code>, mask status indicating unmasked / masked uninterruptible / masked interruptible</td></tr><tr><td><code>h$Thread.excep</code></td><td><code>Array</code>, list of unposted asynchronous exceptions and their posting <code>h$Thread</code> objects. When the receiving thread unmasks, the scheduler posts the exceptions to its <code>h$Thread.stack</code> with <code>h$raiseAsync_frame</code> and unblocks the sending threads</td></tr><tr><td><code>h$Thread.interruptible</code></td><td><code>boolean</code>, interruptible state of the thread</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_mojV" id="important-functions-and-values">Important Functions and Values<a class="hash-link" href="#important-functions-and-values" title="Direct link to heading">​</a></h2><p>We have seen various global names and code examples so far, but some example code was simplified a little for clarity. This section offers some pointers to get started with exploring the actual code.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="global-variables">Global Variables<a class="hash-link" href="#global-variables" title="Direct link to heading">​</a></h4><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>h$stack</code></td><td><code>Array</code>, the stack of the currently running thread</td></tr><tr><td><code>h$sp</code></td><td><code>integer</code>, index of the top slot of the stack</td></tr><tr><td><code>h$r1</code>, <code>h$r2</code>, ..., <code>h$r32</code></td><td><code>Any</code>, &quot;registers&quot;, function arguments (first 32)</td></tr><tr><td><code>h$regs</code></td><td><code>Array</code>, function arguments when more than 32 are needed</td></tr><tr><td><code>h$currentThread</code></td><td><code>h$Thread</code>, object of currently running Haskell thread. <code>null</code> if no Haskell thread is running</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_mojV" id="running-threads">Running Threads<a class="hash-link" href="#running-threads" title="Direct link to heading">​</a></h4><p>These functions start a new thread given an <code>IO</code> action. They also start the main loop of the scheduler.</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>h$run(c)</code></td><td>Run <code>IO</code> action <code>c</code> in a new lightweight thread</td></tr><tr><td><code>h$main(c)</code></td><td>Run <code>IO</code> action <code>c</code> in a new lightweight thread, flush buffers and exit the program when finished</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_mojV" id="some-useful-internal-functions">Some Useful Internal Functions<a class="hash-link" href="#some-useful-internal-functions" title="Direct link to heading">​</a></h4><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>h$stackFrameSize(f)</code></td><td>Compute the size of the stack frame <code>f</code></td></tr><tr><td><code>h$throw(e, async)</code></td><td>Throw exception <code>e</code> (<code>object</code>), <code>async</code> (<code>boolean</code>) determines whether the exception is asynchronous.</td></tr><tr><td><code>h$mainloop</code></td><td>The entry point for running Haskell code</td></tr><tr><td><code>h$runThreadSlice</code></td><td>The actual trampolining loop (for asynchronous threads)</td></tr><tr><td><code>h$scheduler</code></td><td>Picks the next thread to schedule, schedules it and returns the continuation to call</td></tr><tr><td><code>h$suspendCurrentThread</code></td><td>Saves the thread state registers onto the stack to allow another thread to be run, used in conjunction with <code>h$restoreThread</code></td></tr><tr><td><code>h$reschedule</code></td><td>Tells the scheduler to schedule another thread</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_mojV" id="some-common-stack-frames">Some Common Stack Frames<a class="hash-link" href="#some-common-stack-frames" title="Direct link to heading">​</a></h4><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>h$done</code></td><td>Finish the current thread</td></tr><tr><td><code>h$return</code></td><td>Load a value from the stack into <code>h$r1</code></td></tr><tr><td><code>h$restoreThread</code></td><td>Load values from stack frame into registers, used to restore the thread state</td></tr><tr><td><code>h$catch_e</code></td><td>Catch an exception</td></tr><tr><td><code>h$ap_n_m_e</code></td><td>Apply a function to <code>m</code> arguments taking <code>n</code> slots on the stack</td></tr><tr><td><code>h$raiseAsync_frame</code></td><td>Raise an asynchronous exception received by this thread</td></tr><tr><td><code>h$ap_gen</code></td><td>Generic apply a function, the number of arguments is in the stack frame</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>We have introduced the <em>trampolining</em> calling convention used by the JavaScript backend for GHC and the structure of the stacks used by it.</p><p>We have seen that stacks of Haskell lightweight threads are represented by JavaScript arrays with the JavaScript backend. The contents on the stack consist of stack frames with a header and a payload. The header of each stack frame contains some metadata so that code for exception handling can traverse the stack and transfer control to an exception handler.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/threads">threads</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/rts">rts</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Stacks in the JavaScript Backend" href="/2023-04-21-stacks-in-the-js-backend"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-04-20-ghc-update">IOG GHC Update #8</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-04-20T00:00:00.000Z" itemprop="datePublished">April 20, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Bartłomiej Cieślar</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Intern @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><ul><li><p>Sylvain: fixed the implementation of some thread-related primops
(listThreads, getThreadLabel...).
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10303" target="_blank" rel="noopener noreferrer">GHC!10303</a></p></li><li><p>Sylvain: regenerated Cabal lexer with a newer Alex containing his bug fix
for the JS backend (cf previous update). Some Cabal tests had to be updated in the process because
they were relying on an Alex bug which has been fixed. This raised the question of
bug fixes vs the PVP. See <a href="https://github.com/haskell/cabal/pull/8896" target="_blank" rel="noopener noreferrer">Cabal#8896</a>,
<a href="https://github.com/haskell/alex/issues/227" target="_blank" rel="noopener noreferrer">Alex#227</a>,
and <a href="https://github.com/haskell/pvp/issues/49" target="_blank" rel="noopener noreferrer">PVP#49</a>.</p></li><li><p>Josh: added an implementation for <code>mkdir</code> for node targets. Primarily this is
expected to be used by Cabal setup scripts, but any JS backend programs running on
node will be able to use it. See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10279" target="_blank" rel="noopener noreferrer">GHC!10279</a>.</p></li><li><p>Josh: fixed the <code>-fcheck-prim-bounds</code> flag for the JS backend. The old implementation
mostly only caused false negatives in the bounds that were rejected (i.e. it would miss
some invalid bounds), but it some cases there were also false positives, caused by
casted byte array indexing operations being indexed on the casted type&#x27;s size.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10234" target="_blank" rel="noopener noreferrer">GHC!10234</a>.</p></li><li><p>Josh: fixed the JS implementation for the <code>access</code> function on files. This
function comes from C, but node also provides a direct equivalent - which the new
implementation uses. See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10301" target="_blank" rel="noopener noreferrer">GHC!10301</a>.</p></li><li><p>Luite: Worked on optimizing finalizers by disabling heap scanning and found
an issue affecting <code>debugIO</code> in the base library. This is caused by the code
generated for <code>h$appendToHsStringA</code>. A fix is now ready, see
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10312" target="_blank" rel="noopener noreferrer">GHC!10312</a></p></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="pipeline-refactoring-and-new-ir">Pipeline refactoring and new IR<a class="hash-link" href="#pipeline-refactoring-and-new-ir" title="Direct link to heading">​</a></h3><ul><li>Jeff: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10260" target="_blank" rel="noopener noreferrer">MR!10260</a>
ready to land. This MR paves the way for the new IR, changes the small
optimization pass the JavaScript backend had to target the current IR instead of
directly printing optimized forms, and adds an IR to IR optimizer. CI shows that
the compile time allocations for the JavaScript backend is reduced an average of
3.3% with a maximum reduction 13% with this MR. Note that these reductions
come from cleaner code generation, not from the optimizer.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="testsuite-and-cleanup">Testsuite and cleanup<a class="hash-link" href="#testsuite-and-cleanup" title="Direct link to heading">​</a></h3><ul><li>Sylvain: replaced uses of obsolescent <code>egrep</code> with <code>grep -E</code>. Otherwise
recent <code>egrep</code> programs print a warning that makes some GHC golden tests fail.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22351" target="_blank" rel="noopener noreferrer">GHC#22351</a>
and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10308" target="_blank" rel="noopener noreferrer">GHC!10308</a>.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="documentation">Documentation<a class="hash-link" href="#documentation" title="Direct link to heading">​</a></h3><ul><li>Luite: Finished the blog post on the lightweight stacks and calling convention
the JavaScript backend uses. This will be published on the IOG engineering blog
shortly.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghc-proposal-0134-deprecated-exports">GHC Proposal #0134 (Deprecated Exports)<a class="hash-link" href="#ghc-proposal-0134-deprecated-exports" title="Direct link to heading">​</a></h2><ul><li>Bartek: Implemented the parsing and pretty printing of warnings of deprecated exports.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10283" target="_blank" rel="noopener noreferrer">GHC!10283</a> for the partial
implementation of the proposal so far.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="performance">Performance<a class="hash-link" href="#performance" title="Direct link to heading">​</a></h2><ul><li><p>Jeff : First case study on performance engineering for the <a href="https://input-output-hk.github.io/hs-opt-handbook.github.io/" target="_blank" rel="noopener noreferrer">Haskell
Optimization Handbook</a> is almost done. The case study demonstrates a first pass
of performance engineering on the klister programming language&#x27;s interpreter.
The chapter demonstrates the use of ticky ticky, info-table, biography and
retainer analysis profiling to gain a 6-fold improvement in the interpreter.</p></li><li><p>Josh: Updated the unboxed codebuffers implementation to include pattern
synonyms for backwards-compatability. Now, the implementation of handle encoding
in base can be updated to be more performant without requiring external changes.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9948" target="_blank" rel="noopener noreferrer">GHC!9948</a>.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #8" href="/2023-04-20-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-04-06-ghc-update">IOG GHC Update #7</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-04-06T00:00:00.000Z" itemprop="datePublished">April 6, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Bartłomiej Cieślar</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Intern @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><p>Sylvain: fixed build of GHC with the <code>quickest</code> Hadrian flavour.
It was failing due to a incorrect coercion in <code>ghc-heap</code>.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23181" target="_blank" rel="noopener noreferrer">#23181</a>
and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10192" target="_blank" rel="noopener noreferrer">!10192</a></p><p>Jeff: Began to implement the plan to add GHCJS&#x27;s optimizer to the JavaScript
backend. This item is slated for GHC 9.8 and is on our
<a href="https://gitlab.haskell.org/ghc/ghc/-/wikis/javascript-backend" target="_blank" rel="noopener noreferrer">roadmap</a>. The
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10142" target="_blank" rel="noopener noreferrer">first step</a>, which
is now finished, is to split the intermediate representation the backend uses to
isolate all code generation. This split then allows us to change the existing
intermediate representation for the RTS and GC, remove some cruft that was
adopted from GHCJS, and add optimization passes.</p><p>Jeff: Tested generating <code>let</code> instead of <code>var</code> to take advantage of more recent
JavaScript standards than GHCJS comported to. However, this change produced such
significant runtime regressions in the generated JavaScript that we abandoned it. </p><p>Sylvain: fixed an out-of-bound array access in code generated by Alex, the lexer
generator, see <a href="https://github.com/haskell/alex/pull/223" target="_blank" rel="noopener noreferrer">Alex#223</a>. The out-of-bound access
only triggers an exception with the JS backend; with native backends it only causes a
benign data corruption. This was found in Cabal-syntax&#x27;s lexer, which still needs to be
regenerated, see <a href="https://github.com/haskell/cabal/issues/8892" target="_blank" rel="noopener noreferrer">Cabal#8892</a>.</p><p>Josh: brought the callbacks CLC ticket to vote. Now it has enough votes to be
passed, so we&#x27;re just awaiting a formal conclusion. Following this, the JavaScript
backend will be able to pass Haskell functions to foreign imports as JavaScript
callbacks, which in turn enables JavaScript to call into Haskell code.</p><p>Merge request: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10128" target="_blank" rel="noopener noreferrer">GHC MR 10128</a></p><p>Josh: debugged an issue with the <code>-fcheck-prim-bounds</code> flag. The errors were mostly
false negatives in the indicies that were rejected, but there were also a false positive
due to the existing code not accounting for zero-size ranges being allowed in range-based
operations (even at indicies that don&#x27;t exist, such as negative).</p><p>Merge request: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10234" target="_blank" rel="noopener noreferrer">GHC MR 10234</a></p><p>Luite: Worked on using the JavaScript finalization functionality for Haskell weak references.
It looks like it&#x27;s not possible to keep the existing &quot;GHC style&quot; reachability semantics from
<code>System.Mem.Weak</code>. Our new approach is to create a &quot;JavaScript style&quot; variant in <code>System.Mem.Weak.JS</code>
that avoids the need for expensive heap scanning. Both variants of weak references
can be supported by the JavaScript backend, and heap scanning can be avoided if there
are no pending finalizers for &quot;GHC style&quot; weak references (in progress).</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="compiler-performance">Compiler Performance<a class="hash-link" href="#compiler-performance" title="Direct link to heading">​</a></h2><p>Jeff: Finally landed
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9702" target="_blank" rel="noopener noreferrer">MR!9702</a> which
refactored GHC&#x27;s driver to use more eficient data structures. This refactor
reduced allocations <em>for every</em> test in GHC&#x27;s testsuite, with an geometric mean
of -1.6%.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="team">Team<a class="hash-link" href="#team" title="Direct link to heading">​</a></h2><p>The DevX team at IOG welcomes our summer intern Bartek! Bartek will be working
on GHC proposal
<a href="https://github.com/ghc-proposals/ghc-proposals/blob/master/proposals/0134-deprecating-exports-proposal.rst#implementation-plan" target="_blank" rel="noopener noreferrer">134</a>;
deprecating exports,
<a href="https://github.com/ghc-proposals/ghc-proposals/blob/master/proposals/0516-incomplete-record-selectors.rst" target="_blank" rel="noopener noreferrer">516</a>;
adding warnings for incomplete record selectors, and <a href="https://github.com/ghc-proposals/ghc-proposals/pull/575" target="_blank" rel="noopener noreferrer">deprecating
instances</a>. We are glad
to be working with him and happy to have him on the team.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghc-migration-and-stability">GHC migration and stability<a class="hash-link" href="#ghc-migration-and-stability" title="Direct link to heading">​</a></h2><p>Bartek: Started this sprint and has begun to read through the front end code of
GHC to begin working on one of the ghc proposal tickets next week.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="miscellaneous">Miscellaneous<a class="hash-link" href="#miscellaneous" title="Direct link to heading">​</a></h2><p>Sylvain: Fixed linker warning issue with <code>-fproc-alignment=64</code>. See
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20758" target="_blank" rel="noopener noreferrer">#20758</a> and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10200" target="_blank" rel="noopener noreferrer">!10200</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #7" href="/2023-04-06-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-03-23-ghc-update">IOG GHC Update #6</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-03-23T00:00:00.000Z" itemprop="datePublished">March 23, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="port-of-ghcjss-callback-feature">Port of GHCJS&#x27;s Callback feature<a class="hash-link" href="#port-of-ghcjss-callback-feature" title="Direct link to heading">​</a></h3><p>Josh: opened an MR for porting GHCJS&#x27;s <code>GHCJS.Foreign.Callback</code> module into the JavaScript backend.
The <code>Callback</code> type allows for passing Haskell functions into the FFI using standard JavaScript-styled
function arguments - where compiled functions usually use global variables as registers to pass arguments.
By passing functions into FFI imports and storing references to the functions, we can enable a form
of FFI &quot;exports&quot; - since the passed functions allow JavaScript code to call back into Haskell code.</p><p>This MR additionally adds user guide documentation for both callbacks, and general JavaScript FFI usage.</p><p>We&#x27;re currently awaiting the results of a CLC proposal before the merge can be completed.</p><p>See the following links for more information:</p><ul><li><a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23126" target="_blank" rel="noopener noreferrer">GHC Issue</a></li><li><a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10128" target="_blank" rel="noopener noreferrer">Merge Request</a></li><li><a href="https://github.com/haskell/core-libraries-committee/issues/150" target="_blank" rel="noopener noreferrer">CLC Proposal</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="pipeline-refactoring-and-new-ir">Pipeline refactoring and new IR<a class="hash-link" href="#pipeline-refactoring-and-new-ir" title="Direct link to heading">​</a></h3><p>Jeff: Began to lay the foundation for splitting the DSL in the JavaScript backend by segregating code generation to a new, basically identical DSL. The motivation is that by splitting the existing DSL, we can now replace the old DSL while still providing working builds. This is the first step in a multistep plan that eventually ends with GHCJS&#x27;s optimizer and a typed sunroof based DSL. <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10142" target="_blank" rel="noopener noreferrer">MR is up</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="faster-weak-references-implementation">Faster weak references implementation?<a class="hash-link" href="#faster-weak-references-implementation" title="Direct link to heading">​</a></h3><p>Luite: investigated replacing heap traversal with newer JS feature.</p><p>ES2021 has new functionality for <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakRef" target="_blank" rel="noopener noreferrer">weak references</a>
and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry" target="_blank" rel="noopener noreferrer">finalization</a>. These do not directly map to Haskell weak references and finalizers, but it&#x27;s probably possible to use them to avoid a lot of the expensive heap scanning that we currently do.</p><p>It&#x27;s not yet clear whether we can completely remove the heap scanning while exactly preserving the current semantics for weak references.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="testsuite-and-cleanup">Testsuite and cleanup<a class="hash-link" href="#testsuite-and-cleanup" title="Direct link to heading">​</a></h3><p>Sylvain: removed dead code in the JS RTS <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10102" target="_blank" rel="noopener noreferrer">!10102</a></p><p>Sylvain: did some triage of tests in GHC&#x27;s testsuite failing with the JS backend. See tickets <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22370" target="_blank" rel="noopener noreferrer">#22370</a>, <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22374" target="_blank" rel="noopener noreferrer">#22374</a>, <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22576" target="_blank" rel="noopener noreferrer">#22576</a>, and merge requests <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10148" target="_blank" rel="noopener noreferrer">!10148</a>, <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10150" target="_blank" rel="noopener noreferrer">!10150</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="code-generator-and-performance">Code generator and performance<a class="hash-link" href="#code-generator-and-performance" title="Direct link to heading">​</a></h3><p>Jeff: tested changing the code generator to generate <code>let</code> instead of <code>var</code>. This led to a large performance regression (~20%), which was not isolated to any single function (via a ticky profile in node). The working hypothesis is that <code>let</code> requires more work when allocating closures because the JavaScript engine needs to ensure all variables are lexically scoped. We have not confirmed that this is the cause yet, but we did find that we generate closures that are allocated at runtime in the code generated for <code>base</code>. So after review we decided to leave the <code>var</code>s and not generate <code>let</code>s. Unless we begin to observe issues around scoping, using the safer construct seems to be too much of a performance hit.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="miscellaneous">Miscellaneous<a class="hash-link" href="#miscellaneous" title="Direct link to heading">​</a></h2><p>Jeff: Revived Data structure work in GHC.Unit.State resulting in -1.7% reduction in allocations (by geometric average) and -9% in some cases. <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9702" target="_blank" rel="noopener noreferrer">MR is here</a> and ready to land, just needs to upstream a single-line patch to haddock.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #6" href="/2023-03-23-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-03-09-ghc-update">IOG GHC Update #5</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-03-09T00:00:00.000Z" itemprop="datePublished">March 9, 2023</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><p>Luite: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10059" target="_blank" rel="noopener noreferrer">!10059</a>
Implemented computing a valid <code>LambdaFormInfo</code> for the JavaScript backend
so that interface files can be written without warnings. Fixes
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23053" target="_blank" rel="noopener noreferrer">#23053</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="template-haskell">Template Haskell<a class="hash-link" href="#template-haskell" title="Direct link to heading">​</a></h3><p>Luite: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10008" target="_blank" rel="noopener noreferrer">!10008</a>
implemented keeping track of subdirectories in GHC&#x27;s temporary file manager.
It has been updated after reviews and is now ready to be merged.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-edsl">JavaScript EDSL<a class="hash-link" href="#javascript-edsl" title="Direct link to heading">​</a></h3><p>Jeff: MR is <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10000" target="_blank" rel="noopener noreferrer">open</a>.
In response to feedback from the team Jeff has added (and removed)
several features that distinguish the eDSL from
<a href="https://github.com/ku-fpg/sunroof-compiler" target="_blank" rel="noopener noreferrer">sunroof</a>. These include: </p><ul><li>removing threading and continuations</li><li>adding named unique variables and a proper switch statement</li><li>removing a dependency on the <code>operational</code> package</li><li>removing a dependency on the <code>data-reify</code> package</li><li>added a compilation function that compiles the eDSL to the IR the JavaScript backend uses.</li></ul><p>These changes allow more of the RTS to be replaced in the eDSL and allow the RTS
to be typed using Haskell&#x27;s type system. For example, now the STG registers
track the type of the values they hold. The RTS migration is now underway.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="copymutablearray-primops">copyMutableArray primops<a class="hash-link" href="#copymutablearray-primops" title="Direct link to heading">​</a></h3><p>Sylvain: fixed JS implementations for <code>copyMutableByteArray#</code> and
<code>copySmallMutableArray</code> primops. They were wrong in some cases when the source
and target arrays overlap. See
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23033" target="_blank" rel="noopener noreferrer">#23033</a> and
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10037" target="_blank" rel="noopener noreferrer">!10037</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="testsuite">Testsuite<a class="hash-link" href="#testsuite" title="Direct link to heading">​</a></h3><p>Sylvain: made a minor cleanup in the testsuite to correctly tag tests requiring
Cmm support (which the JS backend doesn&#x27;t have):
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10043" target="_blank" rel="noopener noreferrer">!10043</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="callbacks">Callbacks<a class="hash-link" href="#callbacks" title="Direct link to heading">​</a></h3><p>Josh: ported GHCJS&#x27;s <code>GHCJS.Foreign.Callback</code> module. Manual testing revealed some
minor changes required in the JavaScript backend, including to <code>base.GHC.JS.Prim</code>,
to make everything work as expected.</p><p>This will enable passing Haskell functions into <code>foreign import</code>s, which in turn
enables a form of calling into Haskell from JavaScript code.</p><hr><h2 class="anchor anchorWithStickyNavbar_mojV" id="compiler-performance">Compiler performance<a class="hash-link" href="#compiler-performance" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="optimization-handbook">Optimization Handbook<a class="hash-link" href="#optimization-handbook" title="Direct link to heading">​</a></h3><p>Jeff: Work has begun on the first major case study: a performance
<a href="https://github.com/LeventErkok/sbv/issues/642" target="_blank" rel="noopener noreferrer">regression</a> in the
<a href="https://github.com/LeventErkok/sbv" target="_blank" rel="noopener noreferrer">sbv</a> library. </p><hr><h2 class="anchor anchorWithStickyNavbar_mojV" id="rts-linker">RTS linker<a class="hash-link" href="#rts-linker" title="Direct link to heading">​</a></h2><p>Sylvain: helped fixing a RTS linker bug. The RTS ELF linker didn&#x27;t properly
take into account required section alignments and always used 16-bytes alignment.
However AVX instructions generated by the C compiler may expect 32-bytes alignment
(even if the code uses unaligned load intrinsics, the C compiler may optimize them
into aligned load instructions, as was the case here).
The fix was simple, the test case a bit more involved.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23066" target="_blank" rel="noopener noreferrer">#23066</a> and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10087" target="_blank" rel="noopener noreferrer">!10087</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #5" href="/2023-03-09-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-02-23-ghc-update">IOG GHC Update #4</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-02-23T00:00:00.000Z" itemprop="datePublished">February 23, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="template-haskell">Template Haskell<a class="hash-link" href="#template-haskell" title="Direct link to heading">​</a></h3><p>Sylvain: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779" target="_blank" rel="noopener noreferrer">!9779</a>
adding TH support for the JS backend passes CI and is ready for reviews.</p><p>Ticket <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/23013" target="_blank" rel="noopener noreferrer">#23013</a> has been
opened to keep track of an issue with the recompilation avoidance mechanism.
Fixing the issue seems to require some invasive refactoring that is best left
for a future merge request.</p><p>Luite: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10008" target="_blank" rel="noopener noreferrer">!10008</a>
Implemented keeping track of subdirectories in GHC&#x27;s temporary file manager.
Ready for review. Fixes
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22952" target="_blank" rel="noopener noreferrer">#22952</a>.</p><p>Temporary subdirectories are used when linking Template Haskell with the
JavaScript backend and also in some situations when linking with other backends.
This would always result in files being left behind in GHC&#x27;s temporary directory
(and a warning at high enough verbosity settings) since these subdirectories
were never removed. With this patch, GHC keeps track of all created subdirectories
and removes them at the end of the session.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-rts-refactor">JavaScript RTS refactor<a class="hash-link" href="#javascript-rts-refactor" title="Direct link to heading">​</a></h3><p>Josh: has merged the refactor of the RTS generation module to reduce redundant code.
In this refactor, debug logging was also completed to determine the correct numbers
to use as the cache sizes for generated JavaScript names - allowing us to vastly
reduce the size of these arrays for efficiency, and to remove <code>panic</code> cases in favour
of generating higher numbered names without caching.</p><p><a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9794" target="_blank" rel="noopener noreferrer">!9794</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="integer-performance">Integer performance<a class="hash-link" href="#integer-performance" title="Direct link to heading">​</a></h3><p>Sylvain: <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9825" target="_blank" rel="noopener noreferrer">!9825</a> has
been updated after an helpful review by Matthew Claven.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-edsl">JavaScript EDSL<a class="hash-link" href="#javascript-edsl" title="Direct link to heading">​</a></h3><p>Jeff: MR is <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10000" target="_blank" rel="noopener noreferrer">open</a>.
In response to feedback from the team Jeff has added (and removed)
several features that distinguish the eDSL from
<a href="https://github.com/ku-fpg/sunroof-compiler" target="_blank" rel="noopener noreferrer">sunroof</a>. These include: removing
threading and continuations, adding named unique variables and a proper switch
statement. These changes allow more of the RTS to be replaced in the eDSL and
allow the RTS to be typed using Haskell&#x27;s type system. For example, now the STG
registers track the type of the values they hold.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ci">CI<a class="hash-link" href="#ci" title="Direct link to heading">​</a></h3><p>Sylvain: fixed CI script test that prevented performance results to be stored for
the JS backend (see <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22923" target="_blank" rel="noopener noreferrer">#22923</a> and
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10026" target="_blank" rel="noopener noreferrer">!10026</a>).</p><hr><h2 class="anchor anchorWithStickyNavbar_mojV" id="compiler-performance">Compiler performance<a class="hash-link" href="#compiler-performance" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="more-strict-breakspan">More-strict <code>break</code>/<code>span</code><a class="hash-link" href="#more-strict-breakspan" title="Direct link to heading">​</a></h3><p>Josh: opened a CLC (Core Libraries Committee) proposal to add stricter versions of
<code>break</code> and <code>span</code> to <code>Data.List</code> in addition to the existing lazy versions. The
proposal considers evidence that these versions are situationally more performant,
by comparing allocation statistics, generated STG, and microbenchmarks - as well as
making the argument for consistency with existing <code>List</code> functions that also have
strict versions.</p><p>See also:</p><ul><li><a href="https://github.com/haskell/core-libraries-committee/issues/133" target="_blank" rel="noopener noreferrer">CLC proposal 133</a></li><li><a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22865" target="_blank" rel="noopener noreferrer">GHC Issue 22865</a></li><li><a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9868" target="_blank" rel="noopener noreferrer">GHC MR 9868</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="unboxed-codebuffers">Unboxed CodeBuffers<a class="hash-link" href="#unboxed-codebuffers" title="Direct link to heading">​</a></h3><p>Josh: opened a CLC proposal to modify the implementation of <code>CodeBuffer</code>s in <code>base</code>
to use unboxed tuples in the return type of encoding functions. This change presents
a significant allocation improvement, due to the difficulty GHC has with applying a
certain optimisation within data types.</p><p>See also:</p><ul><li><a href="https://github.com/haskell/core-libraries-committee/issues/134" target="_blank" rel="noopener noreferrer">CLC proposal 134</a></li><li><a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22946" target="_blank" rel="noopener noreferrer">GHC Issue 22946</a></li><li><a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9948" target="_blank" rel="noopener noreferrer">GHC MR 9948</a>.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="optimization-handbook">Optimization Handbook<a class="hash-link" href="#optimization-handbook" title="Direct link to heading">​</a></h3><p>Jeff: Has been hard at work on the <a href="https://input-output-hk.github.io/hs-opt-handbook.github.io/" target="_blank" rel="noopener noreferrer">Optimization Handbook</a>.
He has finished a
chapter on <code>Lambda Lifting</code>, significantly expanded the glossary, and added
documentation to the
<a href="https://github.com/yongrenjie/sphinx-exec-directive" target="_blank" rel="noopener noreferrer">sphinx-exec-directive</a>
haskell extension that he finished last month. The optimization handbook is now
in review by IOG&#x27;s IT team to migrate it to the Haskell Foundation website.</p><hr><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghci">GHCi<a class="hash-link" href="#ghci" title="Direct link to heading">​</a></h2><p>Luite: Added a testcase and did some cleanups in the types of the C code in MR
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9957" target="_blank" rel="noopener noreferrer">!9957</a>, and adjusted
the bytecode generator to not produce zero offset <code>SLIDE</code> instructions anymore.
This is now ready for review.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #4" href="/2023-02-23-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-02-09-ghc-update">IOG GHC Update #3 (2023-02-09)</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-02-09T00:00:00.000Z" itemprop="datePublished">February 9, 2023</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Biweekly update from the GHC DevX team at IOG.</p><p>Previous updates can be found <a href="https://engineering.iog.io/tags/ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="template-haskell">Template Haskell<a class="hash-link" href="#template-haskell" title="Direct link to heading">​</a></h3><p>Luite: fixed the support for one-shot mode (GHC&#x27;s <code>-c</code> command-line flag)
in the TH JS linker.</p><p>Luite: Investigated a warning about the temporary directory not being removed
after running Template Haskell with the JavaScript backend. It turned out
that GHC&#x27;s <code>GHC.Utils.TmpFs.newTempDir</code>, which is used by the Template Haskell
linker, does not allow the newly created directory to be removed
(see <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22952" target="_blank" rel="noopener noreferrer">#22952</a>).</p><p>Sylvain: cleaned up the <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779" target="_blank" rel="noopener noreferrer">merge request</a>,
removing unnecessary changes and adding documentation.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-ci">JavaScript backend CI<a class="hash-link" href="#javascript-backend-ci" title="Direct link to heading">​</a></h3><p>Jeff: JavaScript backend CI was <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9552" target="_blank" rel="noopener noreferrer">finally
merged</a>! Now that we
have CI we are unblocked on several fronts, such as, implementing <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9825" target="_blank" rel="noopener noreferrer">faster
arithmetic</a> and fixing
some <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9879" target="_blank" rel="noopener noreferrer">async
exceptions</a>. In
general, we can now have confidence that our work is progressing the JavaScript
backend to a better state.</p><p>Sylvain: fixed a spurious failure on JS CI due to some test <em>passing</em> on fast runners
while it was expected to fail (see <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9934" target="_blank" rel="noopener noreferrer">!9934</a>).</p><p>Josh: fixed some inaccurate test predicates <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9939" target="_blank" rel="noopener noreferrer">!9939</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="filestat">FileStat<a class="hash-link" href="#filestat" title="Direct link to heading">​</a></h3><p>Josh: rebased and merged <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9755" target="_blank" rel="noopener noreferrer">!9755</a>.
This patch changes the representation of the JavaScript equivalent of the C <code>struct stat</code>
to make its field offsets match the C ones: some Haskell codes directly access fields of
this structure using <code>hsc2hs</code> to get the field offsets from the C headers.</p><p>This patch also adds fields to the JavaScript file stat that were previously not
included, such as modification and access times.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-rts-refactor">JavaScript RTS refactor<a class="hash-link" href="#javascript-rts-refactor" title="Direct link to heading">​</a></h3><p>Josh: rebased <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9794" target="_blank" rel="noopener noreferrer">!9794</a> which consists
in the refactor of the module generating some part of the RTS. The new JS CI job found a bug in the patch that
caused ~50 tests to time out, so waiting for CI to be set up before merging this MR was judicious.</p><p>This MR also became an opportunity to revisit some arbitrary cache sizes in the RTS code generator.
This is still ongoing work.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="warnings">Warnings<a class="hash-link" href="#warnings" title="Direct link to heading">​</a></h3><p>Luite: We accidently removed the check for the &quot;javascript&quot; calling convention on
foreign imports, allowing this convention to be wrongly used on native platform.
Fixed in <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9880" target="_blank" rel="noopener noreferrer">!9880</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="fix-for-asynchronous-exceptions">Fix for asynchronous exceptions<a class="hash-link" href="#fix-for-asynchronous-exceptions" title="Direct link to heading">​</a></h3><p>Luite: Fixed an issue in the garbage collector for the JavaScript backend:
A thread that posts an asynchronous exception (<code>throwTo</code>) to another thread
is temporarily suspended until the exception has been delivered. The
garbage collector did not correctly follow the list of threads suspended in
this way, potentially considering them unreachable and cleaning up data
referenced by them. See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22836" target="_blank" rel="noopener noreferrer">#22836</a> and
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9879" target="_blank" rel="noopener noreferrer">!9879</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="integer-performance">Integer performance<a class="hash-link" href="#integer-performance" title="Direct link to heading">​</a></h3><p>Evaluating the following expression is very slow in general but especially with
the JS backend:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">1 `shiftL` (1 `shiftL` 20) :: Integer</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We&#x27;ve had to mark a test computing this as broken on CI because it triggers a
timeout error. Luckily the identification of slow operations is easy with
JavaScript profiling tools (see graphs in
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22835" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/issues/22835</a>) and we know that <code>Word32</code>
primops are the culprit in this case.</p><p>Sylvain started replacing the uses of JavaScript&#x27;s <code>BigInt</code> in the
implementation of these primops with usual JavaScript <code>numbers</code>.
See <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9825" target="_blank" rel="noopener noreferrer">!9825</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-edsl">JavaScript EDSL<a class="hash-link" href="#javascript-edsl" title="Direct link to heading">​</a></h3><p>Jeff: JavaScript eDSL based on
<a href="https://github.com/ku-fpg/sunroof-compiler" target="_blank" rel="noopener noreferrer">sunroof</a> close to MR, see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22736" target="_blank" rel="noopener noreferrer">#22736</a> for background.
Compiler is complete. Major items left are: the interpreter to translate to
<code>JStat</code>, filling in documentation, and testing now that CI has been merged.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="documentation">Documentation<a class="hash-link" href="#documentation" title="Direct link to heading">​</a></h3><p>Jeff: Wrote the JavaScript backend release notes. Notes pending
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9828" target="_blank" rel="noopener noreferrer">approval</a>. We cite
the <a href="https://gitlab.haskell.org/ghc/ghc/-/wikis/javascript-backend" target="_blank" rel="noopener noreferrer">JavaScript
backend</a> wiki
page in the release notes. So Jeff and Sylvain heavily edited the wiki pages to
make them suitable for external customers.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="change-from-js-to-javascript-architecture">Change from <code>js</code> to <code>javascript</code> architecture<a class="hash-link" href="#change-from-js-to-javascript-architecture" title="Direct link to heading">​</a></h3><p>In <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22740" target="_blank" rel="noopener noreferrer">#22740</a> it was noticed that
<code>hackage-server</code> would prevent the upload of the upcoming <code>base</code> package bundled with GHC 9.6.
The reason is that <code>hackage-server</code> relies on the <code>cabal --check</code> feature which filters
out perfectly valid packages (it happened before, for example with <a href="https://gitlab.haskell.org/haskell/ghc-api-compat/-/issues/1" target="_blank" rel="noopener noreferrer">ghc-api-compat</a>).</p><p>In our case, the package was rejected because the <code>js</code> architecture wasn&#x27;t recognized
as a built-in one, but luckily we could fall back to the existing <code>javascript</code> built-in
architecture defined for GHCJS (if it wasn&#x27;t a JS backend, we would have had to fix Cabal,
update <code>hackage-server</code> dependencies, and redeploy <code>hackage-server</code>...).</p><p>Sylvain completed Ben&#x27;s MR in <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9814" target="_blank" rel="noopener noreferrer">!9814</a>.</p><p>For early users of the JS backend the change means that from now on:</p><ul><li><code>configure</code> command is: <code>emconfigure ./configure --target=javascript-unknown-ghcjs</code></li><li>Cabal condition is: <code>arch(javascript)</code></li><li>CPP condition is: <code>#if defined(javascript_HOST_ARCH)</code></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="compiler-performance">Compiler performance<a class="hash-link" href="#compiler-performance" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="more-strict-break">More-strict <code>break</code><a class="hash-link" href="#more-strict-break" title="Direct link to heading">​</a></h3><p>Josh: opened merge request <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9868" target="_blank" rel="noopener noreferrer">!9868</a> to add a stricter <code>break&#x27;</code> version to <code>base</code> - however, this would require a CLC proposal.</p><p>Further analysis was done using ticky profiles on a simple test program that benchmarks GHC&#x27;s startup code.
This has found an example where a more-strict break is an improvement in GHC, which will provide motivation
for the CLC proposal.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="unboxed-codebuffers">Unboxed CodeBuffers<a class="hash-link" href="#unboxed-codebuffers" title="Direct link to heading">​</a></h3><p>Josh: implemented changes to GHC&#x27;s text encoding buffers to use unboxed tuples on handle encoders/decoders.
The buffers pass around and repeatedly pack/unpack a tuple in an <code>IO</code> inner loop, which causes a significant
number of unnecessary allocations. By replacing this with an unboxed tuple, and replacing the <code>IO</code> with
manually passing around a <code>State# RealWorld</code> in the same tuple, we&#x27;re able to reduce allocations by nearly 50%
in a pathological example (non-allocating loop printing characters). See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22946" target="_blank" rel="noopener noreferrer">#22946</a> and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9948" target="_blank" rel="noopener noreferrer">!9948</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="optimization-handbook">Optimization Handbook<a class="hash-link" href="#optimization-handbook" title="Direct link to heading">​</a></h3><p>Jeff: opened IT ticket to move the <a href="https://github.com/input-output-hk/hs-opt-handbook.github.io" target="_blank" rel="noopener noreferrer">Optimization
Handbook</a> to Haskell Foundation&#x27;s repository.
IT stated they need to check with legal, of course.</p><p>Jeff: almost finished the <a href="https://input-output-hk.github.io/hs-opt-handbook.github.io/src/Optimizations/GHC_opt/lambda_lifting.html" target="_blank" rel="noopener noreferrer">lambda
lifting</a>
chapter; major remaining items are adding some glossary terms and describing the
interaction between lambda lifting and calling conventions.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="constant-folding-for-division-operations">Constant folding for division operations<a class="hash-link" href="#constant-folding-for-division-operations" title="Direct link to heading">​</a></h3><p>While looking into his old merge requests still opened, Sylvain nerd-snipped
himself into fixing constant folding rules for division operations (see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22152" target="_blank" rel="noopener noreferrer">#22152</a>).</p><p>MR <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/8956" target="_blank" rel="noopener noreferrer">!8956</a> adds the
following rewrite rules:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">   case quotRemInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     (# q, _ #) -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ====&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   case quotInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     q -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   case quotRemInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     (# _, r #) -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ====&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   case remInt# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     r -&gt; body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  For all primitive numerical types:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (x `quot` l1) `quot` l2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | l1 /= 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | l2 /= 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     | l1*l2 doesn&#x27;t overflow/underflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ====&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x `quot` (l1 * l2)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>It also makes some division primops (Word64/Int64 Quot/Rem, WordQuotRem2Op)
ok-for-speculation when the divisor is known to be non-zero, similarly to other
division primops. Otherwise the last rule wasn&#x27;t firing in the added test
because we got the following Core (simplified for the presentation):</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">case quotWord64# x# 10#Word64 of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ds1 -&gt; case quotWord64# ds1 20#Word64 of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ds2 -&gt; ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>and not:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">case quotWord64# (quotWord64# x# 10#Word64) 20#Word64 of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ds2 -&gt; ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghci">GHCi<a class="hash-link" href="#ghci" title="Direct link to heading">​</a></h2><p>Luite: A test run of GHC 9.6 with the <code>-fbyte-code-and-object-code</code> flag
on <a href="https://ghc.gitlab.haskell.org/head.hackage/" target="_blank" rel="noopener noreferrer">head.hackage</a> revealed
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22888" target="_blank" rel="noopener noreferrer">issue #22888</a> with bytecode
size limits. Many bytecode instructions have <code>Word16</code> operands, which
is not always enough to run programs generated from optimized core. The solution
is to enable large operands for all the bytecode instructions that deal with
stack offsets. See <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22888" target="_blank" rel="noopener noreferrer">#22888</a>
and <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9957" target="_blank" rel="noopener noreferrer">!9957</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about IOG GHC Update #3 (2023-02-09)" href="/2023-02-09-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-01-26-ghc-update">GHC DevX Update 2023-01-26</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-26T00:00:00.000Z" itemprop="datePublished">January 26, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This is the second biweekly update of the IOG GHC DevX team.
You can find the previous one <a href="https://engineering.iog.io/2023-01-12-ghc-update" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="template-haskell">Template Haskell<a class="hash-link" href="#template-haskell" title="Direct link to heading">​</a></h3><p>Sylvain continued his work on the implementation of Template Haskell for the JS
backend. He factorized the code from <code>iserv</code> and <code>libiserv</code> into the <code>ghci</code>
library. This makes it easy for GHC to load and run the external interpreter
server (<code>iserv</code>) that ends up compiled into JavaScript in a NodeJS instance. He
modified GHC to avoid creating ByteCode objects (which are unsupported by the JS
backend) and to instead compile and link JavaScript code.</p><p>Template Haskell basically works with the JavaScript backend now, except for a few
corner cases (such as one-shot mode), but these should be fixed in the coming
days/weeks.</p><p>Luite modified Sylvain&#x27;s JavaScript code to fix support for Darwin and Windows. If you
want to test it, a draft merge request has been opened:
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-in-the-browser-tutorial">JavaScript backend in the browser tutorial<a class="hash-link" href="#javascript-backend-in-the-browser-tutorial" title="Direct link to heading">​</a></h3><p>Josh published a tutorial about using code produced by the JavaScript backend in a web
page:
<a href="https://engineering.iog.io/2023-01-24-javascript-browser-tutorial" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2023-01-24-javascript-browser-tutorial</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="cabal-support-for-js-sources">Cabal support for js-sources<a class="hash-link" href="#cabal-support-for-js-sources" title="Direct link to heading">​</a></h3><p>Sylvain added tests to his patch that adds cabal support for the <code>js-sources</code>
stanza when GHC is used as a compiler (and not only when GHCJS is used as a
compiler), allowing the patch to be merged:
<a href="https://github.com/haskell/cabal/pull/8636" target="_blank" rel="noopener noreferrer">https://github.com/haskell/cabal/pull/8636</a></p><p><a href="https://github.com/haskell/cabal/issues/8639" target="_blank" rel="noopener noreferrer">https://github.com/haskell/cabal/issues/8639</a> is still open though so be careful
if you try to use <code>js-sources</code>, they still don&#x27;t work in some cases.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-ci">JavaScript backend CI<a class="hash-link" href="#javascript-backend-ci" title="Direct link to heading">​</a></h3><p>The <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9552" target="_blank" rel="noopener noreferrer">JavaScript backend
CI</a> has been an
ongoing saga for the last month, and has been a blocking item for JavaScript
Backend development. Thankfully it is close to being merged. This week, Jeff
rebased the CI to discover that recent
<a href="https://gitlab.haskell.org/ghc/ghc/-/commit/d31fcbca6cf4bc166904cfd25696503401ad631d" target="_blank" rel="noopener noreferrer">changes</a>
removed <code>nodejs</code> (the <code>node</code> that is bundled with emscripten) from the CI
containers <code>$PATH</code>. So Jeff patched the CI images to add <code>node</code>. Now the CI runs
and has discovered two new bugs even before being merged. All that is left is to
bump some submodules and the CI will be ready to land in GHC HEAD.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="filestat">FileStat<a class="hash-link" href="#filestat" title="Direct link to heading">​</a></h3><p>Josh opened an MR to match the layout of the JavaScript <code>fileStat</code> with the
layout of the equivalent struct defined in Emscripten&#x27;s <code>stat.h</code>. This is needed
to ensure that hsc2hs features work correctly with this data type. Hsc2hs features
can peek at memory locations directly without using accessor functions, and the
memory locations are taken from the header file, hence the requirement to match
these layouts.</p><p>This MR only touches JavaScript files, so we&#x27;re waiting on the approval of the
JS CI before continuing. For more information, see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22573" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/issues/22573</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-rts-refactor">JavaScript RTS refactor<a class="hash-link" href="#javascript-rts-refactor" title="Direct link to heading">​</a></h3><p>Josh refactored parts of the GHC.StgtoJS.Rts.Rts module to remove special cases
from one of the n-argument JavaScript RTS functions, and combined these cases
into a general case. Thus, simplifying the Rts module&#x27;s code.</p><p>Josh also improved the caching in the JavaScript Backend for commonly used names
in the generated JavaScript ASTs. Previously, names such as <code>x1</code> would require
allocation <em>for each</em> use: first by allocating a <code>String</code>, which was then
converted to a GHC <code>FastString</code>, which was finally wrapped in a JavaScript AST
data constructor. Now, these names are captured in a static CAF&#x27;d <code>Array</code> and
each reference was replaced with a lookup to the corresponding slot in the
array. This avoids the extra allocations and ensures these names are shared.</p><p>For the full set of refactors, see:
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22822" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/issues/22822</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-edsl">JavaScript EDSL<a class="hash-link" href="#javascript-edsl" title="Direct link to heading">​</a></h3><p>Jeff began work on a new eDSL to replace the existing DSL the JavaScript Backend
inherited from GHCJS. This solves a <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22736" target="_blank" rel="noopener noreferrer">design
problem</a>. The existing DSL in
the JavaScript Backend is used for two things: (1) to write the JavaScript
Backend&#x27;s garbage collector, runtime system and other low level bits; (2) as a
target for optimizations; (3) as the source for code generation. This becomes
problematic because the existing DSL tries to do so much that it ends up not
being particularly good at (1), (2) and (3).</p><p>The fix is to separate concerns by writing a new DSL for (1). The DSL is Type
Safe and based on the <a href="https://github.com/ku-fpg/sunroof-compiler" target="_blank" rel="noopener noreferrer">Sunroof
compiler</a> (Thanks Andy Gill et al.
for your labor!). Then, we&#x27;ll compile the new DSL to the existing GHCJS DSL.
This way we can slowly begin to replace JavaScript Backend code module by
module, thus gaining type safety while still continuing other work. The end game
of this project is to eventually remove the GHCJS DSL entirely and then compile
our new DSL to a better intermediate representation that is explicitly crafted
to make optimizations easier.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="blog-posts">Blog posts<a class="hash-link" href="#blog-posts" title="Direct link to heading">​</a></h3><p>Luite has been working on new blog posts about internals of the GHC JavaScript
backend and a strategy guide for debugging the generated JavaScript code. These
will be published in the coming weeks.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-configuration-issue-in-a-docker-image">JavaScript backend configuration issue in a Docker image<a class="hash-link" href="#javascript-backend-configuration-issue-in-a-docker-image" title="Direct link to heading">​</a></h3><p>Sylvain debugged a configuration issue of GHC with the JavaScript backend (see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22814" target="_blank" rel="noopener noreferrer">#22814</a>).
The recommended way to configure is to use the following command line:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">emconfigure ./configure --target=js-unknown-ghcjs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>where <code>emconfigure</code> is provided by the Emscripten project and sets appropriate
environment variables (CC, LD, AR...).</p><p>However in some cases it seems like these variables are set as follows:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">CC=emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LD=emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>in which case GHC&#x27;s <code>configure</code> script will silently ignores them... and uses
the C compiler for the host platform instead (x86-64, aarch64...). As the C
compiler is only used for the CPP pass, it results in some inscrutable errors.
In <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22814" target="_blank" rel="noopener noreferrer">#22814</a> the error is due
to <code>CSize</code> being inferred as a 64-bit type while it should be 32-bit for the
JavaScript platform, leading to CSize values being passed as 2 arguments in FFI
calls while the callee expects 1.</p><p>Calling <code>configure</code> with the right environment variables fixes the issue:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./configure CC=$(which emcc) LD=$(which emcc) --target=js-unknown-ghcjs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="discussion-about-javascript-backend-maturity">Discussion about JavaScript backend maturity<a class="hash-link" href="#discussion-about-javascript-backend-maturity" title="Direct link to heading">​</a></h3><p>Quite some time was spent discussing users&#x27; expectations about the JavaScript and WASM backends.
We would like to make it very clear that even if GHCJS has been here for a long time,
the JavaScript backend doesn&#x27;t yet have the same level of maturity.</p><p>Bugs, missing features, and sub-par performance are to be expected in the 9.6 release.
We encourage adventurous users to try out this release and send us feedback, but it&#x27;s
best to exercise caution before relying on it for production.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="compiler-performance">Compiler performance<a class="hash-link" href="#compiler-performance" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="more-strict-break">More-strict <code>break</code><a class="hash-link" href="#more-strict-break" title="Direct link to heading">​</a></h3><p>Josh did more investigation into the performance difference that introducing
some strictness into the <code>break</code> function would make. The STG and microbenchmarks
are very promising, but using the &quot;compile cabal&quot; benchmark, there doesn&#x27;t seem
to be a noticable time difference caused by the change. In terms of memory, it
seems to reduce GC copying, but slightly increase overall allocations and total
memory usage.</p><p>There&#x27;s pathological cases in using a strict break by default - for example in the
<code>lines</code> function. Because of this, it&#x27;s likely that this optimization would have
the most benefit if applied in isolated cases in GHC, if any pathological lazy
cases are found.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="misc">Misc<a class="hash-link" href="#misc" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="cross-compilation-from-linuxdarwin-to-windows">Cross-compilation from Linux/Darwin to Windows<a class="hash-link" href="#cross-compilation-from-linuxdarwin-to-windows" title="Direct link to heading">​</a></h3><p>Ticket <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22805" target="_blank" rel="noopener noreferrer">#22805</a> reminded Sylvain that he had made <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9310" target="_blank" rel="noopener noreferrer">MR !9310</a> more than two months ago to fix the same issue: cross-compilation from Linux/Darwin to Windows. The MR has now been updated, tested, reviewed, and merged.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="hadrian-rules-to-build-the-sphinx-based-docs">Hadrian rules to build the Sphinx-based docs<a class="hash-link" href="#hadrian-rules-to-build-the-sphinx-based-docs" title="Direct link to heading">​</a></h3><p>Sylvain started working on adding a chapter about the JavaScript in GHC&#x27;s Users Guide.
The first step was to fix Hadrian&#x27;s build rules for the Users Guide (<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9795" target="_blank" rel="noopener noreferrer">MR !9795</a>)</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHC DevX Update 2023-01-26" href="/2023-01-26-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-01-24-javascript-browser-tutorial">Using GHC&#x27;s JavaScript Backend in the Browser</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-24T00:00:00.000Z" itemprop="datePublished">January 24, 2023</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In a previous
<a href="https://engineering.iog.io/2022-12-13-ghc-js-backend-merged" target="_blank" rel="noopener noreferrer">post</a> we
introduced GHC&#x27;s new JavaScript backend, which allows the compilation of Haskell
code into JavaScript. This is the first tutorial in a new series about the
JavaScript backend. In this post, we&#x27;ll build GHC as
a JavaScript cross-compiler and run a trivial Haskell program in the browser.</p><p>We plan to write more of those blog post in the coming weeks and
months as we add new features (e.g. support for &quot;foreign exports&quot; that will
allow JavaScript code to call into Haskell code, support for Template Haskell,
etc.). For now it relies on our &quot;insider&quot; knowledge (e.g. how the FFI works)
that isn&#x27;t well documented elsewhere. We do plan to add a chapter about the
JavaScript backend in GHC&#x27;s user guide, but for now your best chance is to look
at GHCJS&#x27;s documentation or at the source code.</p><p>Please note: this is a technology preview of the in-development JavaScript backend
for GHC. Not all Haskell features are implemented, and bugs are expected. It is
currently rather complicated for JavaScript code to call into Haskell code (&quot;foreign
exports&quot; aren&#x27;t implemented). GHC isn&#x27;t a multi-target compiler yet, so a GHC executable
built for a native platform (Linux/x86-64, Windows/x86-64, Darwin/AArch64...) as currently distributed (via ghcup, Stack, binary distributions, etc.) won&#x27;t be able to produce JavaScript. Official prebuilt binary distributions are likely to remain
unavailable until GHC gains multi-target support - requiring the JavaScript backend
to be built from source even after the backend matures.
That&#x27;s why we start this post with the required steps to build yourself
a GHC compiler capable of producing JavaScript.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-ghc-as-a-cross-compiler-to-javascript">Building GHC as a Cross Compiler to JavaScript<a class="hash-link" href="#building-ghc-as-a-cross-compiler-to-javascript" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="installing-dependencies">Installing Dependencies<a class="hash-link" href="#installing-dependencies" title="Direct link to heading">​</a></h3><p>First we need to install all the typical dependencies for GHC plus <code>Emscripten</code>,
so our final list is:</p><ul><li>GHC version 9.2 or later</li><li>Cabal</li><li>Alex</li><li>Happy</li><li>Emscripten to configure with</li><li>(Optional) NodeJS to run JavaScript locally</li></ul><p>Let&#x27;s take these in order, a standard GHC distribution with Cabal is needed so we can boot our new compiler.
We recommend using  GHCUP
(<a href="https://www.haskell.org/ghcup/install/" target="_blank" rel="noopener noreferrer">https://www.haskell.org/ghcup/install/</a>),
or your system&#x27;s package manager to install the this. </p><p>We need Alex and Happy to build GHC, these can be installed through Cabal:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cabal install alex happy -j</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We need Emscripten during the <code>configure</code> step of the build. <code>Emscripten</code> should be available in most package managers, but you can also build and install it from source:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/emscripten-core/emsdk.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd emsdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./emsdk install latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./emsdk activate latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source ./emsdk_env.sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After installing Emscripten, <code>emconfigure</code> should be available on your system
path. Use <code>which emconfigure</code> to check that it is on your <code>$PATH</code>. If you built
from source, then the output should point to a location within the emsdk git
project like so:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ which emconfigure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/path/to/emsdk/upstream/emscripten/emconfigure</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For more detailed installation instructions, see <a href="https://emscripten.org/docs/getting_started/downloads.html" target="_blank" rel="noopener noreferrer">https://emscripten.org/docs/getting_started/downloads.html</a>. </p><p>That&#x27;s all we need to build GHC as a cross compiler. NodeJS can be installed via your system&#x27;s package manager if you want to run the JavaScript programs locally. We&#x27;ll assume it&#x27;s in your <code>$PATH</code> for the rest of the blog post.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="building-ghc">Building GHC<a class="hash-link" href="#building-ghc" title="Direct link to heading">​</a></h3><p>With all the dependencies installed, we can clone GHC HEAD and build the cross compiler:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://gitlab.haskell.org/ghc/ghc.git --recursive</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You should notice quite a few submodules being cloned as well as the main repo; expect this to take a while. Once this has completed, navigate to the <code>ghc</code> directory and run the following configuration commands:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cd ghc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">emconfigure ./configure --target=javascript-unknown-ghcjs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>emconfigure ./configure --target=javascript-unknown-ghcjs</code> will finish by outputting a screen that looks like:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Configure completed successfully.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Building GHC version  : 9.5.20221219</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Git commit id  : 761c1f49f55afc9a9f290fafb48885c2033069ed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Build platform        : x86_64-unknown-linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Host platform         : x86_64-unknown-linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Target platform       : javascript-unknown-ghcjs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Bootstrapping using   : /home/josh/.ghcup/bin/ghc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      which is version   : 9.4.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      with threaded RTS? : YES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Using (for bootstrapping) : gcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Using clang               : /home/josh/emsdk/upstream/emscripten/emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      which is version       : 15.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      linker options         :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Building a cross compiler : YES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Unregisterised            : NO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   TablesNextToCode          : YES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Build GMP in tree         : NO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   hs-cpp       : /home/josh/emsdk/upstream/emscripten/emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   hs-cpp-flags : -E -undef -traditional -Wno-invalid-pp-token -Wno-unicode -Wno-trigraphs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ar           : /home/josh/emsdk/upstream/emscripten/emar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ld           : /home/josh/emsdk/upstream/emscripten/emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   nm           : /home/josh/emsdk/upstream/bin/llvm-nm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   objdump      : /usr/bin/objdump</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ranlib       : /home/josh/emsdk/upstream/emscripten/emranlib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   otool        : otool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   install_name_tool : install_name_tool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   windres      :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   dllwrap      :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   genlib       :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Happy        : /home/josh/.cabal/bin/happy (1.20.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Alex         : /home/josh/.cabal/bin/alex (3.2.7.1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   sphinx-build :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   xelatex      :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   makeinfo     :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   git          : /usr/bin/git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   cabal-install : /home/josh/.cabal/bin/cabal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Using LLVM tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      clang : clang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      llc   : llc-14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      opt   : opt-14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   HsColour was not found; documentation will not contain source links</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Tools to build Sphinx HTML documentation available: NO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Tools to build Sphinx PDF documentation available: NO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Tools to build Sphinx INFO documentation available: NO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------------------------------------</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If everything is correct, you&#x27;ll see that the <code>Target platform</code> is set to
<code>javascript-unknown-ghcjs</code>, and the build tools will be set to their
Emscripten counterparts: <code>ar</code> becomes <code>emar</code>, <code>nm</code> becomes <code>llvm-nm</code>, etc.</p><p>Finally, to build GHC:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./hadrian/build --bignum=native -j --docs=none</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Expect this to take around a half hour or longer. If all goes well you should see:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/--------------------------------------------------------\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Successfully built library &#x27;ghc&#x27; (Stage1, way p).      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Library: _build/stage1/compiler/build/libHSghc-9.5_p.a |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Library synopsis: The GHC API.                         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\--------------------------------------------------------/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Copy package &#x27;ghc&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cabal-copy (for _build/stage1/lib/package.conf.d/ghc-9.5.conf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Run GhcPkg Recache Stage1: none =&gt; none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Copy file: _build/stage0/bin/javascript-unknown-ghcjs-ghc =&gt; _build/stage1/bin/javascript-unknown-ghcjs-ghc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Build completed in 1h00m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Take note of <code>_build/stage1/bin/javascript-unknown-ghcjs-ghc</code> path. This is the GHC executable that we&#x27;ll use to compile to JavaScript. To make life easier on ourselves we can alias it:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">alias ghc-js=`pwd`/_build/stage1/bin/javascript-unknown-ghcjs-ghc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="first-haskell-to-javascript-program">First Haskell to JavaScript Program<a class="hash-link" href="#first-haskell-to-javascript-program" title="Direct link to heading">​</a></h2><p>Now that we have a version of GHC that can output JavaScript, let&#x27;s compile a Haskell program and run it with NodeJS. Make a file named &quot;HelloJS.hs&quot;, with the following contents:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- HelloJS.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module Main where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main :: IO ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main = putStrLn &quot;Hello, JavaScript!&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we can compile it using the alias we defined earlier:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ghc-js HelloJS.hs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You should see the following output, and a <code>HelloJS</code> executable.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">[1 of 2] Compiling Main             ( HelloJS.hs, HelloJS.o )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2 of 2] Linking HelloJS.jsexe</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If you have NodeJS is on your <code>Path</code>, then this executable can be run just like any other command line program:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./HelloJS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello, JavaScript!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that a directory called <code>HelloJS.jsexe</code> was created. This directory
contains all the final JavaScript code, including a file named <code>all.js</code>, and a
minimal <code>index.html</code> HTML file that wraps <code>all.js</code>. For now, we&#x27;ll only care
about <code>all.js</code> and return to <code>index.html</code> later. <code>all.js</code> <em>is</em> the payload of our
<code>HelloJS</code> exectuable. The executable is simply a copy of <code>all.js</code>, with a call
to <code>node</code> added to the top. We could have equivalently run our program with:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">node HelloJS.jsexe/all.js</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="haskell-in-the-browser">Haskell in the Browser<a class="hash-link" href="#haskell-in-the-browser" title="Direct link to heading">​</a></h2><p>We saw in the previous example that GHC&#x27;s JavaScript backend allows us to write
Haskell and run the output JavaScript with NodeJS. This produces a portable
executable, but otherwise doesn&#x27;t enable anything we couldn&#x27;t do before; GHC can
already compile Haskell to run on most platforms! So let&#x27;s do something novel,
and run Haskell in the browser.</p><p>In this example, we&#x27;ll use Haskell to draw a simple SVG circle to our browser window. Put the following code in a file named <code>HelloBrowser.hs</code>:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- HelloBrowser.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module Main where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import Foreign.C.String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foreign import javascript &quot;((arr,offset) =&gt; document.body.innerHTML = h$decodeUtf8z(arr,offset))&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  setInnerHtml :: CString -&gt; IO ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circle :: String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">circle = &quot;&lt;svg width=300 height=300&gt;&lt;circle cx=50% cy=50% r=50%&gt;&lt;/circle&gt;&lt;/svg&gt;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main :: IO ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main = withCString circle setInnerHtml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that we&#x27;ve encountered a Haskell feature that&#x27;s only available in the
JavaScript backend: JavaScript foreign imports. This feature allows our Haskell
program to call JavaScript functions. In our example we use this feature to call
a JavaScript <a href="https://262.ecma-international.org/13.0/#prod-ArrowFunction" target="_blank" rel="noopener noreferrer">arrow
function</a> that
updates the <code>body</code> of the page with our HTML snippet containing a drawing of a
circle. Alternatively, we could have set the foreign import to a function symbol
like so:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">foreign import javascript &quot;setInnerHTML&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  setInnerHtml :: CString -&gt; IO ()</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>where <code>setInnerHTML</code> is defined in a <code>.js</code> file that is then loaded
by passing the JavaScript file to GHC along with the Haskell sources.</p><p>Next, we can compile our program to JavaScript, again with our built GHC:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ghc-js HelloBrowser.hs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Or <code>ghc-js HelloBrowser.hs foo.js</code> if <code>setInnerHTML</code> is defined in <code>foo.js</code>.</p><p>Recall the <code>index.html</code> file inside the <code>HelloBrowser.jsexe</code> directory. This HTML
file has our compiled JavaScript already included, so if you open it in your
browser, you&#x27;ll find it loads our SVG circle in the top-left of the page!</p><p><img alt="Example webpage screenshot" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAlgAAAJYCAIAAAAxBA+LAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAASdEVYdFNvZnR3YXJlAEdyZWVuc2hvdF5VCAUAABp4SURBVHhe7d29a1X7uvfhQ0CCwcZCkTSuIsi2EbuAsFYV0qWxEyScA48SWFVSpFo2AZsQCGkESSN2qYKoIIKQQkhjIQia2kbBP0AQYT/3ozcPa5+FM29zjDnGvK8Li/3iy8wYv+/4oCSZ//Wvf1397//5P3744YcffvhR88f/C+G/AaAqIQSgNCEEoDQhBKA0IQSgNCEEoDQhBKA0IQSgNCHsjc+fP7958+bp06fb29v3799fXl5eXFxcWFj4448/rl+/PjMzMz09ff78+ampqTNnzkxMTPzXD/Ef4r/G/xj/V/yE+Gnxk+OXxC+MXx6/SfxW8RvGbxu/efwR+YcBlCGEXXRwcPDkyZONjY2lpaX5+fkrV65MTk7+DFvT4g+KPy7+0Pij4wXEy4gXky8LYBwJ4eh9+fLl5cuX6+vrt2/fjr+uxV/gMkqdES8pXli8vHiR8VLjBedLB+g/IRyN/f39zc3NW7duzczMZG16JV52vPj4EOIDyQ8JoJ+EsD17e3tra2tzc3Nnz57NnoyF+HDig4oPLT7A/FAB+kMIm/Xhw4etra2FhYWpqansxliLDzM+2PiQ4wPPSwDQbULYiFevXq2srFy9ejX7UFJ8+HER4lLkRQHoJCEcpufPn9+5c+fixYuZAn6ICxKXJS5OXiaALhHCIYi/9CwtLV24cCEf/PxCXKK4UP6OCHSKEJ7c+/fv792719NP+xytuGhx6eIC5qUEGB0hPInHjx/Pzc3lQ51TiMsYFzMvK8AoCOExHBwcrK6u+ifQoYtLGhfWt7ABRkIIj+TFixc3b97MxzaNiYsclzovOkArhPAQjx49mp2dzec0rYgLHpc9bwBAw4Twl7a2tnwizAjFxY9bkDcDoDFC+L99//59fX19eno6n8eMVNyIuB1xU/L2AAybEP6HjY2NS5cu5TOYzoibErcmbxLAUAlhevDgweXLl/O5SyfFDYrblDcMYEiE8N87OzvXrl3LZy2dFzcrblnePIBTKx3C169fz8/P5/OVXokbF7cvbyTAKRQN4adPn+7evZvPVHorbmLcyrypACdSMYSbm5vnzp3LRyk9F7cybmjeWoDjqxXCvb29Gzdu5BOUMRK31fvjAydTJYTfvn1bXl7OpyZjKm5x3Oi85QBHUyKEu7u7vkdMEXGj43bnjQc4gjEP4devX5eWlvIZSRlx0+PW5yEAGGicQ/js2TN/ESwrbn0cgDwKAL82tiFcXV3NJyKFxTHIAwHwC2MYwrdv3/rUUP6/OAxxJPJwAPzDuIXw4cOHExMT+QiEH+JIxMHIIwLwn8YqhL5ZDAPE8ciDAvA3YxLCd+/eeR95DhWHJI5KHhqAH8YhhDs7O1NTU/mog4HiqHjzCuDveh/CtbW1fMLBkcWxyQMElNfvEC4uLuaDDY4pDk8eI6C2vobw48ePv//+ez7S4ETiCMVByiMFVNXLEO7v7//222/5MINTiIMUxykPFlBS/0K4u7s7OTmZjzE4tThOvk83VNazEG5vb+fTC4YqjlYeMqCYPoVwfX09H1rQgDhgedSASnoTwr/++isfV9CYOGZ54IAy+hHClZWVfFBBw+Kw5bEDauhBCP/88898REEr4sjl4QMK6HoIvb88IxEHL48gMO46HUIVZIS0EIrobgj9iygj599IoYKOhtBnx9ARPncGxl4XQ+grJegUX1MB461zIfRV83SQr7WHMdatEPoOanSW78EG46pDIdzd3c1HDnSS780NY6krIdzf3/eeEnRcHFHv2QTjpxMh/Pjxo/cXpBfioHovXxgznQih95qnR+K45sEFxsLoQ7i4uJgPGOiJOLR5fIH+G3EI19bW8tECvRJHNw8x0HOjDOHOzk4+VKCH4gDnUQb6bGQhfPfu3dTUVD5RoIfiAMcxzgMN9NbIQjg7O5uPE+itOMZ5oIHeGk0I7969mw8S6Lk4zHmsgX4aQQgfPnyYjxAYC3Gk83ADPdR2CN++fTsxMZHPDxgLcaTjYOcRB/qm7RDeuHEjHx4wRuJg5xEH+qbVEK6uruZjA8ZOHO886ECvtBfCZ8+e5QMDxlQc8jzuQH+0FMKvX7/OzMzk0wLGVBzyOOp56IGeaCmES0tL+aiAsRZHPQ890BNthNA77lKK9++Ffmk8hN++ffOPopQSBz6OfQ4A6LzGQ7i8vJyPBygjjn0OAOi8ZkO4t7eXDwYoJg5/zgDotmZD6MvnKcuX2ENfNBjCzc3NfCRASTGBHAPQYU2F8NOnT+fOncvnAZQUE4gh5CSArmoqhN5oCYI3aYLuaySEr1+/zscAlBdzyGEAndRICOfn5/MZAOXFHHIYQCcNP4Q7Ozv5AAB+iFHkPIDuGX4Ir127lusHfohR5DyA7hlyCB88eJDTB/4mppEjATpmyCG8fPly7h74m5hGjgTomGGGcGNjI0cP/EMMJKcCdMnQQvj9+/dLly7l4oF/iIHETHIwQGcMLYTr6+s5d+AXYiY5GKAzhhbC6enp3DrwCzGTHAzQGcMJ4dbWVg4dGCjGkrMBumE4IfQe9HBEMZacDdANQwjho0ePcuLAEcRkcjxABwwhhLOzs7lv4AhiMjkeoANOG8IXL17kuIEji+HkhIBRO20Ib968mcsGjiyGkxMCRu1UITw4OMhZA8cU88khASN1qhCurq7mpoFjivnkkICROlUIL1y4kJsGjinmk0MCRurkIXz8+HEOGjiRGFHOCRidk4dwbm4u1wycSIwo5wSMzglD+P79+5wycAoxpRwVMCInDOG9e/dyx8ApxJRyVMCInDCEvrkoDIVvPQojd5IQvnr1KkcMnFoMKqcFjMJJQri0tJQLBk4tBpXTAkbhJCH05YMwRL6gEEbr2CF8/vx5zhcYkphVDgxo3bFDeOfOndwuMCQxqxwY0Lpjh/DixYu5XWBIYlY5MKB1xwuhzxeFhvjcURiV44VwZWUlVwsMVYwrZwa063ghvHr1aq4WGKoYV84MaNcxQvjhw4ecLNCAmFiODWjRMUK4tbWVewUaEBPLsQEtOkYIFxYWcq9AA2JiOTagRccI4dTUVO4VaEBMLMcGtOioIdzb28uxAo2JoeXkgLYcNYRra2u5VKAxMbScHNCWo4Zwbm4ulwo0JoaWkwPactQQnj17NpcKNCaGlpMD2nKkEO7v7+dMgYbF3HJ4QCuOFMLNzc3cKNCwmFsOD2jFkUJ469at3CjQsJhbDg9oxZFCODMzkxsFGhZzy+EBrTg8hF++fMmBAq2I0eX8gOYdHsKXL1/mOoFWxOhyfkDzDg/h+vp6rhNoRYwu5wc07/AQ3r59O9cJtCJGl/MDmnd4CK9fv57rBFoRo8v5Ac07PIRnzpzJdQKtiNHl/IDmHRLCg4ODnCbQophejhBo2CEhfPLkSe4SaFFML0cINOyQEG5sbOQugRbF9HKEQMMOCeHS0lLuEmhRTC9HCDTskBDOz8/nLoEWxfRyhEDDDgnhlStXcpdAi2J6OUKgYYeEcHJyMncJtCimlyMEGjYohJ8/f85RAq2LAeYUgSYNCuGbN29ykUDrYoA5RaBJg0L49OnTXCTQuhhgThFo0qAQbm9v5yKB1sUAc4pAkwaF8P79+7lIoHUxwJwi0KRBIVxeXs5FAq2LAeYUgSYNCuHi4mIuEmhdDDCnCDRpUAgXFhZykUDrYoA5RaBJg0L4xx9/5CKB1sUAc4pAkwaF0HvTwwh5n3pox6AQzszM5CKB1sUAc4pAkwaFcHp6OhcJtC4GmFMEmjQohOfPn89FAq2LAeYUgSYNCuHU1FQuEmhdDDCnCDRpUAjPnDmTiwRaFwPMKQJNGhTCiYmJXCTQuhhgThFo0qAQ5hyBEckpAk0SQuiunCLQJP80Ch3ln0ahHT5ZBjrKJ8tAOwaF0JdPwAj58glox6AQ+oJ6GCFfUA/tGBRC32INRsi3WIN2DAqhb7oNI+SbbkM7BoXQ2zDBCHkbJmjHoBB6Y14YIW/MC+0YFMKFhYVcJNC6GGBOEWjSoBAuLi7mIoHWxQBzikCTBoVweXk5Fwm0LgaYUwSaNCiE9+/fz0UCrYsB5hSBJg0K4fb2di4SaF0MMKcINGlQCJ8+fZqLBFoXA8wpAk0aFMI3b97kIoHWxQBzikCTBoXw8+fPuUigdTHAnCLQpEEhDJOTkzlKoEUxvRwh0LBDQnjlypXcJdCimF6OEGjYISGcn5/PXQItiunlCIGGHRLCpaWl3CXQophejhBo2CEh3NjYyF0CLYrp5QiBhh0SwidPnuQugRbF9HKEQMMOCeHBwUHuEmhRTC9HCDTskBCGM2fO5DSBVsTocn5A8w4Pofeph5Z5b3po0+EhvH37dq4TaEWMLucHNO/wEK6vr+c6gVbE6HJ+QPMOD+HLly9znUArYnQ5P6B5h4fwy5cvuU6gFTG6nB/QvMNDGGZmZnKgQMNibjk8oBVHCuGtW7dyo0DDYm45PKAVRwrh5uZmbhRoWMwthwe04kgh3N/fz40CDYu55fCAVhwphOHs2bM5U6AxMbScHNCWo4Zwbm4ulwo0JoaWkwPactQQrq2t5VKBxsTQcnJAW44awr29vVwq0JgYWk4OaMtRQximpqZyrEADYmI5NqBFxwjhwsJC7hVoQEwsxwa06Bgh3Nrayr0CDYiJ5diAFh0jhB8+fMi9Ag2IieXYgBYdI4Th6tWrOVlgqGJcOTOgXccL4crKSq4WGKoYV84MaNfxQvjq1atcLTBUMa6cGdCu44UwXLx4MYcLDEnMKgcGtO7YIbxz505uFxiSmFUODGjdsUP4/Pnz3C4wJDGrHBjQumOHMFy4cCHnC5xaDCqnBYzCSUK4tLSUCwZOLQaV0wJG4SQh9LmjMEQ+XxRG6yQhDDMzMzli4BRiSjkqYEROGMJ79+7ljoFTiCnlqIAROWEI379/nzsGTiGmlKMCRuSEIQxzc3M5ZeBEYkQ5J2B0Th7Cx48f55qBE4kR5ZyA0Tl5CIMvKIQT8+WD0BGnCuHq6mpuGjimmE8OCRipU4Xw4OAgNw0cU8wnhwSM1KlCGG7evJmzBo4shpMTAkbttCF88eJFLhs4shhOTggYtdOGMMzOzua4gSOIyeR4gA4YQggfPXqU+waOICaT4wE6YAghDL71KByRby4KXTOcEG5tbeXKgYFiLDkboBuGE8IwPT2dQwd+IWaSgwE6Y2ghXF9fz60DvxAzycEAnTG0EH7//v3SpUs5d+AfYiAxkxwM0BlDC2HY2NjIxQP/EAPJqQBdMswQhsuXL+fogb+JaeRIgI4ZcggfPHiQuwf+JqaRIwE6ZsghDNeuXcvpAz/EKHIeQPcMP4Q7Ozu5fuCHGEXOA+ie4YcwzM/P5wMAyos55DCATmokhK9fv85nAJQXc8hhAJ3USAjD3bt38zEAhcUQchJAVzUVwk+fPp07dy4fBlBSTCCGkJMAuqqpEIbNzc18HkBJMYEcA9BhDYYw3LhxIx8JUEwc/pwB0G3NhnBvby+fClBMHP6cAdBtzYYwLC8v54MByohjnwMAOq/xEH779s3711NKHPg49jkAoPMaD2HY3d3NJwQUEAc+jz7QB22EMCwtLeVDAsZaHPU89EBPtBTCr1+/+gdSxl4c8jjqeeiBnmgphOHZs2f5tIAxFYc8jzvQH+2FMKyuruYDA8ZOHO886ECvtBrC4EvsGUu+fB76q+0Qvn37dmJiIh8eMBbiSMfBziMO9E3bIQwPHz7M5weMhTjSebiBHhpBCIM3aWJseKMl6LvRhDDMzs7mgwR6K45xHmigt0YWwnfv3k1NTeXjBHooDnAc4zzQQG+NLIRhZ2cnnyjQQ3GA8ygDfTbKEIa1tbV8qECvxNHNQwz03IhDGBYXF/PRAj0RhzaPL9B/ow9h+P333/MBA50XxzUPLjAWOhHCjx8//vbbb/mYgQ6LgxrHNQ8uMBY6EcKwv78/OTmZDxvopDiicVDzyALjoishDN6/l47zjrswljoUwrC9vZ2PHOiYOJx5TIHx0q0QhvX19XzwQGfEscwDCoydzoUw/PXXX/n4gQ6IA5lHExhHXQxhWFlZyYcQjFQcxTyUwJjqaAjDn3/+mY8iGJE4hHkcgfHV3RCGpaWlfCBB6+L45UEExlqnQxi0kJFQQaij6yEM/o2UlvkXUSilByEMPneG1vjsGKimHyEMvqaCFvhKCSioNyEMvtaeRvmqeaipTyEMvgcbDfEd1KCsnoUw7O7uep8KhiiOk++mDZX1L4Rhf3/f+xcyFHGQvLMSFNfLEIaPHz96X3tOKY6Qd9kF+hrCnxYXF/ORBscUhyePEVBbv0MY1tbW8sEGRxbHJg8QUF7vQxh2dnampqbyCQcDxVGJA5NHB2A8QhjevXs3Ozubjzr4hTgkcVTy0AD8MCYh/Onu3bv5wIN/iOORBwXgb8YqhOHhw4cTExP55IMf4kjEwcgjAvCfxi2E4e3btzdu3MhHIOXFYYgjkYcD4B/GMIQ/ra6u5oOQwuIY5IEA+IWxDWF49uzZzMxMPhEpJm59HIA8CgC/Ns4hDF+/fvUe9wXFTY9bn4cAYKAxD+FPu7u7/mpYRNxo30EbOJYSIQzfvn1bXl7OhyVjKm5x3Oi85QBHUyWEP+3t7fmE0rEUtzVubt5mgOOoFcKfNjc3z507l09Qei5uZdzQvLUAx1cxhOHTp0++Dc0YiJsYtzJvKsCJFA3hT69fv56fn89nKr0SNy5uX95IgFMoHcKfdnZ2rl27ls9XOi9ulrePAIZICNODBw8uX76cz1o6KW5Q3Ka8YQBDIoT/YWNj49KlS/ncpTPipsStyZsEMFRC+L99//59fX19eno6n8GMVNyIuB1xU/L2AAybEP7S1taW70czQnHx4xbkzQBojBAe4tGjR977vmVxweOy5w0AaJgQHsmLFy9u3ryZz2kaExc5LnVedIBWCOExHBwcrK6uXrhwIR/bDElc0riwcXnzQgO0SAhP4vHjx3Nzc/kU5xTiMsbFzMsKMApCeHLv37+/d++eT6g5gbhoceniAualBBgdIRyCV69eLS0t+SfTQ8UligsVlysvHEAHCOEwPX/+/M6dOxcvXswHPz/EBYnLEhcnLxNAlwhhI+IvPSsrK1evXs0UlBQfflwEf/8DOk4Im/Xhw4etra2FhYWpqansw1iLDzM+2PiQ4wPPSwDQbULYnr29vbW1tbm5ubNnz2Y3xkJ8OPFBxYfmPeKBPhLC0djf39/c3Lx161ZPP+k0Xna8+PgQ4gPJDwmgn4Rw9L58+fLy5cv19fXbt29fv379zJkzWZvOiJcULyxeXrzIeKnxgvOlA/SfEHbRwcHBkydPNjY2lpaW5ufnr1y5Mjk5mVFqWPxB8cfFHxp/dLyAeBm+4Qsw3oSwNz5//vzmzZunT59ub2/fv39/eXl5cXFxYWHhjz/+iL+uzczMTE9Pnz9/fmpqKv4CNzEx8TNs8R/iv8b/GP9X/IT4afGT45fEL4xfHr9J/FbxG8ZvG795/BH5hwGUIYQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhACUJoQAlCaEAJQmhAAU9u9//19DGrzCtvYzlwAAAABJRU5ErkJggg==" width="600" height="600"></p><p><code>index.html</code> contains the minimal HTML code required to load the generated JavaScript code. It simply loads the <code>all.js</code> file mentioned above with the following <code>script</code> tag that you can reuse in your own HTML files:</p><div class="codeBlockContainer_I0IT language-html theme-code-block"><div class="codeBlockContent_wNvx html"><pre tabindex="0" class="prism-code language-html codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">language</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">javascript</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">all.js</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">defer</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>As the JS backend still lacks support for some FFI features (foreign exports, foreign &quot;wrapper&quot; imports...), JavaScript codes can&#x27;t easily interact with Haskell codes. It reduces the amount of advanced/interesting examples we can present for now. We&#x27;ll publish new blog posts illustrating these features when they will be implemented.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>In this post, we&#x27;ve seen how to build a first Haskell program to run in the browser using a preview of GHC&#x27;s in-development JavaScript backend. This program used &quot;foreign imports&quot; to make a JavaScript function available within the Haskell code, which allows a limited interaction between Haskell and the browser. We also saw the structure of the outputs of the JavaScript backend, in the <code>.jsexe</code> directory, and how this allows our Haskell program to be invoked by a custom HTML wrapper. This was all enabled by building a version of GHC from source, with the build process having been configured with Emscripten to produce a GHC exectuable that targets JavaScript.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cross-compilation">cross-compilation</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Using GHC&#x27;s JavaScript Backend in the Browser" href="/2023-01-24-javascript-browser-tutorial"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2023-01-12-ghc-update">GHC DevX Update 2023-01-12</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-12T00:00:00.000Z" itemprop="datePublished">January 12, 2023</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Starting in 2023 we–the IOG GHC DevX team–are going to provide biweekly updates
about our work. This is the first edition.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="js-backend">JS backend<a class="hash-link" href="#js-backend" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="js-backend-in-the-browser-tutorial">JS backend in the browser tutorial<a class="hash-link" href="#js-backend-in-the-browser-tutorial" title="Direct link to heading">​</a></h3><p>We are working on a draft of a JS backend tutorial about using it to build a
simple web application: <a href="https://github.com/input-output-hk/engineering/pull/24" target="_blank" rel="noopener noreferrer">https://github.com/input-output-hk/engineering/pull/24</a></p><p>Publication is expected next week.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="cabal-support-for-js-sources">Cabal support for js-sources<a class="hash-link" href="#cabal-support-for-js-sources" title="Direct link to heading">​</a></h3><p>Sylvain made a patch to add cabal support for the <code>js-sources</code> stanza when
GHC is used as a compiler (and not only when GHCJS is used as a compiler):
<a href="https://github.com/haskell/cabal/pull/8636" target="_blank" rel="noopener noreferrer">https://github.com/haskell/cabal/pull/8636</a></p><p>It’s missing tests and then it should be ready to be merged.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="js-backend-ci">JS backend CI<a class="hash-link" href="#js-backend-ci" title="Direct link to heading">​</a></h3><p>Jeff worked on adding a proper CI job that runs the full testsuite
with the JS backend. Cf ticket
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22128" target="_blank" rel="noopener noreferrer">#22128</a> and merge request
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9552" target="_blank" rel="noopener noreferrer">!9552</a>.</p><p>He had to fix some unexpected test passes (!) with the JS backend due to an
imprecise <code>req_smp</code> predicate used by the testsuite. More details on
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22630" target="_blank" rel="noopener noreferrer">#22630</a> and
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9568" target="_blank" rel="noopener noreferrer">!9568</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="js-backend-template-haskell">JS backend: Template Haskell<a class="hash-link" href="#js-backend-template-haskell" title="Direct link to heading">​</a></h3><p>Luite and Sylvain started implementing support for Template Haskell (TH) with
the JS backend.</p><p>Sylvain reimplemented support for running an adapted version of the
THRunner.js script from GHCJS. He also refactored the JS linker and
implemented incremental linking.</p><p>The next step is to link and to run an instance of the external interpreter code
that implements the Template Haskell protocol (execution of the <code>Q</code> monad)
adapted to run in JavaScript. GHCJS used to have its own duplicated code for
this but for maintenance concerns it’s much better to reuse the external
interpreter code.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghci">GHCi<a class="hash-link" href="#ghci" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="ghci-sized-primitive-types-word8-etc">GHCi: sized primitive types (Word8#, etc.)<a class="hash-link" href="#ghci-sized-primitive-types-word8-etc" title="Direct link to heading">​</a></h3><p>Luite implemented support for sized primitive types in GHCi. Cf
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/8822" target="_blank" rel="noopener noreferrer">!8822</a>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ghci-prim-calling-convention">GHCi: “prim” calling convention<a class="hash-link" href="#ghci-prim-calling-convention" title="Direct link to heading">​</a></h3><p>Luite implemented support for the “prim” calling convention in GHCi. Cf
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9026" target="_blank" rel="noopener noreferrer">!9026</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="compiler-performance">Compiler performance<a class="hash-link" href="#compiler-performance" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="jeff">Jeff<a class="hash-link" href="#jeff" title="Direct link to heading">​</a></h3><p>Each of these improves allocations between 0.2 - 0.7% depending on the input
(improvements by a thousand cuts):</p><ul><li><p><strong>GHC.Foreign improved Strictness</strong>: An Attempt to remove lazy IO and SAT an
argument that is only used for a debug message. Got a review from Andreas.
Want to try to 2 more improvements then ready to merge.
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9644" target="_blank" rel="noopener noreferrer">!9644</a></p></li><li><p><strong>InfoTableProv: ShortText → ShortByteString</strong>: Post review from Ben I made some
improvements that preserved type safety and still recovered most of the
performance improvements. Ready to merge
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9637" target="_blank" rel="noopener noreferrer">!9637</a></p></li><li><p><strong>GHC.Unit.State</strong>: swapped use of Data.Map for GHC.Unique.UniqMap and expanded
UniqMap API. Results in progress (need to patch Haddock) and still
experimental. The idea here is to use a data structure that no longer needs to
balance on insertions because Unit.State performs a lot of merges on these
maps.</p></li><li><p><strong>GHC.Utils.Binary.foldGet’ removed lazy IO and lazy accumulator</strong>: merged
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9538" target="_blank" rel="noopener noreferrer">!9538</a></p></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="josh">Josh<a class="hash-link" href="#josh" title="Direct link to heading">​</a></h3><ul><li><p><strong>Stricter break</strong>: we noticed in a ticky profile that <code>GHC.List.break</code> allocates
3 thunks and 1 datacon per list element returned the first part of the list.
If this list is fully evaluated later, we can allocate only 1 datacon per list
element instead. Preliminary results bootstrapping GHC with this change look
very promising.</p></li><li><p><strong>FastMutInt (Binary)</strong>: Josh started reviving Sylvain’s MR
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7246" target="_blank" rel="noopener noreferrer">!7246</a> about
bundling more than one <code>Int#</code> in a <code>FastMutInt</code> for performance. He tried to
make a proof of concept generalisation of 2-FastMutInt into n-FastMutInts
(using GHC type level Natural). The types don’t really recurse in a convenient
way (Int -&gt; (… -&gt; IO ())) so it would probably introduce more complexity than
the problem is worth. Now, he’s just implementing the original patch with the
fixes and documentation.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHC DevX Update 2023-01-12" href="/2023-01-12-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-12-13-ghc-js-backend-merged">JavaScript backend merged into GHC</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-12-13T00:00:00.000Z" itemprop="datePublished">December 13, 2022</time> · <!-- -->20 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Joshua Meredith</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Moritz Angermann</span></a></div><small class="avatar__subtitle" itemprop="description">Head of DevX @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>A new JavaScript backend was
<a href="https://gitlab.haskell.org/ghc/ghc/-/commit/cc25d52e0f65d54c052908c7d91d5946342ab88a" target="_blank" rel="noopener noreferrer">merged</a>
into GHC on November 30th, 2022! This means that the next release of GHC will be
able to emit code that runs in web browsers without requiring any extra tools,
enabling Haskell for both front-end and back-end web applications.</p><p>In this post, we, the GHC DevX team at <a href="https://iohk.io/" target="_blank" rel="noopener noreferrer">IOG</a>, describe the
challenges we faced bringing GHCJS to GHC, how we overcame those challenges, and
what&#x27;s left to do. This post is rather long so we&#x27;ve provided these links in
case you would like to skip ahead:</p><p><a href="#ghcjs">Take me to the future of GHCJS</a><br>
<a href="#expectations">Tell me what to expect</a><br>
<a href="#roadmap">Show me the product roadmap</a><br>
<a href="#contributing">Tell me how I can help</a><br>
<a href="#build">Just show me how to hello world! (Skip to build instructions)</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="why-javascript-or-the-big-picture">Why JavaScript? Or, the Big Picture.<a class="hash-link" href="#why-javascript-or-the-big-picture" title="Direct link to heading">​</a></h2><p>To put it simply, the number of users on the internet is as low as it will ever
be <em>right now</em>, and it is almost guaranteed that those users use JavaScript. At
time of writing, JavaScript holds 97.3% of client-side programming <a href="https://w3techs.com/technologies/details/cp-javascript" target="_blank" rel="noopener noreferrer">market
share</a> (not to mention
market share of front-end technologies). Furthermore, JavaScript is not going to
disappear anytime soon. As more and more interactivity is pushed onto the
internet, JavaScript will become more entrenched because of backwards
compatibility, network effects and the amount of capital already devoted to it.
JavaScript, like C and
<a href="https://cacm.acm.org/news/244370-cobol-programmers-are-back-in-demand-seriously/fulltext?mobile=false" target="_blank" rel="noopener noreferrer">COBOL</a>
will be with us for the foreseeable future. This makes JavaScript an attractive
target; it provides portability, allows us to capitalize on the massive
investments in the language and platform, and essentially eliminates the risk
that the we build our technology atop a disappearing or deprecating foundation.</p><p>WebAssembly is a promising target as well, and <a href="https://www.tweag.io/" target="_blank" rel="noopener noreferrer">Tweag</a>
has just merged a <a href="https://www.tweag.io/blog/2022-11-22-wasm-backend-merged-in-ghc/" target="_blank" rel="noopener noreferrer">WebAssembly
backend</a> into
GHC (great work and congrats!). WebAssembly is not as ubiquitous as
JavaScript yet, and has a harder time interacting with JavaScript directly.
Hence, we believe that the WebAssembly and JavaScript backends provide different
strengths, and it is to the Haskell community&#x27;s benefit to have and support
both code generation paths in GHC for different use cases and requirements.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="why-haskell">Why Haskell?<a class="hash-link" href="#why-haskell" title="Direct link to heading">​</a></h2><p>JavaScript has many problems ranging from the
<a href="https://www.codeproject.com/Articles/182416/A-Collection-of-JavaScript-Gotchas" target="_blank" rel="noopener noreferrer">downstream</a>
<a href="https://wtfjs.com/" target="_blank" rel="noopener noreferrer">effects</a> of early <a href="https://dl.acm.org/doi/pdf/10.1145/3386327" target="_blank" rel="noopener noreferrer">design
decisions</a> (that inhibit programmer
productivity and are subtle bug generators), to ecosystem <a href="https://lwn.net/Articles/681410/" target="_blank" rel="noopener noreferrer">security
issues</a>, to <a href="https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/" target="_blank" rel="noopener noreferrer">fundamental
issues</a>
with asynchronous and concurrent programming.</p><p>These issues are problematic for our product domain. At IOG, a central
engineering requirement is to create a code base that has a high degree of
correctness. Haskell makes this easy; or to get a little technical, the
combination of Strong Static Hindley-Milner based typing allows us to write
performant, correct, and maintainable code. In addition to this, many of the
problems that occur in JavaScript are simply not expressible because of
Haskell&#x27;s type system and concurrency offerings.</p><p>There are, of course, competitors: <a href="https://www.purescript.org/" target="_blank" rel="noopener noreferrer">PureScript</a>
targets Javascript and provides a programmer experience close to Haskell&#x27;s. The
benefit of using Haskell instead is code sharing: we can write the front-end of a
web app in Haskell that compiles to JavaScript and the back-end in Haskell that
compiles to machine code. In particular, the (de)serialization code (e.g.
from/to JSON) is shared and cannot get out of sync between the front-end and the
back-end.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="why-a-ghc-backend">Why a GHC backend?<a class="hash-link" href="#why-a-ghc-backend" title="Direct link to heading">​</a></h2><p>Haskell is a language driven by its implementation in GHC. GHC development is
very active and GHC does not define a stable interface for compiler backends
that are independently maintained, which means that maintaining an out-of-tree
backend is costly.</p><p>The maintenance burden is not hypothetical; our teammate Luite Stegeman has been
developing a fork of GHC that emits JavaScript, called GHCJS, for close to 10
years and has experienced the pain first hand. Any changes to upstream GHC had
to be adapted to the customized fork or GHCJS would fall behind. And fall behind
it did: at the time of writing, GHCJS has stuck to using GHC 8.10, lagging
behind by three major releases and counting.</p><p>Similarly, the <a href="https://github.com/typelead/eta" target="_blank" rel="noopener noreferrer">Eta</a> compiler<!-- -->—<!-- -->which is
targeting the JVM<!-- -->—<!-- -->faced the same issues and appears to be discontinued
(compatibility with GHC 7.10.3&#x27;s Haskell from 2015 is mentioned).</p><p>Compounding the issue, the normal Haskell toolchain was not designed for an
edge case like GHCJS. So GHCJS required that the normal tooling, e.g., Cabal and
Stack, could distinguish between GHC and GHCJS compilers. This
meant that the GHCJS developers had to maintain the GHC fork, develop GHCJS, and
patch or contribute to Cabal and Stack. Simply put, the maintenance burden was
much too high per developer. Examples of differences between GHCJS and GHC:</p><ul><li>GHCJS had a double version<!-- -->—<!-- -->its own version and the version of GHC it was
based on<!-- -->—<!-- -->and build tools had to deal with both</li><li>GHCJS used non-standard file extension (e.g. <code>.js_o</code> and <code>.js_a</code> for objects
and static libraries respectively) and custom file formats (still true for
<code>.o</code> but no longer true for <code>.a</code>)</li></ul><p>So instead of spending engineering time and energy <em>responding</em> to ecosystem
changes and maintenance, the DevX team decided the best course of action was to
enhance GHC&#x27;s cross-compilation support and add a proper JavaScript backend
based on GHCJS. We feel that this adds value to the entire Haskell ecosystem,
keeps the JavaScript backend in sync with GHC, provides a better user experience
for all, reduces maintenance costs, and greatly improves the backends in GHC in
general. By implementing support for a JavaScript backend in GHC, we also
improve GHC&#x27;s support for cross-compilation (and testing cross-compilers), which
is directly applicable to the WebAssembly, iOS, and Android backends in GHC.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghcjs">Is GHCJS Dead?<a class="hash-link" href="#ghcjs" title="Direct link to heading">​</a></h2><p>Not yet! As it stands, the JavaScript backend doesn&#x27;t provide all the features
provided by GHCJS. In particular it doesn&#x27;t support Template Haskell and we&#x27;ve
removed the extended GHCJS FFI syntax to refine its design. See our roadmap
below for more details.</p><p>Nevertheless GHCJS is unlikely to be updated to use a GHC version more recent
than 8.10.x. So from our point of view it is in maintenance mode until the
JavaScript backend totally subsumes its features. New maintainers who want to
continue the development of GHCJS until its feature set has been fully subsumed
by mainline GHC are of course welcome.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="expectations">What is Missing From GHCJS?<a class="hash-link" href="#expectations" title="Direct link to heading">​</a></h2><p>The JavaScript backend borrows a lot of code from GHCJS, but not all of it.
Here are the main differences between GHCJS and the JavaScript backend:</p><ol><li><p>GHCJS was stuck on GHC version 8.10 while the JavaScript backend follows GHC HEAD.</p></li><li><p>GHCJS&#x27;s incremental linking support (&quot;base&quot; bundles) hasn&#x27;t been ported. This
feature required too many changes (such as adding new command-line flags) and
would have been backend-specific. This might be implemented in the future if
it proves to be useful for the newer Template Haskell implementation, for example.</p></li><li><p>GHCJS&#x27;s JavaScript code optimizer hasn&#x27;t been ported. The code was trying to
do too much all at once and consequently was fragile and slow. We plan to
work on an intermediate representation between STG and JavaScript to perform
the same optimizations with better performance, maintainability, and
reliability.</p></li><li><p>GHCJS&#x27;s compactor (link time optimizations) code hasn&#x27;t been ported. Some
optimizations have been reimplemented (e.g. global renaming of local
identifiers), but some other are lacking (e.g. compacting initialization code).
We plan to work on this as part of a larger effort on refactoring the code
generator, the linker, and some aspects of the runtime system.
More details are available in <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/22352" target="_blank" rel="noopener noreferrer">GHC issue #22352</a>.</p></li><li><p>GHCJS&#x27;s hacky support for plugins hasn&#x27;t been ported.
Instead we implemented a new way to load plugins from shared libraries that
works in any GHC cross-compiler. See
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20964" target="_blank" rel="noopener noreferrer">#20964</a> and
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7377" target="_blank" rel="noopener noreferrer">!7377</a>.</p><p>The common and convenient approach to load plugins still isn&#x27;t supported by
GHC when it is used as a cross-compiler (see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/14335" target="_blank" rel="noopener noreferrer">#14335</a> for more
details).</p></li><li><p>GHCJS&#x27;s support for Template Haskell hasn&#x27;t been ported. GHCJS had its own implementation
of an external interpreter (THRunner) which has been used as an inspiration
to implement GHC&#x27;s external interpreter (IServ).
While serving the same purpose, IServ is quite different from
THRunner and can&#x27;t be directly used as a substitute for it.
Retrofitting THRunner into Iserv is our next priority. More details on
<a href="https://engineering.iog.io/2022-05-17-javascript-template-haskell-external-interpreter" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-05-17-javascript-template-haskell-external-interpreter</a></p></li><li><p>GHCJS supported an extended FFI import syntax allowing Javascript code to be
inlined (the FFI import string supports templates of Javascript code with
placeholders for arguments). This hasn&#x27;t been ported because adding a
JavaScript parser to GHC was difficult and complex, and the imported code
made no safety guarantees whatsoever. For now, only JavaScript function calls
are supported.</p></li><li><p>Any command-line flag introduced by GHCJS has not been ported. We didn&#x27;t make
any change to GHC&#x27;s command line in this work except for adding a <code>-ddump-js</code>
flag. Other options will be added later as needed.</p></li><li><p>The JavaScript backend itself hasn&#x27;t been optimized and we even removed some
undocumented uses of NFData from GHCJS&#x27;s code. We intend to optimize
the JavaScript backend in a principled way (e.g. by first gathering evidence
with profiling).</p></li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="roadmap">What&#x27;s on the JS Backend&#x27;s Roadmap?<a class="hash-link" href="#roadmap" title="Direct link to heading">​</a></h2><p>Our top priorities are:</p><ul><li>Implementing Template Haskell support.</li><li>Reducing generated JavaScript code size.</li><li>Modernizing the generated JavaScript code. The code generator adapted from
GHCJS does not use more modern JavaScript features such as fat-arrows (<code>=&gt;</code>),
<code>symbols</code> and <code>let</code> bindings. We aim for the JavaScript backend to emit
JavaScript that comports with <a href="https://tc39.es/ecma262/" target="_blank" rel="noopener noreferrer">ECMA-262</a>.</li><li>Enhancing the run-time performance of the generated code</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="what-has-improved-compared-to-ghcjs">What has Improved Compared to GHCJS?<a class="hash-link" href="#what-has-improved-compared-to-ghcjs" title="Direct link to heading">​</a></h2><p>Or, why did it take you so long to port a stripped GHCJS into GHC? While it may
seem like such a task should be relatively quick<!-- -->—<!-- -->especially in a language
with such a good refactoring story like Haskell<!-- -->—<!-- -->there were numerous road
blocks that we needed to remove before adding the backend. In particular, here
were the troublesome bits:</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="removing-the-use-of-external-libraries">Removing the Use of External Libraries<a class="hash-link" href="#removing-the-use-of-external-libraries" title="Direct link to heading">​</a></h4><p>GHCJS used libraries that aren&#x27;t already dependencies of GHC, such as <code>text</code>, <code>lens</code>,
<code>attoparsec</code>, and <code>aeson</code>. As we didn&#x27;t want to add new dependencies to GHC, we&#x27;ve
refactored the code to avoid them. Examples:</p><ul><li>we&#x27;ve replaced <code>Text</code> with GHC&#x27;s <code>ShortText</code> (which provides a similar API)
and finally with GHC&#x27;s <code>FastString</code> in most cases (which is usually more
performant).</li><li>we&#x27;ve replaced a lot of lens-heavy code with its non-lens equivalents, because
GHC does not use lenses itself, and a design requirement was to stay within
existing code conventions.</li><li>we&#x27;ve replaced <code>pretty</code> with GHC&#x27;s pretty-printer (<code>SDoc</code>, etc.).</li><li>we&#x27;ve replaced <code>binary</code> with GHC&#x27;s <code>Binary</code> instances.</li></ul><p>GHCJS used to provide its own <code>base</code> and <code>prim</code> libraries: <code>ghcjs-base</code> and
<code>ghcjs-prim</code>. We&#x27;ve merged those into the existing <code>base</code> and <code>ghc-prim</code>
libraries.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="reusing-ghcs-build-system-hadrian">Reusing GHC&#x27;s Build System: Hadrian<a class="hash-link" href="#reusing-ghcs-build-system-hadrian" title="Direct link to heading">​</a></h4><p>GHCJS has a reputation for being complex to build. It relied on custom build
scripts to deal with the GHC fork it uses. The JavaScript backend however is as
easy to build as any other GHC. It doesn&#x27;t require any wrapper script, only the
<code>emconfigure</code> tool provided by the
<a href="https://emscripten.org/docs/getting_started/downloads.html" target="_blank" rel="noopener noreferrer">Emscripten</a>
project.</p><p>With a fresh checkout of the GHC source tree, you can now build a GHC with the
JavaScript backend with just these commands:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; ./boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; emconfigure ./configure --target=javascript-unknown-ghcjs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; ./hadrian/build --bignum=native -j</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note that if this doesn&#x27;t work, up to date instructions and troubleshootings can
be found on
<a href="https://gitlab.haskell.org/ghc/ghc/-/wikis/javascript-backend/building" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/wikis/javascript-backend/building</a></p><p>The Hadrian build system has been adapted to support Cabal&#x27;s <code>js-sources</code>
stanzas that are to support user-provided <code>.js</code> files. Both the <code>rts</code> and <code>base</code>
packages required this feature.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="support-for-running-ghcs-test-suite">Support for Running GHC&#x27;s Test Suite<a class="hash-link" href="#support-for-running-ghcs-test-suite" title="Direct link to heading">​</a></h4><p>GHC&#x27;s entire test suite can now run and check the JavaScript backend! We had to
tweak Hadrian to make this possible (to make Hadrian cross-compiler aware), but
the test suite has already found some bugs that we have since fixed.</p><p>However, in order to merge for the GHC 9.6 release we had to disable many tests
because of missing features (Template Haskell, Haskell Program Coverage (HPC),
compact regions, etc.) or because the generated code would time out (not
surprising given the missing optimizer and compactor).</p><p>But in the process of disabling those tests we&#x27;ve laid a good path forward.
We&#x27;ve added more precise properties to the test suite, which indicate the
required features to run each test. So when we implement some feature, it will
be painless to re-enable all its tests. In addition, failing tests now have
proper tickets in GHC&#x27;s <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/?sort=created_date&amp;state=opened&amp;label_name%5B%5D=javascript&amp;first_page_size=100" target="_blank" rel="noopener noreferrer">issue tracker</a>.</p><p>We&#x27;ve spent some time trying to run the test suite on CI but this work wasn&#x27;t
ready in time to be included in the initial commit with the rest of the backend.
For now, only some basic testing is done on CI: compiling a non trivial program
that uses the GHC library into JavaScript and executing it.
Nevertheless, we have a merge request in the works so that future contributions
should be properly validated by running the test suite on CI soon.</p><p>For the time being, the following command will run the
test suite locally:</p><blockquote><p>./hadrian/build --bignum=native -j2 test</p></blockquote><p>We use <code>-j2</code> to avoid running too many tests in parallel as this could allocate
too much memory and fail, which isn&#x27;t surprising as the JavaScript backend
hasn&#x27;t been optimized for memory usage yet.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="upgrading-from-ghc-810-to-ghc-96">Upgrading from GHC 8.10 to GHC 9.6<a class="hash-link" href="#upgrading-from-ghc-810-to-ghc-96" title="Direct link to heading">​</a></h4><p>The latest version of GHCJS is based on a fork of GHC 8.10.7. We spent a
significant amount of time adapting the code generator to support GHC HEAD. In
practice this meant:</p><ul><li>Adding support for new primops, especially sized primitives.</li><li>Adapting to <code>ghc-bignum</code> changes.</li><li>Adapting to internal changes.</li><li>Fixing support for polymorphism in kinds.</li><li>Fixing support for unlifted newtypes.</li><li>Fixing support for unboxed sums.</li><li>Many other fixes...</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="fixing-some-performance-issues">Fixing Some Performance Issues<a class="hash-link" href="#fixing-some-performance-issues" title="Direct link to heading">​</a></h4><p>As we haven&#x27;t ported GHCJS&#x27;s Compactor, output size was predictably incredibly
large. So we&#x27;ve spent time re-implementing a crucial piece of the
Compactor<!-- -->—<!-- -->renaming and shortening of local variables<!-- -->—<!-- -->using a different
approach. Our new approach ended up being faster than GHCJS&#x27;s compactor. For the
GHC devs out there, as we first replaced the <code>Text</code> type with the <code>FastString</code>
type, the newer Compactor can now replace a <code>FastString</code>-based identifier with a
new identifier derived from the <code>FastString</code>&#x27;s <code>Unique</code> in constant time.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="removal-of-custom-file-extensions-and-support-for-javascript-pragmas">Removal of Custom File Extensions and Support for JavaScript Pragmas<a class="hash-link" href="#removal-of-custom-file-extensions-and-support-for-javascript-pragmas" title="Direct link to heading">​</a></h4><p>GHCJS used the <code>.js.pp</code> file extension to identify JavaScript files that needed
to be passed through CPP before being valid JavaScript. Adding support for this
extension in both Hadrian and GHC proved to be more work than just adding
support for JavaScript pragmas. So we decided to do the latter; similarly to
Haskell extension pragmas, you can now write <code>//#OPTIONS: CPP</code> in your
JavaScript files to enable the CPP pass, and the file extension is always <code>.js</code>.</p><p>While we&#x27;re on the topic of file extensions, technically <code>.js</code> files don&#x27;t have
to be compiled into <code>.o</code> files (contrary to C/C++/Haskell/etc. files) at all.
However, build systems (Hadrian, Cabal...) and compilers (GHC) expect this. So
for consistency with other backends, we&#x27;ve added a fake compilation pass for
<code>.js</code> files too. They are now renamed into <code>.o</code> files with a <code>//JAVASCRIPT</code>
header added to distinguish them from object files produced by the JavaScript
backend (and from Emscripten, in the future).</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="blogs">Cleanup and Documentation<a class="hash-link" href="#blogs" title="Direct link to heading">​</a></h4><p>GHC provides some utilities (pretty-printer, binary serialization, string
interning, etc.) that GHCJS did not make use of. So we adapted the GHCJS code to
exploit these utilities, keep the JavaScript backend similar to other backends,
and for better performance.</p><p>Three of us (out of four) were totally new to GHCJS&#x27;s code base.
We strived to grok the code and to make it understandable by adding
a lot of comments and refactoring.
Throughout this process we logged our learning in our engineering blog
to explain some (sadly not all) technical details about GHCJS&#x27;s internals:</p><ul><li><a href="https://engineering.iog.io/2022-05-17-javascript-template-haskell-external-interpreter/" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-05-17-javascript-template-haskell-external-interpreter/</a></li><li><a href="https://engineering.iog.io/2022/05/24/april-GHCJS-Objectable-vs-GHC-Binary/" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022/05/24/april-GHCJS-Objectable-vs-GHC-Binary/</a></li><li><a href="https://engineering.iog.io/2022-07-18-lightweight-threads-on-JavaScript/" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-07-18-lightweight-threads-on-JavaScript/</a></li><li><a href="https://engineering.iog.io/2022-07-20-js-backend-prim-types/" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-07-20-js-backend-prim-types/</a></li><li><a href="https://engineering.iog.io/2022-07-26-the-ghcjs-linker/" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-07-26-the-ghcjs-linker/</a></li><li><a href="https://engineering.iog.io/2022-08-18-js-backend-ffi/" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-08-18-js-backend-ffi/</a></li><li><a href="https://engineering.iog.io/2022-09-23-ghcjs-heap-representation/" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-09-23-ghcjs-heap-representation/</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="plugin-support-in-cross-compilers">Plugin Support in Cross-Compilers<a class="hash-link" href="#plugin-support-in-cross-compilers" title="Direct link to heading">​</a></h4><p>GHC doesn&#x27;t support plugins when built as a cross-compiler (cf
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/14335" target="_blank" rel="noopener noreferrer">#14335</a>). This is because it
cannot yet support two environments at once: one for the target code (JavaScript
code here) and one for the host (e.g. native x86 or AArch64 code for the
plugin). We&#x27;ve spent a lot of time making it more modular (see the <a href="https://hsyl20.fr/home/files/papers/2022-ghc-modularity.pdf" target="_blank" rel="noopener noreferrer">Modularizing
GHC</a> white paper we
published earlier this year and Sylvain&#x27;s <a href="https://youtu.be/OHGH5HLOCEM" target="_blank" rel="noopener noreferrer">lightning
talk</a> at HIW 2022) but there is a lot more to do
to achieve this (cf
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/17957" target="_blank" rel="noopener noreferrer">#17957</a>).</p><p>GHCJS used a fragile hack to support plugins: at plugin loading time it would
substitute the plugin unit with another corresponding one from another package
database (For the non-GHC devs out there interested in GHC Units see this
<a href="https://gitlab.haskell.org/ghc/ghc/-/blob/master/compiler/GHC/Unit.hs" target="_blank" rel="noopener noreferrer">note</a>).
This was fragile because it could violate GHC&#x27;s single environment assumptions.</p><p>GHCJS&#x27;s hack did not get ported. Nevertheless we have implemented a new way for
GHC to load plugins directly from libraries instead of packages
(<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20964" target="_blank" rel="noopener noreferrer">#20964</a>/<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7377" target="_blank" rel="noopener noreferrer">!7377</a>).
This method doesn&#x27;t require GHC to load module interfaces for the plugin and its
dependencies, hence workarounds GHC&#x27;s limitations.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="what-about-libraries-using-c-sources">What About Libraries Using C Sources?<a class="hash-link" href="#what-about-libraries-using-c-sources" title="Direct link to heading">​</a></h2><p>Libraries that use C sources (<code>c-sources</code> Cabal stanza) aren&#x27;t supported by the
JavaScript backend. In the future we plan to use Emscripten to compile C sources
and then to generate some adapter code for them, but this isn&#x27;t done yet.</p><p>For now, there are two ways to fix libraries that use C sources.
The C code can either be rewritten in Javascript, or it can be rewritten in
Haskell.
Then it is possible to use Cabal predicates (e.g. <code>arch(js)</code>) to select between
the different versions.</p><p>We do have a preference for writing pure Haskell versions because it is more
future proof.
For example if someone adds some new backends for Lua, Java, CLR, etc. then the
Haskell version can be directly compiled by that backend and there is no extra work.
In contrast, if the C source is rewritten in JavaScript, then it would need to
be rewritten <em>for each</em> backend.</p><p>That is the approach we&#x27;ve taken when we wrote the <code>ghc-bignum</code> library.
<code>Ghc-bignum</code> provides a &quot;native&quot; implementation written in Haskell that is
functionally equivalent to the GMP based implementation. Of course, besides
being more future proof the Haskell version is just more pleasant to write than
the Javascript version.</p><p>Note that GHCJS came with a &quot;shim&quot; library where a shim is JavaScript source
code specifically for some package. For example, GHCJS provided shims for
packages like <code>text</code>, <code>process</code>, and <code>hashable</code>. We do not intend the JavaScript
backend to provide shims so these JavaScript sources will have to be upstreamed
or reimplemented in Haskell.</p><p>Note that the linking behavior is different due to the interpreted nature of
Javascript. In the JavaScript backend, we can link with libraries using foreign
imports <em>even if</em> the imported functions don&#x27;t exist. Instead of failing at link
time (which is what usually happens with native code) a JavaScript exception is
raised only when and if the imported function is called.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="contributing">How to Help?<a class="hash-link" href="#contributing" title="Direct link to heading">​</a></h2><p>We have now reached our first milestone; anyone can easily build and test the
JavaScript backend, and anyone can open bug reports or offer patches for the
JavaScript backend on GHC&#x27;s GitLab.</p><p>For those who offered their help this year: thank you! Until now it was
difficult to split the work into independent tasks (one fix led to a new
failure, which led to an architectural issue, etc.) and it was difficult to
coordinate with people outside of our team. However, we&#x27;re now in a much better
position to discuss suggestions and to test/review patches in the spirit of open
source.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="build">tl;dr Just Tell Me How to Say Hello World<a class="hash-link" href="#build" title="Direct link to heading">​</a></h2><p>You need:</p><ul><li><a href="https://emscripten.org/docs/getting_started/downloads.html" target="_blank" rel="noopener noreferrer">Emscripten</a>
version 3.14 or better. Be sure that your emscripten is bundled with either
LLVM 15 or an up to date, patched LLVM 14.</li><li><a href="https://nodejs.org/en/" target="_blank" rel="noopener noreferrer">Nodejs</a>, latest stable version. Only if you want to
run the compiled JavaScript with node.</li></ul><p>Most Linux distributions will have the necessary LLVM patches. If you&#x27;re on NixOS,
you&#x27;ll need to use <code>llvm_git</code> and hope for the best. <a href="https://github.com/doyougnu/ghc.nix" target="_blank" rel="noopener noreferrer">This
fork</a> of <code>ghc.nix</code> will also be useful to
you.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="checkout-the-ghc-source">Checkout the GHC source<a class="hash-link" href="#checkout-the-ghc-source" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">git clone --recurse-submodules https://gitlab.haskell.org/ghc/ghc.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ghc # ensure you are in the ghc source tree for the following commands</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="update-the-submodules">Update the submodules<a class="hash-link" href="#update-the-submodules" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">git submodule update --init --recursive</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="boot-and-configure-for-javascript">Boot and Configure for JavaScript<a class="hash-link" href="#boot-and-configure-for-javascript" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./boot &amp;&amp; emconfigure ./configure --target=js-unknown-ghcjs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You should see <code>configure</code> finish and report something similar:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Configure completed successfully.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Building GHC version  : 9.5.20220819</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Git commit id  : 08c3c4783c72d3173d79ccda2ac282e2d3e04e34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Build platform        : x86_64-unknown-linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Host platform         : x86_64-unknown-linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Target platform       : js-unknown-ghcjs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Bootstrapping using   : /nix/store/4bkmkc7c98m4qyszsshnw9iclzzmdn4n-ghc-9.2.3-with-packages/bin/ghc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      which is version   : 9.2.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      with threaded RTS? : YES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Using (for bootstrapping) : /nix/store/yzs8390walgk2rwl6i5li2g672hdn0kv-gcc-wrapper-11.3.0/bin/cc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Using clang               : /nix/store/p894nlicv53firllwgrfxfi51jzckh5l-emscripten-3.1.15/bin/emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      which is version       : 15.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      linker options         : </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Building a cross compiler : YES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Unregisterised            : NO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   TablesNextToCode          : YES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Build GMP in tree         : NO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   hs-cpp       : /nix/store/p894nlicv53firllwgrfxfi51jzckh5l-emscripten-3.1.15/bin/emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   hs-cpp-flags : -E -undef -traditional -Wno-invalid-pp-token -Wno-unicode -Wno-trigraphs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ar           : /nix/store/p894nlicv53firllwgrfxfi51jzckh5l-emscripten-3.1.15/bin/emar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ld           : /nix/store/p894nlicv53firllwgrfxfi51jzckh5l-emscripten-3.1.15/bin/emcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   nm           : /nix/store/0dp0bfg9sncg7bjy389zwyg2gskknm6b-emscripten-llvm-3.1.15/bin/llvm-nm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   objdump      : /nix/store/zgvxnf9047rdd8g8kq2zxxm9k6kfqf8b-binutils-2.38/bin/objdump</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ranlib       : /nix/store/p894nlicv53firllwgrfxfi51jzckh5l-emscripten-3.1.15/bin/emranlib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   otool        : otool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   install_name_tool : install_name_tool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   windres      : </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   dllwrap      : </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   genlib       : </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Happy        : /nix/store/ijdmyaj6i6hgx5ll0lxxgcm9b0xn8nma-happy-1.20.0/bin/happy (1.20.0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Alex         : /nix/store/qzgm2m7p7xc0fnyj4vy3jcmz8pvbg9p7-alex-3.2.6/bin/alex (3.2.6)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   sphinx-build : /nix/store/27dk5i52465a4azjr2dqmrhyc0m4lpf2-python3.9-sphinx-4.5.0/bin/sphinx-build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   xelatex      : /nix/store/8jc2258h4nqzqjy303zzkssd3ip675pf-texlive-combined-2021/bin/xelatex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   makeinfo     : /run/current-system/sw/bin/makeinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   git          : /nix/store/vsr2cn15h7cbwd5vqsam2ab2jzwfbyf9-git-2.36.0/bin/git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   cabal-install : /nix/store/cjmd2qv1b5pdw4lxh1aw4xwwy4ibnb2p-cabal-install-3.6.2.0/bin/cabal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Using LLVM tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      clang : clang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      llc   : llc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      opt   : opt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   HsColour was not found; documentation will not contain source links</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Tools to build Sphinx HTML documentation available: YES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Tools to build Sphinx PDF documentation available: YES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Tools to build Sphinx INFO documentation available: YES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------------------------------------</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Be sure to verify that <code>ar</code>, <code>ld</code>, <code>nm</code> and friends point to the emscripten
versions, i.e., the output shows <code>&lt;tool&gt; : &lt;some-path&gt;-emscripten-&lt;tool&gt;</code>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="build-the-javascript-backend">Build the JavaScript backend<a class="hash-link" href="#build-the-javascript-backend" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">./hadrian/build --bignum=native -j</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="now-compile-hello-world">Now Compile Hello World<a class="hash-link" href="#now-compile-hello-world" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-hs theme-code-block"><div class="codeBlockContent_wNvx hs"><pre tabindex="0" class="prism-code language-hs codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">module Main where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main :: IO ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main = putStrLn &quot;Hello JS!&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ &lt;path-to-ghc-root-dir&gt;/_build/ghc-stage1 -fforce-recomp Main.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./Main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ Hello JS!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Under the hood <code>Main</code> is just a JavaScript program written as a script with
<code>nodejs</code> as the interpreter. This means you can treat the compiled program like
any other JavaScript program: loading it into JavaScript tooling or hack on it
by hand. This also means that all compiled programs, such as <code>Main</code>, are
human-readable, for example here are the first ten lines:</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx js"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ head </span><span class="token maybe-class-name">Main</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">env node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> h$currentThread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> h$stack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> h$sp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> h$initStatic </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> h$staticThunks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> h$staticThunksArr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> h$CAFs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> h$CAFsReset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> h$regs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The program begins with a shebang instructing the operating system to send the
rest of the file to <code>nodejs</code>. The remaining lines are our actual program, which
starts with global variables that the runtime system, garbage collector, and
scheduler need. Now human-readable is not the same as easy to understand, for
example here is the logic that implements a <code>Maybe</code>:</p><div class="codeBlockContainer_I0IT language-js theme-code-block"><div class="codeBlockContent_wNvx js"><pre tabindex="0" class="prism-code language-js codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">h$baseZCGHCziMaybeziJust_con_e</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">h$rs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">h$baseZCGHCziMaybeziJust_e</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> h$$13be2042 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h$r2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">h$r1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">h$c1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h$baseZCGHCziMaybeziJust_con_e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> h$$13be2042</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">h$rs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">h$baseZCGHCziMaybeziNothing_con_e</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">h$rs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If you would like to understand this code and how the JavaScript backend works
in general please see <a href="#blogs">our other blog posts</a>. In any case, we invite you
to try it out, hack, and be merry!</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="acknowledgements">Acknowledgements<a class="hash-link" href="#acknowledgements" title="Direct link to heading">​</a></h2><p>We want to thank Jan Hrcek, and David Thrane Christiansen for their time, labor,
comments, and suggestions on drafts of this blog post.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cross-compilation">cross-compilation</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about JavaScript backend merged into GHC" href="/2022-12-13-ghc-js-backend-merged"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-09-23-ghcjs-heap-representation">GHCJS heap representation</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-09-23T00:00:00.000Z" itemprop="datePublished">September 23, 2022</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>I recently gave a short presentation about heap objects representation in GHCJS and hence in the upcoming JS backend for GHC. This post is a summary of the content.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="heap-objects">Heap objects<a class="hash-link" href="#heap-objects" title="Direct link to heading">​</a></h2><p>GHC implements Haskell code evaluation by using graph reduction. As such Haskell
programs compiled by GHC use the heap to store nodes of the graph to be
reduced and utility nodes participating in graph reduction. These nodes are:</p><ul><li>FUN: functions with their free variables as payload</li><li>THUNK: suspensions with their free variables as payload</li><li>PAP: partial application to a FUN. FUN closure and already applied arguments
as payload.</li><li>IND: indirection to another heap object</li><li>BLACKHOLE: used to overwrite a THUNK when it is being evaluated</li></ul><p>The heap is also used to store other values:</p><ul><li>CON: boxed values (saturated constructor applications) with field values as payload</li><li>Other unlifted values: TSO, BCO, arrays, MutVar#, MVar#, TVar#, stacks, stack frames...</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="info-tables">Info tables<a class="hash-link" href="#info-tables" title="Direct link to heading">​</a></h2><p>Many heap objects share the same properties: e.g. all <code>Int</code> CON objects are
exactly the same except for their payload (the <code>Int#</code> value) that may be
different.
Hence heap objects are split in two parts to allow sharing of common properties:</p><ul><li>info table: statically known properties (at compilation time) that can be
shared by several heap objects</li><li>heap object itself: dynamically allocated in the heap</li></ul><p>Heap objects always have the same layout in the native code generated by GHC.
They are composed of:</p><ul><li>a pointer to an info table</li><li>some words of payload</li></ul><p>Heap traversal is done by following the info table pointer of every heap
object to query in the info table the layout of the heap object payload.</p><p>Info tables contain a pointer to a function called &quot;entry code&quot; that can be
specific to each info table. This code is mainly used to apply a node to some
arguments.
Note that with tables-next-to-code optimisation enabled, to avoid an
indirection the info table pointer is actually a pointer to this entry code and
the info table itself is stored in the words preceeding the entry code.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="heap-objects-in-javascript">Heap objects in JavaScript<a class="hash-link" href="#heap-objects-in-javascript" title="Direct link to heading">​</a></h2><p>GHCJS represents most heap objects with a JavaScript object having the following
fields:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>One question I had was: why don&#x27;t we use a JS array instead of a JS object?
Arrays should be faster than objects (i.e. hashmaps), no? It turns out that
objects like this are optimised by JS engines using &quot;hidden classes&quot; (see
<a href="https://v8.dev/blog/fast-properties" target="_blank" rel="noopener noreferrer">https://v8.dev/blog/fast-properties</a> for an explanation). That&#x27;s why
they are usually more efficient than arrays for which bound checking must be
made. Also arrays are larger in memory because they need to store their size.</p><p>Let&#x27;s now discuss the fields of the heap objects.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="f-field">f field<a class="hash-link" href="#f-field" title="Direct link to heading">​</a></h3><p>&quot;f&quot; is the equivalent of the info table pointer. It contains a JavaScript
function that is the entry code for the heap object.</p><p>Similar to the tables-next-to-code optimisation discussed above, we use the
fact that JS functions are objects which have properties to store the info
table fields as properties of the function itself.</p><p>Example of an info table / entry function:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token known-class-name class-name">Function</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> h$entry_function_xyz</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> t    </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) object type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) number of fields in payload (-1 if variable layout)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i    </span><span class="token comment" style="color:#999988;font-style:italic">// (Array) fields layout (empty if variable layout)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n    </span><span class="token comment" style="color:#999988;font-style:italic">// (String) object name for debug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a    </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) function arity or constructor tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> r    </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) arity in number of JS variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s    </span><span class="token comment" style="color:#999988;font-style:italic">// (Array) static refs that must be kept alive (SRT)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m    </span><span class="token comment" style="color:#999988;font-style:italic">// GC mark</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="d1-d2-fields">d1, d2 fields<a class="hash-link" href="#d1-d2-fields" title="Direct link to heading">​</a></h3><p>The d1 and d2 fields contain the payload of the heap object: constructor fields,
function free variables, etc.</p><p>Payloads can be composed of zero, one, or many fields. A naive solution would be
to have one JS object field (d1, d2, d3...) per payload field. However it would
be bad for two reasons:</p><ul><li><p>performance: JS engine hidden classes optimisation mentioned above needs
objects to have the same field structure.</p></li><li><p>genericity: we couldn&#x27;t write generic functions (e.g. to copy a closure)
without dynamically querying the number of fields composing the payload.</p></li></ul><p>Another solution would be to use a single field to store the whole payload. It
would fulfill the genericity constraint. However performance may not be good
because of the extra allocation of the object containing the payload and the
indirection to access its fields.</p><p>Instead GHCJS uses a middle ground approach: it always uses only two JS object
fields to store any number of payload fields. The following encoding is used to
stash any number of payload fields into two JS fields:</p><table><thead><tr><th>Payload</th><th>d1</th><th>d2</th></tr></thead><tbody><tr><td>[]</td><td>null</td><td>null</td></tr><tr><td>[a]</td><td>a</td><td>null</td></tr><tr><td>[a,b]</td><td>a</td><td>b</td></tr><tr><td>[a,b,c]</td><td>a</td><td>{d1=b,d2=c}</td></tr><tr><td>[a,b,c,d...]</td><td>a</td><td>{d1=b,d2=c,d3=d...}</td></tr></tbody></table><p>It still fulfills the genericity constraint and small objects (up to two fields
of payload) don&#x27;t pay for an extra allocation/indirection. The price to pay is
that two fields of payload are always allocated, even for for objects with 1
field of payload.</p><p>It would be interesting to benchmark the performance of the different payload
representations.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="m-field">m field<a class="hash-link" href="#m-field" title="Direct link to heading">​</a></h3><p>The &quot;m&quot; field is used both for reachability checking (~ garbage collection) and
to implement the &quot;stable names&quot; features.</p><p>GHCJS can&#x27;t rely on the JS engine to know when a heap object is collected. So it
implements its own heap traversal algorithm for this. The &quot;m&quot; field is used as a
marker for this algorithm (it will be the topic of a future blog post).
In this case, the &quot;m&quot; field is a number (a GC mark).</p><p>When a StableName is created for an object, the &quot;m&quot; field of the object is
updated to point to the StableName object:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$StableName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> m </span><span class="token comment" style="color:#999988;font-style:italic">// GC mark</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s </span><span class="token comment" style="color:#999988;font-style:italic">// stable name unique id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The &quot;m&quot; field of the StableName object is used in replacement of the mark of the object.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="cc-field">cc field<a class="hash-link" href="#cc-field" title="Direct link to heading">​</a></h3><p>The &quot;cc&quot; field is the cost center associated to the heap object. This field is
only present when profiling mode is enabled. Cost centers are entered (pushed on
the cost center stack of the current thread) before the evaluation of thunks and
function applications.</p><p>Cost centers are allocated with the <code>h$CC</code> function.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="other-heap-object-representation">Other heap object representation<a class="hash-link" href="#other-heap-object-representation" title="Direct link to heading">​</a></h2><p>The generic heap object representation presented above is only used for some
objects: those involved in graph reduction (e.g. updatable objects) and values
that don&#x27;t have a fixed layout (e.g. CON objects have different layouts
depending on which constructor they represent). The object layout allows generic
access to the infotable and to the payload, and the infotable describes the
object type and the payload layout.</p><p>Several other objects don&#x27;t need this machinery: they always have the same
layout and are never the result of a reduction (they are unlifted values). These
objects are represented as JS objects with any fields they need (i.e. not using
the d1/d2 encoding above). To determine the type of such heap objects, instead
of using the &quot;type&quot; field of an infotable the code uses the <code>instanceof</code>
operator. For example a TSO is represented as a <code>h$Thread</code> object.</p><p>Note that we could be tempted to give every heap object a different object name
and to always use <code>instanceof</code> instead of the infotable &quot;type&quot; properties. It
would mean adding <code>h$Con</code>, <code>h$Thunk</code>, <code>h$Fun</code>, <code>h$Pap</code>, <code>h$Blackhole</code>, and
<code>h$StackFrame</code> objects. Then all the heap objects could be treated in the same
way. However the isssue is that these objects need to be overwritable in place:
a Thunk becomes a Fun/Con/Pap/Blackhole, etc. As far as I know we can&#x27;t update
the &quot;instance&quot; of an object, so all these object have to be instances of
the same JS object.</p><p>Also note that the JS backend doesn&#x27;t need INDirection nodes because it can
always overwrite the fields of a JS object with the fields of another to update
a closure. For the record, indirection nodes are needed in backends that
layout closures as a chunk of bytes/words and when the size of the closure to
update is smaller than the size of the updatee closure.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="automatic-unboxing">Automatic unboxing<a class="hash-link" href="#automatic-unboxing" title="Direct link to heading">​</a></h3><p>Sometimes the generic heap object representation is unnecessary. For example, a
boxed <code>Int</code> would be represented as a <code>CON</code> heap object with the <code>Int#</code> in its
payload, represented as a JavaScript number value. The only thing we can do with
this heap object is to pass it around and to extract its payload. As such, it is
more memory efficient to directly pass the payload (a JS number).</p><p>GHCJS provides an optimisation that consists in automatically unboxing some CON
heap objects. For example, Haskell booleans (True and False datacons) are
directly mapped to JavaScript booleans, boxed numbers (Float, Double, Int, Word,
Int8, etc.) are directly mapped to JavaScript numbers.</p><p>We can do this because JavaScript already provides some boxing of its own: we
can use the <code>typeof</code> operator on a heap object to know if it is a JS object, a
JS number, a JS boolean, etc. It makes it possible to distinguish between heap
object representations. In comparison, we can&#x27;t do this with the native (non-JS)
backend when we only have a pointer to a heap object: the pointer doesn&#x27;t carry
the kind of value it points to, hence the pointed memory location must be
generic enough for this introspection to be performed (e.g. using infotable
pointers).</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">​</a></h2><p>Heap object can be represented as JS values (number, boolean) because of the
automatic unboxing, or as JS objects: discimination is done with the <code>typeof</code>
operator.</p><p>Heap objects represented as JS objects come in two flavours:</p><ul><li>unlifted objects are represented with specific JS objects, disciminated with
the <code>instanceof</code> operator</li><li>other objects use the following generic and updatable structure:</li></ul><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">cc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHCJS heap representation" href="/2022-09-23-ghcjs-heap-representation"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-08-18-js-backend-ffi">GHCJS FFI system in the JS Backend</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-08-18T00:00:00.000Z" itemprop="datePublished">August 18, 2022</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ol><li><a href="#orgcf7b9df">The Design Space</a></li><li><a href="#orgdca8008">GHCJS<!-- -->’<!-- -->s FFI</a></li><li><a href="#org461ca2a">Lightweight safety checks</a></li><li><a href="#orge4568be">Returning multiple values</a></li><li><a href="#org87ce79c">Changes in the FFI System for the JS Backend</a></li></ol><p>Users of GHCJS enjoyed a rich
<a href="https://github.com/ghcjs/ghcjs/blob/master/doc/foreign-function-interface.md" target="_blank" rel="noopener noreferrer">FFI</a>
system for foreign JavaScript imports. However, this has changed during our
adaptation of GHCJS to GHC 9.x. This short post goes over the GHCJS FFI system,
the motivation for these changes and what the changes are. First, we must
consider the design space of an FFI system.</p><a id="orgcf7b9df"></a><h1>The Design Space</h1><p>FFI code is typically employed in high performance scenarios. Additionally,
users of the FFI <em>do not</em> want to deal with the object language the compiler is
compiling to. Instead, users want a simple way to call functions from the object
language and use them in their own code as normal Haskell functions. However,
users of the FFI system <em>do</em> tend to be power users, and so as a design principle
we want to expose the tools they need to achieve their performance needs,
whatever those needs may be. We can summarize these constraints as follows:</p><ol><li>The FFI must abstract the JavaScript backend<!-- -->’<!-- -->s infidelities away as much as
possible. That is, users of the FFI <em>should</em> need to worry about the <code>Int64#</code>
representation, but should also be able to simply follow standard patterns we
have written in <code>base</code>.</li><li>The FFI must provide tools to achieve high performance code, even if those
tools require up front knowledge of the runtime system to use. However, these
tools should not be in the path of least resistance to use the FFI system.</li><li>The FFI must provide a lightweight specification that user<!-- -->’<!-- -->s program against
for the JS backend to optimize the imported function and for good error
messages for users.</li></ol><p>GHCJS<!-- -->’<!-- -->s FFI sets a high (qualitative) benchmark on these three constraints.
Let<!-- -->’<!-- -->s inspect them each in detail, in no particular order.</p><a id="orgdca8008"></a><h1>GHCJS<!-- -->’<!-- -->s FFI</h1><p>In GHCJS, a user could take advantage of JavaScript functions in their Haskell
code using the GHCJS<!-- -->’<!-- -->s FFI. However, the syntax was unique to GHCJS with place
holder variables like one might see in perl, nix, or bash. For example, here is
a foreign import from the <code>base</code> library for <code>st_size</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- base/System/Posix/Internal.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- the JS FFI version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foreign import javascript unsafe &quot;$r1 = h$base_st_size($1_1,$1_2); $r2 = h$ret1;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   st_size :: Ptr CStat -&gt; IO Int64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The syntax is different from what we know and love in the normal Haskell world
but the grammar is straightforward. We declare a <code>foreign import</code> from <code>javascript</code>,
state that the import is <code>unsafe</code> or <code>interruptible</code> and then provide a string,
<code>h$base_fstat(...)</code> for the code generator to use when compiling. Compare this
with the C version:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- base/System/Posix/Internal.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- the C FFI version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foreign import ccall unsafe &quot;HsBase.h __hscore_st_size&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   st_size :: Ptr CStat -&gt; IO Int64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And we see that they are similar. The only difference is the strange <code>$n</code>
symbols in the referrent string. Contrast this with the C version, which simply
declares a name.</p><p>These symbols are <em>place holder</em> variables with special meaning in GHCJS. There
are two intractable reasons for the placeholder patterns. First, we require
these patterns to work around the limitations of JavaScript as a backend (1).
For example, consider the case where we need to return an <code>Int64#</code> from an
imported foreign function. In C and Haskell this is not a problem because both
can represent <code>Int64#</code> natively, however JavaScript only has native support for
32-bit values. Thus, to be able to return an <code>Int64#</code> we need to have a method to
return two 32-bit numbers. Similarly, in order to apply a function to an <code>Int64#</code>
that function must take at least two arguments, one for the high bits and one
for the low. Second, the referrent string is untyped and can contain arbritrary
JavaScript code. So placeholder patterns provide a simply and lightweight way
for safety checks and eliminate classes of untyped, hard to understand errors.
For example, consider an arity mismatch error between a function definition and
call site. When this happens JavaScript happily continues processing with the
return value from the function application defined as <code>NaN</code> (of course). Such
arity conflicts can easily occur, especially when dealing with 64-bit values
which require function arity assumptions.</p><a id="org461ca2a"></a><h1>Lightweight safety checks</h1><p>Lightweight safety checks (3) are done by GHCJS by parsing the names of the
place holder variables; each of which follows a specific naming convention. This
convention is:</p><ul><li>Argument types:<ul><li><code>$n</code>: Used for unary arguments, i.e., arguments which require only a single register.</li><li><code>$n_n</code>: Used for binary arguments, i.e., arguments which require two registers.</li><li><code>$c</code>: A continuation argument, only valid for <code>interruptible</code> foreign functions.</li></ul></li><li>Return types:<ul><li><code>$r</code>: a unary return</li><li><code>$r1</code>, <code>$r2</code>: a binary return</li><li><code>$r1</code>, <code>$r2</code>, <code>$r3_1</code>, <code>$r3_2</code>: unboxed tuple return</li></ul></li><li>Top level patterns:<ul><li><code>&quot;&amp;value&quot;</code>: simply emitted as <code>value</code> by the code generator</li><li><code>&quot;someFunction&quot;</code>: emitted as <code>ret = someFunction(...)</code>, i.e., map the FFI to
the result of the function call.</li><li><code>&quot;$r = $1.f($2)&quot;</code>: emitted as <code>r1 = a1.f(a2)</code>, i.e., a combination of a
function call and a property access.</li></ul></li></ul><p>With this standard GHCJS then parses the FFI referrent string to ensure that it
conforms to this standard. If not then GHCJS can at least respond to the user
with an ill-formatted FFI message <em>and</em> say precisely where the issue is. For
example, it could respond that only half of an <code>Int64#</code> is returned based on the
referrent string and the function type.</p><a id="orge4568be"></a><h1>Returning multiple values</h1><p>But what of performant code? GHCJS achieves performant FFI by not trying to
abstract away from the runtime system. Instead, an advantage of GHCJS<!-- -->’<!-- -->s FFI <em>is</em>
that we can specify exactly which registers the foreign function should dump its
results or even arbitrary global variables. This places more burden on the user
of the FFI in specific scenarios, but crucially allows the FFI system to get out
of the way of the user. The FFI system also exploits this capability to return
multiple values from a single function call, which is a common need when
compiling to JavaScript. For example, in the above code <code>st_size</code> is declared to
return an <code>IO Int64</code>, the JavaScript handler <code>h$base_st_size</code> returns the <code>Int64</code>
using two registers <code>$r1</code> and <code>$r2</code>, but does so through the use of a special
purpose global variable called <code>h$ret1</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">function h$base_st_size(stat, stat_off) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$ret1 = (stat.i3[(stat_off&gt;&gt;2)+2]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (stat.i3[(stat_off&gt;&gt;2)+1]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The function inputs a pointer and an offset. Pointers in GHCJS are simply
pointers to ByteArrays so the function indexes into the ByteArray and retrieves
and stores the lower 32-bits in <code>h$ret1</code>, then returns the higher 32-bits
directly. These results are picked up by the FFI code, which performs assignment
to set <code>$r1</code> to the result of the function call (the higher 32-bits), and set <code>$r2</code>
to the value of <code>h$ret1</code> (the lower 32-bits). Crucially, the runtime system needs
to do nothing. The registers are already handled ready to be consumed by
whatever the caller of the foreign function will do.</p><p>One might consider using a simpler design, which trades register juggling for a
more straightforward representation such as a ByteArray which stores the <code>Int64#</code>.
However, such a design would trade speed for implementation simplicity. If we
passed ByteArrays then each foreign function would spend time wrapping and
unwrapping the array to get the payload; clearly an undesirable outcome for high
performance code.</p><a id="org87ce79c"></a><h1>Changes in the FFI System for the JS Backend</h1><p>So we see that GHCJS<!-- -->’<!-- -->s FFI system actually performs quite well in the design
space. Power users are well supported and can leverage enough unsafety to bind
global variables like <code>h$ret1</code> and specific registers such as <code>$r1</code>. The system
provides some lightweight checking through parsing. The nuances of the
JavaScript platform are generally abstracted over and the FFI system is tuned
for performance critical scenarios. So why change it?</p><p>The short answer is to hit deadlines. By skipping the FFI parsing the JS Backend
team was able to produce a working (can output <!-- -->“<!-- -->Hello World!<!-- -->”<!-- -->, and compile GHC<!-- -->’<!-- -->s
boot libraries), integrated, JS backend in GHC faster than had we finished the
FFI system.</p><p>For the time being, we have opted to replaced each foreign function call with a
JavaScript fat arrow, for example:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">foreign import javascript unsafe &quot;(($1_1,$1_2) =&gt; { return h$base_st_size($1_1,$1_2); })&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   st_size :: Ptr CStat -&gt; IO Int64</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p> Of course, this situation is untenable, as argued above, FFI code is assumed to
be used in performance critical code, and thus any extra overhead, such as a
function closure and consequent indirection, must be avoided. But fear not! In
the near future we<!-- -->’<!-- -->ll be overhauling the FFI system and returning it to its
former glory.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ffi">ffi</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/explanation">explanation</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/knowledge-engineering">knowledge_engineering</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHCJS FFI system in the JS Backend" href="/2022-08-18-js-backend-ffi"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-08-01-ghc-update">GHC DevX July 2022 Update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-08-01T00:00:00.000Z" itemprop="datePublished">August 1, 2022</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This is the July 2022 monthly update from the GHC DevX team at IOG.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-for-ghc">JavaScript Backend for GHC<a class="hash-link" href="#javascript-backend-for-ghc" title="Direct link to heading">​</a></h2><p>For a few months we have been merging GHCJS (Haskell to JavaScript compiler)
into GHC. We set our first milestone to be the ability to compile and to run the
usual &quot;Hello World&quot; program. This month we finally reached it!</p><p>We are now focusing on:</p><ul><li><p>fixing failing tests in GHC&#x27;s testsuite (~2800 unexpected failures). To do that, we
have to implement new primops, to fix bugs we introduced while we ported the
code from GHCJS, etc.</p></li><li><p>implementing support for the &quot;js-sources&quot; Cabal stanza in Hadrian. Currently
the JS backend finds the JS sources required for the RTS and for base into
explicitly defined location. It was only a stop-gap measure and we now need to
implement proper support for user-provided JavaScript files.</p></li><li><p>documenting and refactoring the source code and making it similar to other GHC
modules. As an example, GHCJS used the text package which isn&#x27;t a boot
package. Hence we first switched to use GHC&#x27;s ShortText implementation and now
we switched to a FastString based implementation.</p></li><li><p>adding back GHCJS&#x27;s features that we haven&#x27;t ported for some reasons (e.g. the
compactor, TH, etc.).</p></li></ul><p>You can follow our progress on our development branch
<a href="https://gitlab.haskell.org/ghc/ghc/-/tree/wip/js-staging" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="blog-posts">Blog posts<a class="hash-link" href="#blog-posts" title="Direct link to heading">​</a></h2><p>For the time being, we will focus blog post topics on GHCJS internals and
related topics. A few of these blog posts are currently under review and should
be published shortly.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHC DevX July 2022 Update" href="/2022-08-01-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-07-26-the-ghcjs-linker">The GHCJS Linker</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-26T00:00:00.000Z" itemprop="datePublished">July 26, 2022</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>I recently gave a short presentation on the workings of the GHCJS linker. This post is a summary of the content.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-executables">JavaScript &quot;executables&quot;<a class="hash-link" href="#javascript-executables" title="Direct link to heading">​</a></h2><p>The task of a linker is collecting and organizing object files and resources into a loadable library or executable program. JavaScript can be run in various environments, for example the browser or node.js, and not in all of these the concept of an executable makes sense.</p><p>Therefore, when we link a Haskell program, we generate a <code>jsexe</code> directory filled with various files that allow us to run the JavaScript result:</p><table><thead><tr><th align="center">File</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center"><code>out.js</code></td><td align="center">compiled/linked Haskell code</td></tr><tr><td align="center"><code>out.frefs.*</code></td><td align="center">list of foreign calls from <code>out.js</code></td></tr><tr><td align="center"><code>out.stats</code></td><td align="center">source code size origin statistics for <code>out.js</code></td></tr><tr><td align="center"><code>lib.js</code></td><td align="center">non-Haskell code, from <code>js-sources</code> in packages and RTS. possibly preprocessed</td></tr><tr><td align="center"><code>rts.js</code></td><td align="center">generated part of RTS (apply functions and similarly repetitive things)</td></tr><tr><td align="center"><code>runmain.js</code></td><td align="center">single line just starts <code>main</code></td></tr><tr><td align="center"><code>all.js</code></td><td align="center">complete runnable program, created by combining <code>out.js</code>, <code>lib.js</code>, <code>rts.js</code> and <code>runmain.js</code></td></tr></tbody></table><p>Most of the work done by the linker is producing <code>out.js</code>, and that&#x27;s what we&#x27;ll be focusing on in the next sections.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-outjs">Building <code>out.js</code><a class="hash-link" href="#building-outjs" title="Direct link to heading">​</a></h2><p>The linker builds <code>out.js</code> by collecting all code reachable from <code>main</code> (and a few other symbols required by the RTS) and generating the required initialization code for all top-level data. The code is found in object files. These object files have the following structure:</p><table><thead><tr><th align="center">Section</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">Header</td><td align="center">version number and offsets of other sections</td></tr><tr><td align="center">String table</td><td align="center">shared string table, referred to by <code>Dependencies</code> and <code>Code</code>, to avoid duplication in file and memory</td></tr><tr><td align="center">Dependencies</td><td align="center">Dependency data, internally between binding groups and externally to symbols in other object files</td></tr><tr><td align="center">Code</td><td align="center">Compiled Haskell code stored as serialized JavaScript AST and metadata. Code is organized in binding groups</td></tr></tbody></table><p>The object files contain binding groups of mutually dependent bindings. These are the smallest units of code that can be linked. Each binding group has some associated metadata required for initialization of the heap objects in the group. The metadata contains for example constructor tags (e.g. 1 for <code>Nothing</code>, 2 for <code>Just</code>), the arity of functions and static reference tables.</p><p>From a high level, the procedure that the linker follows is this:</p><table><thead><tr><th align="center">Step</th></tr></thead><tbody><tr><td align="center">Read object files from dependencies into memory</td></tr><tr><td align="center">Decode dependency part of all object files in dependencies (includes reading the string tables)</td></tr><tr><td align="center">Using dependency data, find all code reachable from <code>main</code></td></tr><tr><td align="center">Decode reachable binding groups</td></tr><tr><td align="center">Render AST to JavaScript</td></tr><tr><td align="center">Construct initializers from metadata</td></tr></tbody></table><p>We avoid decoding (deserializing) the binding groups that do end up in the linked result to keep the memory consumption lower. Still the linker requires a lot of memory for larger programs, so we may need to make more improvements in the future.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-compactor">The Compactor<a class="hash-link" href="#the-compactor" title="Direct link to heading">​</a></h2><p>The compactor is an optional link-time transformation step that reduces code size. It consists of a lightweight (i.e. no expensive operations like dataflow analysis) rewrite of the code contained in the object files. The compactor is disabled when linking with the <code>-debug</code> flag. There are a few steps involved.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="renaming-private-symbols">Renaming private symbols<a class="hash-link" href="#renaming-private-symbols" title="Direct link to heading">​</a></h3><p>Haskell names are quite long by default: they need to be globally unique, hence they contain their defining unit-id and module name. For example: <code>mtl-2.2.2-somehash-Control.Monad.State.Lazy.execState_go1</code> (special characters would be z-encoded but it isn&#x27;t shown here).</p><p>Private symbols are only referred to from within the same module. It doesn&#x27;t matter which JavaScript name we pick for them, as long as there is no overlap between the names from different modules. The compactor renames all the private symbols using a global sequence to ensure short names that do not overlap.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="block-initializer">Block Initializer<a class="hash-link" href="#block-initializer" title="Direct link to heading">​</a></h3><p>Without the compactor, the linker generates an <code>h$initObj</code> initialization call (or <code>h$o</code>) call for each global Haskell heap value. The code for this can get quite big. The compactor collects all heap objects to be initialized in a single large array and encodes the metadata in a string. This makes the initialization code much more compact.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="deduplication">Deduplication<a class="hash-link" href="#deduplication" title="Direct link to heading">​</a></h3><p>An optional step in the compactor is deduplication of code. When deduplication is enabled with the <code>-dedupe</code> flag, the compactor looks for functionally equivalent pieces of JavaScript in the output and merges them. This can result in a significant reduction of code size.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="incremental-linking">Incremental Linking<a class="hash-link" href="#incremental-linking" title="Direct link to heading">​</a></h2><p>The linker supports building programs that are loaded incrementally. This is used for example for Template Haskell. The process that runs the Template Haskell stays alive during compilation of a whole module. When the first Template Haskell expression is compiled, it is linked against all its dependencies (including the RTS) and the resulting JavaScript code is sent over to be run in the evaluator process.</p><p>As subsequent Template Haskell expressions are evaluated in the same process, there is no need to load already loaded dependencies (including the RTS) again and it is much more efficient to avoid doing so. Therefore the linker keeps track of which dependencies have already been linked and each subsequent TH expression is only linked against dependencies that are not already loaded in the evaluator process.</p><p>It&#x27;s also possible for users to use this functionality directly, with the <code>-generate-base</code> to create a &quot;linker state&quot; file along with the regular <code>jsexe</code> files. Another program can then be linked with <code>-use-base=state_file</code>, resulting in a program which leaves out everything already present in the first program.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="future-improvements">Future Improvements<a class="hash-link" href="#future-improvements" title="Direct link to heading">​</a></h2><p>Memory consumption is the biggest problem in the linker at the moment. Possible ways to achieve this are compression, more efficient representation of the data structures or more incremental loading of the parts from the object files that we need.</p><p>In terms of functionality, we don&#x27;t take advantage of JavaScript modules yet. It would be good if we could improve the linker to support linking a library as a JavaScript module. We should also consider making use of <code>foreign export javascript</code> for this purpose.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/linking">linking</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about The GHCJS Linker" href="/2022-07-26-the-ghcjs-linker"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-07-20-js-backend-prim-types">Primitive Type Representation in GHC&#x27;s upcoming JS-backend</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-20T00:00:00.000Z" itemprop="datePublished">July 20, 2022</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ol><li><a href="#orge86cd4a">GHC Primitives</a><ol><li><a href="#org75a0c27">The Easy Cases</a></li><li><a href="#org5eb1aee">ByteArray#, MutableByteArray#, SmallArray#, MutableSmallArray#,</a></li><li><a href="#org0de7f9e">Addr# and StablePtr#</a></li><li><a href="#orgfa8aeb4">Numbers: The Involved Case</a><ol><li><a href="#orgc9d245e">Working with 64-bit Types</a></li><li><a href="#org453f9cc">Unwrapped Number Optimization</a></li></ol></li><li><a href="#org2e2e79e">But what about the other stuff!</a></li></ol></li></ol><p>One of the key challenges in any novel backend is representing GHC primitive
types in the new backend. For JavaScript, this is especially tricky, as
JavaScript only has 8 primitive types and some of those types, such as <code>number</code> do
not directly map to any Haskell primitive type, such as <code>Int8#</code>. This post walks
through the most important GHC primitives and describes our implementation for
each in the JavaScript backend. This post is intended to be an
explanation-oriented post, light on details, but just enough to understand how
the system works.</p><a id="orge86cd4a"></a><h1>GHC Primitives</h1><p>There are 36 <code>primtype</code>s that GHC defines in <code>primops.txt.pp</code>:</p><ol><li><code>Char#</code></li><li><code>Int8#</code>, <code>Int16#</code>, <code>Int32#</code>, <code>Int64#</code>, <code>Int#</code></li><li><code>Word8#</code>, <code>Word16#</code>, <code>Word32#</code>, <code>Word64#</code>, <code>Word#</code></li><li><code>Double#</code>, <code>Float#</code>,</li><li><code>Array#</code>, <code>MutableArray#</code>,, <code>SmallArray#</code>, <code>SmallMutableArray#</code></li><li><code>ByteArray#</code>, <code>MutableByteArray#</code></li><li><code>Addr#</code></li><li><code>MutVar#</code>, <code>TVar#</code>, <code>MVar#</code>,</li><li><code>IOPort#</code>, <code>State#</code>, <code>RealWorld</code>, <code>ThreadId#</code></li><li><code>Weak#</code>, <code>StablePtr#</code>, <code>StableName#</code>, <code>Compact#</code>, <code>BCO</code>,</li><li><code>Fun</code>, <code>Proxy#</code></li><li><code>StackSnapshot#</code></li><li><code>VECTOR</code></li></ol><p>Some of these are unsupported in the JS-backend, such as <code>VECTOR</code> or lower
priority such as <code>StackSnapshot#</code>. We<!-- -->’<!-- -->ll begin with the easy cases.</p><a id="org75a0c27"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-easy-cases">The Easy Cases<a class="hash-link" href="#the-easy-cases" title="Direct link to heading">​</a></h2><p>The easy cases are the cases that are implemented as JavaScript objects. In
general, this is the big hammer used when nothing else will do. We<!-- -->’<!-- -->ll expand on
the use of objects<!-- -->—<!-- -->especially representing heap objects<!-- -->—<!-- -->in a future post,
but for the majority of cases we mimic the STG-machine behavior for GHC heap
objects using JavaScript heap objects. For example,</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">var someConstructor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { f  =                   // entry function of the datacon worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    , m  = 0                 // garbage collector mark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    , d1 = first arg         // First data field for the constructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    , d2 = arity = 2: second arg // second field, or object containing the remaining fields</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           arity &gt; 2: { d1, d2, ...} object with remaining args (starts with &quot;d1 = x2&quot;!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This is the general recipe; we define a JavaScript object that contains
properties which correspond to the entry function of the heap object; in this
case that is the entry function, <code>f</code> for a constructor, some meta data for garbage
collection <code>m</code>, and pointers to the fields of the constructor or whatever else the
heap object might need. Using JavaScript objects allows straightforward
translations of several GHC types. For example <code>TVar</code>s and <code>MVar</code>s:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// stg.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/** @constructor */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$TVar(v) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TRACE_STM(&quot;creating TVar, value: &quot; + h$collectProps(v));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.val        = v;           // current value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.blocked    = new h$Set(); // threads that get woken up if this TVar is updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.invariants = null;        // invariants that use this TVar (h$Set)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.m          = 0;           // gc mark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this._key       = ++h$TVarN;   // for storing in h$Map/h$Set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef GHCJS_DEBUG_ALLOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$debugAlloc_notifyAlloc(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// stm.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$MVar() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TRACE_SCHEDULER(&quot;h$MVar constructor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.val     = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.readers = new h$Queue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.writers = new h$Queue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.waiters = null;  // waiting for a value in the MVar with ReadMVar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.m       = 0; // gc mark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.id      = ++h$mvarId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef GHCJS_DEBUG_ALLOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$debugAlloc_notifyAlloc(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that both implementations defined properties specific to the semantics of
the Haskell type. JavaScript functions which create these objects follow the
naming convention <code>h$&lt;something&gt;</code> and reside in <em>Shim</em> files. <em>Shim</em> files are
JavaScript files that the JS-backend links against and are written in pure
JavaScript. This allows us to save some compile time by not generating code
which doesn<!-- -->’<!-- -->t change, and decompose the backend into JavaScript modules.</p><p>This strategy is also how functions are implemented in the JS-backend. Function
objects are generated by <code>StgToJS.Expr.genExpr</code> and <code>StgToJS.Apply.genApp</code> but
follow this recipe:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">var myFUN =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> { f  = &lt;function itself&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> , m  = &lt;garbage collector mark&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> , d1 = free variable 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> , d2 = free variable 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To summarize; for most cases we write custom JavaScript objects which hold
whatever machinery is needed as properties to satisfy the expected semantics of
the Haskell type. This is the strategy that implements: <code>TVar</code>, <code>MVar</code>, <code>MutVar</code> and
<code>Fun</code>.</p><a id="org5eb1aee"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="bytearray-mutablebytearray-smallarray-mutablesmallarray">ByteArray#, MutableByteArray#, SmallArray#, MutableSmallArray#,<a class="hash-link" href="#bytearray-mutablebytearray-smallarray-mutablesmallarray" title="Direct link to heading">​</a></h2><p><code>ByteArray#</code> and friends map to JavaScript&#x27;s
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer" target="_blank" rel="noopener noreferrer"><code>ArrayBuffer</code></a>
object. The <code>ArrayBuffer</code> object provides a fixed-length, raw binary data
buffer. To index into the <code>ArrayBuffer</code> we need to know the type of data the
buffer is expected to hold. So we make engineering tradeoff; we allocate typed
views of the buffer payload once at buffer allocation time. This prevents
allocations from views later when we might be handling the buffer in a hot loop,
at the cost of slower initialization. For example, consider the <code>mem.js.pp</code>
shim, which defines <code>ByteArray#</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// mem.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$newByteArray(len) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var len0 = Math.max(h$roundUpToMultipleOf(len, 8), 8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var buf = new ArrayBuffer(len0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return { buf: buf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , len: len</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , i3: new Int32Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u8: new Uint8Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u1: new Uint16Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f3: new Float32Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f6: new Float64Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , dv: new DataView(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , m: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p> <code>buf</code> is the payload of the <code>ByteArray#</code>, <code>len</code> is the length of the
<code>ByteArray#</code>. <code>i3</code> to <code>dv</code> are the <em>views</em> of the payload; each view is an
object which interprets the raw data in <code>buf</code> differently according to type. For
example, <code>i3</code> interprets <code>buf</code> as holding <code>Int32</code>, while <code>dv</code> interprets <code>buf</code>
as a
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" target="_blank" rel="noopener noreferrer"><code>DataView</code></a>
and so on. The final property, <code>m</code>, is the garbage collector marker.</p><a id="org0de7f9e"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="addr-and-stableptr">Addr# and StablePtr#<a class="hash-link" href="#addr-and-stableptr" title="Direct link to heading">​</a></h2><p><code>Addr#</code> and <code>StablePtr#</code> are implemented as a pair of <code>ByteArray#</code> and an <code>Int#</code>
offset into the array. We<!-- -->’<!-- -->ll focus on <code>Addr#</code> because <code>StablePtr#</code> is the
same implementation, with the exception that the <code>StablePtr#</code> is tracked in the
global variable <code>h$stablePtrBuf</code>. <code>Addr#</code>s do not have an explicit constructor,
rather they are implicitly constructed. For example, consider <code>h$rts_mkPtr</code>
which creates a <code>Ptr</code> that contains an <code>Addr#</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">function h$rts_mkPtr(x) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var buf, off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(typeof x == &#x27;string&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = h$encodeUtf8(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else if(typeof x == &#x27;object&#x27; &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     typeof x.len == &#x27;number&#x27; &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     x.buf instanceof ArrayBuffer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else if(x.isView) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = h$wrapBuffer(x.buffer, true, 0, x.buffer.byteLength);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = x.byteOffset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = h$wrapBuffer(x, true, 0, x.byteLength);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return (h$c2(h$baseZCGHCziPtrziPtr_con_e, (buf), (off)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The function does some type inspection to check for the special case on
<code>string</code>. If we do not have a string then a <code>Ptr</code>, which contains an <code>Addr#</code>, is
returned. The <code>Addr#</code> is implicitly constructed by allocating a new
<code>ArrayBuffer</code> and an offset into that buffer. The <code>object</code> case is an idempotent
check; if the input is already such a <code>Ptr</code>, then just return the input. The
cases which do the work are the cases which call to <code>h$wrapBuffer</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// mem.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$wrapBuffer(buf, unalignedOk, offset, length) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!unalignedOk &amp;&amp; offset &amp;&amp; offset % 8 !== 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw (&quot;h$wrapBuffer: offset not aligned:&quot; + offset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!buf || !(buf instanceof ArrayBuffer))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw &quot;h$wrapBuffer: not an ArrayBuffer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!offset) { offset = 0; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!length || length &lt; 0) { length = buf.byteLength - offset; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return { buf: buf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , len: length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , i3: (offset%4) ? null : new Int32Array(buf, offset, length &gt;&gt; 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u8: new Uint8Array(buf, offset, length)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u1: (offset%2) ? null : new Uint16Array(buf, offset, length &gt;&gt; 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f3: (offset%4) ? null : new Float32Array(buf, offset, length &gt;&gt; 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f6: (offset%8) ? null : new Float64Array(buf, offset, length &gt;&gt; 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , dv: new DataView(buf, offset, length)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>h$wrapBuffer</code> is a utility function that does some offset checks and performs
the allocation for the typed views as described above.</p><a id="orgfa8aeb4"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="numbers-the-involved-case">Numbers: The Involved Case<a class="hash-link" href="#numbers-the-involved-case" title="Direct link to heading">​</a></h2><p>Translating numbers has three issues. First, JavaScript has no concept of
fixed-precision 64-bit types such as <code>Int64#</code> and <code>Word64#</code>. Second, JavaScript
bitwise operators only support <em>signed</em> 32-bit values (except the unsigned
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Unsigned_right_shift" target="_blank" rel="noopener noreferrer">right
shift</a>
operator of course). Third, numbers are atomic types and do not require any
special properties for correct semantics, thus using wrapping objects gains us
nothing at the cost of indirection.</p><a id="orgc9d245e"></a><h3 class="anchor anchorWithStickyNavbar_mojV" id="working-with-64-bit-types">Working with 64-bit Types<a class="hash-link" href="#working-with-64-bit-types" title="Direct link to heading">​</a></h3><p>To express 64-bit numerics, we simply use two 32-bit numbers, one to express
the high bits, one for the low bits. For example, consider comparing two <code>Int64#:</code></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// arith.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$hs_ltInt64(h1,l1,h2,l2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(h1 === h2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var l1s = l1 &gt;&gt;&gt; 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var l2s = l2 &gt;&gt;&gt; 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (l1s &lt; l2s || (l1s === l2s &amp;&amp; ((l1&amp;1) &lt; (l2&amp;1)))) ? 1 : 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (h1 &lt; h2) ? 1 : 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The less than comparison function expects four inputs, two for each <code>Int64#</code> in
Haskell. The first number is represented by <code>h1</code> and <code>l1</code> (<em>high</em> and <em>low</em>),
and similarly the second number is represented by <code>h2</code> and <code>l2</code>. The comparison
is straightforward, we check equivalence of our high bits, if equal then we
check the lower bits while being careful with signedness. No surprises here.</p><p>For the bitwise operators we store both <code>Word32#</code> and <code>Word#</code> as 32-bit signed
values, and then map any values greater or equal <code>2^31</code> bits to negative values.
This way we stay within the 32-bit range even though in Haskell these types only
support nonnegative values.</p><a id="org453f9cc"></a><h3 class="anchor anchorWithStickyNavbar_mojV" id="unwrapped-number-optimization">Unwrapped Number Optimization<a class="hash-link" href="#unwrapped-number-optimization" title="Direct link to heading">​</a></h3><p>The JS backend uses JavaScript values to represent both Haskell heap objects and
unboxed values (note that this isn&#x27;t the only possible implementation, see
<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>). As such, it doesn&#x27;t require that all heap objects have the same
representation (e.g. a JavaScript object with a &quot;tag&quot; field indicating its type)
because we can rely on JS introspection for the same purpose (especially
<code>typeof</code>). Hence this optimization consists in using a more efficient JavaScript
type to represent heap objects when possible, and to fallback on the generic
representation otherwise.</p><p>This optimization particularly applies to <code>Boxed</code> numeric values (<code>Int</code>, <code>Word</code>,
<code>Int8</code>, etc.) which can be directly represented with a JavaScript number,
similarly to how unboxed <code>Int#</code>, <code>Word#</code>, <code>Int8#</code>, etc. values are represented.</p><p>Pros:</p><ul><li>Fewer allocations and indirections: instead of one JavaScript object with a
field containing a number value, we directly have the number value.</li></ul><p>Cons:</p><ul><li>More complex code to deal with heap objects that can have different
representations</li></ul><p>The optimization is applicable when:</p><ol><li>We have a single data type with a single data constructor.</li><li>The constructor holds a single field that <em>can only</em> be a particular type.</li></ol><p>If these invariants hold then, we remove the wrapping object and instead refer
to the value held by the constructor directly. <code>Int8</code> is the simplest case for
this optimization. In Haskell we have:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data Int8 = Int8 Int8#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that this definition satisfies the requirements. A direct translation in
the JS backend would be:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// An Int8 Thunk represented as an Object with an entry function, f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// and payload, d1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var anInt8 = { d1 = &lt;Int8# payload&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             , f  : entry function which would scrutinize the payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We can operationally distinguish between a <code>Thunk</code> and an <code>Int8</code> because these
will have separate types in the <code>StgToJS</code> GHC pass and will have separate types
(<code>object</code> vs <code>number</code>) at runtime. In contrast, in Haskell an <code>Int8</code> may
actually be a <code>Thunk</code> until it is scrutinized <em>and then</em> becomes the <code>Int8</code>
payload (i.e., call-by-need). So this means that we will always know when we
have an <code>Int8</code> rather than a <code>Thunk</code> and therefore we can omit the wrapper
object and convert this code to just:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// no object, just payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var anInt8 = = &lt;Int8# payload&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For the interested reader, this optimization takes place in the JavaScript code
generator module <code>GHC.StgToJS.Arg</code>, specifically the functions <code>allocConStatic</code>,
<code>isUnboxableCon</code>, and <code>primRepVt</code>.</p><a id="org2e2e79e"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="but-what-about-the-other-stuff">But what about the other stuff!<a class="hash-link" href="#but-what-about-the-other-stuff" title="Direct link to heading">​</a></h2><ul><li><code>Char#</code>: is represented by a <code>number</code>, i.e., the <a href="https://en.wikipedia.org/wiki/Code_point" target="_blank" rel="noopener noreferrer">code point</a></li><li><code>Float#/Double#</code>: Both represented as a JavaScript Double. This means that
<code>Float#</code> has excess precision and thus we do not generate exactly the same
answers as other platforms which are IEEE754 compliant. Full emulation of
single precision Floats does not seem to be worth the effort as of writing.
Our implementation represents these in a <code>ByteArray#</code>, where each <code>Float#</code>
takes 4 bytes in the <code>ByteArray#</code>. This means that the precision is reduced
to a 32-bit Float.</li></ul><div class="footnotes"><hr><ol><li id="fn-1">An alternative approach would be to use some JS ArrayBuffers as memory
blocks into which Haskell values and heap objects would be allocated. As an
example this is the approach used by the Asterius compiler. The RTS would
then need to be much more similar to the C RTS and the optimization
presented in this section wouldn&#x27;t apply because we couldn&#x27;t rely on
introspection of JS values.<a href="#fnref-1" class="footnote-backref">↩</a></li></ol></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/explanation">explanation</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/knowledge-engineering">knowledge_engineering</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Primitive Type Representation in GHC&#x27;s upcoming JS-backend" href="/2022-07-20-js-backend-prim-types"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-07-18-lightweight-threads-on-JavaScript">Lightweight Haskell Threads on JavaScript</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-18T00:00:00.000Z" itemprop="datePublished">July 18, 2022</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>I recently gave a short presentation on the topic of threads in GHCJS to the GHC team at IOG. This blog post is a summary of the content.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-and-threads">JavaScript and Threads<a class="hash-link" href="#javascript-and-threads" title="Direct link to heading">​</a></h2><p>JavaScript is fundamentally single threaded. There are ways to share specific data between tasks but it&#x27;s not possible to run multiple threads that have access to a shared memory space of JavaScript data.</p><p>The single JavaScript thread is often responsible for multiple tasks. For example a node.js server handles multiple simultaneous connections and a web application may be dealing with user input while downloading new data in the background.</p><p>This means that any single task should take care to never block execution of the other task. JavaScript&#x27;s canonical answer is to use asynchronous programming. A function reading a file returns immediately without waiting for the file data to be loaded in memory. When the data is ready, a user-supplied callback is called to continue processing the data.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="haskell-threads">Haskell Threads<a class="hash-link" href="#haskell-threads" title="Direct link to heading">​</a></h2><p>Concurrent Haskell supports lightweight threads through <code>forkIO</code>. These threads are scheduled on top of one more more operating system thread. A blocking foreign call blocks an OS thread but other lightweight threads can still run on other OS threads if available.</p><p>There is no built-in support for foreign calls with a callback in the style of JavaScript. Functions imported with <code>foreign import ccall interruptible</code> can be interrupted by sending an asynchronous exception to the corresponding lightweight thread.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="lightweight-threads-in-javascript">Lightweight Threads in JavaScript<a class="hash-link" href="#lightweight-threads-in-javascript" title="Direct link to heading">​</a></h2><p>GHCJS implements lightweight threads on top of the single JavaScript thread. The scheduler switches between threads and handles synchronization through <code>MVar</code> and <code>STM</code> as expected from other Haskell platforms.</p><p>Foreign calls that don&#x27;t block can be handled in the usual way. We extend the foreign function interface with a new type <code>foreign import javascript interruptible</code> that conveniently supports the callback mechanism used by JavaScript frameworks. The foreign call is supplied with an additional argument <code>$c</code> representing a callback to be called with the result when ready. From the Haskell side the corresponding lightweight thread is blocked until <code>$c</code> is called. This type of foreign call can be interrupted with an asynchronous exception to the lightweight Haskell thread.</p><p>By default, Haskell threads in the JS environment run asynchronously. A call to <code>h$run</code> returns immediately and starts the thread in the background. This works for tasks that does not require immediate actions. For situations that require more immediate action, such as dealing with event handler propagation, there is <code>h$runSync</code>. This starts a synchronous thread that is not interleaved with other task. If possible, the thread runs to completion before the call to <code>h$runSync</code> returns. If the thread blocks for any reason, such as waiting for an <code>MVar</code> or a <code>foreign import javascript interruptible</code> call, synchronous execution cannot complete. The blocking task is then either interrupted with an exception or the thread is &quot;demoted&quot; to a regular asynchronous thread.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="black-holes">Black Holes<a class="hash-link" href="#black-holes" title="Direct link to heading">​</a></h2><p>When a Haskell value is evaluated, its heap object is overwritten by a black hole. This black hole marks the value as being evaluated and prevents other threads from doing the same. &quot;black holing&quot; can be done either immediately or &quot;lazily&quot;, when the garbage collector is run. GHCJS implements immediate blackholing.</p><p>Black holes give rise to an interesting problem in the presence of synchronous and asynchronous threads. Typically if we use <code>h$runSync</code>, we want to have some guarantee that at least part of the task will run succesfully without blocking. For the most past it&#x27;s fairly clear which parts of our task depends on potentially blocking IO or thread synchronization. But black holes throw a spanner in the works: Suddenly any &quot;pure&quot; data structure can be a source of blocking if it is under evaluation by another thread.</p><p>To regain some predictability and usability of synchronous threads, the <code>h$runSync</code> scheduler can run other Haskell threads in order to &quot;clear&quot; a black hole. The process ends all black holes have been cleared or when any of the black holes is impossible to clear because of a blocking situation.</p><p>This all happens transparantly to the caller of <code>h$runSync</code>, if the black holes could be cleared it appears as if they were never there.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>We have lightweight Haskell threads in the single-threaded JavaScript environment and extend the foreign function interface to easily support foreign calls that depend on an asynchronous callback. This way, only the Haskell lightweight thread blocks.</p><p>By default, Haskell threads are asynchronous and run in the background: The scheduler interleaves the tasks and synchronization between threads. For situations that require immediate results or actions there are synchronous threads. Synchronous threads cannot block and are not interleaved with other tasks except when a black hole is encountered.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/concurrency">concurrency</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ffi">ffi</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Lightweight Haskell Threads on JavaScript" href="/2022-07-18-lightweight-threads-on-JavaScript"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-07-01-ghc-update">GHC DevX June 2022 Update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-01T00:00:00.000Z" itemprop="datePublished">July 1, 2022</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This is the June 2022 monthly update from the GHC DevX team at IOG.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-for-ghc">JavaScript Backend for GHC<a class="hash-link" href="#javascript-backend-for-ghc" title="Direct link to heading">​</a></h2><p>For a few months we have been merging GHCJS (Haskell to JavaScript compiler) into GHC.
We set our first milestone to be the ability to compile and to run the usual &quot;Hello World&quot; program.
It turned out to be much more involved than we initially thought (requiring FFI support, etc.), but we should be getting there soon.</p><p>This month we have made the following progress:</p><ul><li><p><strong>Linking</strong>: GHCJS requires some functions to be directly implemented in
JavaScript (e.g. the RTS, some low-level functions in base). We have added support
for linking <code>.js</code> files. We&#x27;ve also added support for a preprocessing pass with CPP
for <code>.js.pp</code> files.</p></li><li><p><strong>js-sources</strong>: there is some ongoing work to load these external JavaScript
files from installed libraries. Cabal provides a <code>js-sources</code> stanza for this,
we need to adapt Hadrian to make use of it.</p></li><li><p><strong>Binary vs Objectable</strong>: GHCJS used its own ByteString-based Objectable
type-class: we replaced it with GHC&#x27;s similar Binary type-class.
Josh has published a <a href="https://engineering.iog.io/2022/05/24/april-GHCJS-Objectable-vs-GHC-Binary" target="_blank" rel="noopener noreferrer">blog
post</a>
about their differences.</p></li><li><p><strong>64-bit primops</strong>: we&#x27;ve added support for 64-bit primops (Word64# and Int64#
types). In GHCJS (GHC 8.10), these were still implemented as foreign function
calls. It&#x27;s no longer true on GHC head.</p></li><li><p><strong>base library</strong>: added CPP as required to support the JS backend. Ported and
converted FFI imports from GHCJS to use JavaScript fat arrows (we haven&#x27;t
implemented GHCJS&#x27;s fancy import syntax yet).</p></li></ul><p>Now we can compile and link the &quot;HelloWorld&quot; program.
To reach the first milestone we only have to fix the remaining runtime errors.</p><p>You can follow our progress on our development branch <a href="https://gitlab.haskell.org/ghc/ghc/-/tree/wip/js-staging" target="_blank" rel="noopener noreferrer">here</a>.
We now rebase this branch every Friday to avoid lagging too much behind GHC head.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="haskell-optimization-handbook">Haskell Optimization Handbook<a class="hash-link" href="#haskell-optimization-handbook" title="Direct link to heading">​</a></h2><p>The &quot;Haskell Optimization Handbook&quot; is an <a href="https://github.com/haskellfoundation/tech-proposals/blob/main/proposals/accepted/026-haskell-optimization-handbook.md" target="_blank" rel="noopener noreferrer">accepted proposal</a> of the Haskell Foundation.
Jeff has been steadily writing some initial material as per the project plan.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHC DevX June 2022 Update" href="/2022-07-01-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-06-01-ghc-update">GHC DevX May 2022 Update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-06-01T00:00:00.000Z" itemprop="datePublished">June 1, 2022</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This is the May 2022 monthly update from the GHC DevX team at IOG.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend-for-ghc">JavaScript Backend for GHC<a class="hash-link" href="#javascript-backend-for-ghc" title="Direct link to heading">​</a></h2><p>For a few months we have been merging GHCJS (Haskell to JavaScript compiler) into GHC.
We set our first milestone to be the ability to compile and to run the usual &quot;Hello World&quot; program.
It turned out to be much more involved than we initially thought (requiring FFI support, etc.), but we should be getting there soon.</p><p>This month we have made the following progress:</p><ul><li><p><strong>RTS</strong>: we have modified Hadrian and <code>rts.cabal</code> in order to build a valid
native <code>rts</code> unit that GHC can use, in particular containing appropriate
header files.</p></li><li><p><strong>linker</strong>: the JS linker has been hooked up with GHC&#x27;s driver.
We fixed several panics in the linker due to erroneous symbol generation code.
These bugs were introduced while porting the code from the old 8.10 pretty-printing infrastructure to the newer one.</p></li><li><p><strong>boot libraries</strong>: the JS backend can now build and link all the boot libraries.
Note that we are not claiming that they are all usable yet. In particular complete FFI support is lacking, but the JS backend Hadrian build completes and so we can start using the produced JS cross-compiler.</p></li><li><p><strong>levity polymorphism</strong>: building <code>ghc-prim</code> uncovered a lurking bug related to
levity polymorphism. It wasn&#x27;t noticed in GHCJS 8.10 because it is also
related to the <code>BoxedRep</code> proposal that introduced a constructor application
in a commonly used <code>RuntimeRep</code>.</p></li><li><p><strong>sized literals</strong>: support for new sized literals have been added to the code
generator.</p></li></ul><p>Now that have achieved a build process that actually produces a JS cross compiler, we are confronting and fixing issues in the produced JavaScript code, such as adding, managing, and debugging CPP conditional compilation blocks in JS shim files. You can follow our progress on our development branch <a href="https://gitlab.haskell.org/ghc/ghc/-/tree/wip/js-staging" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="external-static-plugins">External Static Plugins<a class="hash-link" href="#external-static-plugins" title="Direct link to heading">​</a></h2><p>GHC doesn&#x27;t support plugins in cross-compilers <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/14335" target="_blank" rel="noopener noreferrer">#14335</a>.
Some time ago, we came up with a solution called &quot;external static plugins&quot; <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7377" target="_blank" rel="noopener noreferrer">!7377</a>.
These are plugins that are directly loaded from shared libaries, bypassing the issue with usual plugins.</p><p>Our colleague Shea Levy confirmed that the approach works, backported it to GHC 8.10, and has been working on making it work in stage1 cross-compilers for Windows.
Kudos for this work, Shea.</p><p>As the current user-interface based on environment variables isn&#x27;t convenient, we have been working on adding new command-line flags to GHC instead.
We expect to propose this for integration into GHC when the new interface will be fully implemented.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="blog-posts">Blog posts<a class="hash-link" href="#blog-posts" title="Direct link to heading">​</a></h2><p>Inspired by our friends and colleagues at Well-Typed and Tweag, we have been starting to write blog posts for IOG&#x27;s engineering blog.
They will mostly be about stuff we are working on or that we are interested in.
Feel free to send us feedback about these posts and to send us topics you would be interested to read about.</p><ul><li><a href="https://engineering.iog.io/2022-04-28-on-the-inlining-of-integer-and-natural-operations" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-04-28-on-the-inlining-of-integer-and-natural-operations</a></li><li><a href="https://engineering.iog.io/2022-05-02-setup-ext-stg-interp" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-05-02-setup-ext-stg-interp</a></li><li><a href="https://engineering.iog.io/2022-05-17-javascript-template-haskell-external-interpreter" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-05-17-javascript-template-haskell-external-interpreter</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="haskell-optimization-handbook">Haskell Optimization Handbook<a class="hash-link" href="#haskell-optimization-handbook" title="Direct link to heading">​</a></h2><p>The &quot;Haskell Optimization Handbook&quot; is an <a href="https://github.com/haskellfoundation/tech-proposals/blob/main/proposals/accepted/026-haskell-optimization-handbook.md" target="_blank" rel="noopener noreferrer">accepted proposal</a> of the Haskell Foundation.
Jeff has been working behind the scene to make this proposal concrete.
More about this in the upcoming months.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHC DevX May 2022 Update" href="/2022-06-01-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-05-17-javascript-template-haskell-external-interpreter">JavaScript, Template Haskell and the External Interpreter</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-05-17T00:00:00.000Z" itemprop="datePublished">May 17, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>At IOG DevX we have been working on integrating various bits of GHCJS into GHC, with the goal of having a fully working JavaScript backend for the 9.6 release. For some parts this has mostly consisted of an update of the code to use the newer GHC API and dependencies. Other bits, like the Template Haskell runner, need more work.</p><p>This post gives an overview of the existing approaches for running Template Haskell in GHC based cross compilers and our plan for the JavaScript backend. Hopefully we can revisit this topic once all the work has been done, and see what exactly we ended up with.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-ghcjs-template-haskell-runner">The GHCJS Template Haskell Runner<a class="hash-link" href="#the-ghcjs-template-haskell-runner" title="Direct link to heading">​</a></h2><p>When I first worked on Template Haskell (TH) support for GHCJS, there was no mechanism to combine Template Haskell with cross compilation in GHC.</p><p>Normally, Template Haskell is run by loading library code directly into the GHC process and using the bytecode interpreter for the current module. Template Haskell can directly access GHC data structures through the <code>Q</code> monad. Clearly this would not be possible for GHCJS: We only have JavaScript code available for the libraries and the organization of the JavaScript data structures is very different from what GHC uses internally.</p><p>So I had to look for an alternative. Running Template Haskell consists of two parts:</p><ol><li>loading/executing the TH code</li><li>handling compiler queries from the TH code, for example looking up names or types</li></ol><p>Running the TH code can be done by first compiling the Haskell to JavaScript and then using the JavaScript <code>eval</code> feature.</p><p>Template Haskell code can query the compiler using the <code>Quasi</code> typeclass. I noticed that none of the methods required passing around functions or complicated data structures, so it would be possible to serialize each request and response and send it to another process.</p><p>So I went ahead and implemented this approach with a script <code>thrunner.js</code> to load and start the code in a node.js server, a message type with serialization, and a new instance of the <code>Quasi</code> typeclass to handle the communication with the compiler via the messages. This is still what&#x27;s in use by GHCJS to this day. Every time GHCJS encounters Template Haskell, it starts a <code>thrunner</code> process and the compiler communicates with it over a pipe.</p><p>After starting <code>thrunner.js</code> GHCJS sends the Haskell parts of the Template Haskell runnner to the script. This includes the runtime system and the implementation of the <code>Quasi</code> typeclass and communication protocol. After that, the TH session starts. A typical TH session looks as follows:</p><table><thead><tr><th align="left">Compiler</th><th align="left">thrunner</th></tr></thead><tbody><tr><td align="left"><code>RunTH THExp &lt;js code&gt; &lt;source location&gt;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>LookupName (Just &lt;name-string&gt;)</code></td></tr><tr><td align="left"><code>LookupName&#x27; (Just &lt;name&gt;)</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>Reify &lt;name&gt;</code></td></tr><tr><td align="left"><code>Reify&#x27; &lt;name-info&gt;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>RunTH&#x27; &lt;result&gt;</code></td></tr><tr><td align="left"><code>RunTH THDec &lt;js code&gt; &lt;source location&gt;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>AddTopDecls &lt;declarations&gt;</code></td></tr><tr><td align="left"><code>AddTopDecls&#x27;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>RunTH&#x27; &lt;result&gt;</code></td></tr><tr><td align="left"><code>FinishTH True</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>FinishTH&#x27; &lt;memory-consumption&gt;</code></td></tr></tbody></table><p>Each message is followed up by a corresponding reply. For example, a <code>LookupName&#x27;</code> response follows a <code>LookupName</code> request and a <code>RunTH</code> message will eventually generate a <code>RunTH&#x27;</code> result. The first <code>RunTH</code> message contains the compiled JavaScript for the Template Haskell code, along with its dependencies. Each subsequent <code>RunTH</code> only includes dependencies that have not already been sent.</p><p>The <code>thrunner</code> process stays alive during the compilation of at least an entire module, allowing for persistent state (<code>putQ</code>/<code>getQ</code>).</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-ghc-external-interpreter">The GHC External Interpreter<a class="hash-link" href="#the-ghc-external-interpreter" title="Direct link to heading">​</a></h2><p>If we build a Haskell program with (cost centre) profiling, the layout of our data structures changes to include bookkeeping of cost centre information. This means that we need a special profiling runtime system to run this code.</p><p>What can we do if we want to run our profiled build in GHCi or Template Haskell? We cannot load compiled profiling libraries into GHC directly; its runtime system expects non-profiled code. We could use a profiled version of the compiler itself, but this would make all compilation very slow. Or we could somehow separate the profiled code of our own program from the non-profiled code in the compiler.</p><p>This was Simon Marlow&#x27;s motivation for adapting the GHCJS <code>thrunner</code> approach, integrating in GHC and extending it it to support GHCi and bytecode. This functionality can be activated with the <code>-fexternal-interpreter</code> flag and has been available since GHC version 8.0.1. When the external interpreter is activated, GHC starts a separate process, <code>iserv</code> (customizable with the <code>-pgmi</code> flag) which has the role analogous to the <code>thrunner</code> script for GHCJS.</p><p>Over time, the <code>iserv</code> code has evolved with GHC and has been extended to include more operations. By now, there are quite a few differences in features:</p><table><thead><tr><th align="left">Feature</th><th align="center">thrunner</th><th align="center">iserv</th></tr></thead><tbody><tr><td align="left">Template Haskell support</td><td align="center">yes</td><td align="center">yes</td></tr><tr><td align="left">GHCi</td><td align="center">no</td><td align="center">yes</td></tr><tr><td align="left">Debugger</td><td align="center">no</td><td align="center">yes</td></tr><tr><td align="left">Bytecode</td><td align="center">no</td><td align="center">yes</td></tr><tr><td align="left">Object code</td><td align="center">through pipe</td><td align="center">from file</td></tr><tr><td align="left">Object code linking</td><td align="center">compiler</td><td align="center">iserv process</td></tr></tbody></table><p><code>thrunner</code> is not quite as complete as <code>iserv</code>: It lacks GHCi and the debugger, and there is no bytecode support. But these features are not essential for basic Template Haskell.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="proxies-and-bytecodes">Proxies and Bytecodes<a class="hash-link" href="#proxies-and-bytecodes" title="Direct link to heading">​</a></h2><p>We have now seen two systems for running Template Haskell code outside the compiler process: The original GHCJS <code>thrunner</code> and the extended GHC <code>iserv</code>.</p><p>Clearly it isn&#x27;t ideal to have multiple &quot;external interpreter&quot; systems in GHC, therefore we plan to switch from <code>thrunner</code> to <code>iserv</code> for the upcoming JavaScript GHC backend. We don&#x27;t need the debugger or GHCi support yet, but we do need to adapt to other changes in the infrastructure. So what does this mean in practice?</p><p>The biggest change is that we have to rework the linker: <code>thrunner</code> does not contain any linking logic by itself: GHCJS compiles everything to JavaScript and sends compiled code to the <code>thrunner</code> process, ready to be executed. In contrast, <code>iserv</code> has a loader for object and archive files. When dependencies need to be loaded into the interpreter, GHC just gives it the file name.</p><p>Another change is using the updated message types. In the <code>thrunner</code> session example above we could see that each message is paired with a response. For example a <code>RunTH&#x27;</code> response always follows a <code>RunTH</code> message, with possibly other messages in between. <code>iserv</code> has an interesting approach for the <code>Message</code> datatype: Instead of having pairs of data constructors for each message and its response, <code>iserv</code> has a GADT <code>Message a</code>, where the <code>a</code> type parameter indicates the expected response payload for each data constructor.</p><p>During development of the <code>thrunner</code> program it turned out to be very useful to save and replay Template Haskell sessions for debugging purposes. We&#x27;d like to do this again, but now saving the message in a readable/writable format. Since we&#x27;re dealing with JavaScript, JSON appears to be the obvious choice.</p><p>Our plan is to have an <code>iserv</code> implementation that consists of a JavaScript part that runs in node.js and a proxy process to handle communication with GHC. The proxy process converts the messages between GHC&#x27;s own (<code>binary</code> based) serialization format and JSON. The proxy process is relatively simple, but it does reveal one downside of the new GADT based message types: A proxy is stateful. We must always know which message we have sent to convert the response back from JSON to <code>binary</code>.</p><p>It&#x27;s not yet known whether we will implement a full bytecode interpreter. We expect it to become clear during implementation whether we can get away without one early on.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>We have seen how Template Haskell and GHCi code can be run outside the GHC process for profiling or cross compiling, with both the <code>thrunner</code> approach in GHCJS and the newer <code>iserv</code> in GHC.</p><p>We at IOG DevX are working on switching to the <code>iserv</code> infrastructure for the upcoming GHC JavaScript backend, which involves a substantial rewrite, mainly because of differences in linking. This is a work in progress, and we intend to revisit this topic in another blog post once the final design has been implemented.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghcjs">ghcjs</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/tooling">tooling</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/profiling">profiling</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about JavaScript, Template Haskell and the External Interpreter" href="/2022-05-17-javascript-template-haskell-external-interpreter"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/ghc-update-2022-04">GHC April 2022 Update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-05-13T00:00:00.000Z" itemprop="datePublished">May 13, 2022</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Welcome to the (rather late) April 2022 monthly update from the GHC DevX team at IOG. Since the last update we&#x27;ve continued work on the upcoming JavaScript backend for GHC. Unfortunately, we have nothing to show quite yet but that doesn&#x27;t mean nothing has happened! On the contrary, we&#x27;ve made great progress and are close to that crucial first milestone <code>hello world</code>. Besides our work on the JavaScript backend, we were pleased to finally push through the <a href="https://hsyl20.fr/home/posts/2022-05-03-modularizing-ghc-paper.html" target="_blank" rel="noopener noreferrer">Modularizing GHC</a> paper that Sylvain has been working on for 2+ years! It causes quite the splash on the Haskell discourse and reddit, we recommend reading it if you haven&#x27;t already (links below). Alright, enough introduction let&#x27;s get into the update.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-backend">JavaScript Backend<a class="hash-link" href="#javascript-backend" title="Direct link to heading">​</a></h2><p>We have made the following progresses in the implementation of a JavaScript
backend for GHC (adapted from GHCJS):</p><ul><li><p><strong>linker</strong>: ported GHCJS&#x27;s linker code into GHC. A lot of code was duplicated from GHC and
slightly modified for GHCJS&#x27;s needs, making the process far from trivial.</p></li><li><p><strong>testsuite</strong>: fixed Hadrian to run GHC&#x27;s testsuite with cross-compilers
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7850" target="_blank" rel="noopener noreferrer">!7850</a>. There are
remaining issues though (see
<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/21292" target="_blank" rel="noopener noreferrer">#21292</a>).</p></li><li><p><strong>build system</strong>: fixes for GHC&#x27;s configure script were ported (e.g. support for
the &quot;ghcjs&quot; target in <code>config.sub</code>). GHCJS&#x27;s custom
build script was integrated into <code>configure.ac</code>. We can now
configure the build with: <code>./configure --target=js-unknown-ghcjs</code></p></li><li><p><strong>TH</strong>: we have conducted some experiments to find the best way to bridge GHCJS&#x27;s
TH runner and GHC&#x27;s external interpreter. This will be described in details in
a future blog post.</p></li><li><p><strong>FFI</strong>: basic support for JavaScript FFI has been ported from GHCJS to GHC. We
haven&#x27;t ported the JavaScript parser, so we have dropped the fancy import
syntax (e.g. &quot;$1.xyz&quot;). It should be enough to build boot libraries and we
will add JS parsing support later.</p></li></ul><p>At this stage, we are working on building boot libraries and on supporting
linking with the JS RTS.</p><p>Development happens in the following branch: <a href="https://gitlab.haskell.org/ghc/ghc/-/tree/wip/js-staging" target="_blank" rel="noopener noreferrer">https://gitlab.haskell.org/ghc/ghc/-/tree/wip/js-staging</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="modularity-paper">Modularity paper<a class="hash-link" href="#modularity-paper" title="Direct link to heading">​</a></h2><p>Sylvain, Jeffrey, and John Ericson (from Obsidian Systems) wrote a paper about
&quot;modularizing GHC&quot; using domain-driven design.</p><ul><li>Announce blog post: <a href="https://hsyl20.fr/home/posts/2022-05-03-modularizing-ghc-paper.html" target="_blank" rel="noopener noreferrer">https://hsyl20.fr/home/posts/2022-05-03-modularizing-ghc-paper.html</a></li><li>Paper: <a href="https://hsyl20.fr/home/files/papers/2022-ghc-modularity.pdf" target="_blank" rel="noopener noreferrer">https://hsyl20.fr/home/files/papers/2022-ghc-modularity.pdf</a></li><li>Reddit: <a href="https://www.reddit.com/r/haskell/comments/uhdu4l/modularizing_ghc_paper/" target="_blank" rel="noopener noreferrer">https://www.reddit.com/r/haskell/comments/uhdu4l/modularizing_ghc_paper/</a></li><li>Discourse: <a href="https://discourse.haskell.org/t/modularizing-ghc-paper/4471" target="_blank" rel="noopener noreferrer">https://discourse.haskell.org/t/modularizing-ghc-paper/4471</a></li></ul><p>We&#x27;ve got a lot of great feedback about it (expect a first revision soon).
We also got a GHC contribution directly inspired by the paper (see
<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/8160" target="_blank" rel="noopener noreferrer">!8160</a>) which was
very welcome!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHC April 2022 Update" href="/ghc-update-2022-04"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-05-02-setup-ext-stg-interp">Setting up Csaba&#x27;s External STG Interpreter</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-05-02T00:00:00.000Z" itemprop="datePublished">May 2, 2022</time> · <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="table-of-contents">Table of Contents<a class="hash-link" href="#table-of-contents" title="Direct link to heading">​</a></h2><ul><li><a href="#orgfeb334e">Making sense of the project</a></li><li><a href="#org1d461dc">Building a working external STG interpreter</a><ul><li><a href="#orgb670539">ghc.nix</a></li><li><a href="#orgbb3f1d5">Building ghc-wpc</a></li><li><a href="#org9ef4bc5">Building the stg tooling</a></li></ul></li><li><a href="#org4a2eaf9">Building the external-stg-interpreter</a></li><li><a href="#org1d34a2e">Linking the external-stg-interpreter</a></li><li><a href="#org2daa4b8">The whole setup process on a demo</a></li><li><a href="#org8193a1a">Summary</a><ul><li><a href="#org940ba90">File Descriptions</a></li><li><a href="#org8e9f409">Step-by-Step guide for running the interpreter on your code</a></li></ul></li></ul><p>Haskell is a great language camouflaged by lackluster tooling. This situation
has led to well-known problems (who could forget Cabal hell?). A less discussed
problem is what I will call the <!-- -->“<!-- -->Black-box syndrome<!-- -->”<!-- -->: It is hard to
know <em>exactly</em> what the memory representation and runtime performance of my
Haskell programs are<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>. Now black-box syndrome is not <em>only</em> a problem,
it is also one of the nice features in the language since like all good
abstractions it elides things I<!-- -->’<!-- -->d rather not care about, at least most of
the time. In other words, I am happy I don<!-- -->’<!-- -->t have to do manual memory
manipulation!</p><p>However, when I have my optimization hat on, I run face first into black-box syndrome. The crux of the problem is a tension between the need for observation during performance engineering and optimization, and the need to ship fast code. During development we want to be able to open up a system, see exactly how it is working, make tweaks, package it back up and test again. I want to be able to answer questions like <!-- -->“<!-- -->Why is my executable this size?<!-- -->”<!-- -->, <!-- -->“<!-- -->Which code is a hot loop?<!-- -->”<!-- -->, or <!-- -->“<!-- -->When does my code do direct, known or unknown function calls?<!-- -->”<!-- -->.</p><p>In order to answer these questions we need the ability to observe <em>every part of that system as the machine experiences it</em>, without this ability we have no way to make progress other than test, change some code, compile and test again in an ad-hoc manner. And therein lies the problem, most Haskell tooling is insufficient to provide the observability that we would like, instead the tooling often expects and requires us to make source code changes to our program or even recompile all of our libraries and code for a profiling way. This leads to the idea and <em>the expectation</em> in the Haskell community that Haskell programs are hard to optimize because the barrier to entry for optimization has artificially increased.</p><p><a href="https://www.patreon.com/csaba_hruska" target="_blank" rel="noopener noreferrer">Csaba Hruska</a> has recently been making headway in this area with his work on the <a href="https://youtu.be/iXhh0NSR67k" target="_blank" rel="noopener noreferrer">GRIN</a> compiler and an external STG interpreter. His STG interpreter (and patched ghc) exactly solve these problems and he has demonstrated dumping the entire call graph of large Haskell projects, filter to hot loops and finding unknown function calls in these graphs. If you haven<!-- -->’<!-- -->t seen his <a href="https://www.youtube.com/watch?v=wt6iCgYmVGA&amp;t=2054s" target="_blank" rel="noopener noreferrer">demo</a> be sure to watch it, it is well worth your time.</p><p>This post is the first in a new blog series. In this blog series we<!-- -->’<!-- -->re going to kick the tires on the external STG interpreter see what it can do, and what we can uncover in some popular libraries by using it. In particular, I<!-- -->’<!-- -->m interested in running it on projects I<!-- -->’<!-- -->ve previously optimized<!-- -->—<!-- -->such as ghc itself, containers, unordered-containers<!-- -->—<!-- -->using the standard methods: ticky-ticky profiling, prof, flamegraphs, heap profiling, ghc-debug, cachegrind etc. This post, however, will be focused on setting up the patched ghc and interpreter on a NixOS system. My goals are threefold:</p><ol><li>Give an overview of the project and project layout to lower barrier to entry for the system.</li><li>Give step by step instructions on setting up the interpreter on a nix-based system and provide a forked github repo for nix users. This should allow nix users to just <code>git clone foo</code> and <code>nix-build</code> (spoiler: it won<!-- -->’<!-- -->t be that easy but still not hard.)</li><li>Popularize Csaba<!-- -->’<!-- -->s project! It is a refreshing take on Haskell optimization and compilation.</li></ol><a id="orgfeb334e"></a><h1>Making sense of the project</h1><p>The external STG interpreter is part of the <a href="https://github.com/grin-compiler" target="_blank" rel="noopener noreferrer">GRIN compiler</a> project. We are not doing anything with the GRIN compiler (yet!) and so we are only interested in <a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project" target="_blank" rel="noopener noreferrer">The GHC whole compiler project</a>. The whole-compiler-project has several sub-projects that we<!-- -->’<!-- -->ll be building and using directly:</p><ul><li><a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/tree/master/external-stg" target="_blank" rel="noopener noreferrer">external-stg</a>: This subproject provides utilites we<!-- -->’<!-- -->ll be using, in particular <code>mkfullpak</code></li><li><a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/tree/master/external-stg-interpreter" target="_blank" rel="noopener noreferrer">external-stg-interpreter</a>: This is the actual STG interpreter. The good news is that this is independent of the rest of the project and can be built just like a regular Haskell executable</li><li><a href="https://github.com/grin-compiler/ghc-wpc/tree/b51ab235f5c07caa5eb3dd3b40487f67f50fb838" target="_blank" rel="noopener noreferrer">ghc-wpc</a>: This is a fork of <code>ghc-8.10.x</code> (I<!-- -->’<!-- -->m not sure exactly which version it forks to be honest) which we must build in order to use the external STG interpreter. Ghc-wpc serves as a frontend for the external-stg-interpreter.</li></ul><a id="org1d461dc"></a><h1>Building a working external STG interpreter</h1><p>The external STG interpreter can be built like any regular haskell executable. But in order to use the interpreter we have to build <code>ghc-wpc</code>. <code>ghc-wpc</code> is necessary because it serves as a frontend for the STG interpreter. It compiles a Haskell program like normal and then dumps an enriched STG IR to file. This file is then run through a utility <code>gen-exe</code> (gen-exe is an executable built in the <a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/tree/master/external-stg-compiler" target="_blank" rel="noopener noreferrer">external-stg-compiler</a> sub-project) which picks up the compilation pipeline from the STG IR and creates an executable like we would expect from a normal compilation pipeline.</p><p>The major difference between this process and the usual compiler pipeline is that <code>ghc-wpc</code> leaves enough compiler information on disk for the rest of the tooling to consume, namely, in files with a <code>*.o_stgbin</code> (this is STG IR generated at compile time), and <code>*.o_stgapp</code> (project linker and dependency information) extension. Thus, once we build this custom ghc version we can use it to build the source code we wish to analyze and begin our optimization work.</p><p>For the rest of this tutorial I<!-- -->’<!-- -->ll be referencing my <a href="https://github.com/doyougnu/ghc-whole-program-compiler-project" target="_blank" rel="noopener noreferrer">fork</a> of the <code>ghc-whole-compiler-project</code> that includes everything you need if you want to follow along, including <code>.nix</code> files for creating a <code>nix-shell</code> which will prepare a suitable environment to run the entire toolchain.</p><a id="orgb670539"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghcnix">ghc.nix<a class="hash-link" href="#ghcnix" title="Direct link to heading">​</a></h2><p>The usual way to build ghc using a nix based system is with the <a href="https://github.com/alpmestan/ghc.nix" target="_blank" rel="noopener noreferrer">ghc.nix</a> project. Ghc.nix provides a <code>default.nix</code> with a suitable environment to run hadrian and build ghc. For <code>ghc-wpc</code> we<!-- -->’<!-- -->ll need some special packages, and we need our boot compiler to be <em>exactly</em> <code>ghc-8.3.3</code>. The custom <code>ghc.nix</code> file is included in my fork, I<!-- -->’<!-- -->ve taken the liberty to pin the nixpkgs to the right version for <code>ghc-8.3.3</code>. So let<!-- -->’<!-- -->s begin:</p><p>Clone the forked repo:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/doyougnu/ghc-whole-program-compiler-project.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ghc-whole-program-compiler-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tree -L </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── dist-newstyle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── external-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── external-stg-compiler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── external-stg-interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── ghc.nix.wpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── ghc-wpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── lambda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── mod-pak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── shell.nix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── stack.yaml.lock</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You<!-- -->’<!-- -->ll find the patched <code>ghc.nix</code> included (<code>ghc.nix.wpc</code>) and a <code>shell.nix</code> for a <code>nix-shell</code>. The <code>shell.nix</code> file simply references <code>ghc.nix.wpc/default.nix</code> with the appropriate options:</p><div class="codeBlockContainer_I0IT language-nix theme-code-block"><div class="codeBlockContent_wNvx nix"><pre tabindex="0" class="prism-code language-nix codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat shell.nix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import (./ghc.nix.wpc/default.nix) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">useClang = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">withHadrianDeps = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">withIde   = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">withLlvm  = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><a id="orgbb3f1d5"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-ghc-wpc">Building ghc-wpc<a class="hash-link" href="#building-ghc-wpc" title="Direct link to heading">​</a></h2><p>Now we can enter a nix-shell and build <code>ghc-wpc</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">pwd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/doyougnu/programming/haskell/ghc-whole-program-compiler-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ nix-shell shell.nix  </span><span class="token comment" style="color:#999988;font-style:italic"># or just nix-shell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trace: checking </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> /home/doyougnu/programming/haskell/ghc-whole-program-compiler-project/hadrian/hadrian.cabal is present:  no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Recommended ./configure arguments </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">found </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$CONFIGURE_ARGS</span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or use the configure_ghc </span><span class="token builtin class-name">command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sznfxigwvrvn6ar3nz3f0652zsld9xqj-gmp-6.2.0-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/447im4mh8gmw85dkrvz3facg1jsbn6c7-gmp-6.2.0/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/84g84bg47xxg01ba3nv0h418v5v3969n-ncurses-6.1-20190112-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/xhhkr936b9q5sz88jp4l29wljbbcg39k-ncurses-6.1-20190112/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-dwarf-unwind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell/ghc-whole-program-compiler-project</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we need to <code>cd</code> into <code>ghc-wpc</code> and tweak the hadrian build.</p><p><strong>MAJOR CONSTRAINT: You must build ghc-wpc with hadrian/build-stack</strong>, if you build in any other way you<!-- -->’<!-- -->ll run into shared object errors, see this <a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/issues/4" target="_blank" rel="noopener noreferrer">ticket</a> for details.</p><p>So in order to build <code>ghc-wpc</code> with stack we<!-- -->’<!-- -->ll have to tweak the <code>stack.yaml</code> file. <strong>You must do this since it is not included in the fork</strong>:</p><p>Quick side note: To make the formatting nicer I truncate
<code>nix-shell:~/foo/bar/baz/ghc-whole-program-compiler-project</code> to just <code>...</code>, so
<code>nix-shell:.../ghc-wpc</code> is equivalent to
<code>~/path/to/ghc-whole-compiler-project/ghc-wpc</code>.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ghc-wpc/hadrian/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc/hadrian</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resolver: lts-15.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- </span><span class="token string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- </span><span class="token string" style="color:#e3116c">&#x27;GHC-Cabal&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">system-ghc: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nix:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   enable: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   shell-file: </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/shell.nix</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The changes are: (1) tell <code>stack</code> we are using <code>nix</code>, and (2) reference the <code>shell.nix</code> file which points to <code>ghc.wpc.nix</code> at the root of the project, i.e., <code>ghc-whole-program-compiler-project/shell.nix</code>.</p><p>Now we should be able to begin our build, return to the root of <code>ghc-wpc</code> and run the following:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc/hadrian</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./boot </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> ./configure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ hadrian/build-stack -j</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>and go get some coffee since this will take some time. Once it finishes you should have the <code>ghc-wpc</code> binary in <code>_build/stage1/bin</code></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l _build/stage1/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">8592</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1843752</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 ghc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">11082</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 ghc.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">660128</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:50 ghc-pkg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">9977</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:50 ghc-pkg.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4624680</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 haddock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">16883</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 haddock.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">49344</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:25 hp2ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">2504</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:25 hp2ps.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">716440</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">9959</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hpc.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">738544</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hsc2hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10264</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hsc2hs.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">58384</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:34 runghc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">8864</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:34 runghc.dyn_o_ghc_stgapp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that this build dumped <code>*.&lt;way&gt;_o_ghc_stgapp</code> files!</p><a id="org9ef4bc5"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-the-stg-tooling">Building the stg tooling<a class="hash-link" href="#building-the-stg-tooling" title="Direct link to heading">​</a></h2><p>Now that we have a working <code>ghc-wpc</code> we need to build the rest of the project by pointing <code>stack</code> to the <code>ghc-wpc</code> binary in <code>ghc-wpc/_build/stage1/bin</code>. That is, we must change the <code>ghc-whole-program-compiler-project/stack.yaml</code> file:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell/ghc-whole-program-compiler-project</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resolver: lts-16.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allow-newer: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;external-stg-compiler&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;external-stg&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ghc-options:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$everything</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> -fno-stgbin -fno-stgapp -optcxx-std</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">c++17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra-deps:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - async-pool-0.9.1@sha256:4015140f896c3f1652b06a679b0ade2717d05557970c283ea2c372a71be2a6a1,1605</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - souffle-haskell-1.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - zip-1.7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># use custom ext-stg whole program compiler GHC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compiler:     ghc-8.11.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skip-ghc-check: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nix:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enable: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># use local GHC (for development)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">system-ghc: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra-path:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - /home/doyougnu/programming/haskell/ghc-whole-program-compiler-project/ghc-wpc/_build/stage1/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># DEBUG INFO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#dump-logs: all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#build:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  keep-tmp-files: true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  cabal-verbose: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The changes are: (1) set <code>compiler: ghc-8.11.0</code> (the <code>ghc-wpc</code> fork), (2) set <code>skip-ghc-check: true</code> so that stack doesn<!-- -->’<!-- -->t complain about the ghc version, (3) set <code>nix.enable: false</code>, confusingly if you leave this as true then stack will try to use <code>nixpkgs</code> to get a ghc binary, but we want it to use our local binary so we disable this even though we<!-- -->’<!-- -->ll still be in our original nix-shell (4) set <code>system-path: true</code> to tell stack we will be using a ghc we have on our system, and finally (5) set <code>extra-path: &lt;path-to-ghc-wpc-binary&gt;</code>.</p><p>Now we can run stack and install the stg tooling:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ stack --stack-root </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain">/.stack-root </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trouble loading CompilerPaths cache: UnliftIO.Exception.throwString called with:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Compiler </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> metadata mismatch, ignoring cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Called from:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throwString </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">src/Stack/Storage/User.hs:277:8 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> stack-2.7.5-9Yv1tjrmAU3JiZWCo86ldN:Stack.Storage.User</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Ignoring tagged</span><span class="token string" style="color:#e3116c">&#x27;s bounds on template-haskell (&gt;=2.8 &amp;&amp; &lt;2.17); using template-haskell-2.17.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">WARNING: Ignoring aeson&#x27;</span><span class="token plain">s bounds on template-haskell </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">2.9</span><span class="token plain">.0.0 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">2.17</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> using template-haskell-2.17.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Ignoring th-abstraction</span><span class="token string" style="color:#e3116c">&#x27;s bounds on template-haskell (&gt;=2.5 &amp;&amp; &lt;2.17); using template-haskell-2.17.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">WARNING: Ignoring unliftio-core&#x27;</span><span class="token plain">s bounds on base </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">4.5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">4.14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> using base-4.14.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Ignoring souffle-haskell&#x27;s bounds on megaparsec </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">7.0</span><span class="token plain">.5 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> using megaparsec-8.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stack --stack-root </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain">/.stack-root </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token comment" style="color:#999988;font-style:italic"># bunch of output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copied executables to /home/doyougnu/.local/bin:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- dce-fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ext-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-exe2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-obj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-obj2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- mkfullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- show-ghc-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Installation path /home/doyougnu/.local/bin not found on the </span><span class="token environment constant" style="color:#36acaa">PATH</span><span class="token plain"> environment variable.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can add <code>~/.local/bin</code> to your <code>PATH</code> if you want, I<!-- -->’<!-- -->ll just be directly referencing these binaries as we go.</p><a id="org4a2eaf9"></a><h1>Building the external-stg-interpreter</h1><p>We are almost all done, all that is left is to build the external-stg-interpreter and run a small script that links everything together into a shared object for the interpreter. So:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> external-stg-interpreter/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ stack </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.  </span><span class="token comment" style="color:#999988;font-style:italic"># bunch of output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copied executables to /home/doyougnu/.local/bin:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ext-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ext-stg-interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- mkfullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Installation path /home/doyougnu/.local/bin not found on the </span><span class="token environment constant" style="color:#36acaa">PATH</span><span class="token plain"> environment variable.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we have our <code>ext-stg-interpreter</code> built! There are a few caveats I want to point out here. I<!-- -->’<!-- -->ve modified <code>ghc-whole-program-compiler-project/external-stg-interpreter/stack.yaml</code> to load the right packages and use nix:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resolver: lts-16.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;external-stg&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra-deps:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - souffle-haskell-2.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - primitive-0.7.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - zip-1.7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nix:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enable: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  packages: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> zlib, libffi, pkg-config, </span><span class="token function" style="color:#d73a49">bzip2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice the <code>nix:</code> block. We could have just as easily built this using <code>nix</code> directly or using our <code>shell.nix</code> file.</p><a id="org1d34a2e"></a><h1>Linking the external-stg-interpreter</h1><p>The only task left is to link into a shared object library called
<code>libHSbase-4.14.0.0.cbits.so</code>. To do that we need to use the script called, <code>c</code>,
in <code>ghc-whole-program-compiler-project/external-stg-interpreter/data</code>. This
script is a bit of a hack, it generates the shared object file so that we can link the symbols requested by the C
FFI in <code>base</code>, but it populates those functions with our replacements, which do absolutely nothing. For example, we supply a fake garbage collect:</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// in .../external-stg-interpreter/data/cbits.so-script/c-src/fake_rts.c</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">performGC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">performMajorGC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This works because we won&#x27;t be using the runtime system at all, we&#x27;ll be using
the external STG interpreter instead, however we still need to provide these
symbols in order to link. *<strong>*MAJOR NOTE: this file must be next to any
<!-- -->*<!-- -->.fullpak file you<!-- -->’<!-- -->ll be running the interpreter on**</strong> or else
you<!-- -->’<!-- -->ll get an undefined symbol error during linking, for example:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cbits.so-script  ghc-rts-base.fullpak  minigame-strict.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### notice no .so file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ~/.local/bin/ext-stg-interpreter ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ext-stg-interpreter: user error </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dlopen: ./libHSbase-4.14.0.0.cbits.so: cannot </span><span class="token function" style="color:#d73a49">open</span><span class="token plain"> shared object file: No such </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> or directory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## we error&#x27;d out because it was missing, also</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## if you get this error then you have an old cbits.so file and need to rerun the c script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ~/.local/bin/ext-stg-interpreter ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ext-stg-interpreter: user error </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dlopen: ./libHSbase-4.14.0.0.cbits.so: undefined symbol: getProcessElapsedTime</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To link the interpreter we need to run <code>c</code> in the <code>data/cbits.so-script</code> sub-folder:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> data/cbits.so-script/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ar  c  cbits-rts.dyn_o  c-src  libHSbase-4.14.0.0.cbits.so  stub-base.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> ar/libHSbase-4.14.0.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSbindings-GLFW-3.3.2.0-Jg9TvsfYUZwD0ViIP0H2Tz-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSbytestring-0.10.9.0-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHScriterion-measurement-0.1.2.0-73BCI2Fnk7qE8QjjTa1xNa-ghc8.11.0.20210324.dyn_o_cbits.a ar/libHSghc-8.11.0.20210306-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20210324.dyn_o_stubs.a ar/libHShashable-1.3.0.0-Kn7aNSFvzgo2qY16wYzuCX-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSinteger-gmp-1.0.3.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSlambdacube-quake3-engine-0.1.0.0-7CKLP3Rqgq0PR81lhlwlR-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSmersenne-random-pure64-0.2.2.0-ExYg8DmthtrLG9JevQbt2m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSOpenGLRaw-3.3.4.0-5vXBlmbOM3AIT7GRYfpE3o-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSprimitive-0.7.0.1-2k3g9qX0zz16vEv34R307m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSprocess-1.6.8.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHStext-1.2.4.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_stubs.a ar/libHSzlib-0.6.2.1-1I6DmfbLEyTBgDZI7SbZfW-ghc8.11.0.20210306.dyn_o_stubs.a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> stub-base.dyn_o/Blank_stub.dyn_o stub-base.dyn_o/ClockGetTime_stub.dyn_o stub-base.dyn_o/Internals_stub.dyn_o stub-base.dyn_o/RUsage_stub.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> cbits-rts.dyn_o/StgPrimFloat.dyn_o cbits-rts.dyn_o/TTY.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> c-src/fake_rts.c c-src/hack.c c-src/hschooks.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ gcc -o libHSbase-4.14.0.0.cbits.so -shared -Wl,--whole-archive ar/libHSbase-4.14.0.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSbindings-GLFW-3.3.2.0-Jg9TvsfYUZwD0ViIP0H2Tz-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSbytestring-0.10.9.0-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHScriterion-measurement-0.1.2.0-73BCI2Fnk7qE8QjjTa1xNa-ghc8.11.0.20210324.dyn_o_cbits.a ar/libHSghc-8.11.0.20210306-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20210324.dyn_o_stubs.a ar/libHShashable-1.3.0.0-Kn7aNSFvzgo2qY16wYzuCX-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSinteger-gmp-1.0.3.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSlambdacube-quake3-engine-0.1.0.0-7CKLP3Rqgq0PR81lhlwlR-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSmersenne-random-pure64-0.2.2.0-ExYg8DmthtrLG9JevQbt2m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSOpenGLRaw-3.3.4.0-5vXBlmbOM3AIT7GRYfpE3o-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSprimitive-0.7.0.1-2k3g9qX0zz16vEv34R307m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSprocess-1.6.8.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHStext-1.2.4.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_stubs.a ar/libHSzlib-0.6.2.1-1I6DmfbLEyTBgDZI7SbZfW-ghc8.11.0.20210306.dyn_o_stubs.a -Wl,--no-whole-archive stub-base.dyn_o/Blank_stub.dyn_o stub-base.dyn_o/ClockGetTime_stub.dyn_o stub-base.dyn_o/Internals_stub.dyn_o stub-base.dyn_o/RUsage_stub.dyn_o cbits-rts.dyn_o/StgPrimFloat.dyn_o cbits-rts.dyn_o/TTY.dyn_o -fPIC c-src/fake_rts.c c-src/hack.c c-src/hschooks.c -lm -lgmp -ltinfo -lGL -lX11 -lXi -lXrandr -lXxf86vm -lXcursor -lXinerama -lpthread</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This will produce <code>libHSbase-4.14.0.0.cbits.so</code> in the immediate directory:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">984</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 ar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 cbits-rts.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 c-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">986008</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:50 libHSbase-4.14.0.0.cbits.so    </span><span class="token comment" style="color:#999988;font-style:italic">## &lt;----- new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 stub-base.dyn_o</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we can test our interpreter by running it on the <code>*.fullpak</code> files in <code>external-stg-interpreter/data</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cbits.so-script  ghc-rts-base-call-graph-summary  ghc-rts-base-call-graph.tsv  ghc-rts-base.fullpak  libHSbase-4.14.0.0.cbits.so  minigame-strict.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## remove the old .so file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## soft-link to the one we just built</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ln</span><span class="token plain"> -s cbits.so-script/libHSbase-4.14.0.0.cbits.so libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">79220</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:50 cbits.so-script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:47 ghc-rts-base-call-graph-summary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">28238</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:47 ghc-rts-base-call-graph.tsv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22450708</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">43</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:55 libHSbase-4.14.0.0.cbits.so -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cbits.so-script/libHSbase-4.14.0.0.cbits.so  </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">58630129</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 minigame-strict.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ~/.local/bin/ext-stg-interpreter ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssHeapStartAddress: </span><span class="token number" style="color:#36acaa">53522</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssTotalLNECount: </span><span class="token number" style="color:#36acaa">69</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssClosureCallCounter: </span><span class="token number" style="color:#36acaa">360</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">executed closure </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> count: </span><span class="token number" style="color:#36acaa">114</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call graph size: </span><span class="token number" style="color:#36acaa">150</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">79220</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:50 cbits.so-script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:56 ghc-rts-base-call-graph-summary    </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">28238</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:56 ghc-rts-base-call-graph.tsv        </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22450708</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">43</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:55 libHSbase-4.14.0.0.cbits.so -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cbits.so-script/libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">58630129</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 minigame-strict.fullpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And it works, we have two new files, <code>&lt;foo&gt;-call-graph-summary</code> and <code>&lt;foo&gt;-call-graph.tsv</code> which we can analyze to inspect the behavior of our program (more on this later).</p><a id="org2daa4b8"></a><h1>The whole setup process on a demo</h1><p>That was a rather involved example, to make clear the dependencies and steps required to run this on your own code the rest of this tutorial will run the interpreter on two of Csaba<!-- -->’<!-- -->s demo<!-- -->’<!-- -->s from his skillshare talk. First let<!-- -->’<!-- -->s grab the code:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">pwd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/doyougnu/programming/haskell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/grin-compiler/ext-stg-interpreter-presentation-demos.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ext-stg-interpreter-presentation-demos ghc-whole-program-compiler-project </span><span class="token punctuation" style="color:#393A34">..</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we<!-- -->’<!-- -->ll run the first demo which is a simply fold over a list:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ nix-shell ghc-whole-program-compiler-project/shell.nix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trace: checking </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> /home/doyougnu/programming/haskell/hadrian/hadrian.cabal is present:  no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Recommended ./configure arguments </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">found </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$CONFIGURE_ARGS</span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or use the configure_ghc </span><span class="token builtin class-name">command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sznfxigwvrvn6ar3nz3f0652zsld9xqj-gmp-6.2.0-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/447im4mh8gmw85dkrvz3facg1jsbn6c7-gmp-6.2.0/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/84g84bg47xxg01ba3nv0h418v5v3969n-ncurses-6.1-20190112-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/xhhkr936b9q5sz88jp4l29wljbbcg39k-ncurses-6.1-20190112/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-dwarf-unwind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ext-stg-interpreter-presentation-demos/demo-01-tsumupto/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell/ext-stg-interpreter-presentation-demos/demo-01-tsumupto</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/ghc-wpc/_build/stage1/bin/ghc -O2 tsumupto.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> of </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Compiling Main             </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> tsumupto.hs, tsumupto.o </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Linking tsumupto </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ext-stg-interpreter-presentation-demos/demo-01-tsumupto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsumupto  tsumupto.hi  tsumupto.hs  tsumupto.o  tsumupto.o_ghc_stgapp  tsumupto.o_modpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note, that we have two new files: <code>*.o_ghc_stgapp</code> and <code>.o_modpak</code> as a result of building with <code>ghc-wpc</code>. If you try to run this from outside the nix-shell you<!-- -->’<!-- -->ll get an error about missing <code>mkmodpak</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/ghc-wpc/_build/stage1/bin/ghc -O2 tsumupto.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> of </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Compiling Main             </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> tsumupto.hs, tsumupto.o </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ghc: could not execute: mkmodpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now that we have those files we can run the interpreter, but first though we need to make a <code>*.fullpak</code> file from the <code>*.o_ghc_stgapp</code> file and create a symbolic link to <code>libHSbase-4.14.0.0.cbits.so</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## make the fullpack file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ~/.local/bin/mkfullpak tsumupto.o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">all modules: </span><span class="token number" style="color:#36acaa">259</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app modules: </span><span class="token number" style="color:#36acaa">113</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app dependencies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token comment" style="color:#999988;font-style:italic"># bunch of output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main                                                         Main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">creating tsumupto.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## create the link to the shared object file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ln</span><span class="token plain"> -s </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/external-stg-interpreter/data/cbits.so-script/libHSbase-4.14.0.0.cbits.so libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## the final directory should look like this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libHSbase-4.14.0.0.cbits.so  tsumupto  tsumupto.fullpak  tsumupto.hi  tsumupto.hs  tsumupto.o  tsumupto.o_ghc_stgapp  tsumupto.o_modpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And now we can run the interpreter:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ~/.local/bin/ext-stg-interpreter tsumupto.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">50005000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssHeapStartAddress: </span><span class="token number" style="color:#36acaa">44082</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssTotalLNECount: </span><span class="token number" style="color:#36acaa">43</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssClosureCallCounter: </span><span class="token number" style="color:#36acaa">30275</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">executed closure </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> count: </span><span class="token number" style="color:#36acaa">112</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call graph size: </span><span class="token number" style="color:#36acaa">146</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The first line is the output of the program and the rest are diagnostics that the interpreter outputs. More importantly we should have a tab-separated csv file and call graph file in our local directory after running the interpreter:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">23876</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">114</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:21 libHSbase-4.14.0.0.cbits.so -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/external-stg-interpreter/data/cbits.so-script/libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">9442648</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">53</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:23 tsumupto-call-graph-summary   </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">27490</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:23 tsumupto-call-graph.tsv       </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw------- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14922366</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:19 tsumupto.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">1769</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.hi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">207</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">28</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:56 tsumupto.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">4488</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">8817</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw------- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">9803</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.o_modpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Which can be loaded into <code>gephi</code> for closer inspection of the call graph of our program. Be sure to watch the rest of the demo in Csaba<!-- -->’<!-- -->s talk for this part! For now we<!-- -->’<!-- -->ll be going over using <code>gephi</code> and these files in our next blog post in this series, stay tuned!</p><a id="org8193a1a"></a><h1>Summary</h1><a id="org940ba90"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="file-descriptions">File Descriptions<a class="hash-link" href="#file-descriptions" title="Direct link to heading">​</a></h2><ul><li><code>foo.modpak</code>: A zip file which contains the Core, STG, CMM, source code, and assembly for the module <code>foo</code></li><li><code>foo.fullpak</code>: A zip file which contains the same information as <code>modpack</code> but for every module of the program rather than just module <code>foo</code>.</li><li><code>foo.o_ghc_stgapp</code>: a yaml like file that contains:<ul><li>the module<!-- -->’<!-- -->s dependencies including package dependencies</li><li>a bunch of file paths for shared objects of the libraries</li><li>the flags the module was built with</li></ul></li><li><code>libHSbase-4.14.0.0.cbits.so</code>: shared object file created by <code>ext-stg-interpreter/data/cbits.so-script.c</code>. Required to be in the same directory as <code>ext-stg-interpreter</code> will be invoked.</li></ul><a id="org8e9f409"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="step-by-step-guide-for-running-the-interpreter-on-your-code">Step-by-Step guide for running the interpreter on your code<a class="hash-link" href="#step-by-step-guide-for-running-the-interpreter-on-your-code" title="Direct link to heading">​</a></h2><ol><li>Build your project with <code>ghc-wpc/_build/stage1/bin</code> by directly invoking that <code>ghc</code> (as I did in the demo-01 project) or by pointing stack to it with <code>system-ghc</code> and <code>extra-path</code> in <code>stack.yaml</code>, or by passing <code>-w &lt;path-to-ghc-wpc-binary</code> with cabal.</li><li>Generate the <code>foo.fullpak</code> file with <code>mkfullpak foo.o_ghc_stgapp</code></li><li>Soft-link to <code>libHSbase-4.14.0.0.cbits.so</code> in the directory you will run the interpreter in. This file must be present when you run the interpreter!</li><li>Now run the interpreter on <code>project.fullpak</code></li><li>Analyze <code>foo-call-graph-summary</code> and <code>foo-call-graph.tsv</code> with whatever tools make sense to you</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="footnotes">Footnotes<a class="hash-link" href="#footnotes" title="Direct link to heading">​</a></h2><div class="footnotes"><hr><ol><li id="fn-1">This isn<!-- -->’<!-- -->t completely true, there is the <code>RuntimeRep</code> type controls
exactly this and the levity polymorphism work by <a href="https://richarde.dev/" target="_blank" rel="noopener noreferrer">Richard
Eisenberg</a>. See <a href="https://www.youtube.com/watch?v=Mb_B-j8ePfc" target="_blank" rel="noopener noreferrer">this
video</a> for examples on using these
features. We do plan to include a more thorough and real world example on using
levity polymorphism for better performance in the <a href="https://github.com/haskellfoundation/tech-proposals/pull/26" target="_blank" rel="noopener noreferrer">haskell optimization
handbook</a>.<a href="#fnref-1" class="footnote-backref">↩</a></li></ol></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/stg">stg</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/tooling">tooling</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/profiling">profiling</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/optimization">optimization</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Setting up Csaba&#x27;s External STG Interpreter" href="/2022-05-02-setup-ext-stg-interp"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-04-28-on-the-inlining-of-integer-and-natural-operations">On the inlining of Integer and Natural operations</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-04-28T00:00:00.000Z" itemprop="datePublished">April 28, 2022</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In this post I discuss the inlining of Integer and Natural operations in Haskell. It’s a promising performance work I’ve been conducting six months ago, which was blocked by an independent issue, but that I will likely resume soon as the issue has been fixed in the meantime.</p><hr><p>To follow this post, you must know that <code>Natural</code> numbers are represented as follows in <code>ghc-bignum</code>:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- | Natural number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Invariant: numbers &lt;= WORD_MAXBOUND use the `NS` constructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data Natural</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   = NS !Word#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   | NB !BigNat#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Small naturals are represented with a <code>Word#</code> and large ones with a <code>BigNat#</code> (a <code>ByteArray#</code>).</p><p>Now consider the following simple example using Natural:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- | Add 2 to a Word. Use Natural to avoid Word overflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foo :: Word -&gt; Natural</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foo x = fromIntegral x + 2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There are only small naturals involved: <code>fromIntegral x</code> is small because <code>x</code> is a <code>Word</code>, and <code>2</code> is small. We could hope that GHC would use <code>Word#</code> primops to implement this and would allocate a <code>Natural</code> heap object for the result <em>only</em>. However it’s not what happens currently, even in GHC HEAD. In the following STG dump, we can see that a <code>Natural</code> heap object is allocated for <code>x</code> before calling <code>naturalAdd</code> (<code>let</code> bindings in STG reflect heap allocations):</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">foo1 = NS! [2##];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">foo =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    \r [x_sXn]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case x_sXn of {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        W# x#_sXp -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let { sat_sXq = NS! [x#_sXp]; } in  naturalAdd sat_sXq foo1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Let’s look at <code>naturalAdd</code>:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-- | Add two naturals</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">naturalAdd :: Natural -&gt; Natural -&gt; Natural</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{-# NOINLINE naturalAdd #-}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">naturalAdd (NS x) (NB y) = NB (bigNatAddWord# y x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">naturalAdd (NB x) (NS y) = NB (bigNatAddWord# x y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">naturalAdd (NB x) (NB y) = NB (bigNatAdd x y)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">naturalAdd (NS x) (NS y) =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   case addWordC# x y of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (# l,0# #) -&gt; NS l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (# l,c  #) -&gt; NB (bigNatFromWord2# (int2Word# c) l)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We are clearly in the last case where both arguments are small. It seems beneficial to allow this function to be inlined. If we did we would get:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">foo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    \r </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x_s158</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> x_s158 </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token constant" style="color:#36acaa">W</span><span class="token plain"># x#_s15a </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> addWordC# </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x#_s15a </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">##</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">#</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">#</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> l_s15c ds_s15d </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> ds_s15d</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token maybe-class-name">TagProper</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> ds1_s15e </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          __DEFAULT </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> int2Word# </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ds1_s15e</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> sat_s15f </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              __DEFAULT </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> bigNatFromWord2# sat_s15f l_s15c </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> ds2_s15g </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              __DEFAULT </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NB</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ds2_s15g</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"># </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">l_s15c</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>which produces much better assembly code, especially if there is no carry:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    addq $2,%rax       ; add 2 to a machine word</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    setc %bl           ; test the carry.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    movzbl %bl,%ebx    ; it could be done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    testq %rbx,%rbx    ; more efficiently</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jne _blk_c17c      ; with &quot;jc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_blk_c17i:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    movq $NS_con_info,-8(%r12) ; alloc NS datacon value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    movq %rax,(%r12)           ; with the addition result as payload.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    leaq -7(%r12),%rbx         ; make it the first argument</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addq $8,%rbp               ; and then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp *(%rbp)                ; call continuation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>So why aren’t we always inlining <code>naturalAdd</code>? We even explicitly disallow it with a <code>NOINLINE</code> pragma. The reason is that <code>naturalAdd</code> and friends are involved in constant-folding rules.</p><p>For example, consider:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">bar :: Natural -&gt; Natural</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bar x = x + 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">baz = bar 0x12345678913245678912345679123456798</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Currently we get the following Core:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">bar1 = NS 2##</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bar = \ x_aHU -&gt; naturalAdd x_aHU bar1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">baz = NB 99114423092485377935703335253042771879834</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can see that <code>baz</code>  is a constant thanks to constant-folding.</p><p>However if we let <code>naturalAdd</code> inline we get:</p><div class="codeBlockContainer_I0IT language-haskell theme-code-block"><div class="codeBlockContent_wNvx haskell"><pre tabindex="0" class="prism-code language-haskell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">baz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = case bigNatAddWord# 99114423092485377935703335253042771879832 2##</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    of ds_d11H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { __DEFAULT -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NB ds_d11H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>baz</code> is no longer a constant.</p><p>A solution would be to add constant-folding rules for <code>BigNat#</code> functions, such as <code>bigNatAddWord#</code>. This is exactly what we have started doing in <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20361" target="_blank" rel="noopener noreferrer">#20361</a>. Our new plan is:</p><ul><li>Make <code>BigNat#</code> operation <code>NOINLINE</code> and add constant-folding rules for them</li><li>Make Integer/Natural operations <code>INLINEABLE</code> (expose their unfolding)</li><li>Hence rely on constant-folding for <code>Word#/Int#/BigNat#</code> to provide constant folding for <code>Integer</code> and <code>Natural</code></li></ul><p>The good consequences of this plan are:</p><ul><li>Less allocations when bignum operations are inlined and some of the arguments are known to be small/big or fully known (constant).</li><li><code>Integer</code> and <code>Natural</code> are less magical: you can implement your own similar types and expect the same performance without having to add new rewrite rules</li></ul><p>There were some unforeseen difficulties with this plan though:</p><ol><li>Some of the rewrite rules we need involve unboxed values such as <code>BigNat#</code> and <code>Word#</code> and the weren’t supported. Luckily, this has been recently fixed (<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19313" target="_blank" rel="noopener noreferrer">#19313</a>) by removing the “app invariant” (<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20554" target="_blank" rel="noopener noreferrer">#20554</a>). Thanks Joachim! That’s the reason why we could resume this work now.</li><li>Some unfoldings (RHSs) become bigger due to the inlining of bignum operations. Hence they may not themselves be inlined further due to inlining thresholds even if it would be beneficial. A better inlining heuristic would fix this (see <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20516" target="_blank" rel="noopener noreferrer">#20516</a>). It will likely be the topic of the next post.</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about On the inlining of Integer and Natural operations" href="/2022-04-28-on-the-inlining-of-integer-and-natural-operations"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-04-19-ghc-march-2022-update">GHC March 2022 Update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-04-19T00:00:00.000Z" itemprop="datePublished">April 19, 2022</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="js-backend">JS Backend<a class="hash-link" href="#js-backend" title="Direct link to heading">​</a></h2><p>In March the team focused on porting more GHCJS code to GHC head.</p><ul><li>Most of us are new to GHCJS’s codebase so we are taking some time to better understand it and to better document it as code gets integrated into GHC head.</li><li>Development process: initially we had planned to integrate features one after the others into GHC head. However it was finally decided that features would be merged into a <a href="https://gitlab.haskell.org/ghc/ghc/-/commits/wip/javascript-backend" target="_blank" rel="noopener noreferrer">wip/javascript-backend</a> branch first and then later merged into GHC head. After trying this approach we decided to work directly into another branch: <a href="https://gitlab.haskell.org/ghc/ghc/-/commits/wip/js-staging" target="_blank" rel="noopener noreferrer">wip/js-staging</a> . Opening merge requests that can’t be tested against a branch that isn’t GHC head didn’t bring any benefit and slowed us too much.</li><li>Documentation: we wrote a document comparing the different approaches to target JavaScript/WebAssembly <a href="https://gitlab.haskell.org/ghc/ghc/-/wikis/javascript" target="_blank" rel="noopener noreferrer"> https://gitlab.haskell.org/ghc/ghc/-/wikis/javascript</a></li><li>RTS: some parts of GHCJS’s RTS are generated from Haskell code, similarly to code generated with the genapply program in the C RTS. This code has been ported to GHC head. As JS linking---especially linking with the RTS---will only be performed by GHC in the short term, we plan to make it generate this code dynamically at link time.</li><li>Linker: most of GHCJS’s linker code has been adapted to GHC head. Because of the lack of modularity of GHC, a lot of GHC code was duplicated into GHCJS and slightly modified. Now that both codes have diverged we need to spend some time making them converge again, probably by making the Linker code in GHC more modular.</li><li>Adaptation to GHC head: some work is underway to replace GHCJS’s Objectable type-class with GHC’s Binary type-class which serves the same purpose. Similarly a lot of uses of Text have been replaced with GHC’s ShortText or FastString.</li><li>Template Haskell: GHCJS has its own TH runner which inspired GHC’s external interpreter (“Iserv”) programs. We have been exploring options to port TH runner code as an Iserv implementation. The Iserv protocol uses GADTs to represent its messages which requires more boilerplate code to convert them into JS because we can’t automatically derive aeson instances for them.</li><li>Plugins: we have an MR adding support for “external static plugins” to GHC <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7377" target="_blank" rel="noopener noreferrer">!7377</a>. Currently it only supports configuring plugins <em>via</em> environment variables. We have been working on adding support for command-line flags instead.</li><li>Testsuite: we have fixed GHC’s build system so that it can run GHC’s testsuite when GHC is built as a cross-compiler (<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7850" target="_blank" rel="noopener noreferrer">!7850</a>). There is still some work to do (tracked in <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/21292" target="_blank" rel="noopener noreferrer">#21292</a>) to somehow support tests that <em>run</em> compiled programs: with cross-compilers, target programs can’t be directly executed by the host architecture.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="misc">Misc<a class="hash-link" href="#misc" title="Direct link to heading">​</a></h2><ul><li><a href="https://github.com/haskellfoundation/tech-proposals/pull/26" target="_blank" rel="noopener noreferrer">Performance book</a>: some time was spent on the infrastructure (CI) and on switching the format of the book to ReStructured Text</li><li>Modularity: some time was spent discussing GHC’s design and refactoring (c.f. <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7442" target="_blank" rel="noopener noreferrer">!7442</a> and <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20927" target="_blank" rel="noopener noreferrer">#20927</a>).</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHC March 2022 Update" href="/2022-04-19-ghc-march-2022-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-03-09-ghc-february-2022-update">GHC February 2022 Update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-03-09T00:00:00.000Z" itemprop="datePublished">March 9, 2022</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="js-backend">JS backend<a class="hash-link" href="#js-backend" title="Direct link to heading">​</a></h2><p>This month we worked on adapting code from GHCJS to merge into GHC head. We also started discussing the implementation process publicly and especially with our colleagues at Well-Typed.</p><ul><li>Ticket about adapting GHCJS’ code into a proper JS backend for GHC has been opened <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/21078" target="_blank" rel="noopener noreferrer">#21078</a>]<!-- -->. Feedback was very positive!</li><li>There were discussions about the process and an agreement to target GHC 9.6 release <!-- -->[<a href="https://mail.haskell.org/pipermail/ghc-devs/2022-February/020580.html" target="_blank" rel="noopener noreferrer">email on ghc-devs</a>, <a href="https://gitlab.haskell.org/ghc/ghc/-/wikis/javascript-backend" target="_blank" rel="noopener noreferrer">wiki page</a>]</li><li><code>deriveConstants</code> is a program used to generate some header file included in the rts package. While it is mainly useful for native targets, we had to make it support Javascript targets <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7585" target="_blank" rel="noopener noreferrer">!7585</a>]</li><li>Javascript is going to be the first official target platform supported by GHC that has its own notion of managed heap objects. Hence we may need a new <code>RuntimeRep</code> to represent these values for Haskell codes interacting with JS codes via FFI. We opened <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7577" target="_blank" rel="noopener noreferrer">!7577</a> into which we tried to make this new <code>RuntimeRep</code> non JS specific so that it could be reused for future backends targeting other managed platforms (e.g. CLR, JVM). It triggered a lot of discussions summarized in <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/21142" target="_blank" rel="noopener noreferrer">#21142</a>.</li><li>GHCJS’s code generator was ported to GHC head <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7573" target="_blank" rel="noopener noreferrer">!7573</a>]<!-- -->. In its current state, we can generate Javascript unoptimised code -- the optimiser hasn’t been ported yet -- by compiling a module with <code>-c -fjavascript</code>. It required many changes, not only to adapt to changes between GHC 8.10 and GHC head but also to avoid adding new package dependencies. It was also an opportunity to refactor and to document the code, which is still a work in progress.</li><li>GHC doesn’t use any lens library, hence to port the code generator we had to replace lenses with usual record accessors. It turned out that <code>case</code> alternatives in STG lacked them because they were represented with a triple. We took the opportunity to introduce a proper record type for them  <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7652" target="_blank" rel="noopener noreferrer">!7652</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="plutus-apps-js-demo">Plutus-apps JS demo<a class="hash-link" href="#plutus-apps-js-demo" title="Direct link to heading">​</a></h2><ul><li>We improved the proof of concept JavaScript library for generating Plutus transactions with a given set of constraints and lookups, exposing functionality from the <code>plutus-ledger-constraints</code> package. <!-- -->[<a href="https://github.com/hamishmack/plutus-apps/blob/1f331225853f502807aab370f82ec975bdec38ee/plutus-pab/mktx/README.md" target="_blank" rel="noopener noreferrer">Report</a>]</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="reporting">Reporting<a class="hash-link" href="#reporting" title="Direct link to heading">​</a></h2><ul><li>we wrote a blog post about the work we have done in 2021 as it wasn’t covered anywhere else: <a href="https://engineering.iog.io/2022-03-01-2021-ghc-update" target="_blank" rel="noopener noreferrer">https://engineering.iog.io/2022-03-01-2021-ghc-update</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHC February 2022 Update" href="/2022-03-09-ghc-february-2022-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-03-01-2021-ghc-update">2021 GHC update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-03-01T00:00:00.000Z" itemprop="datePublished">March 1, 2022</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>IOG is committed to improving Haskell developer experience, both by <a href="https://iohk.io/en/blog/posts/2020/11/04/iohk-sponsors-new-haskell-foundation" target="_blank" rel="noopener noreferrer">sponsoring the Haskell Foundation</a> and by directly founding a team committed to this task: the Haskell DX team.</p><p>The team now tries to provide regular (monthly) updates about its work. This post is a bit longer because it covers all of 2021 which has not been covered anywhere else.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="code-generation">Code generation<a class="hash-link" href="#code-generation" title="Direct link to heading">​</a></h2><ul><li>Added a new backend for AArch64 architectures, especially to support Apple’s M1. Previously AArch64 was only supported via the LLVM based backend which is much slower. <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5884" target="_blank" rel="noopener noreferrer">!5884</a>]</li><li>Added support for Apple’s M1 calling convention. In GHC 9.2.1 it implied making lifted sized types (e.g. <code>Word8</code>, <code>Int16</code>...) use their unlifted counterparts (e.g. <code>Word8#</code>, <code>Int16#</code>...); in GHC 8.10.7 – a minor release –  a less invasive but more fragile solution was implemented <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/commit/c49250d88915db6acf88d2574db827cc2c4fa080" target="_blank" rel="noopener noreferrer">commit</a>]<!-- -->.</li><li>Fixed a very old GHC issue <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/1257" target="_blank" rel="noopener noreferrer">#1257</a>]<!-- --> by making GHCi support unboxed values <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4412" target="_blank" rel="noopener noreferrer">!4412</a>]<!-- -->: ByteCode is now generated from STG instead of directly from Core. It allows more Haskell codes to be supported by HLS and it even allows GHC code to be loaded into GHCi <!-- -->[<a href="https://mail.haskell.org/pipermail/ghc-devs/2021-October/020345.html" target="_blank" rel="noopener noreferrer">link</a>]<!-- -->.</li><li>Fixed a bug in the Cmm sinking pass that led to register corruption at runtime with the C backend. Even if we don’t use the C backend, fixing this avoided spurious errors in CI jobs using it <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19237" target="_blank" rel="noopener noreferrer">#19237</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5755/" target="_blank" rel="noopener noreferrer">!5755</a>]</li><li>Fixed a register clobbering issue for 64-bit comparisons generated with the 32-bit x86 NCG backend <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/commit/ecd6d14215eb40ac441c075e432ddaa0237f3c72" target="_blank" rel="noopener noreferrer">commit</a>]<!-- -->.</li><li>Fixed generation of switches on sized literals in StgToCmm <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6211" target="_blank" rel="noopener noreferrer">!6211</a>]</li><li>Fixed LLVM shifts <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19215" target="_blank" rel="noopener noreferrer">#19215</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4822" target="_blank" rel="noopener noreferrer">!4822</a>]</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="linker">Linker<a class="hash-link" href="#linker" title="Direct link to heading">​</a></h2><ul><li>Fixed an off-by-one error in the MachO (Darwin) linker <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6041/" target="_blank" rel="noopener noreferrer">!6041</a>]<!-- -->. The fix is simple but the debugging session was epic!</li><li>Fix to avoid linking plugin units unconditionally with target code, which is wrong in general but even more so when GHC is used as a cross-compiler: plugins and target code aren’t for the same platform <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20218" target="_blank" rel="noopener noreferrer">#20218</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6496" target="_blank" rel="noopener noreferrer">!6496</a>]</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="cross-compilation">Cross-compilation<a class="hash-link" href="#cross-compilation" title="Direct link to heading">​</a></h2><ul><li>With John Ericson (Obsidian Systems) we finally made GHC independent of its target <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6791" target="_blank" rel="noopener noreferrer">!6791</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6539" target="_blank" rel="noopener noreferrer">!6539</a>]<!-- -->. It means that there is no need to rebuild GHC to make it target another platform, so it now becomes possible to add support for a <code>--target=...</code> command-line flag <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/11470" target="_blank" rel="noopener noreferrer">#11470</a>]<!-- -->. It also means that a cross-compiling GHC could build plugins for its host platform in addition to building code for its target platform.</li><li>A side-effect of the previous bullet is that primops’ types are now platform independent. Previously some of them would use Word64 on 32-bit architectures and Word on 64-bit architectures: now Word64 is used on every platform. A side-effect of this side-effect is that we had to make Word64 as efficient as Word: it now benefits from the same optimizations (constant folding <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19024" target="_blank" rel="noopener noreferrer">#19024</a>, etc.). On 32-bit platforms, it reduced allocations by a fair amount in some cases: e.g. -25.8% in T9203 test and -11.5% when running haddock on base library <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6167" target="_blank" rel="noopener noreferrer">!6167</a>]<!-- -->. We hope it will benefit other 32-bit architectures such as JavaScript or WebAssembly.</li><li>GHC built as a cross-compiler doesn’t support compiler plugins <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/14335" target="_blank" rel="noopener noreferrer">#14335</a>]<!-- -->. We have been working on refactoring GHC to make it support two separate environments in a given compiler session – one for target code and another for the plugin/compiler code. The implementation in <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6748" target="_blank" rel="noopener noreferrer">!6748</a>]<!-- --> conflicts quite a lot with the support of multiple home-units that was added at about the same time. GHC needs to be refactored a lot more to correctly support this approach, so instead we implemented a different approach to load plugins which is more low-level and bypasses the issue <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20964" target="_blank" rel="noopener noreferrer">#20964</a>, <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7377" target="_blank" rel="noopener noreferrer">!7377</a>]<!-- -->.</li><li>We made GHC consider the target platform instead of the host platform in guessOutputFile <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6116" target="_blank" rel="noopener noreferrer">!6116</a>]</li><li>Use target platform instead of host platform to detect literal overflows <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/17336" target="_blank" rel="noopener noreferrer">#17336</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4986" target="_blank" rel="noopener noreferrer">!4986</a>]</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghcjs">GHCJS<a class="hash-link" href="#ghcjs" title="Direct link to heading">​</a></h2><ul><li>We updated GHCJS to use GHC 8.10.7 <!-- -->[<a href="https://github.com/ghcjs/ghcjs/tree/ghc-8.10" target="_blank" rel="noopener noreferrer">branch</a>]</li><li>We worked on making GHCJS’s codebase more suitable for integration into GHC: reducing the number of dependencies, avoiding the use of Template Haskell, reusing GHC’s build system, etc. There is now a GHCJS integrated into a GHC 8.10.7 fork <!-- -->[<a href="https://github.com/ghcjs/ghc/tree/ghc-8.10-ghcjs" target="_blank" rel="noopener noreferrer">branch</a>]<!-- -->.</li><li>This experience led us to plan the realization of a JS backend into GHC head based on GHCJS. More information about this topic in our next report.</li><li>We worked on making GHC’s testsuite pass with GHCJS, triaging tests that legitimately fail on a JS platform from tests revealing real GHCJS issues. <strong>[<!-- -->LINK<!-- -->]</strong></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="windows">Windows<a class="hash-link" href="#windows" title="Direct link to heading">​</a></h2><ul><li>We seemed to be the first to try to build GHC on Windows with the updated GNU autotools 2.70 and this release made a breaking change to the way auxiliary files (config.guess, config.sub) were handled, breaking GHC’s build (<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19189#note_332168" target="_blank" rel="noopener noreferrer">#19189</a>). The root cause of the issue couldn’t be easily solved so we modified GHC’s build system to avoid the use of these auxiliary files, bypassing the issue. Most GHC devs won’t ever notice that something was broken to begin with when they will update their GNU toolchain on Windows. <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4768" target="_blank" rel="noopener noreferrer">!4768</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4987" target="_blank" rel="noopener noreferrer">!4987</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5065/" target="_blank" rel="noopener noreferrer">!5065</a>]</li><li>Fixed cross-compilation of GHC from Linux to Windows using Hadrian <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20657" target="_blank" rel="noopener noreferrer">#20657</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6945" target="_blank" rel="noopener noreferrer">!6945</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6958" target="_blank" rel="noopener noreferrer">!6958</a>]</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="numeric">Numeric<a class="hash-link" href="#numeric" title="Direct link to heading">​</a></h2><ul><li>Fixed Natural to Float/Double conversions to align with the method used for Integer to Float/Double and added missing rewrite rules <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6004/" target="_blank" rel="noopener noreferrer">!6004</a>]</li><li>Made most bignum literals be desugared into their final form in HsToCore stage instead of CoreToStg stage to ensure that Core optimizations were applied correctly to them <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20245" target="_blank" rel="noopener noreferrer">#20245</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6376" target="_blank" rel="noopener noreferrer">!6376</a>]</li><li>Some constant folding rules were missing and were added:<ul><li>bitwise <code>and</code> primops when applied to a full mask (e.g. 0xFF for a 8-bit word). <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20448" target="_blank" rel="noopener noreferrer">#20448</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6629" target="_blank" rel="noopener noreferrer">!6629</a>]</li><li><code>negate</code> primops <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20347" target="_blank" rel="noopener noreferrer">#20347</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6535" target="_blank" rel="noopener noreferrer">!6535</a></li><li><code>timesInt2#</code> primop <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20374" target="_blank" rel="noopener noreferrer">#20374</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6531" target="_blank" rel="noopener noreferrer">!6531</a></li><li><code>ctz#/clz#/popCnt#</code> <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20376" target="_blank" rel="noopener noreferrer">#20376</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6532" target="_blank" rel="noopener noreferrer">!6532</a></li><li>missing rewrite rule to make the implementation of <code>nat2Word#</code> efficient <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/15547" target="_blank" rel="noopener noreferrer">#15547</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6847" target="_blank" rel="noopener noreferrer">!6847</a>]</li><li>rules for <code>Natural</code> <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/15821" target="_blank" rel="noopener noreferrer">#15821</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4837" target="_blank" rel="noopener noreferrer">!4837</a>]</li></ul></li><li>Allowed some ghc-bignum operations to inline to get better performance, while still managing to keep constant-folding working <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19641" target="_blank" rel="noopener noreferrer">#19641</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6677" target="_blank" rel="noopener noreferrer">!6677</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6696" target="_blank" rel="noopener noreferrer">!6696</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6306" target="_blank" rel="noopener noreferrer">!6306</a>]<!-- -->. There is some work left to do (cf <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20361" target="_blank" rel="noopener noreferrer">#20361</a>) but it is blocked by <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19313" target="_blank" rel="noopener noreferrer">#19313</a> which in turn is blocked by <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20554" target="_blank" rel="noopener noreferrer">#20554</a> which should be fixed soon (<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6865" target="_blank" rel="noopener noreferrer">!6865</a>, thanks Joachim!).</li><li>The ubiquitous <code>fromIntegral</code> function used to have many associated rewrite rules to make it fast (avoiding heap allocation of a passthrough Integer when possible) that were difficult to manage due to the combinatorial number of needed rules (<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19907" target="_blank" rel="noopener noreferrer">#19907</a>, <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20062" target="_blank" rel="noopener noreferrer">#20062</a>). We found a way to remove all these rules (<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5862" target="_blank" rel="noopener noreferrer">!5862</a>).</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="technical-debt--modularity">Technical debt &amp; modularity<a class="hash-link" href="#technical-debt--modularity" title="Direct link to heading">​</a></h2><ul><li>Made several component of the compiler independent of <code>DynFlags</code> (parsed command-line flags):<ul><li>TmpFS (dealing with temporary files) <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6186" target="_blank" rel="noopener noreferrer">!6186</a>]</li><li>Diagnostic options <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6043" target="_blank" rel="noopener noreferrer">!6043</a>]</li><li>Tracing functions <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5970" target="_blank" rel="noopener noreferrer">!5970</a>]</li><li>Logger <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4757" target="_blank" rel="noopener noreferrer">!4757</a>]</li><li>Logger &amp; Parser <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5845" target="_blank" rel="noopener noreferrer">!5845</a>]</li><li>Hooks <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4812" target="_blank" rel="noopener noreferrer">!4812</a>]</li></ul></li><li>Made the handling of “package imports” less fragile <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6586" target="_blank" rel="noopener noreferrer">!6586</a>]<!-- --> and refactored some code related to dependencies and recompilation avoidance <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6528" target="_blank" rel="noopener noreferrer">!6528</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6346" target="_blank" rel="noopener noreferrer">!6346</a>]<!-- -->.</li><li>Abstracted plugin related fields from HscEnv <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7175" target="_blank" rel="noopener noreferrer">!7175</a>]</li><li>Made a home-unit optional in several places <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7013/" target="_blank" rel="noopener noreferrer">!7013</a>]<!-- -->: the home-unit should only be required when compiling code, not when loading code (e.g. when loading plugins in cross-compilers <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/14335" target="_blank" rel="noopener noreferrer">#14335</a>).</li><li>Made GHC no longer expose the (wrong) selected ghc-bignum backend with <code>ghc --info</code>. ghc-bignum now exposes a backendName function for this purpose <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20495" target="_blank" rel="noopener noreferrer">#20495</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6903" target="_blank" rel="noopener noreferrer">!6903</a>]</li><li>Moved <code>tmpDir</code> from Settings to <code>DynFlags</code> <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6297/" target="_blank" rel="noopener noreferrer">!6297</a>]</li><li>Removed use of <code>unsafePerfomIO</code> in <code>getProgName</code> <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6137/" target="_blank" rel="noopener noreferrer">!6137</a>]</li><li>Refactored warning flags handling <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5815" target="_blank" rel="noopener noreferrer">!5815</a>]</li><li>Made assertions use normal functions instead of CPP <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5693" target="_blank" rel="noopener noreferrer">!5693</a>]</li><li>Made the interpreter more independent of the driver <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5627" target="_blank" rel="noopener noreferrer">!5627</a>]</li><li>Replaced <code>ptext . sLit</code> with <code>text</code> <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5625" target="_blank" rel="noopener noreferrer">!5625</a>]</li><li>Removed broken “dynamic-by-default” setting <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/16782" target="_blank" rel="noopener noreferrer">#16782</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5467" target="_blank" rel="noopener noreferrer">!5467</a>]</li><li>Abstracted some components from the compiler session state (<code>HscEnv</code>):<ul><li>unit-related fields into a new <code>UnitEnv</code>datatype <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5425" target="_blank" rel="noopener noreferrer">!5425</a>]</li><li><code>FinderCache</code> and <code>NameCache</code>[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4951" target="_blank" rel="noopener noreferrer">!4951</a>]</li><li>Loader state <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5287" target="_blank" rel="noopener noreferrer">!5287</a>]</li></ul></li><li>Removed the need for a home unit-id to initialize an external package state (EPS) <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5043" target="_blank" rel="noopener noreferrer">!5043</a>]</li><li>Refactored <code>-dynamic-too</code> handling <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19264" target="_blank" rel="noopener noreferrer">#19264</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4905" target="_blank" rel="noopener noreferrer">!4905</a>]</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="performance">Performance<a class="hash-link" href="#performance" title="Direct link to heading">​</a></h2><ul><li>Made <code>divInt#, modInt# and divModInt#</code> branchless and inlineable <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/18067" target="_blank" rel="noopener noreferrer">#18067</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19636" target="_blank" rel="noopener noreferrer">#19636</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/3229" target="_blank" rel="noopener noreferrer">!3229</a>]</li><li>Fixed Integral instances for Word8/16/32 and <code>showWord</code> to use <code>quotRemWordN</code> <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5891" target="_blank" rel="noopener noreferrer">!5891</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5846/" target="_blank" rel="noopener noreferrer">!5846</a>]</li><li>Improved performance of occurrence analysis <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19989" target="_blank" rel="noopener noreferrer">#19989</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5977" target="_blank" rel="noopener noreferrer">!5977</a>]</li><li>Fixed unnecessary pinned allocations in <code>appendFS</code> <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5989/" target="_blank" rel="noopener noreferrer">!5989</a>]</li><li>Added a rewrite rules for string literals:<ul><li>Concatenation of string literals <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20174" target="_blank" rel="noopener noreferrer">#20174</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/16373" target="_blank" rel="noopener noreferrer">#16373</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6259" target="_blank" rel="noopener noreferrer">!6259</a>]</li><li><code>(++) . unpackCString# ⇒ unpackAppendCString#</code> leading to a 15% reduction in compilation time on a specific example. <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6619" target="_blank" rel="noopener noreferrer">!6619</a>]</li><li>Compute SDoc literal size at compilation time <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19266" target="_blank" rel="noopener noreferrer">#19266</a>, <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4901" target="_blank" rel="noopener noreferrer">!4901</a>]</li></ul></li><li>Fix for Dwarf strings generated by the NCG that were unnecessarily retained in the FastString table <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6621" target="_blank" rel="noopener noreferrer">!6621</a>]</li><li>Worked on improving inlining heuristics by taking into account applied constructors at call sites <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20516" target="_blank" rel="noopener noreferrer">#20516</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6732" target="_blank" rel="noopener noreferrer">!6732</a>]<!-- -->. More work is needed though.</li><li>Fixed <a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20857" target="_blank" rel="noopener noreferrer">#20857</a> by making the Id cache for primops used more often <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7241" target="_blank" rel="noopener noreferrer">!7241</a>]</li><li>Replaced some avoidable uses of <code>replicateM . length</code> with more efficient code <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7198" target="_blank" rel="noopener noreferrer">!7198</a>]<!-- -->. No performance gain this time but the next reader of this code won’t have to wonder if fixing it could improve performance.</li><li>Made <code>exprIsCheapX</code> inline for modest but easy perf improvements <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7183" target="_blank" rel="noopener noreferrer">!7183</a>]</li><li>Removed an allocation in the code used to write text on a Handle (used by putStrLn, etc.) <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7160" target="_blank" rel="noopener noreferrer">!7160</a>]</li><li>Replaced inefficient list operations with more efficient <code>Monoid ([a],[b])</code> operations in the driver <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7069" target="_blank" rel="noopener noreferrer">!7069</a>]<!-- -->, leading to 1.9% reduction in compiler allocations in MultiLayerModules test.</li><li>Disabled some callstack allocations in non-debug builds <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6252/" target="_blank" rel="noopener noreferrer">!6252</a>]</li><li>Made file copy in GHC more efficient <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5801" target="_blank" rel="noopener noreferrer">!5801</a>]</li><li>Miscellaneous pretty-printer enhancements <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5226" target="_blank" rel="noopener noreferrer">!5226</a>]</li><li>Type tidying perf improvements with strictness <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/14738" target="_blank" rel="noopener noreferrer">#14738</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4892" target="_blank" rel="noopener noreferrer">!4892</a>]</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="rts">RTS<a class="hash-link" href="#rts" title="Direct link to heading">​</a></h2><ul><li>Fixed issues related to the RTS’s ticker<ul><li>Fixed some races <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/18033" target="_blank" rel="noopener noreferrer">#18033</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20132" target="_blank" rel="noopener noreferrer">#20132</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6201" target="_blank" rel="noopener noreferrer">!6201</a>]</li><li>Made the RTS open the file descriptor for its timer (<code>timerfd</code>) on Linux synchronously to avoid weird interactions with Haskell code manipulating file descriptors <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20618" target="_blank" rel="noopener noreferrer">#20618</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6902" target="_blank" rel="noopener noreferrer">!6902</a>]<!-- -->.</li></ul></li><li>Moved GHC’s global variables used to manage Uniques into the RTS to fix plugin issues <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19940" target="_blank" rel="noopener noreferrer">#19940</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5900" target="_blank" rel="noopener noreferrer">!5900</a>]</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="build-system--ci">Build system / CI<a class="hash-link" href="#build-system--ci" title="Direct link to heading">​</a></h2><ul><li>Fixed Hadrian output to display warnings and errors after the multi screen long command lines <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20490" target="_blank" rel="noopener noreferrer">#20490</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/6690" target="_blank" rel="noopener noreferrer">!6690</a>]</li><li>Avoided the installation of a global <code>platformConstants</code> file; made GHC load constants from the RTS unit instead, allowing it to be reinstalled with different constants <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5427" target="_blank" rel="noopener noreferrer">!5427</a>]</li><li>Made <code>deriveConstants</code> output its file atomically <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/19684" target="_blank" rel="noopener noreferrer">#19684</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5520" target="_blank" rel="noopener noreferrer">!5520</a>]</li><li>Made compression with <code>xz</code> faster on CI <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/5066" target="_blank" rel="noopener noreferrer">!5066</a>]</li><li>Don’t build extra object with <code>-no-hs-main</code> <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/18938" target="_blank" rel="noopener noreferrer">#18938</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4974" target="_blank" rel="noopener noreferrer">!4974</a>]</li><li>Add <code>hi-boot</code> dependencies with <code>ghc -M</code> <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/14482" target="_blank" rel="noopener noreferrer">#14482</a>,<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4876" target="_blank" rel="noopener noreferrer">!4876</a>]</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="misc">Misc<a class="hash-link" href="#misc" title="Direct link to heading">​</a></h2><ul><li>Stack: fixed interface reading in <code>hi-file-parser</code> to support GHC 8.10 and 9.0 <!-- -->[<a href="https://github.com/commercialhaskell/hi-file-parser/pull/2" target="_blank" rel="noopener noreferrer">PR</a>, <a href="https://github.com/commercialhaskell/stack/issues/5134" target="_blank" rel="noopener noreferrer">Stack#5134</a>]</li><li>Enhanced pretty-printing of coercions in Core dumps <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/4856" target="_blank" rel="noopener noreferrer">!4856</a>]</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about 2021 GHC update" href="/2022-03-01-2021-ghc-update"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-02-01-ghc-january-2022-update">GHC January 2022 update</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-02-01T00:00:00.000Z" itemprop="datePublished">February 1, 2022</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Hopefully 2022 should be the year GHC will get a JavaScript backend without relying on GHCJS. This month the team has been busy planning the work that needs to be done to get there!</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="cross-compilation">Cross-compilation<a class="hash-link" href="#cross-compilation" title="Direct link to heading">​</a></h2><ul><li>GHCJS has been <a href="https://github.com/ghcjs/ghc/tree/ghc-8.10-ghcjs" target="_blank" rel="noopener noreferrer">updated</a> to reduce the gap with GHC 8.10.7 codebase to the point that GHC’s build system is used to build GHCJS</li><li>Internal work planning for the integration of GHCJS into GHC</li><li>A different approach to load plugins into cross-compilers has been implemented <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/20964" target="_blank" rel="noopener noreferrer">#20964</a>, <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7377" target="_blank" rel="noopener noreferrer">!7377</a>]</li><li>GHCJS has been exercised to showcase compilation of some Plutus applications</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="modularity">Modularity<a class="hash-link" href="#modularity" title="Direct link to heading">​</a></h2><ul><li>A few “subsystems” of GHC have been made more modular and reusable by making them independent of the command-line flags (<code>DynFlags</code>) <!-- -->[<a href="https://gitlab.haskell.org/ghc/ghc/-/issues/17957" target="_blank" rel="noopener noreferrer">#17957</a>, <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7158" target="_blank" rel="noopener noreferrer">!7158</a>, <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7199" target="_blank" rel="noopener noreferrer">!7199</a>, <a href="https://gitlab.haskell.org/ghc/ghc/-/merge_requests/7325" target="_blank" rel="noopener noreferrer">!7325</a>]<!-- -->. This work resulted in a 10% reduction in call sites to <code>DynFlags</code> and has now removed all references to <code>DynFlags</code> up to the <code>CoreToStg</code> pass, which is almost the entire backend of GHC.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="performance">Performance<a class="hash-link" href="#performance" title="Direct link to heading">​</a></h2><ul><li>Jeffrey wrote a new HF <a href="https://github.com/haskellfoundation/tech-proposals/pull/26" target="_blank" rel="noopener noreferrer">proposal</a> about writing a Haskell Optimization handbook and has started working on it</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc-update">ghc-update</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHC January 2022 update" href="/2022-02-01-ghc-january-2022-update"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/iog_eng" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">IOG Blog</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 IOG Engineering, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ddd8cd56.js"></script>
<script src="/assets/js/main.c7a1df79.js"></script>
</body>
</html>