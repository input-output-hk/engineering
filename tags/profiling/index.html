<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<title data-react-helmet="true">2 posts tagged with &quot;profiling&quot; | IOG Engineering</title><meta data-react-helmet="true" property="og:title" content="2 posts tagged with &quot;profiling&quot; | IOG Engineering"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://engineering.iog.io/tags/profiling"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://engineering.iog.io/tags/profiling"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/tags/profiling" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/tags/profiling" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.10ad4647.css">
<link rel="preload" href="/assets/js/runtime~main.5bcc4665.js" as="script">
<link rel="preload" href="/assets/js/main.3c80257e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/iohk-logo.png" alt="IOG" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/iohk-logo-inverted.png" alt="IOG" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Recent</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">🌜</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">🌞</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-11-16-ghc-update">IOG GHC Update #20</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-10-26-ghc-update">IOG GHC Update #19</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-10-25-internship">Internship in GHC at IOG</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-10-05-ghc-update">IOG GHC Update #18</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-09-14-ghc-update">IOG GHC Update #17</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-08-24-ghc-update">IOG GHC Update #16</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-08-03-ghc-update">IOG GHC Update #15</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-07-13-ghc-update">IOG GHC Update #14</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-06-29-ghc-update">IOG GHC Update #13</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-06-28-p2p">Unveiling Cardano&#x27;s Dynamic P2P: a leap forward in decentralization</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-06-15-ghc-update">IOG GHC Update #12</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-06-01-ghc-update">IOG GHC Update #11</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-05-18-ghc-update">IOG GHC Update #10</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-05-04-ghc-update">IOG GHC Update #9</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-04-21-stacks-in-the-js-backend">Stacks in the JavaScript Backend</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-04-20-ghc-update">IOG GHC Update #8</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-04-14-io-sim-annoucement">IOSim on Hackage!</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-04-06-ghc-update">IOG GHC Update #7</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-03-23-ghc-update">IOG GHC Update #6</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2023-03-09-ghc-update">IOG GHC Update #5</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>2 posts tagged with &quot;profiling&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-05-17-javascript-template-haskell-external-interpreter">JavaScript, Template Haskell and the External Interpreter</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-05-17T00:00:00.000Z" itemprop="datePublished">May 17, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>At IOG DevX we have been working on integrating various bits of GHCJS into GHC, with the goal of having a fully working JavaScript backend for the 9.6 release. For some parts this has mostly consisted of an update of the code to use the newer GHC API and dependencies. Other bits, like the Template Haskell runner, need more work.</p><p>This post gives an overview of the existing approaches for running Template Haskell in GHC based cross compilers and our plan for the JavaScript backend. Hopefully we can revisit this topic once all the work has been done, and see what exactly we ended up with.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-ghcjs-template-haskell-runner">The GHCJS Template Haskell Runner<a class="hash-link" href="#the-ghcjs-template-haskell-runner" title="Direct link to heading">​</a></h2><p>When I first worked on Template Haskell (TH) support for GHCJS, there was no mechanism to combine Template Haskell with cross compilation in GHC.</p><p>Normally, Template Haskell is run by loading library code directly into the GHC process and using the bytecode interpreter for the current module. Template Haskell can directly access GHC data structures through the <code>Q</code> monad. Clearly this would not be possible for GHCJS: We only have JavaScript code available for the libraries and the organization of the JavaScript data structures is very different from what GHC uses internally.</p><p>So I had to look for an alternative. Running Template Haskell consists of two parts:</p><ol><li>loading/executing the TH code</li><li>handling compiler queries from the TH code, for example looking up names or types</li></ol><p>Running the TH code can be done by first compiling the Haskell to JavaScript and then using the JavaScript <code>eval</code> feature.</p><p>Template Haskell code can query the compiler using the <code>Quasi</code> typeclass. I noticed that none of the methods required passing around functions or complicated data structures, so it would be possible to serialize each request and response and send it to another process.</p><p>So I went ahead and implemented this approach with a script <code>thrunner.js</code> to load and start the code in a node.js server, a message type with serialization, and a new instance of the <code>Quasi</code> typeclass to handle the communication with the compiler via the messages. This is still what&#x27;s in use by GHCJS to this day. Every time GHCJS encounters Template Haskell, it starts a <code>thrunner</code> process and the compiler communicates with it over a pipe.</p><p>After starting <code>thrunner.js</code> GHCJS sends the Haskell parts of the Template Haskell runnner to the script. This includes the runtime system and the implementation of the <code>Quasi</code> typeclass and communication protocol. After that, the TH session starts. A typical TH session looks as follows:</p><table><thead><tr><th align="left">Compiler</th><th align="left">thrunner</th></tr></thead><tbody><tr><td align="left"><code>RunTH THExp &lt;js code&gt; &lt;source location&gt;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>LookupName (Just &lt;name-string&gt;)</code></td></tr><tr><td align="left"><code>LookupName&#x27; (Just &lt;name&gt;)</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>Reify &lt;name&gt;</code></td></tr><tr><td align="left"><code>Reify&#x27; &lt;name-info&gt;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>RunTH&#x27; &lt;result&gt;</code></td></tr><tr><td align="left"><code>RunTH THDec &lt;js code&gt; &lt;source location&gt;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>AddTopDecls &lt;declarations&gt;</code></td></tr><tr><td align="left"><code>AddTopDecls&#x27;</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>RunTH&#x27; &lt;result&gt;</code></td></tr><tr><td align="left"><code>FinishTH True</code></td><td align="left"></td></tr><tr><td align="left"></td><td align="left"><code>FinishTH&#x27; &lt;memory-consumption&gt;</code></td></tr></tbody></table><p>Each message is followed up by a corresponding reply. For example, a <code>LookupName&#x27;</code> response follows a <code>LookupName</code> request and a <code>RunTH</code> message will eventually generate a <code>RunTH&#x27;</code> result. The first <code>RunTH</code> message contains the compiled JavaScript for the Template Haskell code, along with its dependencies. Each subsequent <code>RunTH</code> only includes dependencies that have not already been sent.</p><p>The <code>thrunner</code> process stays alive during the compilation of at least an entire module, allowing for persistent state (<code>putQ</code>/<code>getQ</code>).</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-ghc-external-interpreter">The GHC External Interpreter<a class="hash-link" href="#the-ghc-external-interpreter" title="Direct link to heading">​</a></h2><p>If we build a Haskell program with (cost centre) profiling, the layout of our data structures changes to include bookkeeping of cost centre information. This means that we need a special profiling runtime system to run this code.</p><p>What can we do if we want to run our profiled build in GHCi or Template Haskell? We cannot load compiled profiling libraries into GHC directly; its runtime system expects non-profiled code. We could use a profiled version of the compiler itself, but this would make all compilation very slow. Or we could somehow separate the profiled code of our own program from the non-profiled code in the compiler.</p><p>This was Simon Marlow&#x27;s motivation for adapting the GHCJS <code>thrunner</code> approach, integrating in GHC and extending it it to support GHCi and bytecode. This functionality can be activated with the <code>-fexternal-interpreter</code> flag and has been available since GHC version 8.0.1. When the external interpreter is activated, GHC starts a separate process, <code>iserv</code> (customizable with the <code>-pgmi</code> flag) which has the role analogous to the <code>thrunner</code> script for GHCJS.</p><p>Over time, the <code>iserv</code> code has evolved with GHC and has been extended to include more operations. By now, there are quite a few differences in features:</p><table><thead><tr><th align="left">Feature</th><th align="center">thrunner</th><th align="center">iserv</th></tr></thead><tbody><tr><td align="left">Template Haskell support</td><td align="center">yes</td><td align="center">yes</td></tr><tr><td align="left">GHCi</td><td align="center">no</td><td align="center">yes</td></tr><tr><td align="left">Debugger</td><td align="center">no</td><td align="center">yes</td></tr><tr><td align="left">Bytecode</td><td align="center">no</td><td align="center">yes</td></tr><tr><td align="left">Object code</td><td align="center">through pipe</td><td align="center">from file</td></tr><tr><td align="left">Object code linking</td><td align="center">compiler</td><td align="center">iserv process</td></tr></tbody></table><p><code>thrunner</code> is not quite as complete as <code>iserv</code>: It lacks GHCi and the debugger, and there is no bytecode support. But these features are not essential for basic Template Haskell.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="proxies-and-bytecodes">Proxies and Bytecodes<a class="hash-link" href="#proxies-and-bytecodes" title="Direct link to heading">​</a></h2><p>We have now seen two systems for running Template Haskell code outside the compiler process: The original GHCJS <code>thrunner</code> and the extended GHC <code>iserv</code>.</p><p>Clearly it isn&#x27;t ideal to have multiple &quot;external interpreter&quot; systems in GHC, therefore we plan to switch from <code>thrunner</code> to <code>iserv</code> for the upcoming JavaScript GHC backend. We don&#x27;t need the debugger or GHCi support yet, but we do need to adapt to other changes in the infrastructure. So what does this mean in practice?</p><p>The biggest change is that we have to rework the linker: <code>thrunner</code> does not contain any linking logic by itself: GHCJS compiles everything to JavaScript and sends compiled code to the <code>thrunner</code> process, ready to be executed. In contrast, <code>iserv</code> has a loader for object and archive files. When dependencies need to be loaded into the interpreter, GHC just gives it the file name.</p><p>Another change is using the updated message types. In the <code>thrunner</code> session example above we could see that each message is paired with a response. For example a <code>RunTH&#x27;</code> response always follows a <code>RunTH</code> message, with possibly other messages in between. <code>iserv</code> has an interesting approach for the <code>Message</code> datatype: Instead of having pairs of data constructors for each message and its response, <code>iserv</code> has a GADT <code>Message a</code>, where the <code>a</code> type parameter indicates the expected response payload for each data constructor.</p><p>During development of the <code>thrunner</code> program it turned out to be very useful to save and replay Template Haskell sessions for debugging purposes. We&#x27;d like to do this again, but now saving the message in a readable/writable format. Since we&#x27;re dealing with JavaScript, JSON appears to be the obvious choice.</p><p>Our plan is to have an <code>iserv</code> implementation that consists of a JavaScript part that runs in node.js and a proxy process to handle communication with GHC. The proxy process converts the messages between GHC&#x27;s own (<code>binary</code> based) serialization format and JSON. The proxy process is relatively simple, but it does reveal one downside of the new GADT based message types: A proxy is stateful. We must always know which message we have sent to convert the response back from JSON to <code>binary</code>.</p><p>It&#x27;s not yet known whether we will implement a full bytecode interpreter. We expect it to become clear during implementation whether we can get away without one early on.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>We have seen how Template Haskell and GHCi code can be run outside the GHC process for profiling or cross compiling, with both the <code>thrunner</code> approach in GHCJS and the newer <code>iserv</code> in GHC.</p><p>We at IOG DevX are working on switching to the <code>iserv</code> infrastructure for the upcoming GHC JavaScript backend, which involves a substantial rewrite, mainly because of differences in linking. This is a work in progress, and we intend to revisit this topic in another blog post once the final design has been implemented.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghcjs">ghcjs</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/tooling">tooling</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/profiling">profiling</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about JavaScript, Template Haskell and the External Interpreter" href="/2022-05-17-javascript-template-haskell-external-interpreter"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-05-02-setup-ext-stg-interp">Setting up Csaba&#x27;s External STG Interpreter</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-05-02T00:00:00.000Z" itemprop="datePublished">May 2, 2022</time> · <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="table-of-contents">Table of Contents<a class="hash-link" href="#table-of-contents" title="Direct link to heading">​</a></h2><ul><li><a href="#orgfeb334e">Making sense of the project</a></li><li><a href="#org1d461dc">Building a working external STG interpreter</a><ul><li><a href="#orgb670539">ghc.nix</a></li><li><a href="#orgbb3f1d5">Building ghc-wpc</a></li><li><a href="#org9ef4bc5">Building the stg tooling</a></li></ul></li><li><a href="#org4a2eaf9">Building the external-stg-interpreter</a></li><li><a href="#org1d34a2e">Linking the external-stg-interpreter</a></li><li><a href="#org2daa4b8">The whole setup process on a demo</a></li><li><a href="#org8193a1a">Summary</a><ul><li><a href="#org940ba90">File Descriptions</a></li><li><a href="#org8e9f409">Step-by-Step guide for running the interpreter on your code</a></li></ul></li></ul><p>Haskell is a great language camouflaged by lackluster tooling. This situation
has led to well-known problems (who could forget Cabal hell?). A less discussed
problem is what I will call the <!-- -->“<!-- -->Black-box syndrome<!-- -->”<!-- -->: It is hard to
know <em>exactly</em> what the memory representation and runtime performance of my
Haskell programs are<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>. Now black-box syndrome is not <em>only</em> a problem,
it is also one of the nice features in the language since like all good
abstractions it elides things I<!-- -->’<!-- -->d rather not care about, at least most of
the time. In other words, I am happy I don<!-- -->’<!-- -->t have to do manual memory
manipulation!</p><p>However, when I have my optimization hat on, I run face first into black-box syndrome. The crux of the problem is a tension between the need for observation during performance engineering and optimization, and the need to ship fast code. During development we want to be able to open up a system, see exactly how it is working, make tweaks, package it back up and test again. I want to be able to answer questions like <!-- -->“<!-- -->Why is my executable this size?<!-- -->”<!-- -->, <!-- -->“<!-- -->Which code is a hot loop?<!-- -->”<!-- -->, or <!-- -->“<!-- -->When does my code do direct, known or unknown function calls?<!-- -->”<!-- -->.</p><p>In order to answer these questions we need the ability to observe <em>every part of that system as the machine experiences it</em>, without this ability we have no way to make progress other than test, change some code, compile and test again in an ad-hoc manner. And therein lies the problem, most Haskell tooling is insufficient to provide the observability that we would like, instead the tooling often expects and requires us to make source code changes to our program or even recompile all of our libraries and code for a profiling way. This leads to the idea and <em>the expectation</em> in the Haskell community that Haskell programs are hard to optimize because the barrier to entry for optimization has artificially increased.</p><p><a href="https://www.patreon.com/csaba_hruska" target="_blank" rel="noopener noreferrer">Csaba Hruska</a> has recently been making headway in this area with his work on the <a href="https://youtu.be/iXhh0NSR67k" target="_blank" rel="noopener noreferrer">GRIN</a> compiler and an external STG interpreter. His STG interpreter (and patched ghc) exactly solve these problems and he has demonstrated dumping the entire call graph of large Haskell projects, filter to hot loops and finding unknown function calls in these graphs. If you haven<!-- -->’<!-- -->t seen his <a href="https://www.youtube.com/watch?v=wt6iCgYmVGA&amp;t=2054s" target="_blank" rel="noopener noreferrer">demo</a> be sure to watch it, it is well worth your time.</p><p>This post is the first in a new blog series. In this blog series we<!-- -->’<!-- -->re going to kick the tires on the external STG interpreter see what it can do, and what we can uncover in some popular libraries by using it. In particular, I<!-- -->’<!-- -->m interested in running it on projects I<!-- -->’<!-- -->ve previously optimized<!-- -->—<!-- -->such as ghc itself, containers, unordered-containers<!-- -->—<!-- -->using the standard methods: ticky-ticky profiling, prof, flamegraphs, heap profiling, ghc-debug, cachegrind etc. This post, however, will be focused on setting up the patched ghc and interpreter on a NixOS system. My goals are threefold:</p><ol><li>Give an overview of the project and project layout to lower barrier to entry for the system.</li><li>Give step by step instructions on setting up the interpreter on a nix-based system and provide a forked github repo for nix users. This should allow nix users to just <code>git clone foo</code> and <code>nix-build</code> (spoiler: it won<!-- -->’<!-- -->t be that easy but still not hard.)</li><li>Popularize Csaba<!-- -->’<!-- -->s project! It is a refreshing take on Haskell optimization and compilation.</li></ol><a id="orgfeb334e"></a><h1>Making sense of the project</h1><p>The external STG interpreter is part of the <a href="https://github.com/grin-compiler" target="_blank" rel="noopener noreferrer">GRIN compiler</a> project. We are not doing anything with the GRIN compiler (yet!) and so we are only interested in <a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project" target="_blank" rel="noopener noreferrer">The GHC whole compiler project</a>. The whole-compiler-project has several sub-projects that we<!-- -->’<!-- -->ll be building and using directly:</p><ul><li><a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/tree/master/external-stg" target="_blank" rel="noopener noreferrer">external-stg</a>: This subproject provides utilites we<!-- -->’<!-- -->ll be using, in particular <code>mkfullpak</code></li><li><a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/tree/master/external-stg-interpreter" target="_blank" rel="noopener noreferrer">external-stg-interpreter</a>: This is the actual STG interpreter. The good news is that this is independent of the rest of the project and can be built just like a regular Haskell executable</li><li><a href="https://github.com/grin-compiler/ghc-wpc/tree/b51ab235f5c07caa5eb3dd3b40487f67f50fb838" target="_blank" rel="noopener noreferrer">ghc-wpc</a>: This is a fork of <code>ghc-8.10.x</code> (I<!-- -->’<!-- -->m not sure exactly which version it forks to be honest) which we must build in order to use the external STG interpreter. Ghc-wpc serves as a frontend for the external-stg-interpreter.</li></ul><a id="org1d461dc"></a><h1>Building a working external STG interpreter</h1><p>The external STG interpreter can be built like any regular haskell executable. But in order to use the interpreter we have to build <code>ghc-wpc</code>. <code>ghc-wpc</code> is necessary because it serves as a frontend for the STG interpreter. It compiles a Haskell program like normal and then dumps an enriched STG IR to file. This file is then run through a utility <code>gen-exe</code> (gen-exe is an executable built in the <a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/tree/master/external-stg-compiler" target="_blank" rel="noopener noreferrer">external-stg-compiler</a> sub-project) which picks up the compilation pipeline from the STG IR and creates an executable like we would expect from a normal compilation pipeline.</p><p>The major difference between this process and the usual compiler pipeline is that <code>ghc-wpc</code> leaves enough compiler information on disk for the rest of the tooling to consume, namely, in files with a <code>*.o_stgbin</code> (this is STG IR generated at compile time), and <code>*.o_stgapp</code> (project linker and dependency information) extension. Thus, once we build this custom ghc version we can use it to build the source code we wish to analyze and begin our optimization work.</p><p>For the rest of this tutorial I<!-- -->’<!-- -->ll be referencing my <a href="https://github.com/doyougnu/ghc-whole-program-compiler-project" target="_blank" rel="noopener noreferrer">fork</a> of the <code>ghc-whole-compiler-project</code> that includes everything you need if you want to follow along, including <code>.nix</code> files for creating a <code>nix-shell</code> which will prepare a suitable environment to run the entire toolchain.</p><a id="orgb670539"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="ghcnix">ghc.nix<a class="hash-link" href="#ghcnix" title="Direct link to heading">​</a></h2><p>The usual way to build ghc using a nix based system is with the <a href="https://github.com/alpmestan/ghc.nix" target="_blank" rel="noopener noreferrer">ghc.nix</a> project. Ghc.nix provides a <code>default.nix</code> with a suitable environment to run hadrian and build ghc. For <code>ghc-wpc</code> we<!-- -->’<!-- -->ll need some special packages, and we need our boot compiler to be <em>exactly</em> <code>ghc-8.3.3</code>. The custom <code>ghc.nix</code> file is included in my fork, I<!-- -->’<!-- -->ve taken the liberty to pin the nixpkgs to the right version for <code>ghc-8.3.3</code>. So let<!-- -->’<!-- -->s begin:</p><p>Clone the forked repo:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/doyougnu/ghc-whole-program-compiler-project.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ghc-whole-program-compiler-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tree -L </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── dist-newstyle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── external-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── external-stg-compiler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── external-stg-interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── ghc.nix.wpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── ghc-wpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── lambda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── mod-pak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── shell.nix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── stack.yaml.lock</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You<!-- -->’<!-- -->ll find the patched <code>ghc.nix</code> included (<code>ghc.nix.wpc</code>) and a <code>shell.nix</code> for a <code>nix-shell</code>. The <code>shell.nix</code> file simply references <code>ghc.nix.wpc/default.nix</code> with the appropriate options:</p><div class="codeBlockContainer_I0IT language-nix theme-code-block"><div class="codeBlockContent_wNvx nix"><pre tabindex="0" class="prism-code language-nix codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat shell.nix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import (./ghc.nix.wpc/default.nix) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">useClang = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">withHadrianDeps = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">withIde   = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">withLlvm  = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><a id="orgbb3f1d5"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-ghc-wpc">Building ghc-wpc<a class="hash-link" href="#building-ghc-wpc" title="Direct link to heading">​</a></h2><p>Now we can enter a nix-shell and build <code>ghc-wpc</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">pwd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/doyougnu/programming/haskell/ghc-whole-program-compiler-project</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ nix-shell shell.nix  </span><span class="token comment" style="color:#999988;font-style:italic"># or just nix-shell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trace: checking </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> /home/doyougnu/programming/haskell/ghc-whole-program-compiler-project/hadrian/hadrian.cabal is present:  no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Recommended ./configure arguments </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">found </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$CONFIGURE_ARGS</span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or use the configure_ghc </span><span class="token builtin class-name">command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sznfxigwvrvn6ar3nz3f0652zsld9xqj-gmp-6.2.0-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/447im4mh8gmw85dkrvz3facg1jsbn6c7-gmp-6.2.0/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/84g84bg47xxg01ba3nv0h418v5v3969n-ncurses-6.1-20190112-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/xhhkr936b9q5sz88jp4l29wljbbcg39k-ncurses-6.1-20190112/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-dwarf-unwind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell/ghc-whole-program-compiler-project</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we need to <code>cd</code> into <code>ghc-wpc</code> and tweak the hadrian build.</p><p><strong>MAJOR CONSTRAINT: You must build ghc-wpc with hadrian/build-stack</strong>, if you build in any other way you<!-- -->’<!-- -->ll run into shared object errors, see this <a href="https://github.com/grin-compiler/ghc-whole-program-compiler-project/issues/4" target="_blank" rel="noopener noreferrer">ticket</a> for details.</p><p>So in order to build <code>ghc-wpc</code> with stack we<!-- -->’<!-- -->ll have to tweak the <code>stack.yaml</code> file. <strong>You must do this since it is not included in the fork</strong>:</p><p>Quick side note: To make the formatting nicer I truncate
<code>nix-shell:~/foo/bar/baz/ghc-whole-program-compiler-project</code> to just <code>...</code>, so
<code>nix-shell:.../ghc-wpc</code> is equivalent to
<code>~/path/to/ghc-whole-compiler-project/ghc-wpc</code>.</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ghc-wpc/hadrian/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc/hadrian</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resolver: lts-15.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- </span><span class="token string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- </span><span class="token string" style="color:#e3116c">&#x27;GHC-Cabal&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">system-ghc: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nix:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   enable: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   shell-file: </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/shell.nix</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The changes are: (1) tell <code>stack</code> we are using <code>nix</code>, and (2) reference the <code>shell.nix</code> file which points to <code>ghc.wpc.nix</code> at the root of the project, i.e., <code>ghc-whole-program-compiler-project/shell.nix</code>.</p><p>Now we should be able to begin our build, return to the root of <code>ghc-wpc</code> and run the following:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc/hadrian</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./boot </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> ./configure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ hadrian/build-stack -j</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>and go get some coffee since this will take some time. Once it finishes you should have the <code>ghc-wpc</code> binary in <code>_build/stage1/bin</code></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./ghc-wpc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l _build/stage1/bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">8592</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1843752</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 ghc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">11082</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 ghc.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">660128</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:50 ghc-pkg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">9977</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:50 ghc-pkg.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4624680</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 haddock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">16883</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain">:01 haddock.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">49344</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:25 hp2ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">2504</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:25 hp2ps.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">716440</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">9959</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hpc.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">738544</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hsc2hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">10264</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35 hsc2hs.dyn_o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">58384</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:34 runghc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">8864</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:34 runghc.dyn_o_ghc_stgapp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that this build dumped <code>*.&lt;way&gt;_o_ghc_stgapp</code> files!</p><a id="org9ef4bc5"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-the-stg-tooling">Building the stg tooling<a class="hash-link" href="#building-the-stg-tooling" title="Direct link to heading">​</a></h2><p>Now that we have a working <code>ghc-wpc</code> we need to build the rest of the project by pointing <code>stack</code> to the <code>ghc-wpc</code> binary in <code>ghc-wpc/_build/stage1/bin</code>. That is, we must change the <code>ghc-whole-program-compiler-project/stack.yaml</code> file:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell/ghc-whole-program-compiler-project</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resolver: lts-16.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allow-newer: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;external-stg-compiler&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;external-stg&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ghc-options:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$everything</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> -fno-stgbin -fno-stgapp -optcxx-std</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">c++17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra-deps:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - async-pool-0.9.1@sha256:4015140f896c3f1652b06a679b0ade2717d05557970c283ea2c372a71be2a6a1,1605</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - souffle-haskell-1.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - zip-1.7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># use custom ext-stg whole program compiler GHC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compiler:     ghc-8.11.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skip-ghc-check: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nix:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enable: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># use local GHC (for development)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">system-ghc: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra-path:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - /home/doyougnu/programming/haskell/ghc-whole-program-compiler-project/ghc-wpc/_build/stage1/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># DEBUG INFO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#dump-logs: all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#build:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  keep-tmp-files: true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#  cabal-verbose: true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The changes are: (1) set <code>compiler: ghc-8.11.0</code> (the <code>ghc-wpc</code> fork), (2) set <code>skip-ghc-check: true</code> so that stack doesn<!-- -->’<!-- -->t complain about the ghc version, (3) set <code>nix.enable: false</code>, confusingly if you leave this as true then stack will try to use <code>nixpkgs</code> to get a ghc binary, but we want it to use our local binary so we disable this even though we<!-- -->’<!-- -->ll still be in our original nix-shell (4) set <code>system-path: true</code> to tell stack we will be using a ghc we have on our system, and finally (5) set <code>extra-path: &lt;path-to-ghc-wpc-binary&gt;</code>.</p><p>Now we can run stack and install the stg tooling:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ stack --stack-root </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain">/.stack-root </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trouble loading CompilerPaths cache: UnliftIO.Exception.throwString called with:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Compiler </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> metadata mismatch, ignoring cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Called from:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throwString </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">src/Stack/Storage/User.hs:277:8 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> stack-2.7.5-9Yv1tjrmAU3JiZWCo86ldN:Stack.Storage.User</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Ignoring tagged</span><span class="token string" style="color:#e3116c">&#x27;s bounds on template-haskell (&gt;=2.8 &amp;&amp; &lt;2.17); using template-haskell-2.17.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">WARNING: Ignoring aeson&#x27;</span><span class="token plain">s bounds on template-haskell </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">2.9</span><span class="token plain">.0.0 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">2.17</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> using template-haskell-2.17.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Ignoring th-abstraction</span><span class="token string" style="color:#e3116c">&#x27;s bounds on template-haskell (&gt;=2.5 &amp;&amp; &lt;2.17); using template-haskell-2.17.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">WARNING: Ignoring unliftio-core&#x27;</span><span class="token plain">s bounds on base </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">4.5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">4.14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> using base-4.14.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reason: allow-newer enabled.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Ignoring souffle-haskell&#x27;s bounds on megaparsec </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">7.0</span><span class="token plain">.5 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> using megaparsec-8.0.0.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stack --stack-root </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable builtin class-name" style="color:#36acaa">pwd</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain">/.stack-root </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token comment" style="color:#999988;font-style:italic"># bunch of output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copied executables to /home/doyougnu/.local/bin:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- dce-fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ext-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-exe2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-obj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- gen-obj2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- mkfullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- show-ghc-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Installation path /home/doyougnu/.local/bin not found on the </span><span class="token environment constant" style="color:#36acaa">PATH</span><span class="token plain"> environment variable.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can add <code>~/.local/bin</code> to your <code>PATH</code> if you want, I<!-- -->’<!-- -->ll just be directly referencing these binaries as we go.</p><a id="org4a2eaf9"></a><h1>Building the external-stg-interpreter</h1><p>We are almost all done, all that is left is to build the external-stg-interpreter and run a small script that links everything together into a shared object for the interpreter. So:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> external-stg-interpreter/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ stack </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.  </span><span class="token comment" style="color:#999988;font-style:italic"># bunch of output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copied executables to /home/doyougnu/.local/bin:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ext-stg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ext-stg-interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- mkfullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Installation path /home/doyougnu/.local/bin not found on the </span><span class="token environment constant" style="color:#36acaa">PATH</span><span class="token plain"> environment variable.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we have our <code>ext-stg-interpreter</code> built! There are a few caveats I want to point out here. I<!-- -->’<!-- -->ve modified <code>ghc-whole-program-compiler-project/external-stg-interpreter/stack.yaml</code> to load the right packages and use nix:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> stack.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resolver: lts-16.13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&#x27;external-stg&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra-deps:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - souffle-haskell-2.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - primitive-0.7.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - zip-1.7.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nix:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enable: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  packages: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> zlib, libffi, pkg-config, </span><span class="token function" style="color:#d73a49">bzip2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice the <code>nix:</code> block. We could have just as easily built this using <code>nix</code> directly or using our <code>shell.nix</code> file.</p><a id="org1d34a2e"></a><h1>Linking the external-stg-interpreter</h1><p>The only task left is to link into a shared object library called
<code>libHSbase-4.14.0.0.cbits.so</code>. To do that we need to use the script called, <code>c</code>,
in <code>ghc-whole-program-compiler-project/external-stg-interpreter/data</code>. This
script is a bit of a hack, it generates the shared object file so that we can link the symbols requested by the C
FFI in <code>base</code>, but it populates those functions with our replacements, which do absolutely nothing. For example, we supply a fake garbage collect:</p><div class="codeBlockContainer_I0IT language-c theme-code-block"><div class="codeBlockContent_wNvx c"><pre tabindex="0" class="prism-code language-c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// in .../external-stg-interpreter/data/cbits.so-script/c-src/fake_rts.c</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">performGC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">performMajorGC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This works because we won&#x27;t be using the runtime system at all, we&#x27;ll be using
the external STG interpreter instead, however we still need to provide these
symbols in order to link. *<strong>*MAJOR NOTE: this file must be next to any
<!-- -->*<!-- -->.fullpak file you<!-- -->’<!-- -->ll be running the interpreter on**</strong> or else
you<!-- -->’<!-- -->ll get an undefined symbol error during linking, for example:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cbits.so-script  ghc-rts-base.fullpak  minigame-strict.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### notice no .so file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ~/.local/bin/ext-stg-interpreter ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ext-stg-interpreter: user error </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dlopen: ./libHSbase-4.14.0.0.cbits.so: cannot </span><span class="token function" style="color:#d73a49">open</span><span class="token plain"> shared object file: No such </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> or directory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## we error&#x27;d out because it was missing, also</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## if you get this error then you have an old cbits.so file and need to rerun the c script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ~/.local/bin/ext-stg-interpreter ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ext-stg-interpreter: user error </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dlopen: ./libHSbase-4.14.0.0.cbits.so: undefined symbol: getProcessElapsedTime</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To link the interpreter we need to run <code>c</code> in the <code>data/cbits.so-script</code> sub-folder:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> data/cbits.so-script/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ar  c  cbits-rts.dyn_o  c-src  libHSbase-4.14.0.0.cbits.so  stub-base.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ./c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> ar/libHSbase-4.14.0.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSbindings-GLFW-3.3.2.0-Jg9TvsfYUZwD0ViIP0H2Tz-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSbytestring-0.10.9.0-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHScriterion-measurement-0.1.2.0-73BCI2Fnk7qE8QjjTa1xNa-ghc8.11.0.20210324.dyn_o_cbits.a ar/libHSghc-8.11.0.20210306-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20210324.dyn_o_stubs.a ar/libHShashable-1.3.0.0-Kn7aNSFvzgo2qY16wYzuCX-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSinteger-gmp-1.0.3.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSlambdacube-quake3-engine-0.1.0.0-7CKLP3Rqgq0PR81lhlwlR-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSmersenne-random-pure64-0.2.2.0-ExYg8DmthtrLG9JevQbt2m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSOpenGLRaw-3.3.4.0-5vXBlmbOM3AIT7GRYfpE3o-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSprimitive-0.7.0.1-2k3g9qX0zz16vEv34R307m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSprocess-1.6.8.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHStext-1.2.4.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_stubs.a ar/libHSzlib-0.6.2.1-1I6DmfbLEyTBgDZI7SbZfW-ghc8.11.0.20210306.dyn_o_stubs.a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> stub-base.dyn_o/Blank_stub.dyn_o stub-base.dyn_o/ClockGetTime_stub.dyn_o stub-base.dyn_o/Internals_stub.dyn_o stub-base.dyn_o/RUsage_stub.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> cbits-rts.dyn_o/StgPrimFloat.dyn_o cbits-rts.dyn_o/TTY.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> c-src/fake_rts.c c-src/hack.c c-src/hschooks.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ gcc -o libHSbase-4.14.0.0.cbits.so -shared -Wl,--whole-archive ar/libHSbase-4.14.0.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSbindings-GLFW-3.3.2.0-Jg9TvsfYUZwD0ViIP0H2Tz-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSbytestring-0.10.9.0-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHScriterion-measurement-0.1.2.0-73BCI2Fnk7qE8QjjTa1xNa-ghc8.11.0.20210324.dyn_o_cbits.a ar/libHSghc-8.11.0.20210306-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSGLUT-2.7.0.15-1pzTWDEZBcYHcS36qZ2lpp-ghc8.11.0.20210324.dyn_o_stubs.a ar/libHShashable-1.3.0.0-Kn7aNSFvzgo2qY16wYzuCX-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSinteger-gmp-1.0.3.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSlambdacube-quake3-engine-0.1.0.0-7CKLP3Rqgq0PR81lhlwlR-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSmersenne-random-pure64-0.2.2.0-ExYg8DmthtrLG9JevQbt2m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSOpenGLRaw-3.3.4.0-5vXBlmbOM3AIT7GRYfpE3o-ghc8.11.0.20201112.dyn_o_cbits.a ar/libHSprimitive-0.7.0.1-2k3g9qX0zz16vEv34R307m-ghc8.11.0.20210306.dyn_o_cbits.a ar/libHSprocess-1.6.8.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHStext-1.2.4.0-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_cbits.a ar/libHSunix-2.7.2.2-ghc8.11.0.20210220.dyn_o_stubs.a ar/libHSzlib-0.6.2.1-1I6DmfbLEyTBgDZI7SbZfW-ghc8.11.0.20210306.dyn_o_stubs.a -Wl,--no-whole-archive stub-base.dyn_o/Blank_stub.dyn_o stub-base.dyn_o/ClockGetTime_stub.dyn_o stub-base.dyn_o/Internals_stub.dyn_o stub-base.dyn_o/RUsage_stub.dyn_o cbits-rts.dyn_o/StgPrimFloat.dyn_o cbits-rts.dyn_o/TTY.dyn_o -fPIC c-src/fake_rts.c c-src/hack.c c-src/hschooks.c -lm -lgmp -ltinfo -lGL -lX11 -lXi -lXrandr -lXxf86vm -lXcursor -lXinerama -lpthread</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This will produce <code>libHSbase-4.14.0.0.cbits.so</code> in the immediate directory:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">984</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 ar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 cbits-rts.dyn_o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 c-src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">986008</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:50 libHSbase-4.14.0.0.cbits.so    </span><span class="token comment" style="color:#999988;font-style:italic">## &lt;----- new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 stub-base.dyn_o</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we can test our interpreter by running it on the <code>*.fullpak</code> files in <code>external-stg-interpreter/data</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data/cbits.so-script</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cbits.so-script  ghc-rts-base-call-graph-summary  ghc-rts-base-call-graph.tsv  ghc-rts-base.fullpak  libHSbase-4.14.0.0.cbits.so  minigame-strict.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## remove the old .so file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## soft-link to the one we just built</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ln</span><span class="token plain"> -s cbits.so-script/libHSbase-4.14.0.0.cbits.so libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">79220</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:50 cbits.so-script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:47 ghc-rts-base-call-graph-summary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">28238</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:47 ghc-rts-base-call-graph.tsv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22450708</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">43</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:55 libHSbase-4.14.0.0.cbits.so -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cbits.so-script/libHSbase-4.14.0.0.cbits.so  </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">58630129</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 minigame-strict.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ ~/.local/bin/ext-stg-interpreter ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssHeapStartAddress: </span><span class="token number" style="color:#36acaa">53522</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssTotalLNECount: </span><span class="token number" style="color:#36acaa">69</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssClosureCallCounter: </span><span class="token number" style="color:#36acaa">360</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">executed closure </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> count: </span><span class="token number" style="color:#36acaa">114</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call graph size: </span><span class="token number" style="color:#36acaa">150</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">./external-stg-interpreter/data</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">79220</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:50 cbits.so-script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">48</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:56 ghc-rts-base-call-graph-summary    </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">28238</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:56 ghc-rts-base-call-graph.tsv        </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22450708</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 ghc-rts-base.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">43</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">:55 libHSbase-4.14.0.0.cbits.so -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> cbits.so-script/libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">58630129</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">:10 minigame-strict.fullpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And it works, we have two new files, <code>&lt;foo&gt;-call-graph-summary</code> and <code>&lt;foo&gt;-call-graph.tsv</code> which we can analyze to inspect the behavior of our program (more on this later).</p><a id="org2daa4b8"></a><h1>The whole setup process on a demo</h1><p>That was a rather involved example, to make clear the dependencies and steps required to run this on your own code the rest of this tutorial will run the interpreter on two of Csaba<!-- -->’<!-- -->s demo<!-- -->’<!-- -->s from his skillshare talk. First let<!-- -->’<!-- -->s grab the code:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">pwd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/doyougnu/programming/haskell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/grin-compiler/ext-stg-interpreter-presentation-demos.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ext-stg-interpreter-presentation-demos ghc-whole-program-compiler-project </span><span class="token punctuation" style="color:#393A34">..</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now we<!-- -->’<!-- -->ll run the first demo which is a simply fold over a list:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ nix-shell ghc-whole-program-compiler-project/shell.nix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trace: checking </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> /home/doyougnu/programming/haskell/hadrian/hadrian.cabal is present:  no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Recommended ./configure arguments </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">found </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$CONFIGURE_ARGS</span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or use the configure_ghc </span><span class="token builtin class-name">command</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sznfxigwvrvn6ar3nz3f0652zsld9xqj-gmp-6.2.0-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-gmp-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/447im4mh8gmw85dkrvz3facg1jsbn6c7-gmp-6.2.0/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/84g84bg47xxg01ba3nv0h418v5v3969n-ncurses-6.1-20190112-dev/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-curses-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/xhhkr936b9q5sz88jp4l29wljbbcg39k-ncurses-6.1-20190112/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libnuma-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/bfrcskjspk9a179xqqf1q9xqafq5s8d2-numactl-2.0.13/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-includes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/include</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --with-libdw-libraries</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/nix/store/sv6f05ngaarba50ybr6fdfc7cciv6nbv-elfutils-0.176/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --enable-dwarf-unwind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ext-stg-interpreter-presentation-demos/demo-01-tsumupto/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nix-shell:~/programming/haskell/ext-stg-interpreter-presentation-demos/demo-01-tsumupto</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">$ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/ghc-wpc/_build/stage1/bin/ghc -O2 tsumupto.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> of </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Compiling Main             </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> tsumupto.hs, tsumupto.o </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Linking tsumupto </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> ext-stg-interpreter-presentation-demos/demo-01-tsumupto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tsumupto  tsumupto.hi  tsumupto.hs  tsumupto.o  tsumupto.o_ghc_stgapp  tsumupto.o_modpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note, that we have two new files: <code>*.o_ghc_stgapp</code> and <code>.o_modpak</code> as a result of building with <code>ghc-wpc</code>. If you try to run this from outside the nix-shell you<!-- -->’<!-- -->ll get an error about missing <code>mkmodpak</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/ghc-wpc/_build/stage1/bin/ghc -O2 tsumupto.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> of </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Compiling Main             </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> tsumupto.hs, tsumupto.o </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ghc: could not execute: mkmodpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now that we have those files we can run the interpreter, but first though we need to make a <code>*.fullpak</code> file from the <code>*.o_ghc_stgapp</code> file and create a symbolic link to <code>libHSbase-4.14.0.0.cbits.so</code>:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## make the fullpack file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ~/.local/bin/mkfullpak tsumupto.o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">all modules: </span><span class="token number" style="color:#36acaa">259</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app modules: </span><span class="token number" style="color:#36acaa">113</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app dependencies:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token comment" style="color:#999988;font-style:italic"># bunch of output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main                                                         Main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">creating tsumupto.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## create the link to the shared object file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ln</span><span class="token plain"> -s </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/external-stg-interpreter/data/cbits.so-script/libHSbase-4.14.0.0.cbits.so libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## the final directory should look like this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libHSbase-4.14.0.0.cbits.so  tsumupto  tsumupto.fullpak  tsumupto.hi  tsumupto.hs  tsumupto.o  tsumupto.o_ghc_stgapp  tsumupto.o_modpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And now we can run the interpreter:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ~/.local/bin/ext-stg-interpreter tsumupto.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">50005000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssHeapStartAddress: </span><span class="token number" style="color:#36acaa">44082</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssTotalLNECount: </span><span class="token number" style="color:#36acaa">43</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssClosureCallCounter: </span><span class="token number" style="color:#36acaa">30275</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">executed closure </span><span class="token function" style="color:#d73a49">id</span><span class="token plain"> count: </span><span class="token number" style="color:#36acaa">112</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call graph size: </span><span class="token number" style="color:#36acaa">146</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The first line is the output of the program and the rest are diagnostics that the interpreter outputs. More importantly we should have a tab-separated csv file and call graph file in our local directory after running the interpreter:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">23876</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">114</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:21 libHSbase-4.14.0.0.cbits.so -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ghc-whole-program-compiler-project/external-stg-interpreter/data/cbits.so-script/libHSbase-4.14.0.0.cbits.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">9442648</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">53</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:23 tsumupto-call-graph-summary   </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">27490</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:23 tsumupto-call-graph.tsv       </span><span class="token comment" style="color:#999988;font-style:italic">### &lt;---- interpreter output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw------- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14922366</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:19 tsumupto.fullpak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">1769</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.hi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">207</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">28</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:56 tsumupto.hs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">4488</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">8817</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.o_ghc_stgapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw------- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> doyougnu </span><span class="token function" style="color:#d73a49">users</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">9803</span><span class="token plain"> Apr </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">:12 tsumupto.o_modpak</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Which can be loaded into <code>gephi</code> for closer inspection of the call graph of our program. Be sure to watch the rest of the demo in Csaba<!-- -->’<!-- -->s talk for this part! For now we<!-- -->’<!-- -->ll be going over using <code>gephi</code> and these files in our next blog post in this series, stay tuned!</p><a id="org8193a1a"></a><h1>Summary</h1><a id="org940ba90"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="file-descriptions">File Descriptions<a class="hash-link" href="#file-descriptions" title="Direct link to heading">​</a></h2><ul><li><code>foo.modpak</code>: A zip file which contains the Core, STG, CMM, source code, and assembly for the module <code>foo</code></li><li><code>foo.fullpak</code>: A zip file which contains the same information as <code>modpack</code> but for every module of the program rather than just module <code>foo</code>.</li><li><code>foo.o_ghc_stgapp</code>: a yaml like file that contains:<ul><li>the module<!-- -->’<!-- -->s dependencies including package dependencies</li><li>a bunch of file paths for shared objects of the libraries</li><li>the flags the module was built with</li></ul></li><li><code>libHSbase-4.14.0.0.cbits.so</code>: shared object file created by <code>ext-stg-interpreter/data/cbits.so-script.c</code>. Required to be in the same directory as <code>ext-stg-interpreter</code> will be invoked.</li></ul><a id="org8e9f409"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="step-by-step-guide-for-running-the-interpreter-on-your-code">Step-by-Step guide for running the interpreter on your code<a class="hash-link" href="#step-by-step-guide-for-running-the-interpreter-on-your-code" title="Direct link to heading">​</a></h2><ol><li>Build your project with <code>ghc-wpc/_build/stage1/bin</code> by directly invoking that <code>ghc</code> (as I did in the demo-01 project) or by pointing stack to it with <code>system-ghc</code> and <code>extra-path</code> in <code>stack.yaml</code>, or by passing <code>-w &lt;path-to-ghc-wpc-binary</code> with cabal.</li><li>Generate the <code>foo.fullpak</code> file with <code>mkfullpak foo.o_ghc_stgapp</code></li><li>Soft-link to <code>libHSbase-4.14.0.0.cbits.so</code> in the directory you will run the interpreter in. This file must be present when you run the interpreter!</li><li>Now run the interpreter on <code>project.fullpak</code></li><li>Analyze <code>foo-call-graph-summary</code> and <code>foo-call-graph.tsv</code> with whatever tools make sense to you</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="footnotes">Footnotes<a class="hash-link" href="#footnotes" title="Direct link to heading">​</a></h2><div class="footnotes"><hr><ol><li id="fn-1">This isn<!-- -->’<!-- -->t completely true, there is the <code>RuntimeRep</code> type controls
exactly this and the levity polymorphism work by <a href="https://richarde.dev/" target="_blank" rel="noopener noreferrer">Richard
Eisenberg</a>. See <a href="https://www.youtube.com/watch?v=Mb_B-j8ePfc" target="_blank" rel="noopener noreferrer">this
video</a> for examples on using these
features. We do plan to include a more thorough and real world example on using
levity polymorphism for better performance in the <a href="https://github.com/haskellfoundation/tech-proposals/pull/26" target="_blank" rel="noopener noreferrer">haskell optimization
handbook</a>.<a href="#fnref-1" class="footnote-backref">↩</a></li></ol></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/stg">stg</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/tooling">tooling</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/profiling">profiling</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/optimization">optimization</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Setting up Csaba&#x27;s External STG Interpreter" href="/2022-05-02-setup-ext-stg-interp"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/iog_eng" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">IOG Blog</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 IOG Engineering, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5bcc4665.js"></script>
<script src="/assets/js/main.3c80257e.js"></script>
</body>
</html>