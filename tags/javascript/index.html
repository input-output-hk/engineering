<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="IOG Engineering RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="IOG Engineering Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="IOG Engineering JSON Feed"><title data-react-helmet="true">4 posts tagged with &quot;javascript&quot; | IOG Engineering</title><meta data-react-helmet="true" property="og:title" content="4 posts tagged with &quot;javascript&quot; | IOG Engineering"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://engineering.iog.io/tags/javascript"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://engineering.iog.io/tags/javascript"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/tags/javascript" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://engineering.iog.io/tags/javascript" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.10ad4647.css">
<link rel="preload" href="/assets/js/runtime~main.9473f435.js" as="script">
<link rel="preload" href="/assets/js/main.af154390.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/iohk-logo.jpg" alt="IOG" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Recent</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tags">Tags</a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022-09-23-ghcjs-heap-representation">GHCJS heap representation</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022-08-01-ghc-update">GHC DevX July 2022 Update</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022-07-26-the-ghcjs-linker">The GHCJS Linker</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022-07-20-js-backend-prim-types">Primitive Type Representation in GHC&#x27;s upcoming JS-backend</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022-07-18-lightweight-threads-on-JavaScript">Lightweight Haskell Threads on JavaScript</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>4 posts tagged with &quot;javascript&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-09-23-ghcjs-heap-representation">GHCJS heap representation</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-09-23T00:00:00.000Z" itemprop="datePublished">September 23, 2022</time> Â· <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">â€‹</a></h2><p>I recently gave a short presentation about heap objects representation in GHCJS and hence in the upcoming JS backend for GHC. This post is a summary of the content.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="heap-objects">Heap objects<a class="hash-link" href="#heap-objects" title="Direct link to heading">â€‹</a></h2><p>GHC implements Haskell code evaluation by using graph reduction. As such Haskell
programs compiled by GHC use the heap to store nodes of the graph to be
reduced and utility nodes participating in graph reduction. These nodes are:</p><ul><li>FUN: functions with their free variables as payload</li><li>THUNK: suspensions with their free variables as payload</li><li>PAP: partial application to a FUN. FUN closure and already applied arguments
as payload.</li><li>IND: indirection to another heap object</li><li>BLACKHOLE: used to overwrite a THUNK when it is being evaluated</li></ul><p>The heap is also used to store other values:</p><ul><li>CON: boxed values (saturated constructor applications) with field values as payload</li><li>Other unlifted values: TSO, BCO, arrays, MutVar#, MVar#, TVar#, stacks, stack frames...</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="info-tables">Info tables<a class="hash-link" href="#info-tables" title="Direct link to heading">â€‹</a></h2><p>Many heap objects share the same properties: e.g. all <code>Int</code> CON objects are
exactly the same except for their payload (the <code>Int#</code> value) that may be
different.
Hence heap objects are split in two parts to allow sharing of common properties:</p><ul><li>info table: statically known properties (at compilation time) that can be
shared by several heap objects</li><li>heap object itself: dynamically allocated in the heap</li></ul><p>Heap objects always have the same layout in the native code generated by GHC.
They are composed of:</p><ul><li>a pointer to an info table</li><li>some words of payload</li></ul><p>Heap traversal is done by following the info table pointer of every heap
object to query in the info table the layout of the heap object payload.</p><p>Info tables contain a pointer to a function called &quot;entry code&quot; that can be
specific to each info table. This code is mainly used to apply a node to some
arguments.
Note that with tables-next-to-code optimisation enabled, to avoid an
indirection the info table pointer is actually a pointer to this entry code and
the info table itself is stored in the words preceeding the entry code.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="heap-objects-in-javascript">Heap objects in JavaScript<a class="hash-link" href="#heap-objects-in-javascript" title="Direct link to heading">â€‹</a></h2><p>GHCJS represents most heap objects with a JavaScript object having the following
fields:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>One question I had was: why don&#x27;t we use a JS array instead of a JS object?
Arrays should be faster than objects (i.e. hashmaps), no? It turns out that
objects like this are optimised by JS engines using &quot;hidden classes&quot; (see
<a href="https://v8.dev/blog/fast-properties" target="_blank" rel="noopener noreferrer">https://v8.dev/blog/fast-properties</a> for an explanation). That&#x27;s why
they are usually more efficient than arrays for which bound checking must be
made. Also arrays are larger in memory because they need to store their size.</p><p>Let&#x27;s now discuss the fields of the heap objects.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="f-field">f field<a class="hash-link" href="#f-field" title="Direct link to heading">â€‹</a></h3><p>&quot;f&quot; is the equivalent of the info table pointer. It contains a JavaScript
function that is the entry code for the heap object.</p><p>Similar to the tables-next-to-code optimisation discussed above, we use the
fact that JS functions are objects which have properties to store the info
table fields as properties of the function itself.</p><p>Example of an info table / entry function:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token known-class-name class-name">Function</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> h$entry_function_xyz</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> t    </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) object type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) number of fields in payload (-1 if variable layout)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i    </span><span class="token comment" style="color:#999988;font-style:italic">// (Array) fields layout (empty if variable layout)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n    </span><span class="token comment" style="color:#999988;font-style:italic">// (String) object name for debug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a    </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) function arity or constructor tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> r    </span><span class="token comment" style="color:#999988;font-style:italic">// (Int) arity in number of JS variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s    </span><span class="token comment" style="color:#999988;font-style:italic">// (Array) static refs that must be kept alive (SRT)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m    </span><span class="token comment" style="color:#999988;font-style:italic">// GC mark</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="d1-d2-fields">d1, d2 fields<a class="hash-link" href="#d1-d2-fields" title="Direct link to heading">â€‹</a></h3><p>The d1 and d2 fields contain the payload of the heap object: constructor fields,
function free variables, etc.</p><p>Payloads can be composed of zero, one, or many fields. A naive solution would be
to have one JS object field (d1, d2, d3...) per payload field. However it would
be bad for two reasons:</p><ul><li><p>performance: JS engine hidden classes optimisation mentioned above needs
objects to have the same field structure.</p></li><li><p>genericity: we couldn&#x27;t write generic functions (e.g. to copy a closure)
without dynamically querying the number of fields composing the payload.</p></li></ul><p>Another solution would be to use a single field to store the whole payload. It
would fulfill the genericity constraint. However performance may not be good
because of the extra allocation of the object containing the payload and the
indirection to access its fields.</p><p>Instead GHCJS uses a middle ground approach: it always uses only two JS object
fields to store any number of payload fields. The following encoding is used to
stash any number of payload fields into two JS fields:</p><table><thead><tr><th>Payload</th><th>d1</th><th>d2</th></tr></thead><tbody><tr><td>[]</td><td>null</td><td>null</td></tr><tr><td>[a]</td><td>a</td><td>null</td></tr><tr><td>[a,b]</td><td>a</td><td>b</td></tr><tr><td>[a,b,c]</td><td>a</td><td>{d1=b,d2=c}</td></tr><tr><td>[a,b,c,d...]</td><td>a</td><td>{d1=b,d2=c,d3=d...}</td></tr></tbody></table><p>It still fulfills the genericity constraint and small objects (up to two fields
of payload) don&#x27;t pay for an extra allocation/indirection. The price to pay is
that two fields of payload are always allocated, even for for objects with 1
field of payload.</p><p>It would be interesting to benchmark the performance of the different payload
representations.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="m-field">m field<a class="hash-link" href="#m-field" title="Direct link to heading">â€‹</a></h3><p>The &quot;m&quot; field is used both for reachability checking (~ garbage collection) and
to implement the &quot;stable names&quot; features.</p><p>GHCJS can&#x27;t rely on the JS engine to know when a heap object is collected. So it
implements its own heap traversal algorithm for this. The &quot;m&quot; field is used as a
marker for this algorithm (it will be the topic of a future blog post).
In this case, the &quot;m&quot; field is a number (a GC mark).</p><p>When a StableName is created for an object, the &quot;m&quot; field of the object is
updated to point to the StableName object:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">h$StableName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> m </span><span class="token comment" style="color:#999988;font-style:italic">// GC mark</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s </span><span class="token comment" style="color:#999988;font-style:italic">// stable name unique id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The &quot;m&quot; field of the StableName object is used in replacement of the mark of the object.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="cc-field">cc field<a class="hash-link" href="#cc-field" title="Direct link to heading">â€‹</a></h3><p>The &quot;cc&quot; field is the cost center associated to the heap object. This field is
only present when profiling mode is enabled. Cost centers are entered (pushed on
the cost center stack of the current thread) before the evaluation of thunks and
function applications.</p><p>Cost centers are allocated with the <code>h$CC</code> function.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="other-heap-object-representation">Other heap object representation<a class="hash-link" href="#other-heap-object-representation" title="Direct link to heading">â€‹</a></h2><p>The generic heap object representation presented above is only used for some
objects: those involved in graph reduction (e.g. updatable objects) and values
that don&#x27;t have a fixed layout (e.g. CON objects have different layouts
depending on which constructor they represent). The object layout allows generic
access to the infotable and to the payload, and the infotable describes the
object type and the payload layout.</p><p>Several other objects don&#x27;t need this machinery: they always have the same
layout and are never the result of a reduction (they are unlifted values). These
objects are represented as JS objects with any fields they need (i.e. not using
the d1/d2 encoding above). To determine the type of such heap objects, instead
of using the &quot;type&quot; field of an infotable the code uses the <code>instanceof</code>
operator. For example a TSO is represented as a <code>h$Thread</code> object.</p><p>Note that we could be tempted to give every heap object a different object name
and to always use <code>instanceof</code> instead of the infotable &quot;type&quot; properties. It
would mean adding <code>h$Con</code>, <code>h$Thunk</code>, <code>h$Fun</code>, <code>h$Pap</code>, <code>h$Blackhole</code>, and
<code>h$StackFrame</code> objects. Then all the heap objects could be treated in the same
way. However the isssue is that these objects need to be overwritable in place:
a Thunk becomes a Fun/Con/Pap/Blackhole, etc. As far as I know we can&#x27;t update
the &quot;instance&quot; of an object, so all these object have to be instances of
the same JS object.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="automatic-unboxing">Automatic unboxing<a class="hash-link" href="#automatic-unboxing" title="Direct link to heading">â€‹</a></h3><p>Sometimes the generic heap object representation is unnecessary. For example, a
boxed <code>Int</code> would be represented as a <code>CON</code> heap object with the <code>Int#</code> in its
payload, represented as a JavaScript number value. The only thing we can do with
this heap object is to pass it around and to extract its payload. As such, it is
more memory efficient to directly pass the payload (a JS number).</p><p>GHCJS provides an optimisation that consists in automatically unboxing some CON
heap objects. For example, Haskell booleans (True and False datacons) are
directly mapped to JavaScript booleans, boxed numbers (Float, Double, Int, Word,
Int8, etc.) are directly mapped to JavaScript numbers.</p><p>We can do this because JavaScript already provides some boxing of its own: we
can use the <code>typeof</code> operator on a heap object to know if it is a JS object, a
JS number, a JS boolean, etc. It makes it possible to distinguish between heap
object representations. In comparison, we can&#x27;t do this with the native (non-JS)
backend when we only have a pointer to a heap object: the pointer doesn&#x27;t carry
the kind of value it points to, hence the pointed memory location must be
generic enough for this introspection to be performed (e.g. using infotable
pointers).</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">â€‹</a></h2><p>Heap object can be represented as JS values (number, boolean) because of the
automatic unboxing, or as JS objects: discimination is done with the <code>typeof</code>
operator.</p><p>Heap objects represented as JS objects come in two flavours:</p><ul><li>unlifted objects are represented with specific JS objects, disciminated with
the <code>instanceof</code> operator</li><li>other objects use the following generic and updatable structure:</li></ul><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">cc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about GHCJS heap representation" href="/2022-09-23-ghcjs-heap-representation"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-07-26-the-ghcjs-linker">The GHCJS Linker</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-26T00:00:00.000Z" itemprop="datePublished">July 26, 2022</time> Â· <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">â€‹</a></h2><p>I recently gave a short presentation on the workings of the GHCJS linker. This post is a summary of the content.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-executables">JavaScript &quot;executables&quot;<a class="hash-link" href="#javascript-executables" title="Direct link to heading">â€‹</a></h2><p>The task of a linker is collecting and organizing object files and resources into a loadable library or executable program. JavaScript can be run in various environments, for example the browser or node.js, and not in all of these the concept of an executable makes sense.</p><p>Therefore, when we link a Haskell program, we generate a <code>jsexe</code> directory filled with various files that allow us to run the JavaScript result:</p><table><thead><tr><th align="center">File</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center"><code>out.js</code></td><td align="center">compiled/linked Haskell code</td></tr><tr><td align="center"><code>out.frefs.*</code></td><td align="center">list of foreign calls from <code>out.js</code></td></tr><tr><td align="center"><code>out.stats</code></td><td align="center">source code size origin statistics for <code>out.js</code></td></tr><tr><td align="center"><code>lib.js</code></td><td align="center">non-Haskell code, from <code>js-sources</code> in packages and RTS. possibly preprocessed</td></tr><tr><td align="center"><code>rts.js</code></td><td align="center">generated part of RTS (apply functions and similarly repetitive things)</td></tr><tr><td align="center"><code>runmain.js</code></td><td align="center">single line just starts <code>main</code></td></tr><tr><td align="center"><code>all.js</code></td><td align="center">complete runnable program, created by combining <code>out.js</code>, <code>lib.js</code>, <code>rts.js</code> and <code>runmain.js</code></td></tr></tbody></table><p>Most of the work done by the linker is producing <code>out.js</code>, and that&#x27;s what we&#x27;ll be focusing on in the next sections.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-outjs">Building <code>out.js</code><a class="hash-link" href="#building-outjs" title="Direct link to heading">â€‹</a></h2><p>The linker builds <code>out.js</code> by collecting all code reachable from <code>main</code> (and a few other symbols required by the RTS) and generating the required initialization code for all top-level data. The code is found in object files. These object files have the following structure:</p><table><thead><tr><th align="center">Section</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">Header</td><td align="center">version number and offsets of other sections</td></tr><tr><td align="center">String table</td><td align="center">shared string table, referred to by <code>Dependencies</code> and <code>Code</code>, to avoid duplication in file and memory</td></tr><tr><td align="center">Dependencies</td><td align="center">Dependency data, internally between binding groups and externally to symbols in other object files</td></tr><tr><td align="center">Code</td><td align="center">Compiled Haskell code stored as serialized JavaScript AST and metadata. Code is organized in binding groups</td></tr></tbody></table><p>The object files contain binding groups of mutually dependent bindings. These are the smallest units of code that can be linked. Each binding group has some associated metadata required for initialization of the heap objects in the group. The metadata contains for example constructor tags (e.g. 1 for <code>Nothing</code>, 2 for <code>Just</code>), the arity of functions and static reference tables.</p><p>From a high level, the procedure that the linker follows is this:</p><table><thead><tr><th align="center">Step</th></tr></thead><tbody><tr><td align="center">Read object files from dependencies into memory</td></tr><tr><td align="center">Decode dependency part of all object files in dependencies (includes reading the string tables)</td></tr><tr><td align="center">Using dependency data, find all code reachable from <code>main</code></td></tr><tr><td align="center">Decode reachable binding groups</td></tr><tr><td align="center">Render AST to JavaScript</td></tr><tr><td align="center">Construct initializers from metadata</td></tr></tbody></table><p>We avoid decoding (deserializing) the binding groups that do end up in the linked result to keep the memory consumption lower. Still the linker requires a lot of memory for larger programs, so we may need to make more improvements in the future.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-compactor">The Compactor<a class="hash-link" href="#the-compactor" title="Direct link to heading">â€‹</a></h2><p>The compactor is an optional link-time transformation step that reduces code size. It consists of a lightweight (i.e. no expensive operations like dataflow analysis) rewrite of the code contained in the object files. The compactor is disabled when linking with the <code>-debug</code> flag. There are a few steps involved.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="renaming-private-symbols">Renaming private symbols<a class="hash-link" href="#renaming-private-symbols" title="Direct link to heading">â€‹</a></h3><p>Haskell names are quite long by default: they need to be globally unique, hence they contain their defining unit-id and module name. For example: <code>mtl-2.2.2-somehash-Control.Monad.State.Lazy.execState_go1</code> (special characters would be z-encoded but it isn&#x27;t shown here).</p><p>Private symbols are only referred to from within the same module. It doesn&#x27;t matter which JavaScript name we pick for them, as long as there is no overlap between the names from different modules. The compactor renames all the private symbols using a global sequence to ensure short names that do not overlap.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="block-initializer">Block Initializer<a class="hash-link" href="#block-initializer" title="Direct link to heading">â€‹</a></h3><p>Without the compactor, the linker generates an <code>h$initObj</code> initialization call (or <code>h$o</code>) call for each global Haskell heap value. The code for this can get quite big. The compactor collects all heap objects to be initialized in a single large array and encodes the metadata in a string. This makes the initialization code much more compact.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="deduplication">Deduplication<a class="hash-link" href="#deduplication" title="Direct link to heading">â€‹</a></h3><p>An optional step in the compactor is deduplication of code. When deduplication is enabled with the <code>-dedupe</code> flag, the compactor looks for functionally equivalent pieces of JavaScript in the output and merges them. This can result in a significant reduction of code size.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="incremental-linking">Incremental Linking<a class="hash-link" href="#incremental-linking" title="Direct link to heading">â€‹</a></h2><p>The linker supports building programs that are loaded incrementally. This is used for example for Template Haskell. The process that runs the Template Haskell stays alive during compilation of a whole module. When the first Template Haskell expression is compiled, it is linked against all its dependencies (including the RTS) and the resulting JavaScript code is sent over to be run in the evaluator process.</p><p>As subsequent Template Haskell expressions are evaluated in the same process, there is no need to load already loaded dependencies (including the RTS) again and it is much more efficient to avoid doing so. Therefore the linker keeps track of which dependencies have already been linked and each subsequent TH expression is only linked against dependencies that are not already loaded in the evaluator process.</p><p>It&#x27;s also possible for users to use this functionality directly, with the <code>-generate-base</code> to create a &quot;linker state&quot; file along with the regular <code>jsexe</code> files. Another program can then be linked with <code>-use-base=state_file</code>, resulting in a program which leaves out everything already present in the first program.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="future-improvements">Future Improvements<a class="hash-link" href="#future-improvements" title="Direct link to heading">â€‹</a></h2><p>Memory consumption is the biggest problem in the linker at the moment. Possible ways to achieve this are compression, more efficient representation of the data structures or more incremental loading of the parts from the object files that we need.</p><p>In terms of functionality, we don&#x27;t take advantage of JavaScript modules yet. It would be good if we could improve the linker to support linking a library as a JavaScript module. We should also consider making use of <code>foreign export javascript</code> for this purpose.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/linking">linking</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about The GHCJS Linker" href="/2022-07-26-the-ghcjs-linker"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-07-20-js-backend-prim-types">Primitive Type Representation in GHC&#x27;s upcoming JS-backend</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-20T00:00:00.000Z" itemprop="datePublished">July 20, 2022</time> Â· <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://iog.io/en/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jeffrey M. Young</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Sylvain Henry</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ol><li><a href="#orge86cd4a">GHC Primitives</a><ol><li><a href="#org75a0c27">The Easy Cases</a></li><li><a href="#org5eb1aee">ByteArray#, MutableByteArray#, SmallArray#, MutableSmallArray#,</a></li><li><a href="#org0de7f9e">Addr# and StablePtr#</a></li><li><a href="#orgfa8aeb4">Numbers: The Involved Case</a><ol><li><a href="#orgc9d245e">Working with 64-bit Types</a></li><li><a href="#org453f9cc">Unwrapped Number Optimization</a></li></ol></li><li><a href="#org2e2e79e">But what about the other stuff!</a></li></ol></li></ol><p>One of the key challenges in any novel backend is representing GHC primitive
types in the new backend. For JavaScript, this is especially tricky, as
JavaScript only has 8 primitive types and some of those types, such as <code>number</code> do
not directly map to any Haskell primitive type, such as <code>Int8#</code>. This post walks
through the most important GHC primitives and describes our implementation for
each in the JavaScript backend. This post is intended to be an
explanation-oriented post, light on details, but just enough to understand how
the system works.</p><a id="orge86cd4a"></a><h1>GHC Primitives</h1><p>There are 36 <code>primtype</code>s that GHC defines in <code>primops.txt.pp</code>:</p><ol><li><code>Char#</code></li><li><code>Int8#</code>, <code>Int16#</code>, <code>Int32#</code>, <code>Int64#</code>, <code>Int#</code></li><li><code>Word8#</code>, <code>Word16#</code>, <code>Word32#</code>, <code>Word64#</code>, <code>Word#</code></li><li><code>Double#</code>, <code>Float#</code>,</li><li><code>Array#</code>, <code>MutableArray#</code>,, <code>SmallArray#</code>, <code>SmallMutableArray#</code></li><li><code>ByteArray#</code>, <code>MutableByteArray#</code></li><li><code>Addr#</code></li><li><code>MutVar#</code>, <code>TVar#</code>, <code>MVar#</code>,</li><li><code>IOPort#</code>, <code>State#</code>, <code>RealWorld</code>, <code>ThreadId#</code></li><li><code>Weak#</code>, <code>StablePtr#</code>, <code>StableName#</code>, <code>Compact#</code>, <code>BCO</code>,</li><li><code>Fun</code>, <code>Proxy#</code></li><li><code>StackSnapshot#</code></li><li><code>VECTOR</code></li></ol><p>Some of these are unsupported in the JS-backend, such as <code>VECTOR</code> or lower
priority such as <code>StackSnapshot#</code>. We<!-- -->â€™<!-- -->ll begin with the easy cases.</p><a id="org75a0c27"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-easy-cases">The Easy Cases<a class="hash-link" href="#the-easy-cases" title="Direct link to heading">â€‹</a></h2><p>The easy cases are the cases that are implemented as JavaScript objects. In
general, this is the big hammer used when nothing else will do. We<!-- -->â€™<!-- -->ll expand on
the use of objects<!-- -->â€”<!-- -->especially representing heap objects<!-- -->â€”<!-- -->in a future post,
but for the majority of cases we mimic the STG-machine behavior for GHC heap
objects using JavaScript heap objects. For example,</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">var someConstructor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { f  =                   // entry function of the datacon worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    , m  = 0                 // garbage collector mark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    , d1 = first arg         // First data field for the constructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    , d2 = arity = 2: second arg // second field, or object containing the remaining fields</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           arity &gt; 2: { d1, d2, ...} object with remaining args (starts with &quot;d1 = x2&quot;!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This is the general recipe; we define a JavaScript object that contains
properties which correspond to the entry function of the heap object; in this
case that is the entry function, <code>f</code> for a constructor, some meta data for garbage
collection <code>m</code>, and pointers to the fields of the constructor or whatever else the
heap object might need. Using JavaScript objects allows straightforward
translations of several GHC types. For example <code>TVar</code>s and <code>MVar</code>s:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// stg.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/** @constructor */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$TVar(v) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TRACE_STM(&quot;creating TVar, value: &quot; + h$collectProps(v));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.val        = v;           // current value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.blocked    = new h$Set(); // threads that get woken up if this TVar is updated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.invariants = null;        // invariants that use this TVar (h$Set)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.m          = 0;           // gc mark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this._key       = ++h$TVarN;   // for storing in h$Map/h$Set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef GHCJS_DEBUG_ALLOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h$debugAlloc_notifyAlloc(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// stm.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$MVar() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TRACE_SCHEDULER(&quot;h$MVar constructor&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.val     = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.readers = new h$Queue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.writers = new h$Queue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.waiters = null;  // waiting for a value in the MVar with ReadMVar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.m       = 0; // gc mark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  this.id      = ++h$mvarId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef GHCJS_DEBUG_ALLOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  h$debugAlloc_notifyAlloc(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that both implementations defined properties specific to the semantics of
the Haskell type. JavaScript functions which create these objects follow the
naming convention <code>h$&lt;something&gt;</code> and reside in <em>Shim</em> files. <em>Shim</em> files are
JavaScript files that the JS-backend links against and are written in pure
JavaScript. This allows us to save some compile time by not generating code
which doesn<!-- -->â€™<!-- -->t change, and decompose the backend into JavaScript modules.</p><p>This strategy is also how functions are implemented in the JS-backend. Function
objects are generated by <code>StgToJS.Expr.genExpr</code> and <code>StgToJS.Apply.genApp</code> but
follow this recipe:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">var myFUN =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> { f  = &lt;function itself&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> , m  = &lt;garbage collector mark&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> , d1 = free variable 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> , d2 = free variable 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>To summarize; for most cases we write custom JavaScript objects which hold
whatever machinery is needed as properties to satisfy the expected semantics of
the Haskell type. This is the strategy that implements: <code>TVar</code>, <code>MVar</code>, <code>MutVar</code> and
<code>Fun</code>.</p><a id="org5eb1aee"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="bytearray-mutablebytearray-smallarray-mutablesmallarray">ByteArray#, MutableByteArray#, SmallArray#, MutableSmallArray#,<a class="hash-link" href="#bytearray-mutablebytearray-smallarray-mutablesmallarray" title="Direct link to heading">â€‹</a></h2><p><code>ByteArray#</code> and friends map to JavaScript&#x27;s
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer" target="_blank" rel="noopener noreferrer"><code>ArrayBuffer</code></a>
object. The <code>ArrayBuffer</code> object provides a fixed-length, raw binary data
buffer. To index into the <code>ArrayBuffer</code> we need to know the type of data the
buffer is expected to hold. So we make engineering tradeoff; we allocate typed
views of the buffer payload once at buffer allocation time. This prevents
allocations from views later when we might be handling the buffer in a hot loop,
at the cost of slower initialization. For example, consider the <code>mem.js.pp</code>
shim, which defines <code>ByteArray#</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// mem.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$newByteArray(len) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var len0 = Math.max(h$roundUpToMultipleOf(len, 8), 8);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var buf = new ArrayBuffer(len0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return { buf: buf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , len: len</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , i3: new Int32Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u8: new Uint8Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u1: new Uint16Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f3: new Float32Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f6: new Float64Array(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , dv: new DataView(buf)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , m: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p> <code>buf</code> is the payload of the <code>ByteArray#</code>, <code>len</code> is the length of the
<code>ByteArray#</code>. <code>i3</code> to <code>dv</code> are the <em>views</em> of the payload; each view is an
object which interprets the raw data in <code>buf</code> differently according to type. For
example, <code>i3</code> interprets <code>buf</code> as holding <code>Int32</code>, while <code>dv</code> interprets <code>buf</code>
as a
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" target="_blank" rel="noopener noreferrer"><code>DataView</code></a>
and so on. The final property, <code>m</code>, is the garbage collector marker.</p><a id="org0de7f9e"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="addr-and-stableptr">Addr# and StablePtr#<a class="hash-link" href="#addr-and-stableptr" title="Direct link to heading">â€‹</a></h2><p><code>Addr#</code> and <code>StablePtr#</code> are implemented as a pair of <code>ByteArray#</code> and an <code>Int#</code>
offset into the array. We<!-- -->â€™<!-- -->ll focus on <code>Addr#</code> because <code>StablePtr#</code> is the
same implementation, with the exception that the <code>StablePtr#</code> is tracked in the
global variable <code>h$stablePtrBuf</code>. <code>Addr#</code>s do not have an explicit constructor,
rather they are implicitly constructed. For example, consider <code>h$rts_mkPtr</code>
which creates a <code>Ptr</code> that contains an <code>Addr#</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">function h$rts_mkPtr(x) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  var buf, off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(typeof x == &#x27;string&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = h$encodeUtf8(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else if(typeof x == &#x27;object&#x27; &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     typeof x.len == &#x27;number&#x27; &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     x.buf instanceof ArrayBuffer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else if(x.isView) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = h$wrapBuffer(x.buffer, true, 0, x.buffer.byteLength);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = x.byteOffset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf = h$wrapBuffer(x, true, 0, x.byteLength);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    off = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return (h$c2(h$baseZCGHCziPtrziPtr_con_e, (buf), (off)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The function does some type inspection to check for the special case on
<code>string</code>. If we do not have a string then a <code>Ptr</code>, which contains an <code>Addr#</code>, is
returned. The <code>Addr#</code> is implicitly constructed by allocating a new
<code>ArrayBuffer</code> and an offset into that buffer. The <code>object</code> case is an idempotent
check; if the input is already such a <code>Ptr</code>, then just return the input. The
cases which do the work are the cases which call to <code>h$wrapBuffer</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// mem.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$wrapBuffer(buf, unalignedOk, offset, length) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!unalignedOk &amp;&amp; offset &amp;&amp; offset % 8 !== 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw (&quot;h$wrapBuffer: offset not aligned:&quot; + offset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!buf || !(buf instanceof ArrayBuffer))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw &quot;h$wrapBuffer: not an ArrayBuffer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!offset) { offset = 0; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!length || length &lt; 0) { length = buf.byteLength - offset; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return { buf: buf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , len: length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , i3: (offset%4) ? null : new Int32Array(buf, offset, length &gt;&gt; 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u8: new Uint8Array(buf, offset, length)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , u1: (offset%2) ? null : new Uint16Array(buf, offset, length &gt;&gt; 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f3: (offset%4) ? null : new Float32Array(buf, offset, length &gt;&gt; 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , f6: (offset%8) ? null : new Float64Array(buf, offset, length &gt;&gt; 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         , dv: new DataView(buf, offset, length)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>h$wrapBuffer</code> is a utility function that does some offset checks and performs
the allocation for the typed views as described above.</p><a id="orgfa8aeb4"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="numbers-the-involved-case">Numbers: The Involved Case<a class="hash-link" href="#numbers-the-involved-case" title="Direct link to heading">â€‹</a></h2><p>Translating numbers has three issues. First, JavaScript has no concept of
fixed-precision 64-bit types such as <code>Int64#</code> and <code>Word64#</code>. Second, JavaScript
bitwise operators only support <em>signed</em> 32-bit values (except the unsigned
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Unsigned_right_shift" target="_blank" rel="noopener noreferrer">right
shift</a>
operator of course). Third, numbers are atomic types and do not require any
special properties for correct semantics, thus using wrapping objects gains us
nothing at the cost of indirection.</p><a id="orgc9d245e"></a><h3 class="anchor anchorWithStickyNavbar_mojV" id="working-with-64-bit-types">Working with 64-bit Types<a class="hash-link" href="#working-with-64-bit-types" title="Direct link to heading">â€‹</a></h3><p>To express 64-bit numerics, we simply use two 32-bit numbers, one to express
the high bits, one for the low bits. For example, consider comparing two <code>Int64#:</code></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// arith.js.pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function h$hs_ltInt64(h1,l1,h2,l2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(h1 === h2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var l1s = l1 &gt;&gt;&gt; 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var l2s = l2 &gt;&gt;&gt; 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (l1s &lt; l2s || (l1s === l2s &amp;&amp; ((l1&amp;1) &lt; (l2&amp;1)))) ? 1 : 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (h1 &lt; h2) ? 1 : 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The less than comparison function expects four inputs, two for each <code>Int64#</code> in
Haskell. The first number is represented by <code>h1</code> and <code>l1</code> (<em>high</em> and <em>low</em>),
and similarly the second number is represented by <code>h2</code> and <code>l2</code>. The comparison
is straightforward, we check equivalence of our high bits, if equal then we
check the lower bits while being careful with signedness. No surprises here.</p><p>For the bitwise operators we store both <code>Word32#</code> and <code>Word#</code> as 32-bit signed
values, and then map any values greater or equal <code>2^31</code> bits to negative values.
This way we stay within the 32-bit range even though in Haskell these types only
support nonnegative values.</p><a id="org453f9cc"></a><h3 class="anchor anchorWithStickyNavbar_mojV" id="unwrapped-number-optimization">Unwrapped Number Optimization<a class="hash-link" href="#unwrapped-number-optimization" title="Direct link to heading">â€‹</a></h3><p>The JS backend uses JavaScript values to represent both Haskell heap objects and
unboxed values (note that this isn&#x27;t the only possible implementation, see
<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>). As such, it doesn&#x27;t require that all heap objects have the same
representation (e.g. a JavaScript object with a &quot;tag&quot; field indicating its type)
because we can rely on JS introspection for the same purpose (especially
<code>typeof</code>). Hence this optimization consists in using a more efficient JavaScript
type to represent heap objects when possible, and to fallback on the generic
representation otherwise.</p><p>This optimization particularly applies to <code>Boxed</code> numeric values (<code>Int</code>, <code>Word</code>,
<code>Int8</code>, etc.) which can be directly represented with a JavaScript number,
similarly to how unboxed <code>Int#</code>, <code>Word#</code>, <code>Int8#</code>, etc. values are represented.</p><p>Pros:</p><ul><li>Fewer allocations and indirections: instead of one JavaScript object with a
field containing a number value, we directly have the number value.</li></ul><p>Cons:</p><ul><li>More complex code to deal with heap objects that can have different
representations</li></ul><p>The optimization is applicable when:</p><ol><li>We have a single data type with a single data constructor.</li><li>The constructor holds a single field that <em>can only</em> be a particular type.</li></ol><p>If these invariants hold then, we remove the wrapping object and instead refer
to the value held by the constructor directly. <code>Int8</code> is the simplest case for
this optimization. In Haskell we have:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data Int8 = Int8 Int8#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that this definition satisfies the requirements. A direct translation in
the JS backend would be:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// An Int8 Thunk represented as an Object with an entry function, f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// and payload, d1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var anInt8 = { d1 = &lt;Int8# payload&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             , f  : entry function which would scrutinize the payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We can operationally distinguish between a <code>Thunk</code> and an <code>Int8</code> because these
will have separate types in the <code>StgToJS</code> GHC pass and will have separate types
(<code>object</code> vs <code>number</code>) at runtime. In contrast, in Haskell an <code>Int8</code> may
actually be a <code>Thunk</code> until it is scrutinized <em>and then</em> becomes the <code>Int8</code>
payload (i.e., call-by-need). So this means that we will always know when we
have an <code>Int8</code> rather than a <code>Thunk</code> and therefore we can omit the wrapper
object and convert this code to just:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// no object, just payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var anInt8 = = &lt;Int8# payload&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For the interested reader, this optimization takes place in the JavaScript code
generator module <code>GHC.StgToJS.Arg</code>, specifically the functions <code>allocConStatic</code>,
<code>isUnboxableCon</code>, and <code>primRepVt</code>.</p><a id="org2e2e79e"></a><h2 class="anchor anchorWithStickyNavbar_mojV" id="but-what-about-the-other-stuff">But what about the other stuff!<a class="hash-link" href="#but-what-about-the-other-stuff" title="Direct link to heading">â€‹</a></h2><ul><li><code>Char#</code>: is represented by a <code>number</code>, i.e., the <a href="https://en.wikipedia.org/wiki/Code_point" target="_blank" rel="noopener noreferrer">code point</a></li><li><code>Float#/Double#</code>: Both represented as a JavaScript Double. This means that
<code>Float#</code> has excess precision and thus we do not generate exactly the same
answers as other platforms which are IEEE754 compliant. Full emulation of
single precision Floats does not seem to be worth the effort as of writing.
Our implementation represents these in a <code>ByteArray#</code>, where each <code>Float#</code>
takes 4 bytes in the <code>ByteArray#</code>. This means that the precision is reduced
to a 32-bit Float.</li></ul><div class="footnotes"><hr><ol><li id="fn-1">An alternative approach would be to use some JS ArrayBuffers as memory
blocks into which Haskell values and heap objects would be allocated. As an
example this is the approach used by the Asterius compiler. The RTS would
then need to be much more similar to the C RTS and the optimization
presented in this section wouldn&#x27;t apply because we couldn&#x27;t rely on
introspection of JS values.<a href="#fnref-1" class="footnote-backref">â†©</a></li></ol></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/explanation">explanation</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/knowledge-engineering">knowledge_engineering</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Primitive Type Representation in GHC&#x27;s upcoming JS-backend" href="/2022-07-20-js-backend-prim-types"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022-07-18-lightweight-threads-on-JavaScript">Lightweight Haskell Threads on JavaScript</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-07-18T00:00:00.000Z" itemprop="datePublished">July 18, 2022</time> Â· <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Luite Stegeman</span></a></div><small class="avatar__subtitle" itemprop="description">Haskell DevX Engineer @ IOG</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">â€‹</a></h2><p>I recently gave a short presentation on the topic of threads in GHCJS to the GHC team at IOG. This blog post is a summary of the content.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="javascript-and-threads">JavaScript and Threads<a class="hash-link" href="#javascript-and-threads" title="Direct link to heading">â€‹</a></h2><p>JavaScript is fundamentally single threaded. There are ways to share specific data between tasks but it&#x27;s not possible to run multiple threads that have access to a shared memory space of JavaScript data.</p><p>The single JavaScript thread is often responsible for multiple tasks. For example a node.js server handles multiple simultaneous connections and a web application may be dealing with user input while downloading new data in the background.</p><p>This means that any single task should take care to never block execution of the other task. JavaScript&#x27;s canonical answer is to use asynchronous programming. A function reading a file returns immediately without waiting for the file data to be loaded in memory. When the data is ready, a user-supplied callback is called to continue processing the data.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="haskell-threads">Haskell Threads<a class="hash-link" href="#haskell-threads" title="Direct link to heading">â€‹</a></h2><p>Concurrent Haskell supports lightweight threads through <code>forkIO</code>. These threads are scheduled on top of one more more operating system thread. A blocking foreign call blocks an OS thread but other lightweight threads can still run on other OS threads if available.</p><p>There is no built-in support for foreign calls with a callback in the style of JavaScript. Functions imported with <code>foreign import ccall interruptible</code> can be interrupted by sending an asynchronous exception to the corresponding lightweight thread.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="lightweight-threads-in-javascript">Lightweight Threads in JavaScript<a class="hash-link" href="#lightweight-threads-in-javascript" title="Direct link to heading">â€‹</a></h2><p>GHCJS implements lightweight threads on top of the single JavaScript thread. The scheduler switches between threads and handles synchronization through <code>MVar</code> and <code>STM</code> as expected from other Haskell platforms.</p><p>Foreign calls that don&#x27;t block can be handled in the usual way. We extend the foreign function interface with a new type <code>foreign import javascript interruptible</code> that conveniently supports the callback mechanism used by JavaScript frameworks. The foreign call is supplied with an additional argument <code>$c</code> representing a callback to be called with the result when ready. From the Haskell side the corresponding lightweight thread is blocked until <code>$c</code> is called. This type of foreign call can be interrupted with an asynchronous exception to the lightweight Haskell thread.</p><p>By default, Haskell threads in the JS environment run asynchronously. A call to <code>h$run</code> returns immediately and starts the thread in the background. This works for tasks that does not require immediate actions. For situations that require more immediate action, such as dealing with event handler propagation, there is <code>h$runSync</code>. This starts a synchronous thread that is not interleaved with other task. If possible, the thread runs to completion before the call to <code>h$runSync</code> returns. If the thread blocks for any reason, such as waiting for an <code>MVar</code> or a <code>foreign import javascript interruptible</code> call, synchronous execution cannot complete. The blocking task is then either interrupted with an exception or the thread is &quot;demoted&quot; to a regular asynchronous thread.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="black-holes">Black Holes<a class="hash-link" href="#black-holes" title="Direct link to heading">â€‹</a></h2><p>When a Haskell value is evaluated, its heap object is overwritten by a black hole. This black hole marks the value as being evaluated and prevents other threads from doing the same. &quot;black holing&quot; can be done either immediately or &quot;lazily&quot;, when the garbage collector is run. GHCJS implements immediate blackholing.</p><p>Black holes give rise to an interesting problem in the presence of synchronous and asynchronous threads. Typically if we use <code>h$runSync</code>, we want to have some guarantee that at least part of the task will run succesfully without blocking. For the most past it&#x27;s fairly clear which parts of our task depends on potentially blocking IO or thread synchronization. But black holes throw a spanner in the works: Suddenly any &quot;pure&quot; data structure can be a source of blocking if it is under evaluation by another thread.</p><p>To regain some predictability and usability of synchronous threads, the <code>h$runSync</code> scheduler can run other Haskell threads in order to &quot;clear&quot; a black hole. The process ends all black holes have been cleared or when any of the black holes is impossible to clear because of a blocking situation.</p><p>This all happens transparantly to the caller of <code>h$runSync</code>, if the black holes could be cleared it appears as if they were never there.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">â€‹</a></h2><p>We have lightweight Haskell threads in the single-threaded JavaScript environment and extend the foreign function interface to easily support foreign calls that depend on an asynchronous callback. This way, only the Haskell lightweight thread blocks.</p><p>By default, Haskell threads are asynchronous and run in the background: The scheduler interleaves the tasks and synchronization between threads. For situations that require immediate results or actions there are synchronous threads. Synchronous threads cannot block and are not interleaved with other tasks except when a black hole is encountered.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ghc">ghc</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/javascript">javascript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/concurrency">concurrency</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ffi">ffi</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Lightweight Haskell Threads on JavaScript" href="/2022-07-18-lightweight-threads-on-JavaScript"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/iog_eng" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">IOG Blog</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 IOG Engineering, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9473f435.js"></script>
<script src="/assets/js/main.af154390.js"></script>
</body>
</html>