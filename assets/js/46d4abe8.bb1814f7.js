"use strict";(globalThis.webpackChunkengineering_iog_io=globalThis.webpackChunkengineering_iog_io||[]).push([[8519],{5029:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=t(8168),r=(t(6540),t(5680));const o={slug:"upgrading-to-ghc-9.14",title:"Upgrading to ghc-9.14",authors:["erikd"],tags:["ghc-9.14"]},i=void 0,s={permalink:"/upgrading-to-ghc-9.14",editUrl:"https://github.com/input-output-hk/engineering/tree/master/blog/2025-10-16-upgrading-to-ghc-9.14.md",source:"@site/blog/2025-10-16-upgrading-to-ghc-9.14.md",title:"Upgrading to ghc-9.14",description:"At IOG we have several large and complex Haskell code bases. We also",date:"2025-10-16T00:00:00.000Z",formattedDate:"October 16, 2025",tags:[{label:"ghc-9.14",permalink:"/tags/ghc-9-14"}],readingTime:3.245,hasTruncateMarker:!0,authors:[{name:"Erik de Castro Lopo",title:"Haskell DevX Engineer @ IOG",email:"erikd@mega-nerd.com",key:"erikd"}],frontMatter:{slug:"upgrading-to-ghc-9.14",title:"Upgrading to ghc-9.14",authors:["erikd"],tags:["ghc-9.14"]},nextItem:{title:"IOG GHC Update #47",permalink:"/2025-06-12-ghc-update"}},l={authorsImageUrls:[void 0]},p=[{value:"The requirement to use <code>data</code> instead of <code>pattern</code> in import/export lists.",id:"the-requirement-to-use-data-instead-of-pattern-in-importexport-lists",level:3},{value:"Changes on warnings on constraints",id:"changes-on-warnings-on-constraints",level:3},{value:"Possible Solutions",id:"possible-solutions",level:2},{value:"Turn off <code>-Werror</code>",id:"turn-off--werror",level:3},{value:"Turn off <code>-Wredundant-constraints</code>",id:"turn-off--wredundant-constraints",level:3},{value:"Conclusion",id:"conclusion",level:2}],c={toc:p},g="wrapper";function d({components:e,...n}){return(0,r.yg)(g,(0,a.A)({},c,n,{components:e,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"At IOG we have several large and complex Haskell code bases. We also\nlike to make sure our various code bases compile with new versions of\nGHC when those new versions come out. The alternative would be to just\nuse one supported compiler and to update to a new supported compiler\nevery couple of years. We feel that this is sub optimal for a number\nof reasons:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Fixing breakages in our code due to the new compiler, after skipping\nmany releases, is more difficult than keeping up-to-date with the\ncurrent compiler.")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Keeping up with the latest compiler allows us to test for performance\nregressions as soon as new compiler versions are released. An example\nwhere we didn't do this we found performance regression in ",(0,r.yg)("inlineCode",{parentName:"p"},"ghc-9.6"),"\nwhich had been\n",(0,r.yg)("a",{parentName:"p",href:"https://engineering.iog.io/2024-10-17-ghc-update/"},"introduced in ",(0,r.yg)("inlineCode",{parentName:"a"},"ghc-9.2")),".")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Contributions that we at IOG make to GHC generally only end up in the\nlatest release.")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"If we have to make material changes to our code base for this compatibility\nchange; this also means that we can not rely on existing performance, and\nsimilar metrics we know about the code, and will have to re-run them for\nwhatever compiler we are currently using."))),(0,r.yg)("p",null,"We will now look at the issues of updating one of our code bases to\nbuild with ",(0,r.yg)("inlineCode",{parentName:"p"},"ghc-9.14")," (currently a pre-release). This code base already\ncompiles without any issue with ",(0,r.yg)("inlineCode",{parentName:"p"},"ghc-9.12.2"),"."),(0,r.yg)("p",null,"The code base is\n",(0,r.yg)("a",{parentName:"p",href:"https://github.com/IntersectMBO/cardano-ledger/"},"cardano-ledger"),"\nwhich is a single Git repository containing 28 Haskell/Cabal packages,\n1130 files and a little over 200,000 lines of Haskell code. This code\nbase also uses many relatively new Haskell features, like type families,\npattern synonyms, data kinds, poly kinds and so on."),(0,r.yg)("p",null,"We are currently only using a pre-release ",(0,r.yg)("inlineCode",{parentName:"p"},"ghc-9.14.0.20251007")," and\nthe diff to the code relative to code that compiles with ",(0,r.yg)("inlineCode",{parentName:"p"},"ghc-9.12.2"),"\nhas the following statistics:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"> git diff master | diffstat\n ...\n  127 files changed, 1440 insertions(+), 98 deletions(-)\n")),(0,r.yg)("p",null,"That means that over 10% of all files in this project needed\nmodifications. The modifications required were exclusively of two\ntypes:"),(0,r.yg)("h3",{id:"the-requirement-to-use-data-instead-of-pattern-in-importexport-lists"},"The requirement to use ",(0,r.yg)("inlineCode",{parentName:"h3"},"data")," instead of ",(0,r.yg)("inlineCode",{parentName:"h3"},"pattern")," in import/export lists."),(0,r.yg)("p",null,"This change is explained in the\n",(0,r.yg)("a",{parentName:"p",href:"https://downloads.haskell.org/ghc/9.14.1-alpha1/docs/users_guide/exts/explicit_namespaces.html#the-data-keyword-in-import-export-lists"},"changelog"),"\nfor ",(0,r.yg)("inlineCode",{parentName:"p"},"ghc-9.14"),". Since we need to support older compilers as well as\n",(0,r.yg)("inlineCode",{parentName:"p"},"ghc-9.14"),", we need special ",(0,r.yg)("inlineCode",{parentName:"p"},"CPP")," handling of the form:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"+#if __GLASGOW_HASKELL__ >= 914\n+  data RequireTimeExpire,\n+#else\n   pattern RequireTimeExpire,\n+#endif\n")),(0,r.yg)("h3",{id:"changes-on-warnings-on-constraints"},"Changes on warnings on constraints"),(0,r.yg)("p",null,"  The first pre-release of ",(0,r.yg)("inlineCode",{parentName:"p"},"ghc-9.14")," had a bug,\n",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/26381"},"GHC26381"),"\nEven after this bug is fixed, there is still some significant\nchanges around warning about redundant constraints. This one was\nannoying because some constraints are ",(0,r.yg)("strong",{parentName:"p"},"required")," for earlier\ncompilers and result in redundant constraint warning for ",(0,r.yg)("inlineCode",{parentName:"p"},"ghc-9.14"),".\nThe solution was:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"+#if __GLASGOW_HASKELL__ < 914\n+  -- This constraint is REQUIRED for ghc < 9.14 but REDUNDANT for ghc >= 9.14\n+  -- See https://gitlab.haskell.org/ghc/ghc/-/issues/26381#note_637863\n-  , Show (ContextError era)\n+#endif\n")),(0,r.yg)("h2",{id:"possible-solutions"},"Possible Solutions"),(0,r.yg)("p",null,"There are a number of potential solution to these problems but none are\nconsidered satisfactory."),(0,r.yg)("h3",{id:"turn-off--werror"},"Turn off ",(0,r.yg)("inlineCode",{parentName:"h3"},"-Werror")),(0,r.yg)("p",null,"We find this possible solution unsatisfactory, because we do not want to\nignore warnings and without ",(0,r.yg)("inlineCode",{parentName:"p"},"-Werror")," warnings can just scroll past at a\nfast pace and can easily be missed."),(0,r.yg)("h3",{id:"turn-off--wredundant-constraints"},"Turn off ",(0,r.yg)("inlineCode",{parentName:"h3"},"-Wredundant-constraints")),(0,r.yg)("p",null,"We find this solution unsatisfactory because at around the time this\nwarning first we had some code that was often difficult to modify and\nmaintain because it was overly constrained by constraints that were\nactually not needed."),(0,r.yg)("h2",{id:"conclusion"},"Conclusion"),(0,r.yg)("p",null,"Where there are two possible solutions, neither are considered better\nthan the ",(0,r.yg)("inlineCode",{parentName:"p"},"CPP")," hack alternative. We at IOG hope that the GHC developers\nbecome more aware of how compiler changes impact users, particularly\nthose with large complex code bases. In the meantime we are experimenting\nwith ideas in ",(0,r.yg)("a",{parentName:"p",href:"https://www.stable-haskell.org"},"https://www.stable-haskell.org"),", which we hope will eventually allow\nus to make this easier for us, and provide valuable changes to be we can upstream."))}d.isMDXComponent=!0},5680:(e,n,t)=>{t.d(n,{xA:()=>c,yg:()=>h});var a=t(6540);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach(function(n){r(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),p=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},c=function(e){var n=p(e.components);return a.createElement(l.Provider,{value:n},e.children)},g="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef(function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),g=p(t),u=r,h=g["".concat(l,".").concat(u)]||g[u]||d[u]||o;return t?a.createElement(h,i(i({ref:n},c),{},{components:t})):a.createElement(h,i({ref:n},c))});function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=u;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s[g]="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=t[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"}}]);