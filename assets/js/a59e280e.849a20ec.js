"use strict";(globalThis.webpackChunkengineering_iog_io=globalThis.webpackChunkengineering_iog_io||[]).push([[4036],{782:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var n=a(8168),r=(a(6540),a(5680));const i={slug:"2023-02-23-ghc-update",title:"IOG GHC Update #4",authors:["sylvain","doyougnu","luite","josh"],tags:["ghc","ghc-update"]},o=void 0,s={permalink:"/2023-02-23-ghc-update",editUrl:"https://github.com/input-output-hk/engineering/tree/master/blog/2023-02-23-ghc-update-4.md",source:"@site/blog/2023-02-23-ghc-update-4.md",title:"IOG GHC Update #4",description:"Biweekly update from the GHC DevX team at IOG.",date:"2023-02-23T00:00:00.000Z",formattedDate:"February 23, 2023",tags:[{label:"ghc",permalink:"/tags/ghc"},{label:"ghc-update",permalink:"/tags/ghc-update"}],readingTime:2.935,hasTruncateMarker:!0,authors:[{name:"Sylvain Henry",title:"Haskell DevX Engineer @ IOG",email:"sylvain.henry@iohk.io",key:"sylvain"},{name:"Jeffrey M. Young",title:"Haskell DevX Engineer @ IOG",url:"https://iog.io/en/",key:"doyougnu"},{name:"Luite Stegeman",title:"Haskell DevX Engineer @ IOG",email:"luite.stegeman@iohk.io",key:"luite"},{name:"Joshua Meredith",title:"Haskell DevX Engineer @ IOG",url:"https://iog.io/en/",key:"josh"}],frontMatter:{slug:"2023-02-23-ghc-update",title:"IOG GHC Update #4",authors:["sylvain","doyougnu","luite","josh"],tags:["ghc","ghc-update"]},prevItem:{title:"IOG GHC Update #5",permalink:"/2023-03-09-ghc-update"},nextItem:{title:"IOG GHC Update #3 (2023-02-09)",permalink:"/2023-02-09-ghc-update"}},l={authorsImageUrls:[void 0,void 0,void 0,void 0]},p=[{value:"JavaScript backend",id:"javascript-backend",level:2},{value:"Template Haskell",id:"template-haskell",level:3},{value:"JavaScript RTS refactor",id:"javascript-rts-refactor",level:3},{value:"Integer performance",id:"integer-performance",level:3},{value:"JavaScript EDSL",id:"javascript-edsl",level:3},{value:"CI",id:"ci",level:3},{value:"Compiler performance",id:"compiler-performance",level:2},{value:"More-strict <code>break</code>/<code>span</code>",id:"more-strict-breakspan",level:3},{value:"Unboxed CodeBuffers",id:"unboxed-codebuffers",level:3},{value:"Optimization Handbook",id:"optimization-handbook",level:3},{value:"GHCi",id:"ghci",level:2}],g={toc:p},h="wrapper";function c({components:e,...t}){return(0,r.yg)(h,(0,n.A)({},g,t,{components:e,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"Biweekly update from the GHC DevX team at IOG."),(0,r.yg)("p",null,"Previous updates can be found ",(0,r.yg)("a",{parentName:"p",href:"https://engineering.iog.io/tags/ghc-update"},"here"),"."),(0,r.yg)("h2",{id:"javascript-backend"},"JavaScript backend"),(0,r.yg)("h3",{id:"template-haskell"},"Template Haskell"),(0,r.yg)("p",null,"Sylvain: ",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9779"},"!9779"),"\nadding TH support for the JS backend passes CI and is ready for reviews."),(0,r.yg)("p",null,"Ticket ",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/23013"},"#23013")," has been\nopened to keep track of an issue with the recompilation avoidance mechanism.\nFixing the issue seems to require some invasive refactoring that is best left\nfor a future merge request."),(0,r.yg)("p",null,"Luite: ",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10008"},"!10008"),"\nImplemented keeping track of subdirectories in GHC's temporary file manager.\nReady for review. Fixes\n",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/22952"},"#22952"),"."),(0,r.yg)("p",null,"Temporary subdirectories are used when linking Template Haskell with the\nJavaScript backend and also in some situations when linking with other backends.\nThis would always result in files being left behind in GHC's temporary directory\n(and a warning at high enough verbosity settings) since these subdirectories\nwere never removed. With this patch, GHC keeps track of all created subdirectories\nand removes them at the end of the session."),(0,r.yg)("h3",{id:"javascript-rts-refactor"},"JavaScript RTS refactor"),(0,r.yg)("p",null,"Josh: has merged the refactor of the RTS generation module to reduce redundant code.\nIn this refactor, debug logging was also completed to determine the correct numbers\nto use as the cache sizes for generated JavaScript names - allowing us to vastly\nreduce the size of these arrays for efficiency, and to remove ",(0,r.yg)("inlineCode",{parentName:"p"},"panic")," cases in favour\nof generating higher numbered names without caching."),(0,r.yg)("p",null,(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9794"},"!9794")),(0,r.yg)("h3",{id:"integer-performance"},"Integer performance"),(0,r.yg)("p",null,"Sylvain: ",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9825"},"!9825")," has\nbeen updated after an helpful review by Matthew Claven."),(0,r.yg)("h3",{id:"javascript-edsl"},"JavaScript EDSL"),(0,r.yg)("p",null,"Jeff: MR is ",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10000"},"open"),".\nIn response to feedback from the team Jeff has added (and removed)\nseveral features that distinguish the eDSL from\n",(0,r.yg)("a",{parentName:"p",href:"https://github.com/ku-fpg/sunroof-compiler"},"sunroof"),". These include: removing\nthreading and continuations, adding named unique variables and a proper switch\nstatement. These changes allow more of the RTS to be replaced in the eDSL and\nallow the RTS to be typed using Haskell's type system. For example, now the STG\nregisters track the type of the values they hold."),(0,r.yg)("h3",{id:"ci"},"CI"),(0,r.yg)("p",null,"Sylvain: fixed CI script test that prevented performance results to be stored for\nthe JS backend (see ",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/22923"},"#22923")," and\n",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10026"},"!10026"),")."),(0,r.yg)("hr",null),(0,r.yg)("h2",{id:"compiler-performance"},"Compiler performance"),(0,r.yg)("h3",{id:"more-strict-breakspan"},"More-strict ",(0,r.yg)("inlineCode",{parentName:"h3"},"break"),"/",(0,r.yg)("inlineCode",{parentName:"h3"},"span")),(0,r.yg)("p",null,"Josh: opened a CLC (Core Libraries Committee) proposal to add stricter versions of\n",(0,r.yg)("inlineCode",{parentName:"p"},"break")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"span")," to ",(0,r.yg)("inlineCode",{parentName:"p"},"Data.List")," in addition to the existing lazy versions. The\nproposal considers evidence that these versions are situationally more performant,\nby comparing allocation statistics, generated STG, and microbenchmarks - as well as\nmaking the argument for consistency with existing ",(0,r.yg)("inlineCode",{parentName:"p"},"List")," functions that also have\nstrict versions."),(0,r.yg)("p",null,"See also:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://github.com/haskell/core-libraries-committee/issues/133"},"CLC proposal 133")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/22865"},"GHC Issue 22865")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9868"},"GHC MR 9868"))),(0,r.yg)("h3",{id:"unboxed-codebuffers"},"Unboxed CodeBuffers"),(0,r.yg)("p",null,"Josh: opened a CLC proposal to modify the implementation of ",(0,r.yg)("inlineCode",{parentName:"p"},"CodeBuffer"),"s in ",(0,r.yg)("inlineCode",{parentName:"p"},"base"),"\nto use unboxed tuples in the return type of encoding functions. This change presents\na significant allocation improvement, due to the difficulty GHC has with applying a\ncertain optimisation within data types."),(0,r.yg)("p",null,"See also:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://github.com/haskell/core-libraries-committee/issues/134"},"CLC proposal 134")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/22946"},"GHC Issue 22946")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9948"},"GHC MR 9948"),".")),(0,r.yg)("h3",{id:"optimization-handbook"},"Optimization Handbook"),(0,r.yg)("p",null,"Jeff: Has been hard at work on the ",(0,r.yg)("a",{parentName:"p",href:"https://input-output-hk.github.io/hs-opt-handbook.github.io/"},"Optimization Handbook"),".\nHe has finished a\nchapter on ",(0,r.yg)("inlineCode",{parentName:"p"},"Lambda Lifting"),", significantly expanded the glossary, and added\ndocumentation to the\n",(0,r.yg)("a",{parentName:"p",href:"https://github.com/yongrenjie/sphinx-exec-directive"},"sphinx-exec-directive"),"\nhaskell extension that he finished last month. The optimization handbook is now\nin review by IOG's IT team to migrate it to the Haskell Foundation website."),(0,r.yg)("hr",null),(0,r.yg)("h2",{id:"ghci"},"GHCi"),(0,r.yg)("p",null,"Luite: Added a testcase and did some cleanups in the types of the C code in MR\n",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9957"},"!9957"),", and adjusted\nthe bytecode generator to not produce zero offset ",(0,r.yg)("inlineCode",{parentName:"p"},"SLIDE")," instructions anymore.\nThis is now ready for review."))}c.isMDXComponent=!0},5680:(e,t,a)=>{a.d(t,{xA:()=>g,yg:()=>d});var n=a(6540);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach(function(t){r(e,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))})}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),p=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},g=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},h="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef(function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,g=s(e,["components","mdxType","originalType","parentName"]),h=p(a),u=r,d=h["".concat(l,".").concat(u)]||h[u]||c[u]||i;return a?n.createElement(d,o(o({ref:t},g),{},{components:a})):n.createElement(d,o({ref:t},g))});function d(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[h]="string"==typeof e?e:r,o[1]=s;for(var p=2;p<i;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"}}]);