"use strict";(globalThis.webpackChunkengineering_iog_io=globalThis.webpackChunkengineering_iog_io||[]).push([[1424],{4811:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var n=a(8168),r=(a(6540),a(5680));const i={slug:"2023-04-20-ghc-update",title:"IOG GHC Update #8",authors:["sylvain","doyougnu","luite","josh","bartek"],tags:["ghc","ghc-update"]},o=void 0,l={permalink:"/2023-04-20-ghc-update",editUrl:"https://github.com/input-output-hk/engineering/tree/master/blog/2023-04-20-ghc-update-8.md",source:"@site/blog/2023-04-20-ghc-update-8.md",title:"IOG GHC Update #8",description:"Biweekly update from the GHC DevX team at IOG.",date:"2023-04-20T00:00:00.000Z",formattedDate:"April 20, 2023",tags:[{label:"ghc",permalink:"/tags/ghc"},{label:"ghc-update",permalink:"/tags/ghc-update"}],readingTime:2.6,hasTruncateMarker:!0,authors:[{name:"Sylvain Henry",title:"Haskell DevX Engineer @ IOG",email:"sylvain.henry@iohk.io",key:"sylvain"},{name:"Jeffrey M. Young",title:"Haskell DevX Engineer @ IOG",url:"https://iog.io/en/",key:"doyougnu"},{name:"Luite Stegeman",title:"Haskell DevX Engineer @ IOG",email:"luite.stegeman@iohk.io",key:"luite"},{name:"Joshua Meredith",title:"Haskell DevX Engineer @ IOG",url:"https://iog.io/en/",key:"josh"},{name:"Bart\u0142omiej Cie\u015blar",title:"Haskell DevX Intern @ IOG",email:"bartlomiej.cieslar@iohk.io",key:"bartek"}],frontMatter:{slug:"2023-04-20-ghc-update",title:"IOG GHC Update #8",authors:["sylvain","doyougnu","luite","josh","bartek"],tags:["ghc","ghc-update"]},prevItem:{title:"Stacks in the JavaScript Backend",permalink:"/2023-04-21-stacks-in-the-js-backend"},nextItem:{title:"IOSim on Hackage!",permalink:"/2023-04-14-io-sim-annoucement"}},s={authorsImageUrls:[void 0,void 0,void 0,void 0,void 0]},p=[{value:"JavaScript backend",id:"javascript-backend",level:2},{value:"Pipeline refactoring and new IR",id:"pipeline-refactoring-and-new-ir",level:3},{value:"Testsuite and cleanup",id:"testsuite-and-cleanup",level:3},{value:"Documentation",id:"documentation",level:3},{value:"GHC Proposal #0134 (Deprecated Exports)",id:"ghc-proposal-0134-deprecated-exports",level:2},{value:"Performance",id:"performance",level:2}],g={toc:p},h="wrapper";function c({components:e,...t}){return(0,r.yg)(h,(0,n.A)({},g,t,{components:e,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"Biweekly update from the GHC DevX team at IOG."),(0,r.yg)("p",null,"Previous updates can be found ",(0,r.yg)("a",{parentName:"p",href:"https://engineering.iog.io/tags/ghc-update"},"here"),"."),(0,r.yg)("h2",{id:"javascript-backend"},"JavaScript backend"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Sylvain: fixed the implementation of some thread-related primops\n(listThreads, getThreadLabel...).\nSee ",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10303"},"GHC!10303"))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Sylvain: regenerated Cabal lexer with a newer Alex containing his bug fix\nfor the JS backend (cf previous update). Some Cabal tests had to be updated in the process because\nthey were relying on an Alex bug which has been fixed. This raised the question of\nbug fixes vs the PVP. See ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/haskell/cabal/pull/8896"},"Cabal#8896"),",\n",(0,r.yg)("a",{parentName:"p",href:"https://github.com/haskell/alex/issues/227"},"Alex#227"),",\nand ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/haskell/pvp/issues/49"},"PVP#49"),".")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Josh: added an implementation for ",(0,r.yg)("inlineCode",{parentName:"p"},"mkdir")," for node targets. Primarily this is\nexpected to be used by Cabal setup scripts, but any JS backend programs running on\nnode will be able to use it. See ",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10279"},"GHC!10279"),".")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Josh: fixed the ",(0,r.yg)("inlineCode",{parentName:"p"},"-fcheck-prim-bounds")," flag for the JS backend. The old implementation\nmostly only caused false negatives in the bounds that were rejected (i.e. it would miss\nsome invalid bounds), but it some cases there were also false positives, caused by\ncasted byte array indexing operations being indexed on the casted type's size.\nSee ",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10234"},"GHC!10234"),".")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Josh: fixed the JS implementation for the ",(0,r.yg)("inlineCode",{parentName:"p"},"access")," function on files. This\nfunction comes from C, but node also provides a direct equivalent - which the new\nimplementation uses. See ",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10301"},"GHC!10301"),".")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Luite: Worked on optimizing finalizers by disabling heap scanning and found\nan issue affecting ",(0,r.yg)("inlineCode",{parentName:"p"},"debugIO")," in the base library. This is caused by the code\ngenerated for ",(0,r.yg)("inlineCode",{parentName:"p"},"h$appendToHsStringA"),". A fix is now ready, see\n",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10312"},"GHC!10312")))),(0,r.yg)("h3",{id:"pipeline-refactoring-and-new-ir"},"Pipeline refactoring and new IR"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Jeff: ",(0,r.yg)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10260"},"MR!10260"),"\nready to land. This MR paves the way for the new IR, changes the small\noptimization pass the JavaScript backend had to target the current IR instead of\ndirectly printing optimized forms, and adds an IR to IR optimizer. CI shows that\nthe compile time allocations for the JavaScript backend is reduced an average of\n3.3% with a maximum reduction 13% with this MR. Note that these reductions\ncome from cleaner code generation, not from the optimizer.")),(0,r.yg)("h3",{id:"testsuite-and-cleanup"},"Testsuite and cleanup"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Sylvain: replaced uses of obsolescent ",(0,r.yg)("inlineCode",{parentName:"li"},"egrep")," with ",(0,r.yg)("inlineCode",{parentName:"li"},"grep -E"),". Otherwise\nrecent ",(0,r.yg)("inlineCode",{parentName:"li"},"egrep")," programs print a warning that makes some GHC golden tests fail.\nSee ",(0,r.yg)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/22351"},"GHC#22351"),"\nand ",(0,r.yg)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10308"},"GHC!10308"),".")),(0,r.yg)("h3",{id:"documentation"},"Documentation"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Luite: Finished the blog post on the lightweight stacks and calling convention\nthe JavaScript backend uses. This will be published on the IOG engineering blog\nshortly.")),(0,r.yg)("h2",{id:"ghc-proposal-0134-deprecated-exports"},"GHC Proposal #0134 (Deprecated Exports)"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Bartek: Implemented the parsing and pretty printing of warnings of deprecated exports.\nSee ",(0,r.yg)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10283"},"GHC!10283")," for the partial\nimplementation of the proposal so far.")),(0,r.yg)("h2",{id:"performance"},"Performance"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Jeff : First case study on performance engineering for the ",(0,r.yg)("a",{parentName:"p",href:"https://input-output-hk.github.io/hs-opt-handbook.github.io/"},"Haskell\nOptimization Handbook")," is almost done. The case study demonstrates a first pass\nof performance engineering on the klister programming language's interpreter.\nThe chapter demonstrates the use of ticky ticky, info-table, biography and\nretainer analysis profiling to gain a 6-fold improvement in the interpreter.")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Josh: Updated the unboxed codebuffers implementation to include pattern\nsynonyms for backwards-compatability. Now, the implementation of handle encoding\nin base can be updated to be more performant without requiring external changes.\nSee ",(0,r.yg)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9948"},"GHC!9948"),"."))))}c.isMDXComponent=!0},5680:(e,t,a)=>{a.d(t,{xA:()=>g,yg:()=>d});var n=a(6540);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach(function(t){r(e,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))})}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},g=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},h="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef(function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,g=l(e,["components","mdxType","originalType","parentName"]),h=p(a),u=r,d=h["".concat(s,".").concat(u)]||h[u]||c[u]||i;return a?n.createElement(d,o(o({ref:t},g),{},{components:a})):n.createElement(d,o({ref:t},g))});function d(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[h]="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"}}]);