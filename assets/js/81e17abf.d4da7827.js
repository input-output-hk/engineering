"use strict";(self.webpackChunkengineering_iog_io=self.webpackChunkengineering_iog_io||[]).push([[9245],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return m}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(a),m=r,d=u["".concat(s,".").concat(m)]||u[m]||h[m]||i;return a?n.createElement(d,o(o({ref:t},c),{},{components:a})):n.createElement(d,o({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},1474:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},assets:function(){return c},toc:function(){return h},default:function(){return m}});var n=a(7462),r=a(3366),i=(a(7294),a(3905)),o=["components"],l={slug:"2023-08-03-ghc-update",title:"IOG GHC Update #15",authors:["sylvain","doyougnu","luite","josh","bartek"],tags:["ghc","ghc-update"]},s=void 0,p={permalink:"/2023-08-03-ghc-update",editUrl:"https://github.com/input-output-hk/engineering/tree/master/blog/2023-08-03-ghc-update-15.md",source:"@site/blog/2023-08-03-ghc-update-15.md",title:"IOG GHC Update #15",description:"Biweekly Triweekly update from the GHC DevX team at IOG.",date:"2023-08-03T00:00:00.000Z",formattedDate:"August 3, 2023",tags:[{label:"ghc",permalink:"/tags/ghc"},{label:"ghc-update",permalink:"/tags/ghc-update"}],readingTime:3.445,truncated:!0,authors:[{name:"Sylvain Henry",title:"Haskell DevX Engineer @ IOG",email:"sylvain.henry@iohk.io",key:"sylvain"},{name:"Jeffrey M. Young",title:"Haskell DevX Engineer @ IOG",url:"https://iog.io/en/",key:"doyougnu"},{name:"Luite Stegeman",title:"Haskell DevX Engineer @ IOG",email:"luite.stegeman@iohk.io",key:"luite"},{name:"Joshua Meredith",title:"Haskell DevX Engineer @ IOG",url:"https://iog.io/en/",key:"josh"},{name:"Bart\u0142omiej Cie\u015blar",title:"Haskell DevX Intern @ IOG",email:"bartlomiej.cieslar@iohk.io",key:"bartek"}],frontMatter:{slug:"2023-08-03-ghc-update",title:"IOG GHC Update #15",authors:["sylvain","doyougnu","luite","josh","bartek"],tags:["ghc","ghc-update"]},prevItem:{title:"IOG GHC Update #16",permalink:"/2023-08-24-ghc-update"},nextItem:{title:"IOG GHC Update #14",permalink:"/2023-07-13-ghc-update"}},c={authorsImageUrls:[void 0,void 0,void 0,void 0,void 0]},h=[{value:"Performance",id:"performance",children:[],level:2},{value:"CI / Testsuite",id:"ci--testsuite",children:[],level:2},{value:"Cross Compiling / JavaScript backend",id:"cross-compiling--javascript-backend",children:[],level:2},{value:"Incomplete Record Selectors",id:"incomplete-record-selectors",children:[],level:2},{value:"Deprecated Instances",id:"deprecated-instances",children:[],level:2},{value:"Miscellaneous",id:"miscellaneous",children:[],level:2}],u={toc:h};function m(e){var t=e.components,a=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,(0,i.kt)("del",{parentName:"p"},"Biweekly")," Triweekly update from the GHC DevX team at IOG."),(0,i.kt)("p",null,"Previous updates can be found ",(0,i.kt)("a",{parentName:"p",href:"https://engineering.iog.io/tags/ghc-update"},"here"),"."),(0,i.kt)("h2",{id:"performance"},"Performance"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Sylvain: I've noticed that fusion wasn't happening for ",(0,i.kt)("inlineCode",{parentName:"li"},"enumFrom*")," methods on 32-bit targets (e.g. JavaScript).\nFor example, ",(0,i.kt)("inlineCode",{parentName:"li"},"foo = sum [0..123456] :: Word64")," was compiling into slow code using ",(0,i.kt)("inlineCode",{parentName:"li"},"Integer")," operations (see ",(0,i.kt)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/23578"},"GHC#23578"),").\nJaro has made ",(0,i.kt)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10825"},"a fix")," for the fusion operation (thanks!).\nHowever it turned out that the JS implementation of 64-bit operations is sometimes slower than using ",(0,i.kt)("inlineCode",{parentName:"li"},"Integer")," operations\n(see ",(0,i.kt)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/23597"},"GHC#23597"),") so fixing fusion made the JS code slower!\nSee Jaro's ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/haskell/core-libraries-committee/issues/187#issuecomment-1637560782"},"benchmark's results"),".\nI've updated the implementation of ",(0,i.kt)("inlineCode",{parentName:"li"},"plusWord64")," to fix this specific case (see ",(0,i.kt)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10873"},"GHC!10873"),").\nWith my fix we get a x3.5 speedup on the previous example and with Jaro's fusion fix we get another x5.4 speedup.\nOverall, from 4.8s to 0.25s!"),(0,i.kt)("li",{parentName:"ul"},"Jeff: I've narrowed down the performance regression in the Cardano code base when migrating to GHC-9.2.x to two functions: one which I fully understand and have a fix and another which I still do not understand. However, I have begun writing my report and will use this as a case study for the optimization handbook. I still do not understand the regression, but have found numerous other problems in the code base; such as an overly pervasive use of ",(0,i.kt)("inlineCode",{parentName:"li"},"INLINE")," pragmas, which are leading to code bloat and are hurting other good optimizations such as worker/wrapper.")),(0,i.kt)("h2",{id:"ci--testsuite"},"CI / Testsuite"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Sylvain: implemented ",(0,i.kt)("inlineCode",{parentName:"p"},"getMonotonicTimeNSec")," in JavaScript. See ",(0,i.kt)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/23687"},"GHC#23687"),"\nand ",(0,i.kt)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10900"},"GHC!10900"),".\nFound while working on ",(0,i.kt)("inlineCode",{parentName:"p"},"unix"),"'s package testsuite.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Luite: ran the testsuite for the JavaScript target with strict mode (",(0,i.kt)("inlineCode",{parentName:"p"},'"use strict"'),") on node.js and found some missing declarations that went unnoticed when running in regular mode. Pushed a few fixes. See ",(0,i.kt)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/23775"},"GHC#23775")," and ",(0,i.kt)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/11028"},"GHC!11028"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Josh: worked on adding CI to ",(0,i.kt)("inlineCode",{parentName:"p"},"ghcjs-base")," using the DevX Github actions ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/input-output-hk/devx"},"DevX"),"."))),(0,i.kt)("h2",{id:"cross-compiling--javascript-backend"},"Cross Compiling / JavaScript backend"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Luite: We found that emsdk 3.1.42 changed the layout of the ",(0,i.kt)("inlineCode",{parentName:"p"},"stat")," struct, which broke functionality. Since emsdk data structure layouts were apparently not as stable as we assumed, we needed some improvements in the way we were dealing with data structures and constants from the C compiler. We have removed hardcoded data layout information from the JavaScript support files in favour of layout information directly obtained from the C compiler through the ",(0,i.kt)("inlineCode",{parentName:"p"},"autoconf")," tools. Additionally we have more toolchain version checks now to prevent inconsistencies between the Haskell code (",(0,i.kt)("inlineCode",{parentName:"p"},".hsc")," files) and the JavaScript code. See ",(0,i.kt)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10918"},"GHC!10918"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Luite: Support for the JavaScript backend in the ",(0,i.kt)("inlineCode",{parentName:"p"},"process")," package is now merged. See ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/haskell/process/pull/292"},"process!292"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Luite: Found an issue with incorrect separation of constants such as flags/masks between the node.js platform (mostly seen by jsbits ",(0,i.kt)("inlineCode",{parentName:"p"},".js")," files) and those seen by Haskell ",(0,i.kt)("inlineCode",{parentName:"p"},".hsc")," files. A solution is mostly complete, but depends on ",(0,i.kt)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10918"},"GHC!10918")," to be merged first. See ",(0,i.kt)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/23777"},"GHC#23777"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Jeff: Continued work on implementing the new ",(0,i.kt)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10722"},"JStg IR"),". The MR's compiler is now capable of compiling a hello world, but has a bug in code generation I am still working to understand, although I have narrowed it down to the exact line of code in the JavaScript payload and the corresponding function in the eDSL.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Josh: Fixed an issue with the JavaScript backend's ",(0,i.kt)("inlineCode",{parentName:"p"},"MK_TUP*")," macros where these weren't using the correct constructor names.\nSee:"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/23659"},"GHC#23659")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10886"},"GHC!10886")))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Josh: Implemented ",(0,i.kt)("inlineCode",{parentName:"p"},"rename")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"getcwd")," in the JavaScript backend based on ",(0,i.kt)("inlineCode",{parentName:"p"},"nodejs")," functions.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Josh: Worked on updating ",(0,i.kt)("inlineCode",{parentName:"p"},"ghcjs-dom")," to build with the JavaScript backend.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Josh: Worked on updating certain ",(0,i.kt)("inlineCode",{parentName:"p"},"ghcjs-base")," functions that render ",(0,i.kt)("inlineCode",{parentName:"p"},"Integral")," values as decimal and hexadecimal ",(0,i.kt)("inlineCode",{parentName:"p"},"JSString")," values."))),(0,i.kt)("h2",{id:"incomplete-record-selectors"},"Incomplete Record Selectors"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Bartek: MR fully merged. See ",(0,i.kt)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10736"},"GHC!10736"))),(0,i.kt)("h2",{id:"deprecated-instances"},"Deprecated Instances"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Bartek: MR fully merged. See ",(0,i.kt)("a",{parentName:"li",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10902"},"GHC!10902"))),(0,i.kt)("h2",{id:"miscellaneous"},"Miscellaneous"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Sylvain: fixed two typos in CPP constants used by the JS rts (noticed by Luite). These would only be problematic in uncommon erroring circumstances, explaining why they haven't been caught earlier.\nSee ",(0,i.kt)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/23650"},"GHC#23650")," and ",(0,i.kt)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10862"},"GHC!10862"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Jeff: Finished and submitted the camera ready version of the GHC modularity ",(0,i.kt)("a",{parentName:"p",href:"https://hsyl20.fr/home/files/papers/2022-ghc-modularity.pdf"},"paper"),". See you at ICFP!")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Bartek: Working on Record Wild Cards not producing custom deprecations when used. See ",(0,i.kt)("a",{parentName:"p",href:"https://gitlab.haskell.org/ghc/ghc/-/issues/23382"},"GHC!23382")))))}m.isMDXComponent=!0}}]);